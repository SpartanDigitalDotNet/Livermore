---
phase: 15-admin-ui
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routers/logs.router.ts
  - apps/api/src/routers/index.ts
autonomous: true

must_haves:
  truths:
    - "API can serve log entries filtered by level"
    - "Protected endpoint requires Clerk authentication"
  artifacts:
    - path: "apps/api/src/routers/logs.router.ts"
      provides: "logs.getRecent tRPC endpoint"
      exports: ["logsRouter"]
    - path: "apps/api/src/routers/index.ts"
      provides: "AppRouter including logs"
      contains: "logs: logsRouter"
  key_links:
    - from: "apps/api/src/routers/logs.router.ts"
      to: "logs/*.log files"
      via: "fs.readFileSync"
      pattern: "readFileSync"
    - from: "apps/api/src/routers/index.ts"
      to: "apps/api/src/routers/logs.router.ts"
      via: "import logsRouter"
      pattern: "logsRouter"
---

<objective>
Create the logs tRPC router to serve log file data to the admin UI.

Purpose: The frontend cannot access filesystem directly. This endpoint reads log files server-side and returns parsed, filtered entries. Required for UI-02 (Log viewer).

Output: New `logs.getRecent` tRPC endpoint that reads today's log file and filters by level.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-admin-ui/15-RESEARCH.md

# Existing router structure
@apps/api/src/routers/index.ts
@apps/api/src/routers/alert.router.ts

# Log file format (JSON per line)
# {"timestamp":"2026-01-26T23:59:00.000Z","level":"INFO","name":"livermore","service":"livermore","event":"1m_candle_close","symbol":"BTC-USD",...}
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create logs router with getRecent endpoint</name>
  <files>apps/api/src/routers/logs.router.ts</files>
  <action>
Create `apps/api/src/routers/logs.router.ts`:

```typescript
import { z } from 'zod';
import { router, protectedProcedure } from '@livermore/trpc-config';
import { readFileSync, existsSync, readdirSync } from 'fs';
import path from 'path';

/**
 * Log entry shape from structured JSON logs.
 */
interface LogEntry {
  timestamp: string;
  level: 'DEBUG' | 'INFO' | 'WARN' | 'ERROR';
  name: string;
  service: string;
  msg: string;
  event?: string;
  symbol?: string;
  [key: string]: unknown;
}

/**
 * Get the logs directory path.
 * Logs are stored in ./logs/ relative to the project root.
 */
const LOG_DIR = path.resolve(process.cwd(), 'logs');

/**
 * Parse a single log line (JSON format).
 */
function parseLogLine(line: string): LogEntry | null {
  try {
    return JSON.parse(line) as LogEntry;
  } catch {
    return null;
  }
}

/**
 * Get available log dates (from filenames).
 */
function getAvailableDates(): string[] {
  if (!existsSync(LOG_DIR)) return [];

  const files = readdirSync(LOG_DIR);
  const dates = files
    .filter(f => f.startsWith('livermore-') && f.endsWith('.log'))
    .map(f => f.replace('livermore-', '').replace('.log', ''))
    .sort()
    .reverse();

  return dates;
}

/**
 * Read and parse a log file for a specific date.
 */
function readLogFile(date: string): LogEntry[] {
  const filePath = path.join(LOG_DIR, `livermore-${date}.log`);

  if (!existsSync(filePath)) {
    return [];
  }

  const content = readFileSync(filePath, 'utf-8');
  const lines = content.trim().split('\n').filter(Boolean);

  const entries: LogEntry[] = [];
  for (const line of lines) {
    const entry = parseLogLine(line);
    if (entry) {
      entries.push(entry);
    }
  }

  return entries;
}

/**
 * Logs Router
 *
 * Provides endpoints for viewing application logs.
 * All endpoints require authentication (protectedProcedure).
 */
export const logsRouter = router({
  /**
   * Get recent log entries, optionally filtered by level.
   * Returns entries in reverse chronological order (newest first).
   */
  getRecent: protectedProcedure
    .input(
      z.object({
        /** Filter by log level. If 'WARN', returns WARN and ERROR. If 'ERROR', returns only ERROR. */
        level: z.enum(['DEBUG', 'INFO', 'WARN', 'ERROR']).optional(),
        /** Maximum number of entries to return. Default 100, max 500. */
        limit: z.number().int().positive().max(500).default(100),
        /** Date to fetch logs for (YYYY-MM-DD). Defaults to today. */
        date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
      }).optional()
    )
    .query(async ({ input }) => {
      const level = input?.level;
      const limit = input?.limit ?? 100;
      const date = input?.date ?? new Date().toISOString().split('T')[0];

      // Read log file
      let entries = readLogFile(date);

      // Filter by level (WARN includes ERROR, INFO includes WARN and ERROR, etc.)
      if (level === 'ERROR') {
        entries = entries.filter(e => e.level === 'ERROR');
      } else if (level === 'WARN') {
        entries = entries.filter(e => e.level === 'WARN' || e.level === 'ERROR');
      } else if (level === 'INFO') {
        entries = entries.filter(e => e.level !== 'DEBUG');
      }
      // DEBUG = no filter (all levels)

      // Return most recent entries (reverse order, then limit)
      const recent = entries.slice(-limit).reverse();

      return {
        success: true,
        date,
        count: recent.length,
        total: entries.length,
        data: recent,
      };
    }),

  /**
   * Get available log dates.
   * Useful for date picker in UI.
   */
  getAvailableDates: protectedProcedure
    .query(async () => {
      const dates = getAvailableDates();

      return {
        success: true,
        dates,
      };
    }),
});

export type LogsRouter = typeof logsRouter;
```

Key design decisions:
- Uses `protectedProcedure` (requires Clerk auth) since logs may contain sensitive info
- Filters by level with hierarchy: ERROR only, WARN+ERROR, INFO+WARN+ERROR, or all (DEBUG)
- Returns newest entries first (reversed)
- Supports date parameter for viewing historical logs
  </action>
  <verify>
    Run `pnpm --filter @livermore/api type-check` - should pass.
  </verify>
  <done>logs.router.ts created with getRecent and getAvailableDates endpoints.</done>
</task>

<task type="auto">
  <name>Task 2: Register logs router in appRouter</name>
  <files>apps/api/src/routers/index.ts</files>
  <action>
Update `apps/api/src/routers/index.ts` to include the logs router:

```typescript
import { router } from '@livermore/trpc-config';
import { indicatorRouter } from './indicator.router';
import { alertRouter } from './alert.router';
import { positionRouter } from './position.router';
import { logsRouter } from './logs.router';

/**
 * Main application router
 *
 * Combines all sub-routers into a single tRPC router.
 */
export const appRouter = router({
  indicator: indicatorRouter,
  alert: alertRouter,
  position: positionRouter,
  logs: logsRouter,
});

export type AppRouter = typeof appRouter;

// Re-export sub-routers for type inference
export { indicatorRouter } from './indicator.router';
export { alertRouter } from './alert.router';
export { positionRouter } from './position.router';
export { logsRouter } from './logs.router';
```

This adds the `logs` namespace to the AppRouter, making `trpc.logs.getRecent` available to the admin UI.
  </action>
  <verify>
    1. Run `pnpm --filter @livermore/api type-check` - should pass
    2. Run `pnpm --filter @livermore/api dev` - server starts without errors
    3. Test endpoint with curl (requires valid Clerk token):
       `curl -H "Authorization: Bearer $TOKEN" "http://localhost:3002/trpc/logs.getRecent?input={}"`
       Should return 401 without token, log data with valid token.
  </verify>
  <done>logs router registered in appRouter, logs.getRecent endpoint available.</done>
</task>

</tasks>

<verification>
1. `pnpm --filter @livermore/api type-check` passes
2. `pnpm --filter @livermore/api dev` starts API server
3. logs.getRecent requires authentication (returns 401 without token)
4. logs.getRecent returns parsed log entries when authenticated
5. logs.getAvailableDates returns list of available log dates
</verification>

<success_criteria>
- logs.getRecent endpoint exists and requires authentication
- Endpoint returns parsed JSON log entries
- Level filtering works (ERROR, WARN, INFO, DEBUG)
- Date parameter allows viewing historical logs
- AppRouter type includes logs namespace (frontend type inference works)
</success_criteria>

<output>
After completion, create `.planning/phases/15-admin-ui/15-02-SUMMARY.md`
</output>

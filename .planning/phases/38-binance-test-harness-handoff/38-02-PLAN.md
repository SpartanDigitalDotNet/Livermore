---
phase: 38-binance-test-harness-handoff
plan: 02
type: execute
wave: 2
depends_on: ["38-01"]
files_modified:
  - .planning/phases/38-binance-test-harness-handoff/KAIA-HANDOFF.md
autonomous: false
must_haves:
  truths:
    - "The test harness has been executed against binance_us with real exchange data, and the results are documented with pass/fail status"
    - "Kaia has a handoff document covering: environment variable setup, exchange database configuration, first-run steps, and how to verify her Binance instance is healthy"
  artifacts:
    - path: ".planning/phases/38-binance-test-harness-handoff/KAIA-HANDOFF.md"
      provides: "Handoff documentation for Kaia"
      contains: "Environment Variables"
  key_links:
    - from: "KAIA-HANDOFF.md"
      to: "scripts/test-subscription-harness.ts"
      via: "References test harness as verification step"
      pattern: "test-subscription-harness"
---

<objective>
Execute the test harness against Binance.us with real exchange data (TST-03) and create Kaia's handoff documentation (TST-04).

Purpose: Validates the complete Binance pipeline end-to-end and provides Kaia with everything she needs to configure and run her own Binance instance independently.
Output: Documented test results and `KAIA-HANDOFF.md` in the phase directory.
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/38-binance-test-harness-handoff/38-01-SUMMARY.md
@scripts/test-subscription-harness.ts
@packages/database/schema.sql
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 1: Execute test harness against Binance.us</name>
  <what-built>
Plan 38-01 created the Subscription Test Harness script. This checkpoint runs it against Binance.us to validate the complete pipeline with real exchange data (TST-03).
  </what-built>
  <how-to-verify>
1. Open a PowerShell terminal with Livermore environment variables loaded
2. Run: `.\scripts\test-subscription-harness.ps1 -Exchange binance_us`
3. Verify output shows:
   - **REST Test**: BTC 1d candles fetched from Binance.us REST API and cached in Redis
   - **WebSocket Test**: At least one kline message received from Binance.us WebSocket stream within 2 seconds
   - **Summary**: Both tests show PASS
4. Optionally verify Redis keys directly:
   - Run: `.\scripts\debug-redis-keys.ps1` and look for `candles:{binance_us_exchange_id}:BTCUSDT:1d`
  </how-to-verify>
  <resume-signal>
Report test results: "Both tests passed" or describe any failures. If Binance.us is unreachable (geo-blocking, downtime), try with "binance" instead and note the result.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 2: Create Kaia handoff documentation</name>
  <files>.planning/phases/38-binance-test-harness-handoff/KAIA-HANDOFF.md</files>
  <action>
Create a handoff document at `.planning/phases/38-binance-test-harness-handoff/KAIA-HANDOFF.md` covering everything Kaia needs to configure and run her Binance instance.

**Structure the document with these sections:**

**1. Overview**
- What Livermore does and what "her instance" means (a separate Livermore API process connected to her Binance exchange)
- Each Livermore API instance claims one exchange -- she runs Binance, Mike runs Coinbase

**2. Environment Variables**
Document all required environment variables for Kaia's machine. Group by purpose:

*Database (shared Azure PostgreSQL Sandbox):*
- `DATABASE_HOST` - Azure PostgreSQL host (same as Mike's -- shared database)
- `DATABASE_PORT` - Port (5432)
- `DATABASE_LIVERMORE_USERNAME` - Kaia's database user
- `DATABASE_LIVERMORE_PASSWORD` - Kaia's database password
- `LIVERMORE_DATABASE_NAME` - Database name (shared)

*Redis (shared Azure Managed Redis):*
- `LIVERMORE_REDIS_URL` - Full Redis connection URL (rediss:// for TLS)

*Clerk Authentication:*
- `CLERK_PUBLISHABLE_KEY` - Clerk publishable key
- `CLERK_SECRET_KEY` - Clerk secret key
- `CLERK_WEBHOOK_SIGNING_SECRET` - Clerk webhook signing secret

*Note:* Binance WebSocket is public (no API key needed for market data). REST klines endpoint is also public. API keys only needed if she wants to trade (out of scope for v7.0).

**3. Exchange Database Configuration**
- The `exchanges` table is seeded with `binance_us` entry (id auto-assigned)
- She needs a `user_exchanges` record linking her user to the binance_us exchange
- This is done via the Admin UI Exchange Setup Modal (Phase 37) -- she fills in display name and API key env var names (can leave blank since Binance market data is public)
- Explain the `is_active` and `is_default` flags

**4. First-Run Steps**
Step-by-step instructions:
1. Clone the Livermore repo
2. Run `pnpm install` to install dependencies
3. Set environment variables (reference section 2)
4. Run `pnpm build` to build all packages
5. Start the Admin UI: `.\scripts\run-admin-dev.ps1`
6. Navigate to the Network page
7. Her exchange (binance_us) should appear as an instance card
8. Click the Exchange Setup gear icon to configure her user_exchange record (if not already done)
9. Click "Connect" on her binance_us card to start the instance
10. The instance will go through: idle -> starting -> warming -> active
11. Watch the WarmupProgressPanel for real-time warmup status

**5. Verification Checklist**
How to verify her instance is healthy:
- Admin Network page shows her exchange as "active" with green status
- WarmupProgressPanel shows warmup completed (100%)
- Redis has candle keys: `candles:{exchangeId}:BTCUSDT:1d` etc.
- Run the test harness: `.\scripts\test-subscription-harness.ps1 -Exchange binance_us`
- Check network activity logs in the Admin UI activity feed

**6. Troubleshooting**
Common issues:
- "Exchange not found" -- check exchanges table has binance_us row, run seed if needed
- "No wsUrl configured" -- verify exchanges.ws_url column has the Binance.us WebSocket URL
- Connection timeout -- check if Binance.us is accessible from her network
- Redis connection errors -- verify LIVERMORE_REDIS_URL is correct and Azure Redis is accessible
- The test harness script is the first thing to try for diagnosis

**7. Test Results**
Document the results from the checkpoint execution (Task 1):
- Date tested, exchange tested against (binance_us or binance)
- REST warmup result: PASS/FAIL, candles fetched count, candles cached count
- WebSocket streaming result: PASS/FAIL, messages received count
- Any notes or issues encountered
- This section satisfies TST-03's requirement that test results are documented

**Writing style:** Concise, actionable, numbered steps. Kaia is technical (she built PerseusWeb) so no need to explain what Redis or WebSocket are. Focus on Livermore-specific configuration.
  </action>
  <verify>
File exists at `.planning/phases/38-binance-test-harness-handoff/KAIA-HANDOFF.md` with all 6 sections present. Verify the document references the test harness script for verification.
  </verify>
  <done>
Kaia has a complete handoff document that covers environment variables, database setup, first-run steps, health verification, and troubleshooting. She can configure and run her Binance instance independently.
  </done>
</task>

</tasks>

<verification>
1. Test harness has been executed against Binance.us (or Binance.com if .us is unavailable) with documented results
2. `KAIA-HANDOFF.md` exists with all 7 sections: Overview, Environment Variables, Exchange Database Configuration, First-Run Steps, Verification Checklist, Troubleshooting, Test Results
3. The handoff document references `scripts/test-subscription-harness.ts` as a verification tool
4. The handoff document correctly describes the Admin UI exchange setup flow (Phase 37)
</verification>

<success_criteria>
Binance integration is validated with real exchange data and Kaia has a self-contained handoff document covering everything needed to run her own Binance instance.
</success_criteria>

<output>
After completion, create `.planning/phases/38-binance-test-harness-handoff/38-02-SUMMARY.md`
</output>

---
phase: 36-binance-websocket-adapter
plan: 02
type: execute
wave: 2
depends_on: ["36-01"]
files_modified:
  - apps/api/src/services/exchange/adapter-factory.ts
autonomous: true

must_haves:
  truths:
    - "ExchangeAdapterFactory creates BinanceAdapter when exchange name is 'binance'"
    - "ExchangeAdapterFactory creates BinanceAdapter when exchange name is 'binance_us'"
    - "The commented-out binance case in the factory switch statement is replaced with working code"
    - "BinanceAdapter receives wsUrl and restUrl from the exchanges table via ExchangeConfig"
    - "The factory error message includes 'binance' and 'binance_us' in the supported exchanges list"
  artifacts:
    - path: "apps/api/src/services/exchange/adapter-factory.ts"
      provides: "Factory with binance/binance_us case in createAdapterByType switch"
      contains: "createBinanceAdapter"
  key_links:
    - from: "apps/api/src/services/exchange/adapter-factory.ts"
      to: "packages/exchange-core/src/adapter/binance-adapter.ts"
      via: "import BinanceAdapter and BinanceAdapterOptions"
      pattern: "import.*BinanceAdapter.*from.*exchange-core"
    - from: "apps/api/src/services/exchange/adapter-factory.ts"
      to: "packages/binance-client"
      via: "import BinanceRestClient for backfill REST client injection"
      pattern: "import.*BinanceRestClient.*from.*binance-client"
---

<objective>
Wire BinanceAdapter into ExchangeAdapterFactory so that `factory.create(exchangeId)` returns a BinanceAdapter when the exchange name is 'binance' or 'binance_us'. Replace the commented-out factory branch with working code.

Purpose: Complete the factory pattern so the control channel's handleStart flow works for Binance exchanges without any code changes -- only the database row determines which adapter is created.

Output: Updated `adapter-factory.ts` with working Binance adapter creation.
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/36-binance-websocket-adapter/36-01-SUMMARY.md
@apps/api/src/services/exchange/adapter-factory.ts
@apps/api/src/services/exchange/rest-client-factory.ts
@packages/exchange-core/src/adapter/binance-adapter.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BinanceAdapter creation to ExchangeAdapterFactory</name>
  <files>apps/api/src/services/exchange/adapter-factory.ts</files>
  <action>
Update `adapter-factory.ts` to support creating BinanceAdapter instances.

**1. Add imports:**
```typescript
import { BinanceAdapter, type BinanceAdapterOptions } from '@livermore/exchange-core';
import { BinanceRestClient } from '@livermore/binance-client';
```

**2. Update `createAdapterByType` switch statement:**
Replace the commented-out binance cases with working code:
```typescript
private createAdapterByType(exchange: ExchangeConfig): IExchangeAdapter {
  switch (exchange.name) {
    case 'coinbase':
      return this.createCoinbaseAdapter(exchange);

    case 'binance':
    case 'binance_us':
      return this.createBinanceAdapter(exchange);

    default:
      throw new Error(`Unsupported exchange type: ${exchange.name}. Supported: coinbase, binance, binance_us`);
  }
}
```

**3. Add `createBinanceAdapter` private method:**
```typescript
/**
 * Create a Binance adapter instance
 * Works for both binance.com and binance.us -- only wsUrl/restUrl differ
 */
private createBinanceAdapter(exchange: ExchangeConfig): BinanceAdapter {
  if (!exchange.wsUrl) {
    throw new Error(`Exchange ${exchange.name} (ID: ${exchange.id}) has no wsUrl configured`);
  }

  // Create REST client for reconnection backfill
  // restUrl determines binance.com vs binance.us
  const restClient = new BinanceRestClient({
    baseUrl: exchange.restUrl ?? undefined,
  });

  const config: BinanceAdapterOptions = {
    wsUrl: exchange.wsUrl,
    redis: this.config.redis,
    userId: this.config.userId,
    exchangeId: exchange.id,
    exchangeName: exchange.name,
    restClient,
  };

  const adapter = new BinanceAdapter(config);

  logger.info(
    { exchangeId: exchange.id, exchangeName: exchange.name, wsUrl: exchange.wsUrl },
    'Created Binance adapter via factory'
  );

  return adapter;
}
```

**Key design notes:**
- The `exchange.wsUrl` comes from the `exchanges` table and determines binance.com vs binance.us
- The `exchange.restUrl` is passed to BinanceRestClient to set the correct API base URL
- `exchange.name` is passed as `exchangeName` so the adapter logs and UnifiedCandle.exchange reflect the actual exchange
- No API key/secret needed for Binance public WebSocket market data streams
- REST client is created here (not inside the adapter) to keep exchange-core free from binance-client dependency
- The `restClient` is provided for reconnection backfill (gap-filling after disconnect)

**4. Update AdapterFactoryConfig docstring** to note it's not Coinbase-specific:
Change the comment on `apiKeyId` and `privateKeyPem` to clarify they're for Coinbase (Binance WebSocket doesn't need them):
```typescript
export interface AdapterFactoryConfig {
  /** Coinbase API key ID (required for Coinbase, not used for Binance) */
  apiKeyId: string;
  /** Coinbase private key PEM (required for Coinbase, not used for Binance) */
  privateKeyPem: string;
  /** Redis client for caching and pub/sub */
  redis: RedisClient;
  /** User ID for cache operations */
  userId: number;
}
```

**DO NOT:**
- Change the AdapterFactoryConfig interface fields (only update comments)
- Modify the CoinbaseAdapter creation logic
- Touch the ServiceRegistry (the `coinbaseAdapter` field is typed as IExchangeAdapter and works for any adapter)
- Add new parameters to the factory constructor
  </action>
  <verify>
Run `npx turbo build --filter=api` to confirm the API app builds. Run `npx turbo build` for full workspace build. Verify no TypeScript errors.
  </verify>
  <done>
ExchangeAdapterFactory.createAdapterByType() handles 'binance' and 'binance_us' cases, creating a BinanceAdapter with wsUrl from the exchanges table. The commented-out branch is replaced with working code. The factory creates BinanceRestClient for backfill injection. Full workspace builds cleanly.
  </done>
</task>

</tasks>

<verification>
1. `npx turbo build` passes for the entire workspace
2. `adapter-factory.ts` has `case 'binance':` and `case 'binance_us':` in the switch statement (not commented out)
3. `createBinanceAdapter` method exists and returns a `BinanceAdapter` instance
4. BinanceAdapter receives `wsUrl` from `ExchangeConfig` (from database)
5. BinanceRestClient is created with `restUrl` from database for the correct Binance endpoint
6. Error message in default case lists all three supported exchanges: coinbase, binance, binance_us
7. No changes to ServiceRegistry types or field names
</verification>

<success_criteria>
- `ExchangeAdapterFactory.create(exchangeId)` returns a BinanceAdapter when the exchange name is 'binance' or 'binance_us'
- The wsUrl and restUrl from the exchanges table determine which Binance endpoint is used
- Full workspace build passes with no TypeScript errors
- Existing Coinbase adapter creation is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/36-binance-websocket-adapter/36-02-SUMMARY.md`
</output>

---
phase: 31-network-activity-logging
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/schemas/src/network/activity-log.schema.ts
  - packages/schemas/src/index.ts
  - packages/cache/src/keys.ts
  - apps/api/src/services/network-activity-logger.ts
autonomous: true

must_haves:
  truths:
    - "StateTransitionEntry schema enforces event='state_transition' with fromState, toState, and adminEmail fields"
    - "ErrorEntry schema enforces event='error' with error message and current state fields"
    - "NetworkActivityEntry is a discriminated union on the 'event' field"
    - "networkActivityStreamKey('Coinbase') returns 'logs:network:coinbase' (lowercase)"
    - "NetworkActivityLogger.logTransition() writes to Redis Stream with MINID trimming and never throws"
    - "NetworkActivityLogger.logError() writes to Redis Stream with MINID trimming and never throws"
  artifacts:
    - path: "packages/schemas/src/network/activity-log.schema.ts"
      provides: "Zod schemas for state transition and error log entries with discriminated union"
      exports: ["StateTransitionEntrySchema", "StateTransitionEntry", "ErrorEntrySchema", "ErrorEntry", "NetworkActivityEntrySchema", "NetworkActivityEntry"]
    - path: "packages/schemas/src/index.ts"
      provides: "Re-export of activity-log schemas"
      contains: "export * from './network/activity-log.schema'"
    - path: "packages/cache/src/keys.ts"
      provides: "networkActivityStreamKey function"
      exports: ["networkActivityStreamKey"]
    - path: "apps/api/src/services/network-activity-logger.ts"
      provides: "NetworkActivityLogger class with logTransition, logError, and setIp methods"
      exports: ["NetworkActivityLogger"]
  key_links:
    - from: "packages/schemas/src/index.ts"
      to: "packages/schemas/src/network/activity-log.schema.ts"
      via: "barrel re-export"
      pattern: "export \\* from './network/activity-log\\.schema'"
    - from: "apps/api/src/services/network-activity-logger.ts"
      to: "packages/cache/src/keys.ts"
      via: "import networkActivityStreamKey"
      pattern: "networkActivityStreamKey"
    - from: "apps/api/src/services/network-activity-logger.ts"
      to: "redis.xadd"
      via: "XADD with MINID ~ trimming"
      pattern: "xadd.*MINID"
---

<objective>
Create the activity log schemas, key builder, and NetworkActivityLogger service that wraps Redis Streams XADD with MINID-based 90-day retention.

Purpose: All logging infrastructure must exist before Plan 02 wires it into the state machine and error paths. This keeps concerns separated -- the logger is a standalone service that can be tested independently.
Output: 4 files -- Zod schemas for log entry types, updated schema barrel, updated key builder, and the NetworkActivityLogger service class.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-network-activity-logging/31-RESEARCH.md

Key source files:
@packages/schemas/src/network/instance-status.schema.ts
@packages/schemas/src/index.ts
@packages/cache/src/keys.ts
@packages/cache/src/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activity log Zod schemas and key builder</name>
  <files>
    packages/schemas/src/network/activity-log.schema.ts
    packages/schemas/src/index.ts
    packages/cache/src/keys.ts
  </files>
  <action>
    **Part A: Activity log schemas**

    Create `packages/schemas/src/network/activity-log.schema.ts` with the following:

    1. Import `z` from 'zod' and `ConnectionStateSchema` from `./instance-status.schema`.

    2. **BaseLogEntrySchema** (NOT exported -- internal base only):
       ```typescript
       const BaseLogEntrySchema = z.object({
         timestamp: z.string(),       // ISO 8601
         exchangeId: z.string(),      // String because Redis Streams store all values as strings
         exchangeName: z.string(),
         hostname: z.string(),
         ip: z.string(),              // Empty string if unknown
       });
       ```

    3. **StateTransitionEntrySchema** (LOG-02) -- extends BaseLogEntrySchema:
       ```typescript
       export const StateTransitionEntrySchema = BaseLogEntrySchema.extend({
         event: z.literal('state_transition'),
         fromState: ConnectionStateSchema,
         toState: ConnectionStateSchema,
         adminEmail: z.string(),      // Empty string if not yet known
       });
       ```

    4. **ErrorEntrySchema** (LOG-03) -- extends BaseLogEntrySchema:
       ```typescript
       export const ErrorEntrySchema = BaseLogEntrySchema.extend({
         event: z.literal('error'),
         error: z.string(),
         state: ConnectionStateSchema,
       });
       ```
       IMPORTANT: Error events have `state` (current state), NOT `fromState`/`toState`. These are different event types per LOG-02 vs LOG-03.

    5. **NetworkActivityEntrySchema** -- discriminated union on `event`:
       ```typescript
       export const NetworkActivityEntrySchema = z.discriminatedUnion('event', [
         StateTransitionEntrySchema,
         ErrorEntrySchema,
       ]);
       ```

    6. Export all TypeScript types: `StateTransitionEntry`, `ErrorEntry`, `NetworkActivityEntry`.

    **Part B: Barrel export**

    Update `packages/schemas/src/index.ts` to add at the bottom of the Network schemas section:
    ```typescript
    export * from './network/activity-log.schema';
    ```

    **Part C: Key builder**

    Add `networkActivityStreamKey` function to `packages/cache/src/keys.ts`. Place it in the INSTANCE REGISTRY section (right after `instanceStatusKey`):

    ```typescript
    /**
     * Build Redis Stream key for network activity logging.
     * Phase 31: One stream per exchange, keyed by normalized name.
     *
     * @example networkActivityStreamKey('Coinbase') // 'logs:network:coinbase'
     */
    export function networkActivityStreamKey(exchangeName: string): string {
      return `logs:network:${exchangeName.toLowerCase()}`;
    }
    ```

    The key uses exchange NAME (not ID) per LOG-01. Lowercase normalization ensures consistency regardless of how exchange names are cased elsewhere in the codebase.
  </action>
  <verify>
    Run `npx tsc --noEmit -p packages/schemas/tsconfig.json` -- no type errors.
    Run `npx tsc --noEmit -p packages/cache/tsconfig.json` -- no type errors.
    Grep for `networkActivityStreamKey` in keys.ts to confirm it exists.
    Grep for `activity-log.schema` in packages/schemas/src/index.ts to confirm barrel export.
  </verify>
  <done>
    StateTransitionEntrySchema has fields: event (literal 'state_transition'), timestamp, fromState, toState, exchangeId, exchangeName, hostname, ip, adminEmail. ErrorEntrySchema has fields: event (literal 'error'), timestamp, error, exchangeId, exchangeName, hostname, ip, state. NetworkActivityEntrySchema is a discriminated union. networkActivityStreamKey('Coinbase') returns 'logs:network:coinbase'. Barrel exports both schema files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NetworkActivityLogger service</name>
  <files>
    apps/api/src/services/network-activity-logger.ts
  </files>
  <action>
    Create `apps/api/src/services/network-activity-logger.ts` with the following:

    1. **Imports:**
       - `ConnectionState` from `@livermore/schemas`
       - `RedisClient`, `networkActivityStreamKey` from `@livermore/cache`
       - `createLogger` from `@livermore/utils`

    2. **Constants:**
       ```typescript
       const NINETY_DAYS_MS = 90 * 24 * 60 * 60 * 1000; // 7_776_000_000
       ```

    3. **Constructor options interface:**
       ```typescript
       interface ActivityLoggerOptions {
         redis: RedisClient;
         exchangeId: number;
         exchangeName: string;
         hostname: string;
         ip?: string | null;
         adminEmail?: string | null;
       }
       ```

    4. **NetworkActivityLogger class:**

       **Constructor:**
       - Accept `ActivityLoggerOptions`
       - Store all fields as private properties
       - Initialize `ip` and `adminEmail` to empty string if null/undefined
       - Create logger with `createLogger({ name: 'activity-logger', service: 'network' })`

       **`logTransition(from: ConnectionState, to: ConnectionState): Promise<void>`:**
       - Build stream key via `networkActivityStreamKey(this.exchangeName)`
       - Compute MINID threshold: `${Date.now() - NINETY_DAYS_MS}-0`
       - Call `this.redis.xadd()` with these positional arguments:
         ```
         streamKey, 'MINID', '~', minId, '*',
         'event', 'state_transition',
         'timestamp', new Date().toISOString(),
         'fromState', from,
         'toState', to,
         'exchangeId', String(this.exchangeId),
         'exchangeName', this.exchangeName,
         'hostname', this.hostname,
         'ip', this.ip,
         'adminEmail', this.adminEmail
         ```
       - Wrap ENTIRE body in try/catch. On error, log with `logger.error({ err }, 'Failed to log state transition to stream')` and return -- NEVER throw.
       - This method is fire-and-forget. Callers use `.catch(() => {})` but the method itself must also catch internally.

       **`logError(error: string, currentState: ConnectionState): Promise<void>`:**
       - Same stream key and MINID computation as logTransition.
       - Call `this.redis.xadd()` with:
         ```
         streamKey, 'MINID', '~', minId, '*',
         'event', 'error',
         'timestamp', new Date().toISOString(),
         'error', error,
         'exchangeId', String(this.exchangeId),
         'exchangeName', this.exchangeName,
         'hostname', this.hostname,
         'ip', this.ip,
         'state', currentState
         ```
       - Same try/catch pattern as logTransition. NEVER throw.

       **`setIp(ip: string): void`:**
       - Update `this.ip = ip`. This allows the logger identity to be updated after async IP detection completes. Early log entries may show empty IP -- this is acceptable per RESEARCH.md Open Question #2.

       **`setAdminEmail(email: string): void`:**
       - Update `this.adminEmail = email`. Called when ControlChannelService initializes with authenticated user context.

    5. **Export:** `export { NetworkActivityLogger }` and `export type { ActivityLoggerOptions }`.

    CRITICAL CONSTRAINTS:
    - ALL field values passed to xadd MUST be strings. Use `String(this.exchangeId)` for numbers. Use `this.ip` (already defaulted to '' in constructor) for nullable fields. Redis Streams cannot store null/undefined.
    - Use approximate MINID trimming (`'~'`) not exact (`'='`). Approximate is more performant and recommended by Redis docs.
    - The `*` argument tells Redis to auto-generate the stream entry ID (timestamp-based, monotonic).
    - Do NOT use JSON.stringify for the whole entry. Redis Streams use flat field-value pairs.
  </action>
  <verify>
    Run `npx tsc --noEmit -p apps/api/tsconfig.json` -- no type errors.
    Grep the file for `xadd` to confirm both logTransition and logError use it.
    Grep the file for `MINID` to confirm trimming is present on both methods.
    Grep the file for `catch` to confirm both methods have try/catch (fire-and-forget).
    Verify the class exports `logTransition`, `logError`, `setIp`, and `setAdminEmail`.
  </verify>
  <done>
    NetworkActivityLogger class exists with logTransition (LOG-02), logError (LOG-03), setIp, and setAdminEmail methods. Both log methods use XADD with MINID ~ trimming (LOG-04). All field values are strings (LOG-05). Both methods catch errors internally and never throw. No heartbeat logging exists in this class (LOG-06 by design).
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for packages/schemas, packages/cache, and apps/api
- StateTransitionEntrySchema has all LOG-02 fields: timestamp, event, fromState, toState, exchangeId, exchangeName, hostname, ip, adminEmail
- ErrorEntrySchema has all LOG-03 fields: timestamp, event, error, exchangeId, exchangeName, hostname, ip, state
- NetworkActivityEntrySchema is a discriminated union on 'event'
- networkActivityStreamKey follows LOG-01 pattern: `logs:network:{exchange_name}` (lowercase)
- NetworkActivityLogger uses XADD with MINID ~ for 90-day retention (LOG-04)
- All stream field values are strings (LOG-05)
- Logger has no heartbeat-related methods -- heartbeats are excluded by design (LOG-06)
</verification>

<success_criteria>
- LOG-01: Stream key pattern `logs:network:{exchange_name}` implemented via networkActivityStreamKey
- LOG-02: StateTransitionEntry schema with all required fields, logTransition method writes them
- LOG-03: ErrorEntry schema with all required fields, logError method writes them
- LOG-04: Both XADD calls use MINID ~ with 90-day threshold for inline trimming
- LOG-05: Consistent field names across both entry types via shared BaseLogEntrySchema
- LOG-06: NetworkActivityLogger has no heartbeat logging (heartbeats excluded by design)
</success_criteria>

<output>
After completion, create `.planning/phases/31-network-activity-logging/31-01-SUMMARY.md`
</output>

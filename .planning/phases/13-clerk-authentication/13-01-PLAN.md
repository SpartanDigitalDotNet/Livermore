---
phase: 13-clerk-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/server.ts
  - apps/api/package.json
  - packages/trpc-config/src/context.ts
  - packages/trpc-config/src/trpc.ts
  - packages/trpc-config/package.json
  - packages/schemas/src/env/config.schema.ts
autonomous: true
user_setup:
  - service: clerk
    why: "JWT token validation for API authentication"
    env_vars:
      - name: CLERK_PUBLISHABLE_KEY
        source: "Clerk Dashboard -> API Keys -> Publishable key"
      - name: CLERK_SECRET_KEY
        source: "Clerk Dashboard -> API Keys -> Secret keys"
    dashboard_config:
      - task: "Create Clerk application (if not exists)"
        location: "Clerk Dashboard -> Applications -> Create application"

must_haves:
  truths:
    - "Unauthenticated request to protected procedure returns 401 UNAUTHORIZED"
    - "Request with valid Clerk Bearer token to protected procedure succeeds"
    - "ctx.auth.userId is available as string (not null) in protected procedure handlers"
    - "Server starts without Clerk initialization errors"
  artifacts:
    - path: "apps/api/src/server.ts"
      provides: "Clerk plugin registration with correct import order"
      contains: "import 'dotenv/config'"
    - path: "packages/trpc-config/src/context.ts"
      provides: "Auth object in tRPC context"
      exports: ["BaseContext", "AuthenticatedContext", "createContext"]
    - path: "packages/trpc-config/src/trpc.ts"
      provides: "Protected procedure middleware"
      exports: ["protectedProcedure"]
    - path: "packages/schemas/src/env/config.schema.ts"
      provides: "Clerk env var validation"
      contains: "CLERK_SECRET_KEY"
  key_links:
    - from: "apps/api/src/server.ts"
      to: "@clerk/fastify"
      via: "clerkPlugin registration"
      pattern: "fastify\\.register\\(clerkPlugin\\)"
    - from: "packages/trpc-config/src/context.ts"
      to: "@clerk/fastify"
      via: "getAuth(req) call"
      pattern: "getAuth\\(req\\)"
    - from: "packages/trpc-config/src/trpc.ts"
      to: "packages/trpc-config/src/context.ts"
      via: "ctx.auth.userId check"
      pattern: "ctx\\.auth\\.userId"
---

<objective>
Integrate Clerk authentication into Livermore's Fastify + tRPC stack.

Purpose: Enable JWT token validation for protected API endpoints, allowing the Admin UI (Phase 15) to authenticate users via Clerk.

Output:
- `@clerk/fastify` plugin registered with correct import order (dotenv first)
- tRPC context includes Clerk auth object from `getAuth(req)`
- `protectedProcedure` middleware rejects unauthenticated requests with 401
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-clerk-authentication/13-RESEARCH.md

# Current source files
@apps/api/src/server.ts
@packages/trpc-config/src/context.ts
@packages/trpc-config/src/trpc.ts
@packages/schemas/src/env/config.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @clerk/fastify and register plugin</name>
  <files>
    apps/api/src/server.ts
    apps/api/package.json
    packages/schemas/src/env/config.schema.ts
  </files>
  <action>
1. Install @clerk/fastify in api package:
   ```bash
   pnpm add @clerk/fastify --filter @livermore/api
   ```

2. Add Clerk env vars to EnvConfigSchema (packages/schemas/src/env/config.schema.ts):
   ```typescript
   // Clerk Authentication
   CLERK_PUBLISHABLE_KEY: z.string().min(1, 'Clerk publishable key is required'),
   CLERK_SECRET_KEY: z.string().min(1, 'Clerk secret key is required'),
   ```

3. Modify apps/api/src/server.ts:
   - Add `import 'dotenv/config';` as the FIRST import (before all other imports)
   - Add `import { clerkPlugin } from '@clerk/fastify';` with other imports
   - Register clerkPlugin AFTER cors and websocket, BEFORE tRPC:
     ```typescript
     await fastify.register(clerkPlugin);
     logger.info('Clerk authentication plugin registered');
     ```

CRITICAL: The `import 'dotenv/config'` MUST be the first line of server.ts. Clerk reads CLERK_SECRET_KEY during ES module initialization. If dotenv loads after Clerk imports, initialization fails.

Do NOT modify the Discord webhook env var - it should remain required (user has it configured).
  </action>
  <verify>
1. Check import order: `head -5 apps/api/src/server.ts` shows dotenv/config as first import
2. Verify pnpm install succeeded: `pnpm list @clerk/fastify --filter @livermore/api`
3. TypeScript compiles: `pnpm build --filter @livermore/api`
  </verify>
  <done>
- dotenv/config is first import in server.ts
- clerkPlugin registered before tRPC
- CLERK_PUBLISHABLE_KEY and CLERK_SECRET_KEY in EnvConfigSchema
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add auth to tRPC context</name>
  <files>
    packages/trpc-config/src/context.ts
    packages/trpc-config/package.json
  </files>
  <action>
1. Install @clerk/fastify in trpc-config package (for getAuth and types):
   ```bash
   pnpm add @clerk/fastify @clerk/backend --filter @livermore/trpc-config
   ```

2. Modify packages/trpc-config/src/context.ts:

   a. Add imports at top:
   ```typescript
   import { getAuth } from '@clerk/fastify';
   import type { SignedInAuthObject, SignedOutAuthObject } from '@clerk/backend';
   ```

   b. Add ClerkAuth type:
   ```typescript
   // Clerk auth can be signed in (has userId) or signed out (userId is null)
   type ClerkAuth = SignedInAuthObject | SignedOutAuthObject;
   ```

   c. Update BaseContext interface to include auth:
   ```typescript
   export interface BaseContext {
     /** Logger instance for this request */
     logger: Logger;
     /** Request ID for tracing */
     requestId: string;
     /** Clerk auth object (may be signed in or signed out) */
     auth: ClerkAuth;
   }
   ```

   d. Add AuthenticatedContext type (for use with protectedProcedure):
   ```typescript
   /**
    * Context after isAuthed middleware - userId guaranteed to be string
    */
   export interface AuthenticatedContext extends Omit<BaseContext, 'auth'> {
     auth: SignedInAuthObject & { userId: string };
   }
   ```

   e. Update createContext function to get auth:
   ```typescript
   export function createContext({ req }: CreateFastifyContextOptions): BaseContext {
     const requestId = (req.headers['x-request-id'] as string) || generateRequestId();
     const logger = createLogger('trpc').child({ requestId });
     const auth = getAuth(req);

     return {
       logger,
       requestId,
       auth,
     };
   }
   ```
  </action>
  <verify>
1. TypeScript compiles: `pnpm build --filter @livermore/trpc-config`
2. Check exports: grep for "AuthenticatedContext" in context.ts
3. Check auth in createContext: grep for "getAuth(req)" in context.ts
  </verify>
  <done>
- BaseContext includes `auth: ClerkAuth`
- AuthenticatedContext exported with narrowed userId type
- createContext calls getAuth(req)
- No TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create protectedProcedure middleware</name>
  <files>
    packages/trpc-config/src/trpc.ts
    packages/trpc-config/src/index.ts
  </files>
  <action>
1. Modify packages/trpc-config/src/trpc.ts:

   a. Add TRPCError import:
   ```typescript
   import { initTRPC, TRPCError } from '@trpc/server';
   ```

   b. Import AuthenticatedContext:
   ```typescript
   import type { Context, AuthenticatedContext } from './context';
   ```

   c. Add isAuthed middleware after the `t` initialization:
   ```typescript
   /**
    * Auth middleware - checks if user is authenticated
    * Narrows ctx.auth.userId from string | null to string
    */
   const isAuthed = t.middleware(async function isAuthed(opts) {
     const { ctx } = opts;

     if (!ctx.auth.userId) {
       throw new TRPCError({
         code: 'UNAUTHORIZED',
         message: 'You must be signed in to access this resource',
       });
     }

     // Return narrowed context with guaranteed userId
     return opts.next({
       ctx: {
         ...ctx,
         auth: {
           ...ctx.auth,
           userId: ctx.auth.userId,
         },
       } as AuthenticatedContext,
     });
   });
   ```

   d. Export protectedProcedure after publicProcedure:
   ```typescript
   export const protectedProcedure = t.procedure.use(isAuthed);
   ```

2. Verify index.ts already re-exports everything from trpc.ts (it does via `export * from './trpc'`).
  </action>
  <verify>
1. TypeScript compiles: `pnpm build --filter @livermore/trpc-config`
2. Check export: `grep -n "protectedProcedure" packages/trpc-config/src/trpc.ts`
3. Full monorepo build: `pnpm build`
  </verify>
  <done>
- isAuthed middleware throws UNAUTHORIZED when ctx.auth.userId is null
- protectedProcedure exported from trpc.ts
- TypeScript correctly narrows userId to string in protected procedures
- Monorepo builds without errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   pnpm build
   ```
   All packages compile without errors.

2. **Server starts (requires Clerk env vars):**
   If CLERK_SECRET_KEY and CLERK_PUBLISHABLE_KEY are set:
   ```bash
   pnpm dev --filter @livermore/api
   ```
   Server should start and log "Clerk authentication plugin registered".

3. **Manual API test (after env vars configured):**
   ```bash
   # Health check (public, no auth needed)
   curl http://localhost:3000/health

   # tRPC public procedure (should work without auth)
   curl http://localhost:3000/trpc/indicator.getMetadata

   # tRPC protected procedure without token (should return 401)
   # Note: No protected procedures exist yet - this verifies the middleware is ready
   ```

4. **Type verification:**
   In any router file, protectedProcedure should provide:
   - ctx.auth.userId as string (not string | null)
   - ctx.logger, ctx.requestId as before
</verification>

<success_criteria>
1. `pnpm build` succeeds with no TypeScript errors
2. Server starts without Clerk initialization errors (when env vars are set)
3. `protectedProcedure` is exported from `@livermore/trpc-config`
4. `AuthenticatedContext` type is exported for router type hints
5. Import order in server.ts: dotenv/config is first line
</success_criteria>

<output>
After completion, create `.planning/phases/13-clerk-authentication/13-01-SUMMARY.md`
</output>

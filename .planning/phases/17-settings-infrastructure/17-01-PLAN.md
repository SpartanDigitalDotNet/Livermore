---
phase: 17-settings-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/schema.sql
  - packages/database/src/schema/users.ts
  - packages/schemas/src/settings/user-settings.schema.ts
  - packages/schemas/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Users table has settings JSONB column with default value"
    - "UserSettings Zod schema validates settings structure"
    - "TypeScript types are exported from @livermore/schemas"
  artifacts:
    - path: "packages/database/schema.sql"
      provides: "settings column DDL"
      contains: "ALTER TABLE.*users.*ADD COLUMN.*settings.*jsonb"
    - path: "packages/database/src/schema/users.ts"
      provides: "Drizzle schema with typed JSONB"
      contains: "settings.*jsonb"
    - path: "packages/schemas/src/settings/user-settings.schema.ts"
      provides: "Zod schema + TypeScript types"
      exports: ["UserSettingsSchema", "UserSettings"]
  key_links:
    - from: "packages/database/src/schema/users.ts"
      to: "@livermore/schemas"
      via: "type import"
      pattern: "import.*UserSettings.*@livermore/schemas"
---

<objective>
Add settings JSONB column to users table and create UserSettings Zod schema.

Purpose: Establishes the data layer for user settings - both database storage (JSONB column with version field) and type-safe validation (Zod schema matching existing file structure from research).

Output: Database column definition and TypeScript/Zod types for settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-settings-infrastructure/17-RESEARCH.md

# Existing patterns
@packages/database/schema.sql
@packages/database/src/schema/users.ts
@packages/schemas/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add settings JSONB column to users table</name>
  <files>
    packages/database/schema.sql
    packages/database/src/schema/users.ts
  </files>
  <action>
1. Add settings column to schema.sql (Atlas source of truth):
   - Add after existing columns in users table definition
   - Type: `jsonb DEFAULT '{"version":1}'::jsonb`
   - Column name: `settings`

2. Update Drizzle schema in users.ts:
   - Import type `UserSettings` from `@livermore/schemas` (will exist after Task 2)
   - Add settings column: `settings: jsonb('settings').$type<UserSettings>().default({ version: 1 })`
   - Note: The import will reference a file created in Task 2 - this is intentional as both tasks execute within same plan context

CRITICAL:
- Atlas migrations are BANNED - only update schema.sql
- Keep existing columns/constraints unchanged
- The default `{"version":1}` enables future schema evolution per research
  </action>
  <verify>
    - `grep -q "settings.*jsonb" packages/database/schema.sql` returns 0
    - `grep -q "settings.*jsonb" packages/database/src/schema/users.ts` returns 0
    - TypeScript compiles: `pnpm --filter @livermore/database build`
  </verify>
  <done>
    - schema.sql has settings JSONB column with default `{"version":1}`
    - users.ts Drizzle schema has typed settings column
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UserSettings Zod schema</name>
  <files>
    packages/schemas/src/settings/user-settings.schema.ts
    packages/schemas/src/index.ts
  </files>
  <action>
1. Create new directory and file: `packages/schemas/src/settings/user-settings.schema.ts`

2. Define schemas based on research (17-RESEARCH.md Pattern 3 and Code Examples):
   - `ExchangeConfigSchema`: enabled, ApiKeyEnvironmentVariableName, SecretEnvironmentVariableName, PasswordEnvironmentVariableName (optional)
   - `PerseusProfileSchema`: public_name, description, primary_exchange, trading_mode (paper/live enum), currency, timezone, locale
   - `LivermoreRuntimeSchema`: auto_start, logging object (data_directory, log_directory, verbosity_level)
   - `UserSettingsSchema`: version (number, default 1), sub (optional string), perseus_profile, livermore_runtime, exchanges (record), symbols (array), scanner_symbols_last_update, scanner_exchange

3. Export types:
   - `UserSettings = z.infer<typeof UserSettingsSchema>`
   - `UserSettingsPatch = z.infer<typeof UserSettingsPatchSchema>` for PATCH endpoint

4. Add `UserSettingsPatchSchema`:
   - path: `z.array(z.string()).min(1)` - JSON path array
   - value: `z.unknown()` - value to set at path

5. Update packages/schemas/src/index.ts:
   - Add export: `export * from './settings/user-settings.schema';`

Use existing schema patterns from the codebase (see candle.schema.ts, position.schema.ts for conventions).
  </action>
  <verify>
    - File exists: `test -f packages/schemas/src/settings/user-settings.schema.ts`
    - TypeScript compiles: `pnpm --filter @livermore/schemas build`
    - Exports work: `grep -q "UserSettingsSchema" packages/schemas/src/index.ts`
  </verify>
  <done>
    - UserSettingsSchema and UserSettings type exported from @livermore/schemas
    - UserSettingsPatchSchema for partial updates exported
    - Version field included with default 1
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

```bash
# 1. TypeScript compilation
pnpm build

# 2. Schema contains settings column
grep "settings.*jsonb" packages/database/schema.sql

# 3. Drizzle schema has typed column
grep "settings" packages/database/src/schema/users.ts

# 4. Zod schema exports
grep "UserSettingsSchema" packages/schemas/src/index.ts
```
</verification>

<success_criteria>
- [ ] schema.sql has `settings jsonb DEFAULT '{"version":1}'::jsonb` column on users table
- [ ] users.ts has `settings: jsonb('settings').$type<UserSettings>()` with default
- [ ] UserSettingsSchema validates version, exchanges, symbols, runtime config
- [ ] UserSettingsPatchSchema validates path + value for PATCH operations
- [ ] All packages compile without TypeScript errors
- [ ] Requirements SET-01 and SET-02 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/17-settings-infrastructure/17-01-SUMMARY.md`
</output>

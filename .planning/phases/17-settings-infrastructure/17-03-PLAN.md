---
phase: 17-settings-infrastructure
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - apps/api/src/routers/settings.router.ts
autonomous: true

must_haves:
  truths:
    - "User can export their settings as downloadable JSON"
    - "User can import settings from JSON with validation"
    - "Invalid JSON import is rejected with clear error message"
  artifacts:
    - path: "apps/api/src/routers/settings.router.ts"
      provides: "Export and import endpoints"
      contains: "export:"
  key_links:
    - from: "apps/api/src/routers/settings.router.ts"
      to: "UserSettingsSchema"
      via: "import validation"
      pattern: "safeParse|parse"
---

<objective>
Add settings export and import endpoints to the settings router.

Purpose: Enables users to backup their settings to a JSON file and restore from a previously exported file. Export includes metadata (timestamp), import validates against UserSettingsSchema before saving.

Output: Two additional endpoints on settings router - export (query) and import (mutation).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-settings-infrastructure/17-RESEARCH.md
@.planning/phases/17-settings-infrastructure/17-01-SUMMARY.md
@.planning/phases/17-settings-infrastructure/17-02-SUMMARY.md

# Existing router
@apps/api/src/routers/settings.router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export endpoint</name>
  <files>apps/api/src/routers/settings.router.ts</files>
  <action>
Add `settings.export` query (SET-06):

1. Use protectedProcedure (no input needed)

2. Implementation:
   - Get clerkId from ctx.auth.userId
   - Query user settings by Clerk identity
   - If user not found, throw NOT_FOUND
   - Return object with metadata:
   ```typescript
   return {
     exportedAt: new Date().toISOString(),
     exportVersion: '1.0',
     settings: user.settings ?? { version: 1 },
   };
   ```

3. Note per research Open Question 1:
   - tRPC returns JSON automatically
   - Client (Admin UI) will handle file download via Blob/URL.createObjectURL
   - No special headers needed at API level - this is a data endpoint, not a file download endpoint

The export format includes metadata so imports can be validated and users know when export was created.
  </action>
  <verify>
    - `grep -q "export:.*protectedProcedure" apps/api/src/routers/settings.router.ts`
    - `grep -q "exportedAt" apps/api/src/routers/settings.router.ts`
  </verify>
  <done>
    - settings.export returns settings with exportedAt timestamp
    - Returns default settings if user has none
    - Authenticated via protectedProcedure
  </done>
</task>

<task type="auto">
  <name>Task 2: Add import endpoint with validation</name>
  <files>apps/api/src/routers/settings.router.ts</files>
  <action>
Add `settings.import` mutation (SET-07):

1. Define input schema that accepts the export format:
   ```typescript
   .input(z.object({
     settings: UserSettingsSchema,
     // Optional: allow passing exportedAt/exportVersion but ignore them
   }))
   ```

2. Implementation:
   - Get clerkId from ctx.auth.userId
   - Zod validation happens automatically via .input()
   - If validation fails, tRPC returns 400 with validation errors
   - Lookup user by Clerk identity
   - If user not found, throw NOT_FOUND
   - Replace settings with input.settings (same as update, but for import context)
   - Set updatedAt
   - Return updated settings

3. Per research Pitfall 5:
   - Zod validates schema structure (type errors)
   - JSON.parse errors are handled by tRPC/Fastify body parser
   - Return clear validation errors via Zod's error format

4. Error handling:
   - Invalid JSON structure -> Zod validation error (automatic)
   - User not found -> TRPCError NOT_FOUND
   - Database error -> Let it bubble up (500)
  </action>
  <verify>
    - `grep -q "import:.*protectedProcedure" apps/api/src/routers/settings.router.ts`
    - TypeScript compiles: `pnpm --filter api build`
  </verify>
  <done>
    - settings.import validates input against UserSettingsSchema
    - Invalid imports rejected with Zod validation errors
    - Valid imports replace entire settings document
    - Works with export format (extracts settings field)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# 1. TypeScript compilation
pnpm --filter api build

# 2. All 5 endpoints exist
grep -E "(get:|update:|patch:|export:|import:)" apps/api/src/routers/settings.router.ts | wc -l
# Should return 5

# 3. Export returns metadata
grep "exportedAt" apps/api/src/routers/settings.router.ts

# 4. Import validates with UserSettingsSchema
grep -E "import.*UserSettingsSchema|settings:.*UserSettingsSchema" apps/api/src/routers/settings.router.ts
```
</verification>

<success_criteria>
- [ ] settings.export returns settings with exportedAt timestamp and exportVersion
- [ ] settings.import accepts settings object and validates with UserSettingsSchema
- [ ] Invalid import data rejected with clear Zod validation errors
- [ ] Both endpoints use protectedProcedure
- [ ] Import replaces entire settings (like update, but semantically for import)
- [ ] TypeScript compiles without errors
- [ ] Requirements SET-06 and SET-07 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/17-settings-infrastructure/17-03-SUMMARY.md`
</output>

---
phase: 07-startup-backfill
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - packages/coinbase-client/src/index.ts
  - apps/api/src/server.ts
autonomous: true

must_haves:
  truths:
    - "Server startup runs backfill BEFORE starting indicator service"
    - "All symbols have 60+ candles in cache before indicators start"
    - "No 429 errors during startup backfill"
    - "Backfill completes within 5 minutes for 25 symbols"
    - "Progress is visible in logs during startup"
  artifacts:
    - path: "packages/coinbase-client/src/index.ts"
      provides: "StartupBackfillService export from package"
      exports: ["StartupBackfillService"]
    - path: "apps/api/src/server.ts"
      provides: "Startup orchestration with backfill step"
      contains: "StartupBackfillService"
  key_links:
    - from: "apps/api/src/server.ts"
      to: "StartupBackfillService.backfill()"
      via: "await backfillService.backfill(symbols, timeframes)"
      pattern: "backfillService\\.backfill"
    - from: "apps/api/src/server.ts"
      to: "IndicatorCalculationService.start()"
      via: "Sequential: backfill completes BEFORE indicators start"
      pattern: "await backfillService\\.backfill.*await indicatorService\\.start"
---

<objective>
Integrate StartupBackfillService into server.ts to populate cache before indicator service starts.

Purpose: Ensures indicator service has 60+ candles per symbol/timeframe in cache when it begins processing candle:close events. Without this, all symbols would be skipped due to insufficient data.

Output: Modified server.ts with correct startup ordering: backfill -> indicators -> WebSocket adapter.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-startup-backfill/07-RESEARCH.md
@.planning/phases/07-startup-backfill/07-01-SUMMARY.md

# Key existing files
@apps/api/src/server.ts
@packages/coinbase-client/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Export StartupBackfillService from coinbase-client package</name>
  <files>packages/coinbase-client/src/index.ts</files>
  <action>
Read the existing `packages/coinbase-client/src/index.ts` file and ADD the backfill module exports.

Add this export line (keep existing exports):

```typescript
export { StartupBackfillService, BackfillConfig, DEFAULT_BACKFILL_CONFIG, TIMEFRAME_PRIORITY } from './backfill';
```

This makes the backfill service importable from `@livermore/coinbase-client`.

Do NOT remove any existing exports. The file should end up with all existing exports plus the new backfill exports.
  </action>
  <verify>
Run: `npx tsc --noEmit -p packages/coinbase-client/tsconfig.json`
Check: TypeScript compiles. Can import StartupBackfillService from @livermore/coinbase-client.
  </verify>
  <done>StartupBackfillService is exported from @livermore/coinbase-client package.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate backfill into server.ts startup sequence</name>
  <files>apps/api/src/server.ts</files>
  <action>
Modify `apps/api/src/server.ts` to add backfill step BEFORE indicator service starts.

1. **Add import:**
   Add `StartupBackfillService` to the import from `@livermore/coinbase-client`:
   ```typescript
   import { CoinbaseRestClient, StartupBackfillService } from '@livermore/coinbase-client';
   ```

2. **Add import for getRedisClient if not already imported from correct location:**
   The redis variable is already available from `getRedisClient()` call.

3. **Add backfill step in start() function, AFTER redis initialization and BEFORE indicator service:**

   Find this section (around line 218-238):
   ```typescript
   // Start Coinbase WebSocket data ingestion
   const coinbaseWsService = new CoinbaseWebSocketService(...);
   await coinbaseWsService.start(monitoredSymbols);

   // Start Indicator Calculation Service
   const indicatorService = new IndicatorCalculationService(...);
   ```

   Insert BEFORE the WebSocket service start:
   ```typescript
   // Step 1: Backfill cache with historical candles (MUST complete before indicators)
   // This ensures indicator service has 60+ candles per symbol/timeframe
   logger.info('Starting cache backfill...');
   const backfillTimeframes: Timeframe[] = ['5m', '15m', '1h', '4h', '1d'];
   const backfillService = new StartupBackfillService(
     config.Coinbase_ApiKeyId,
     config.Coinbase_EcPrivateKeyPem,
     redis
   );
   await backfillService.backfill(monitoredSymbols, backfillTimeframes);
   logger.info('Cache backfill complete');
   ```

4. **Update WebSocket service comment:**
   Change "Start Coinbase WebSocket data ingestion" to:
   ```typescript
   // Step 2: Start Coinbase WebSocket data ingestion
   ```

5. **Update Indicator service comment:**
   Change "Start Indicator Calculation Service" to:
   ```typescript
   // Step 3: Start Indicator Calculation Service
   ```

**CRITICAL ordering (from RESEARCH.md Pitfall 3):**
1. Backfill (populates cache)
2. Indicators (reads from cache, now has data)
3. WebSocket (starts receiving live candles)

This prevents the race condition where indicators start before cache is populated.

**Note on SUPPORTED_TIMEFRAMES:**
The existing `SUPPORTED_TIMEFRAMES` array includes '1m'. For backfill, we use a separate array with only ['5m', '15m', '1h', '4h', '1d'] as specified in RESEARCH.md. The indicator service still handles 1m via WebSocket, but we don't backfill 1m since the WebSocket provides it live.
  </action>
  <verify>
Run: `npx tsc --noEmit -p apps/api/tsconfig.json`
Check: TypeScript compiles. The start() function shows backfill -> indicators -> WebSocket ordering.

Verify ordering:
```bash
grep -n "backfillService.backfill\|indicatorService.start\|coinbaseWsService.start" apps/api/src/server.ts
```
Expected: backfill line number < indicator line number < websocket line number
  </verify>
  <done>server.ts runs backfill before indicator service, ensuring cache is populated with 60+ candles per symbol/timeframe.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles (both packages):
   ```bash
   npx tsc --noEmit -p packages/coinbase-client/tsconfig.json
   npx tsc --noEmit -p apps/api/tsconfig.json
   ```

2. StartupBackfillService is exported:
   ```bash
   grep "StartupBackfillService" packages/coinbase-client/src/index.ts
   # Should show export line
   ```

3. Startup ordering is correct:
   ```bash
   grep -n "backfillService\|indicatorService\|coinbaseWsService" apps/api/src/server.ts | head -10
   # Backfill should appear before indicator, indicator before websocket
   ```

4. Import is correct:
   ```bash
   grep "StartupBackfillService" apps/api/src/server.ts
   # Should show import from @livermore/coinbase-client
   ```
</verification>

<success_criteria>
- [ ] StartupBackfillService exported from @livermore/coinbase-client
- [ ] server.ts imports StartupBackfillService
- [ ] server.ts creates StartupBackfillService instance with correct parameters
- [ ] server.ts calls backfillService.backfill() BEFORE indicatorService.start()
- [ ] server.ts calls indicatorService.start() BEFORE coinbaseWsService.start()
- [ ] TypeScript compiles without errors for both packages
- [ ] Backfill uses timeframes: ['5m', '15m', '1h', '4h', '1d']
</success_criteria>

<output>
After completion, create `.planning/phases/07-startup-backfill/07-02-SUMMARY.md`
</output>

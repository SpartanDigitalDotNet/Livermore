---
phase: 07-startup-backfill
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/coinbase-client/src/backfill/types.ts
  - packages/coinbase-client/src/backfill/startup-backfill-service.ts
  - packages/coinbase-client/src/backfill/index.ts
autonomous: true

must_haves:
  truths:
    - "StartupBackfillService can fetch historical candles for multiple symbols and timeframes"
    - "Backfill uses rate limiting to avoid 429 errors (5 req/batch, 1s delay)"
    - "Timeframes are processed in priority order (short first: 5m, 15m, 1h, 4h, 1d)"
    - "Progress is logged during backfill operation"
  artifacts:
    - path: "packages/coinbase-client/src/backfill/types.ts"
      provides: "BackfillConfig interface, DEFAULT_BACKFILL_CONFIG, TIMEFRAME_PRIORITY"
      exports: ["BackfillConfig", "DEFAULT_BACKFILL_CONFIG", "TIMEFRAME_PRIORITY"]
    - path: "packages/coinbase-client/src/backfill/startup-backfill-service.ts"
      provides: "StartupBackfillService class with backfill() method"
      exports: ["StartupBackfillService"]
    - path: "packages/coinbase-client/src/backfill/index.ts"
      provides: "Re-exports for backfill module"
  key_links:
    - from: "startup-backfill-service.ts"
      to: "CoinbaseRestClient.getCandles()"
      via: "this.restClient.getCandles(symbol, timeframe)"
      pattern: "restClient\\.getCandles"
    - from: "startup-backfill-service.ts"
      to: "CandleCacheStrategy.addCandles()"
      via: "this.candleCache.addCandles(userId, exchangeId, candles)"
      pattern: "candleCache\\.addCandles"
---

<objective>
Create a StartupBackfillService that fetches historical candles from Coinbase REST API and populates Redis cache.

Purpose: The indicator service (Phase 06) reads exclusively from cache and requires 60+ candles to calculate MACD-V. This service provides the initial data population before indicators can operate.

Output: New backfill module in `@livermore/coinbase-client` with rate-limited, priority-ordered backfill capability.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-startup-backfill/07-RESEARCH.md

# Key existing files
@packages/coinbase-client/src/rest/client.ts
@packages/cache/src/strategies/candle-cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backfill types and configuration</name>
  <files>packages/coinbase-client/src/backfill/types.ts</files>
  <action>
Create `packages/coinbase-client/src/backfill/types.ts` with:

1. **BackfillConfig interface:**
   ```typescript
   export interface BackfillConfig {
     /** Number of candles to fetch per symbol/timeframe (default: 100) */
     candleCount: number;
     /** Requests per batch (default: 5) */
     batchSize: number;
     /** Delay between batches in ms (default: 1000) */
     batchDelayMs: number;
     /** User ID for cache keys */
     userId: number;
     /** Exchange ID for cache keys */
     exchangeId: number;
   }
   ```

2. **DEFAULT_BACKFILL_CONFIG constant:**
   - candleCount: 100 (request 100 to ensure 60+ available after filtering)
   - batchSize: 5 (conservative - 5 req/sec well under 30 limit)
   - batchDelayMs: 1000 (1 second between batches)
   - userId: 1 (hardcoded test user)
   - exchangeId: 1 (hardcoded exchange)

3. **TIMEFRAME_PRIORITY array** (BKFL-03):
   ```typescript
   import type { Timeframe } from '@livermore/schemas';

   // 5m first since WebSocket provides it, fills fastest for indicator startup
   export const TIMEFRAME_PRIORITY: Timeframe[] = ['5m', '15m', '1h', '4h', '1d'];
   ```

NOTE: Do NOT include '1m' in priority - existing server.ts SUPPORTED_TIMEFRAMES includes 1m but the research specifies 5m as the base WebSocket timeframe. Follow RESEARCH.md which says "5m, 15m, 1h, 4h, 1d".
  </action>
  <verify>
Run: `npx tsc --noEmit -p packages/coinbase-client/tsconfig.json`
Check: No TypeScript errors. File exports BackfillConfig, DEFAULT_BACKFILL_CONFIG, TIMEFRAME_PRIORITY.
  </verify>
  <done>types.ts exists with BackfillConfig interface, DEFAULT_BACKFILL_CONFIG, and TIMEFRAME_PRIORITY array.</done>
</task>

<task type="auto">
  <name>Task 2: Implement StartupBackfillService class</name>
  <files>packages/coinbase-client/src/backfill/startup-backfill-service.ts</files>
  <action>
Create `packages/coinbase-client/src/backfill/startup-backfill-service.ts`:

1. **Imports:**
   ```typescript
   import type { Redis } from 'ioredis';
   import type { Timeframe } from '@livermore/schemas';
   import { CandleCacheStrategy } from '@livermore/cache';
   import { logger } from '@livermore/utils';
   import { CoinbaseRestClient } from '../rest/client';
   import { BackfillConfig, DEFAULT_BACKFILL_CONFIG, TIMEFRAME_PRIORITY } from './types';
   ```

2. **Constructor:**
   - Parameters: `apiKeyId: string, privateKeyPem: string, redis: Redis, config?: Partial<BackfillConfig>`
   - Create CoinbaseRestClient internally
   - Create CandleCacheStrategy with provided Redis
   - Merge config with DEFAULT_BACKFILL_CONFIG

3. **Public method `backfill(symbols: string[], timeframes: Timeframe[]): Promise<void>`:**

   a) Sort timeframes by TIMEFRAME_PRIORITY order (BKFL-03)

   b) Build task list: all symbol/timeframe combinations in priority order
      - Outer loop: timeframes (in priority order)
      - Inner loop: symbols

   c) Log backfill start with event: 'backfill_start', symbols count, timeframes, total tasks

   d) Process tasks in batches:
      - For each batch (slice by batchSize):
        - Execute batch with Promise.allSettled(batch.map(task => backfillSymbolTimeframe))
        - Count fulfilled/rejected results
        - Call logProgress() (BKFL-04)
        - Sleep batchDelayMs before next batch (skip on last batch)

   e) Log backfill complete with event: 'backfill_complete', completed, errors, elapsed time

4. **Private method `backfillSymbolTimeframe(symbol: string, timeframe: Timeframe): Promise<number>`:**
   - Call `this.restClient.getCandles(symbol, timeframe)` (no start/end = most recent)
   - Slice result to `this.config.candleCount` most recent candles
   - Call `this.candleCache.addCandles(userId, exchangeId, candles)`
   - Log debug: event 'backfill_symbol_complete', symbol, timeframe, candle count
   - Return number of candles cached

5. **Private method `logProgress(completed, total, startTime, errors): void`:**
   - Calculate percent, elapsed time, rate, ETA
   - Log info: event 'backfill_progress', completed, total, percent, elapsed, ETA, errors (BKFL-04)

6. **Private method `sleep(ms: number): Promise<void>`:**
   - Simple setTimeout wrapper

**Error handling:**
- Individual task failures logged but don't stop batch
- Use Promise.allSettled, not Promise.all
- Failed tasks counted in errors, logged with warning
  </action>
  <verify>
Run: `npx tsc --noEmit -p packages/coinbase-client/tsconfig.json`
Check: No TypeScript errors. Class has backfill() public method.
  </verify>
  <done>StartupBackfillService class exists with backfill() method that fetches candles with rate limiting, priority ordering, and progress logging.</done>
</task>

<task type="auto">
  <name>Task 3: Create backfill module index and export from package</name>
  <files>packages/coinbase-client/src/backfill/index.ts</files>
  <action>
Create `packages/coinbase-client/src/backfill/index.ts`:

```typescript
export { StartupBackfillService } from './startup-backfill-service';
export { BackfillConfig, DEFAULT_BACKFILL_CONFIG, TIMEFRAME_PRIORITY } from './types';
```

This re-exports all public API from the backfill module.

NOTE: Do NOT modify packages/coinbase-client/src/index.ts yet - that will be done in Plan 02 along with server.ts integration.
  </action>
  <verify>
Run: `npx tsc --noEmit -p packages/coinbase-client/tsconfig.json`
Check: TypeScript compiles. Can import from 'backfill/index'.
  </verify>
  <done>Backfill module has index.ts with all exports.</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compiles:
   ```bash
   npx tsc --noEmit -p packages/coinbase-client/tsconfig.json
   ```

2. Files exist:
   ```bash
   ls packages/coinbase-client/src/backfill/
   # Should show: types.ts, startup-backfill-service.ts, index.ts
   ```

3. Exports are correct:
   ```bash
   grep -E "export (class|interface|const)" packages/coinbase-client/src/backfill/*.ts
   # Should show: BackfillConfig, DEFAULT_BACKFILL_CONFIG, TIMEFRAME_PRIORITY, StartupBackfillService
   ```
</verification>

<success_criteria>
- [ ] packages/coinbase-client/src/backfill/types.ts exists with BackfillConfig, DEFAULT_BACKFILL_CONFIG, TIMEFRAME_PRIORITY
- [ ] packages/coinbase-client/src/backfill/startup-backfill-service.ts exists with StartupBackfillService class
- [ ] packages/coinbase-client/src/backfill/index.ts exists with re-exports
- [ ] TypeScript compiles without errors
- [ ] StartupBackfillService uses CoinbaseRestClient.getCandles() for data fetching
- [ ] StartupBackfillService uses CandleCacheStrategy.addCandles() for cache writes
- [ ] Rate limiting implemented (5 req/batch, 1s delay)
- [ ] Priority ordering implemented (5m first)
- [ ] Progress logging implemented
</success_criteria>

<output>
After completion, create `.planning/phases/07-startup-backfill/07-01-SUMMARY.md`
</output>

---
phase: 23-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/schema.sql
  - packages/database/drizzle/schema.ts
autonomous: true

must_haves:
  truths:
    - "exchanges table exists in PostgreSQL with all metadata columns"
    - "Coinbase and Binance seed data present in exchanges table"
    - "user_exchanges has nullable exchange_id FK column"
    - "TypeScript types reflect new schema"
  artifacts:
    - path: "packages/database/schema.sql"
      provides: "CREATE TABLE exchanges + INSERT seed + ALTER user_exchanges"
      contains: "CREATE TABLE \"exchanges\""
    - path: "packages/database/drizzle/schema.ts"
      provides: "Generated Drizzle types for exchanges table"
      contains: "export const exchanges = pgTable"
  key_links:
    - from: "user_exchanges.exchange_id"
      to: "exchanges.id"
      via: "FK constraint"
      pattern: "user_exchanges_exchange_id_exchanges_id_fk"
---

<objective>
Create the `exchanges` metadata table and add FK reference from `user_exchanges`.

Purpose: Establish normalized exchange metadata storage enabling multi-exchange architecture. Currently exchange identity is stored as a string column, preventing centralized metadata like WebSocket URLs, supported timeframes, and API limits.

Output:
- `exchanges` table with comprehensive metadata columns (JSONB for flexible fields)
- Coinbase and Binance seed data with verified WebSocket URLs and timeframes
- `user_exchanges.exchange_id` nullable FK column referencing `exchanges.id`
- Regenerated Drizzle TypeScript types
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-schema-foundation/23-RESEARCH.md

# Source files
@packages/database/schema.sql
@packages/database/drizzle/schema.ts
@scripts/sync-schema.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exchanges table and seed data to schema.sql</name>
  <files>packages/database/schema.sql</files>
  <action>
Add the `exchanges` table definition AFTER the `users` table and BEFORE `user_exchanges` in schema.sql:

```sql
-- Create "exchanges" table (Phase 23)
-- Exchange metadata for multi-exchange architecture
CREATE TABLE "exchanges" (
  "id" serial NOT NULL,
  "name" character varying(50) NOT NULL,
  "display_name" character varying(100) NOT NULL,
  "ws_url" character varying(255) NULL,
  "rest_url" character varying(255) NULL,
  "supported_timeframes" jsonb NOT NULL DEFAULT '[]'::jsonb,
  "api_limits" jsonb NULL,
  "fee_schedule" jsonb NULL,
  "geo_restrictions" jsonb NULL,
  "is_active" boolean NOT NULL DEFAULT true,
  "created_at" timestamp NOT NULL DEFAULT now(),
  "updated_at" timestamp NOT NULL DEFAULT now(),
  PRIMARY KEY ("id"),
  CONSTRAINT "exchanges_name_unique" UNIQUE ("name")
);

-- Seed data for Coinbase and Binance
INSERT INTO "exchanges" ("name", "display_name", "ws_url", "rest_url", "supported_timeframes", "api_limits", "fee_schedule") VALUES
  ('coinbase', 'Coinbase Advanced Trade',
   'wss://advanced-trade-ws.coinbase.com',
   'https://api.coinbase.com',
   '["1m", "5m", "15m", "30m", "1h", "2h", "4h", "6h", "1d"]'::jsonb,
   '{"ws_connections_per_ip": 750, "ws_messages_per_second": 8, "rest_weight_limit": 10000}'::jsonb,
   '{"base_maker": 0.006, "base_taker": 0.012}'::jsonb
  ),
  ('binance', 'Binance Spot',
   'wss://stream.binance.com:9443',
   'https://api.binance.com',
   '["1m", "3m", "5m", "15m", "30m", "1h", "2h", "4h", "6h", "8h", "12h", "1d", "3d", "1w", "1M"]'::jsonb,
   '{"ws_connections_per_5min": 300, "rest_weight_limit": 6000, "orders_per_10s": 50}'::jsonb,
   '{"base_maker": 0.001, "base_taker": 0.001}'::jsonb
  );
```

IMPORTANT:
- Place exchanges CREATE TABLE BEFORE user_exchanges (FK dependency order)
- Place seed INSERT AFTER the CREATE TABLE
- Use JSONB for timeframes, api_limits, fee_schedule (not TEXT)
- geo_restrictions left NULL in seed data (store data now, enforce later)
  </action>
  <verify>Review schema.sql to confirm:
- exchanges table definition is complete with all columns
- INSERT statements have correct Coinbase and Binance data
- Table placement is before user_exchanges</verify>
  <done>exchanges table and seed data added to schema.sql with correct column types and data</done>
</task>

<task type="auto">
  <name>Task 2: Add exchange_id FK to user_exchanges</name>
  <files>packages/database/schema.sql</files>
  <action>
Modify the existing `user_exchanges` CREATE TABLE statement to add:

1. New column `exchange_id` (nullable integer):
```sql
"exchange_id" integer NULL,
```

2. New FK constraint (after existing user_id FK):
```sql
CONSTRAINT "user_exchanges_exchange_id_exchanges_id_fk" FOREIGN KEY ("exchange_id")
  REFERENCES "exchanges" ("id") ON UPDATE NO ACTION ON DELETE SET NULL
```

3. New index for exchange_id lookups (add after existing indexes):
```sql
CREATE INDEX "user_exchanges_exchange_id_idx" ON "user_exchanges" ("exchange_id");
```

The resulting user_exchanges table should look like:
```sql
CREATE TABLE "user_exchanges" (
  "id" serial NOT NULL,
  "user_id" serial NOT NULL,
  "exchange_name" character varying(50) NOT NULL,
  "exchange_id" integer NULL,  -- NEW: nullable during migration
  "display_name" character varying(100) NULL,
  "api_key" character varying(500) NOT NULL,
  "api_secret" text NOT NULL,
  "additional_credentials" text NULL,
  "is_active" boolean NOT NULL DEFAULT true,
  "is_default" boolean NOT NULL DEFAULT false,
  "last_connected_at" timestamp NULL,
  "created_at" timestamp NOT NULL DEFAULT now(),
  "updated_at" timestamp NOT NULL DEFAULT now(),
  PRIMARY KEY ("id"),
  CONSTRAINT "user_exchanges_user_id_users_id_fk" FOREIGN KEY ("user_id")
    REFERENCES "users" ("id") ON UPDATE NO ACTION ON DELETE CASCADE,
  CONSTRAINT "user_exchanges_exchange_id_exchanges_id_fk" FOREIGN KEY ("exchange_id")
    REFERENCES "exchanges" ("id") ON UPDATE NO ACTION ON DELETE SET NULL
);
```

IMPORTANT:
- Keep exchange_id NULL (not NOT NULL) - existing rows don't have this value
- Use ON DELETE SET NULL (not CASCADE) - don't delete user_exchanges if exchange deleted
- Keep exchange_name column - backward compatibility during migration
- Add index separately after the CREATE TABLE (matches existing pattern)
  </action>
  <verify>Review schema.sql to confirm:
- exchange_id column added after exchange_name
- FK constraint references exchanges(id)
- New index created for exchange_id</verify>
  <done>user_exchanges table has exchange_id nullable FK column with index</done>
</task>

<task type="auto">
  <name>Task 3: Apply schema and regenerate Drizzle types</name>
  <files>packages/database/drizzle/schema.ts</files>
  <action>
Run the sync-schema.ps1 script to:
1. Apply schema changes via Atlas
2. Regenerate Drizzle TypeScript types

Command:
```powershell
powershell -File scripts/sync-schema.ps1
```

Expected Atlas output:
- Schema applied successfully
- No errors about missing tables or constraint violations

After successful run, verify the generated types in `packages/database/drizzle/schema.ts`:
- `exchanges` table export exists with all columns
- `userExchanges` table has `exchangeId` column
- FK relationship and index defined

If Atlas fails with seed data errors (e.g., duplicate key on re-run):
- The INSERT should use ON CONFLICT DO NOTHING, OR
- Wrap inserts in DO $$ BEGIN ... EXCEPTION WHEN unique_violation THEN NULL; END $$;
- Alternatively, move seed data to a separate seed script if Atlas cannot handle idempotent inserts

NOTE: If seed data INSERT fails on re-run (duplicate key violation), modify the INSERT to be idempotent:
```sql
INSERT INTO "exchanges" ("name", "display_name", ...) VALUES (...)
ON CONFLICT ("name") DO UPDATE SET
  "display_name" = EXCLUDED."display_name",
  "ws_url" = EXCLUDED."ws_url",
  "rest_url" = EXCLUDED."rest_url",
  "supported_timeframes" = EXCLUDED."supported_timeframes",
  "api_limits" = EXCLUDED."api_limits",
  "fee_schedule" = EXCLUDED."fee_schedule",
  "updated_at" = now();
```
  </action>
  <verify>
1. sync-schema.ps1 completes without errors
2. Query local database to verify tables exist:
   ```powershell
   # Use psql or a script to verify
   SELECT * FROM exchanges;
   SELECT column_name FROM information_schema.columns WHERE table_name = 'user_exchanges' AND column_name = 'exchange_id';
   ```
3. Verify packages/database/drizzle/schema.ts contains:
   - `export const exchanges = pgTable("exchanges", {...})`
   - `exchangeId: integer("exchange_id")` in userExchanges
  </verify>
  <done>
- Atlas schema applied successfully (exit code 0)
- Drizzle types regenerated
- exchanges table queryable with 2 seed rows (coinbase, binance)
- user_exchanges has exchange_id column
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Schema verification:**
   ```sql
   -- Should return 2 rows
   SELECT id, name, display_name FROM exchanges;

   -- Should show exchange_id column
   \d user_exchanges
   ```

2. **TypeScript verification:**
   - `packages/database/drizzle/schema.ts` contains exports for `exchanges` and updated `userExchanges`
   - No TypeScript compilation errors

3. **Constraint verification:**
   ```sql
   -- Should return the FK constraint
   SELECT constraint_name FROM information_schema.table_constraints
   WHERE table_name = 'user_exchanges' AND constraint_type = 'FOREIGN KEY';
   ```
</verification>

<success_criteria>
- [ ] `exchanges` table exists with columns: id, name, display_name, ws_url, rest_url, supported_timeframes, api_limits, fee_schedule, geo_restrictions, is_active, created_at, updated_at
- [ ] Coinbase row: name='coinbase', ws_url='wss://advanced-trade-ws.coinbase.com'
- [ ] Binance row: name='binance', ws_url='wss://stream.binance.com:9443'
- [ ] `user_exchanges.exchange_id` column exists (nullable integer)
- [ ] FK constraint `user_exchanges_exchange_id_exchanges_id_fk` exists
- [ ] Index `user_exchanges_exchange_id_idx` exists
- [ ] Drizzle types in schema.ts reflect all new structures
- [ ] No TypeScript errors in packages/database
</success_criteria>

<output>
After completion, create `.planning/phases/23-schema-foundation/23-01-SUMMARY.md` following the summary template.
</output>

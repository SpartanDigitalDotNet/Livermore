---
phase: 12-iam-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/schema.sql
  - packages/database/src/types/role.ts
autonomous: true

must_haves:
  truths:
    - "User record can store OAuth identity (provider, sub, display name, picture URL)"
    - "User role can be queried for authorization decisions"
    - "Last login timestamp can be updated when user authenticates"
    - "Schema deployed to local PostgreSQL"
    - "Schema deployed to Azure Sandbox"
    - "TypeScript can access user.identityProvider, user.role, etc."
  artifacts:
    - path: "packages/database/schema.sql"
      provides: "IAM columns in users table + partial unique index"
      contains: "identity_provider"
    - path: "packages/database/drizzle/schema.ts"
      provides: "Generated Drizzle types with IAM columns"
      contains: "identityProvider"
    - path: "packages/database/src/types/role.ts"
      provides: "TypeScript role type and validation"
      exports: ["USER_ROLES", "UserRole", "isValidRole"]
  key_links:
    - from: "packages/database/schema.sql"
      to: "packages/database/drizzle/schema.ts"
      via: "drizzle-kit pull"
      pattern: "identityProvider.*varchar"
---

<objective>
Extend the users table with OAuth identity columns and role-based access fields for Clerk authentication integration.

Purpose: Enable Phase 13 (Clerk Authentication) and Phase 14 (User Sync Webhooks) by providing database columns to store OAuth identity information and authorization roles.

Output: Updated schema.sql with IAM columns, deployed to both local and sandbox databases, with regenerated Drizzle types and TypeScript role helpers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-iam-schema/12-RESEARCH.md
@packages/database/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IAM columns to users table in schema.sql</name>
  <files>packages/database/schema.sql</files>
  <action>
Edit schema.sql to add 6 new columns to the users table and a partial unique index.

Modify the existing CREATE TABLE "users" statement to add these columns BEFORE created_at/updated_at:

```sql
"identity_provider" character varying(20) NULL,
"identity_sub" character varying(255) NULL,
"display_name" character varying(100) NULL,
"identity_picture_url" text NULL,
"role" character varying(20) NOT NULL DEFAULT 'user',
"last_login_at" timestamp NULL,
```

After the users table definition, add the partial unique index:

```sql
-- Unique partial index for OAuth identity lookup (allows multiple NULL identity_provider values)
CREATE UNIQUE INDEX "users_identity_provider_sub_idx" ON "users" ("identity_provider", "identity_sub")
  WHERE identity_provider IS NOT NULL;
```

IMPORTANT:
- Keep columns in the specified order (identity fields, then role, then last_login_at, then existing timestamps)
- Use NULL (not NOT NULL) for identity columns - existing users won't have OAuth data
- Use NOT NULL DEFAULT 'user' for role - every user needs a role
- The partial index WHERE clause is critical - it allows multiple users without OAuth identity
  </action>
  <verify>
Visually inspect schema.sql:
- users table has identity_provider, identity_sub, display_name, identity_picture_url, role, last_login_at columns
- role column has DEFAULT 'user' NOT NULL
- Partial unique index exists with WHERE identity_provider IS NOT NULL
  </verify>
  <done>schema.sql contains all 6 IAM columns and partial unique index</done>
</task>

<task type="auto">
  <name>Task 2: Deploy schema and regenerate Drizzle types</name>
  <files>packages/database/drizzle/schema.ts</files>
  <action>
Run the sync-schema.ps1 script to:
1. Apply schema changes to local PostgreSQL via Atlas
2. Regenerate Drizzle types via drizzle-kit pull

Command:
```powershell
powershell -File scripts/sync-schema.ps1
```

After completion, verify the generated Drizzle types in packages/database/drizzle/schema.ts include the new columns:
- identityProvider (varchar 20)
- identitySub (varchar 255)
- displayName (varchar 100)
- identityPictureUrl (text)
- role (varchar 20, default 'user', notNull)
- lastLoginAt (timestamp)

Then deploy to Azure Sandbox:
```powershell
powershell -File scripts/apply-schema-sandbox.ps1
```
  </action>
  <verify>
1. sync-schema.ps1 exits with code 0
2. apply-schema-sandbox.ps1 exits with code 0
3. packages/database/drizzle/schema.ts contains identityProvider, identitySub, displayName, identityPictureUrl, role, lastLoginAt
4. role field shows .default('user').notNull()
  </verify>
  <done>Schema deployed to local + sandbox, Drizzle types include all IAM columns</done>
</task>

<task type="auto">
  <name>Task 3: Create TypeScript role type helper</name>
  <files>packages/database/src/types/role.ts</files>
  <action>
Create a new file packages/database/src/types/role.ts with type-safe role definitions:

```typescript
/**
 * User role definitions for authorization
 *
 * Roles (from requirements):
 * - user: Default role for all users
 * - admin: Full administrative access
 * - subscriber_basic: Basic subscription tier
 * - subscriber_pro: Professional subscription tier
 */
export const USER_ROLES = ['user', 'admin', 'subscriber_basic', 'subscriber_pro'] as const;

export type UserRole = typeof USER_ROLES[number];

/**
 * Type guard to validate role strings
 */
export function isValidRole(role: string): role is UserRole {
  return USER_ROLES.includes(role as UserRole);
}

/**
 * Assert role is valid, throw if not
 */
export function assertRole(role: string): asserts role is UserRole {
  if (!isValidRole(role)) {
    throw new Error(`Invalid role: ${role}. Valid roles: ${USER_ROLES.join(', ')}`);
  }
}
```

If packages/database/src/types directory doesn't exist, create it first.

Then export from packages/database/src/index.ts by adding:
```typescript
export * from './types/role';
```
  </action>
  <verify>
1. File exists: packages/database/src/types/role.ts
2. TypeScript compiles: `pnpm --filter @livermore/database exec tsc --noEmit`
3. Exports work: USER_ROLES, UserRole, isValidRole, assertRole are exported from package
  </verify>
  <done>Role type helper created and exported from @livermore/database package</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Schema verification (local):**
   ```powershell
   # Use existing debug script or direct query
   # Should show all 6 new columns in users table
   ```

2. **Drizzle type verification:**
   ```typescript
   // This should compile without errors:
   import { users } from '@livermore/database/drizzle/schema';
   type User = typeof users.$inferSelect;
   // User should have: identityProvider, identitySub, displayName, identityPictureUrl, role, lastLoginAt
   ```

3. **Role type verification:**
   ```typescript
   import { UserRole, isValidRole } from '@livermore/database';
   const role: UserRole = 'admin'; // Should compile
   isValidRole('user'); // Should return true
   isValidRole('invalid'); // Should return false
   ```
</verification>

<success_criteria>
- [ ] IAM-01: identity_provider VARCHAR(20) column exists in users table
- [ ] IAM-02: identity_sub VARCHAR(255) column exists in users table
- [ ] IAM-03: display_name VARCHAR(100) column exists in users table
- [ ] IAM-04: identity_picture_url TEXT column exists in users table
- [ ] IAM-05: role VARCHAR(20) DEFAULT 'user' column exists in users table
- [ ] IAM-06: last_login_at TIMESTAMP column exists in users table
- [ ] Partial unique index users_identity_provider_sub_idx created
- [ ] Schema deployed to local PostgreSQL (sync-schema.ps1 succeeds)
- [ ] Schema deployed to Azure Sandbox (apply-schema-sandbox.ps1 succeeds)
- [ ] Drizzle types regenerated with all IAM columns
- [ ] TypeScript role type helper created and exported
</success_criteria>

<output>
After completion, create `.planning/phases/12-iam-schema/12-01-SUMMARY.md`
</output>

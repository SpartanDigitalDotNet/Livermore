---
phase: 12-iam-schema
plan: 01
subsystem: database
tags: [postgresql, atlas, drizzle, oauth, iam, clerk]

# Dependency graph
requires:
  - phase: 11-database-workflow
    provides: Atlas schema management, sync-schema.ps1, apply-schema-sandbox.ps1
provides:
  - IAM columns in users table (identity_provider, identity_sub, display_name, identity_picture_url, role, last_login_at)
  - Partial unique index for OAuth identity lookup
  - TypeScript UserRole type and validation helpers
  - Schema deployed to local and Azure Sandbox databases
affects: [13-clerk-authentication, 14-user-sync-webhooks]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "OAuth identity storage: nullable identity_provider/identity_sub pair with partial unique index"
    - "Role-based access: role column with 'user' default, TypeScript type guard for validation"

key-files:
  created:
    - packages/database/src/types/role.ts
  modified:
    - packages/database/schema.sql
    - packages/database/drizzle/schema.ts
    - packages/database/src/index.ts
    - packages/database/atlas.hcl
    - scripts/apply-schema-sandbox.ps1

key-decisions:
  - "Partial unique index (WHERE identity_provider IS NOT NULL) allows multiple users without OAuth while preventing duplicate OAuth identities"
  - "Role stored as VARCHAR(20) with default 'user' - matches Clerk metadata pattern"
  - "Created livermore database on Azure Sandbox (was missing)"

patterns-established:
  - "IAM columns pattern: identity_provider + identity_sub for OAuth, role for authorization"
  - "Role validation: use isValidRole() type guard or assertRole() for runtime checks"

# Metrics
duration: 25min
completed: 2026-01-26
---

# Phase 12 Plan 01: IAM Schema Summary

**Extended users table with 6 IAM columns for Clerk OAuth integration, deployed to local + Azure Sandbox with TypeScript role type helpers**

## Performance

- **Duration:** 25 min
- **Started:** 2026-01-26T19:30:00Z
- **Completed:** 2026-01-26T19:55:00Z
- **Tasks:** 3
- **Files modified:** 6

## Accomplishments

- Added 6 IAM columns to users table: identity_provider, identity_sub, display_name, identity_picture_url, role, last_login_at
- Created partial unique index for OAuth identity lookup (allows NULL identity_provider)
- Deployed schema to local PostgreSQL and Azure Sandbox
- Created TypeScript USER_ROLES, UserRole type, isValidRole(), and assertRole() helpers
- Regenerated Drizzle types with all IAM columns

## Task Commits

Each task was committed atomically:

1. **Task 1: Add IAM columns to users table** - `f42949a` (feat)
2. **Task 2: Deploy schema and regenerate Drizzle types** - `950b337` (fix - sandbox deployment fixes)
3. **Task 3: Create TypeScript role type helper** - `b6e556e` (feat)

## Files Created/Modified

- `packages/database/schema.sql` - Added 6 IAM columns and partial unique index
- `packages/database/drizzle/schema.ts` - Regenerated with IAM columns (auto-generated by drizzle-kit)
- `packages/database/src/types/role.ts` - NEW: UserRole type and validation functions
- `packages/database/src/index.ts` - Added export for role types
- `packages/database/atlas.hcl` - Fixed sandbox env: added dev URL and search_path
- `scripts/apply-schema-sandbox.ps1` - Fixed env var handling for Atlas HCL

## Decisions Made

- **Partial unique index:** Used `WHERE identity_provider IS NOT NULL` to allow multiple users without OAuth identity while preventing duplicate provider+sub combinations
- **Role VARCHAR(20):** Matches Clerk metadata pattern, allows future role expansion
- **Created Azure database:** Azure Sandbox was missing the `livermore` database - created via Azure CLI

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Azure Sandbox database did not exist**
- **Found during:** Task 2 (sandbox deployment)
- **Issue:** `apply-schema-sandbox.ps1` failed with "database livermore does not exist"
- **Fix:** Created database via `az postgres flexible-server db create`
- **Files modified:** None (Azure resource created)
- **Verification:** Schema deployed successfully after database creation
- **Committed in:** N/A (infrastructure change)

**2. [Rule 3 - Blocking] Atlas sandbox env missing dev URL**
- **Found during:** Task 2 (sandbox deployment)
- **Issue:** Atlas errored with "dev-url cannot be empty" - sandbox env lacked dev database for diff computation
- **Fix:** Added `dev = "docker://postgres/15/dev?search_path=public"` to sandbox env in atlas.hcl
- **Files modified:** packages/database/atlas.hcl
- **Verification:** Atlas schema apply succeeded
- **Committed in:** `950b337`

**3. [Rule 3 - Blocking] Atlas sandbox env missing search_path**
- **Found during:** Task 2 (sandbox deployment)
- **Issue:** Atlas errored with "cannot diff a schema 'public' with a database connection"
- **Fix:** Added `search_path=public` to sandbox URL in atlas.hcl
- **Files modified:** packages/database/atlas.hcl
- **Verification:** Atlas schema apply succeeded
- **Committed in:** `950b337`

**4. [Rule 3 - Blocking] apply-schema-sandbox.ps1 set wrong env vars**
- **Found during:** Task 2 (sandbox deployment)
- **Issue:** Script set DATABASE_URL but atlas.hcl sandbox env uses PG_SANDBOX_* variables
- **Fix:** Changed script to set PG_SANDBOX_HOST, PG_SANDBOX_USER, PG_SANDBOX_PASSWORD
- **Files modified:** scripts/apply-schema-sandbox.ps1
- **Verification:** Atlas schema apply succeeded
- **Committed in:** `950b337`

---

**Total deviations:** 4 auto-fixed (4 blocking)
**Impact on plan:** All fixes necessary to complete sandbox deployment. No scope creep.

## Issues Encountered

- Pre-existing TypeScript errors in migrate.ts and seed.ts (missing @types/node) - not related to this plan, ignored for now

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- IAM columns ready for Clerk authentication integration (Phase 13)
- TypeScript role types available for authorization logic
- Both local and Azure Sandbox databases have identical schema

---
*Phase: 12-iam-schema*
*Completed: 2026-01-26*

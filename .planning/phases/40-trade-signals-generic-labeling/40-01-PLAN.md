---
phase: 40-trade-signals-generic-labeling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/public-api/src/schemas/signal.schema.ts
  - packages/public-api/src/schemas/alert.schema.ts
  - packages/public-api/src/schemas/index.ts
  - packages/public-api/src/transformers/signal.transformer.ts
  - packages/public-api/src/transformers/alert.transformer.ts
  - packages/public-api/src/transformers/index.ts
autonomous: true

must_haves:
  truths:
    - "Signal schemas define only generic fields (type, direction, strength, timeframe, updated_at) with no indicator names"
    - "Alert schemas define only public fields (timestamp, symbol, exchange, timeframe, signal_type, direction, strength, price) with no details JSONB"
    - "Signal transformer maps internal stage to direction and MACD-V magnitude to strength without exposing numeric values"
    - "Alert transformer maps trigger_label to direction and trigger_value to strength category without exposing raw values"
  artifacts:
    - path: "packages/public-api/src/schemas/signal.schema.ts"
      provides: "PublicSignalSchema, SignalParamsSchema, SignalQuerySchema"
      contains: "momentum_signal"
    - path: "packages/public-api/src/schemas/alert.schema.ts"
      provides: "PublicAlertSchema, AlertQuerySchema"
      contains: "signal_type"
    - path: "packages/public-api/src/transformers/signal.transformer.ts"
      provides: "transformIndicatorToSignal"
      contains: "deriveDirection"
    - path: "packages/public-api/src/transformers/alert.transformer.ts"
      provides: "transformAlertHistory"
      contains: "deriveAlertDirection"
  key_links:
    - from: "packages/public-api/src/schemas/index.ts"
      to: "signal.schema.ts, alert.schema.ts"
      via: "barrel exports"
      pattern: "export.*from.*signal\\.schema|alert\\.schema"
    - from: "packages/public-api/src/transformers/index.ts"
      to: "signal.transformer.ts, alert.transformer.ts"
      via: "barrel exports"
      pattern: "export.*from.*signal\\.transformer|alert\\.transformer"
---

<objective>
Create Zod schemas and whitelist transformers for trade signals and alert history endpoints.

Purpose: Establish the data contracts and transformation layer that maps proprietary MACD-V indicator data to generic public labels. This is the IP protection boundary -- every field must be explicitly whitelisted with no indicator names, numeric values, or internal details leaking through.

Output: Schema files (signal.schema.ts, alert.schema.ts) and transformer files (signal.transformer.ts, alert.transformer.ts) with barrel exports updated.
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/40-trade-signals-generic-labeling/40-RESEARCH.md

# Existing patterns to follow exactly
@packages/public-api/src/schemas/candle.schema.ts
@packages/public-api/src/schemas/envelope.schema.ts
@packages/public-api/src/schemas/index.ts
@packages/public-api/src/transformers/candle.transformer.ts
@packages/public-api/src/transformers/index.ts

# Internal data shapes (read-only reference -- do NOT import indicators package)
@packages/cache/src/strategies/indicator-cache.ts (CachedIndicatorValue interface, lines 8-15)
@packages/database/src/schema/alert-history.ts (alertHistory table schema)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create signal and alert Zod schemas</name>
  <files>
    packages/public-api/src/schemas/signal.schema.ts
    packages/public-api/src/schemas/alert.schema.ts
    packages/public-api/src/schemas/index.ts
  </files>
  <action>
Create `signal.schema.ts` following the exact pattern of candle.schema.ts:

**PublicSignalSchema** (response body item):
- `type`: `z.enum(['momentum_signal', 'trend_signal'])` -- generic signal type, NO indicator names
- `direction`: `z.enum(['bullish', 'bearish', 'neutral'])` -- signal direction
- `strength`: `z.enum(['weak', 'moderate', 'strong', 'extreme'])` -- signal strength category
- `timeframe`: `z.string()` -- e.g. "15m", "1h"
- `updated_at`: `z.string()` -- ISO 8601 timestamp

**SignalParamsSchema** (URL params for `/:exchange/:symbol`):
- `exchange`: `z.string().min(1).describe('Exchange name (e.g. "coinbase")')`
- `symbol`: `z.string().min(1).describe('Trading pair (e.g. "BTC-USD")')`

**SignalQuerySchema** (query string):
- `timeframe`: `z.string().optional().describe('Filter to specific timeframe (e.g. "15m", "1h"). Omit for all timeframes.')`

Export types: `PublicSignal`, `SignalParams`, `SignalQuery`

Create `alert.schema.ts`:

**PublicAlertSchema** (response body item):
- `timestamp`: `z.string()` -- ISO 8601
- `symbol`: `z.string()` -- e.g. "BTC-USD"
- `exchange`: `z.string()` -- exchange name (NOT numeric ID)
- `timeframe`: `z.string()` -- e.g. "15m"
- `signal_type`: `z.enum(['momentum_signal'])` -- generic type (maps from 'macdv')
- `direction`: `z.enum(['bullish', 'bearish'])` -- derived from trigger_label
- `strength`: `z.enum(['weak', 'moderate', 'strong', 'extreme'])` -- derived from trigger_value magnitude
- `price`: `z.string()` -- string decimal (no precision loss)

**AlertQuerySchema** (query string):
- `exchange`: `z.string().optional()` -- filter by exchange name
- `symbol`: `z.string().optional()` -- filter by symbol
- `timeframe`: `z.string().optional()` -- filter by timeframe
- `cursor`: `z.string().optional()` -- opaque pagination cursor
- `limit`: `z.coerce.number().int().min(1).max(100).default(50)` -- page size

Export types: `PublicAlert`, `AlertQuery`

All schemas must have `.describe()` on every field with AI-friendly documentation. Add zero references to MACD-V, histogram, EMA, ATR, or any internal indicator name.

Update `schemas/index.ts` barrel to export all new schemas and types.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/public-api/tsconfig.json` -- should compile with zero errors. Grep all new schema files for forbidden terms: `grep -iE "macd|histogram|ema|atr|informative" packages/public-api/src/schemas/signal.schema.ts packages/public-api/src/schemas/alert.schema.ts` should return zero results.
  </verify>
  <done>
PublicSignalSchema, SignalParamsSchema, SignalQuerySchema, PublicAlertSchema, and AlertQuerySchema exist with all fields described. No indicator names appear anywhere in schema files. Barrel index re-exports everything.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create signal and alert whitelist transformers</name>
  <files>
    packages/public-api/src/transformers/signal.transformer.ts
    packages/public-api/src/transformers/alert.transformer.ts
    packages/public-api/src/transformers/index.ts
  </files>
  <action>
Create `signal.transformer.ts` following candle.transformer.ts whitelist pattern:

Define a local `CachedIndicator` interface (do NOT import from @livermore/cache to maintain zero-dependency boundary -- the shape is: `{ timestamp: number, type: string, symbol: string, timeframe: string, value: Record<string, number>, params?: Record<string, unknown> }`).

**deriveDirection(stage: string | undefined)**: Map internal stage to public direction:
- `['rallying', 'rebounding', 'overbought']` -> `'bullish'`
- `['retracing', 'reversing', 'oversold']` -> `'bearish'`
- Everything else (including `'ranging'`, `'unknown'`, undefined) -> `'neutral'`

**deriveStrength(absValue: number)**: Map absolute MACD-V magnitude to strength category:
- `>= 150` -> `'extreme'`
- `>= 80` -> `'strong'`
- `>= 30` -> `'moderate'`
- `< 30` -> `'weak'`

**transformIndicatorToSignal(indicator: CachedIndicator)**: Returns `PublicSignal`:
- Extract `stage` from `indicator.params?.stage` (cast to string)
- Extract macdV value from `indicator.value['macdV'] ?? 0`
- Return ONLY: `{ type: 'momentum_signal', direction: deriveDirection(stage), strength: deriveStrength(Math.abs(macdVValue)), timeframe: indicator.timeframe, updated_at: new Date(indicator.timestamp).toISOString() }`
- CRITICAL: This is an explicit whitelist. Do NOT spread the indicator object.

Create `alert.transformer.ts`:

Define `AlertHistoryRow` interface locally (do NOT import from @livermore/database): `{ triggeredAt: Date, symbol: string, timeframe: string | null, triggerLabel: string, triggerValue: string | null, price: string, exchangeId: number }` -- only the columns the route will SELECT.

**deriveAlertDirection(triggerLabel: string)**: Parse trigger_label to direction:
- `'reversal_oversold'` prefix -> `'bullish'` (reversing FROM oversold)
- `'reversal_overbought'` prefix -> `'bearish'` (reversing FROM overbought)
- `'level_'` prefix: parse number after prefix, negative -> `'bearish'`, positive/zero -> `'bullish'`
- Default fallback: `'bearish'`

**deriveAlertStrength(triggerValue: string | null)**: Map raw trigger_value to strength:
- null/undefined -> `'moderate'` (safe default)
- Parse to float, use absolute value, same thresholds as signal strength (150/80/30)

**transformAlertHistory(row: AlertHistoryRow, exchangeName: string)**: Returns `PublicAlert`:
- Return ONLY: `{ timestamp: row.triggeredAt.toISOString(), symbol: row.symbol, exchange: exchangeName, timeframe: row.timeframe ?? '', signal_type: 'momentum_signal', direction: deriveAlertDirection(row.triggerLabel), strength: deriveAlertStrength(row.triggerValue), price: row.price.toString() }`
- CRITICAL: Do NOT include `details`, `previousLabel`, `notificationSent`, `notificationError`, `alertType`, `triggeredAtEpoch`, or any other internal column.

Update `transformers/index.ts` barrel to export `transformIndicatorToSignal` and `transformAlertHistory`.

Add a comment block at the top of each transformer file (same style as candle.transformer.ts) explicitly documenting the IP protection whitelist pattern and listing which internal fields are intentionally excluded.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/public-api/tsconfig.json` -- zero errors. Grep transformers for forbidden terms: `grep -iE "macd|histogram|ema|atr|informative|details|notification|previous" packages/public-api/src/transformers/signal.transformer.ts packages/public-api/src/transformers/alert.transformer.ts` should return zero results EXCEPT in the comment block documenting excluded fields and the `value['macdV']` access in signal transformer (which extracts but does NOT expose the value).
  </verify>
  <done>
transformIndicatorToSignal and transformAlertHistory exist, both use explicit whitelist pattern (no object spreading), both map internal values to generic categories. No indicator-specific field names appear in output objects. Barrel index exports both transformers.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/public-api/tsconfig.json` compiles cleanly
2. All new schemas have `.describe()` on every field
3. Zero indicator names (macdV, histogram, EMA, ATR, signal line) in any public-facing schema or transformer output
4. Transformer functions return explicit object literals (not spread operations)
5. Barrel exports updated for both schemas and transformers
</verification>

<success_criteria>
- Signal and alert Zod schemas define the public API contract with generic labels only
- Transformers convert internal indicator data and alert history rows to public format via explicit whitelist
- No import from @livermore/indicators or @livermore/cache/strategies exists (local interface copies used)
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/40-trade-signals-generic-labeling/40-01-SUMMARY.md`
</output>

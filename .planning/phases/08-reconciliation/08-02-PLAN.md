---
phase: 08-reconciliation
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - apps/api/src/server.ts
autonomous: true

must_haves:
  truths:
    - "ReconciliationService starts after backfill and indicators"
    - "ReconciliationService stops during graceful shutdown"
    - "Service receives same symbols and timeframes as other services"
  artifacts:
    - path: "apps/api/src/server.ts"
      provides: "ReconciliationService integration in startup sequence"
      contains: "ReconciliationService"
  key_links:
    - from: "apps/api/src/server.ts"
      to: "@livermore/coinbase-client"
      via: "import ReconciliationService"
      pattern: "import.*ReconciliationService.*from.*@livermore/coinbase-client"
    - from: "apps/api/src/server.ts"
      to: "reconciliationService.start"
      via: "service initialization call"
      pattern: "reconciliationService\\.start\\("
    - from: "apps/api/src/server.ts"
      to: "reconciliationService.stop"
      via: "graceful shutdown"
      pattern: "reconciliationService\\.stop\\("
---

<objective>
Integrate ReconciliationService into server.ts startup and shutdown sequences.

Purpose: Enable automatic gap detection and filling during normal server operation, ensuring cache integrity is maintained continuously.

Output: Server starts ReconciliationService after other services, stops it during graceful shutdown.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-reconciliation/08-RESEARCH.md

# Prior plan summary
@.planning/phases/08-reconciliation/08-01-SUMMARY.md

# Key source files
@apps/api/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ReconciliationService to server startup</name>
  <files>apps/api/src/server.ts</files>
  <action>
Integrate ReconciliationService into server.ts following the existing service pattern.

**1. Add import:**
```typescript
import { CoinbaseRestClient, StartupBackfillService, ReconciliationService } from '@livermore/coinbase-client';
```

**2. Add service initialization after Alert Evaluation Service (around line 257):**

ReconciliationService should start AFTER:
- Backfill (cache is populated)
- IndicatorCalculationService (indicators are ready)
- CoinbaseWebSocketService (WebSocket is connected)
- AlertEvaluationService (alerts are ready)

Add after the AlertEvaluationService start:

```typescript
// Step 5: Start Reconciliation Service (background gap detection)
// Runs cron jobs to detect and fill gaps in cached candle data
const reconciliationService = new ReconciliationService(
  config.Coinbase_ApiKeyId,
  config.Coinbase_EcPrivateKeyPem,
  redis
);
await reconciliationService.start(monitoredSymbols, backfillTimeframes);
logger.info('Reconciliation Service started (5-min gap scan, hourly full reconciliation)');
```

Note: Use `backfillTimeframes` (5m, 15m, 1h, 4h, 1d) not SUPPORTED_TIMEFRAMES (which includes 1m).
Reconciliation only needs to check timeframes that are backfilled/cached.

**3. Add to graceful shutdown (in the shutdown function):**

Add reconciliationService.stop() in the shutdown sequence, BEFORE other services:

```typescript
const shutdown = async () => {
  logger.info('Shutting down server...');

  // Stop services in reverse order
  await reconciliationService.stop(); // Add this line
  await alertService.stop();
  await indicatorService.stop();
  coinbaseWsService.stop();
  // ... rest of shutdown
};
```

Reconciliation should stop first since it's the most independent (doesn't publish events others consume).
  </action>
  <verify>
    - `grep "ReconciliationService" apps/api/src/server.ts` returns matches
    - `grep "reconciliationService.start" apps/api/src/server.ts` returns match
    - `grep "reconciliationService.stop" apps/api/src/server.ts` returns match
    - `npx tsc --noEmit -p apps/api` passes
  </verify>
  <done>
    - ReconciliationService imported from @livermore/coinbase-client
    - Service instantiated with API credentials and Redis
    - Service started with monitoredSymbols and backfillTimeframes
    - Service stopped during graceful shutdown (first in stop order)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify full startup sequence</name>
  <files>apps/api/src/server.ts</files>
  <action>
Verify the complete startup sequence is correct and add step numbering comments if needed.

**Expected startup order:**
1. Environment validation
2. Fastify + plugins
3. Database + Redis connections
4. Fetch account symbols
5. Cleanup excluded symbols
6. **Step 1:** Backfill cache (StartupBackfillService)
7. tRPC router registration
8. **Step 2:** IndicatorCalculationService.start()
9. **Step 3:** CoinbaseWebSocketService.start()
10. **Step 4:** AlertEvaluationService.start()
11. **Step 5:** ReconciliationService.start()
12. Discord notification
13. Fastify listen

**Expected shutdown order:**
1. ReconciliationService.stop() (first - most independent)
2. AlertEvaluationService.stop()
3. IndicatorCalculationService.stop()
4. CoinbaseWebSocketService.stop()
5. Discord notification
6. Redis quit
7. Fastify close

Update step comments in server.ts to reflect the complete sequence. Ensure comments accurately describe each step's purpose.
  </action>
  <verify>
    - `grep -n "Step" apps/api/src/server.ts` shows 5 steps in startup
    - Server compiles: `npx tsc --noEmit -p apps/api`
    - Startup order makes sense (dependencies before dependents)
  </verify>
  <done>
    - Startup sequence documented with numbered steps
    - Shutdown sequence stops services in reverse dependency order
    - ReconciliationService properly positioned in both sequences
  </done>
</task>

</tasks>

<verification>
Overall phase 08-02 verification:

1. **Type check:** `npx tsc --noEmit -p apps/api`
2. **Import verification:** `grep "ReconciliationService" apps/api/src/server.ts`
3. **Startup integration:** `grep "reconciliationService.start" apps/api/src/server.ts`
4. **Shutdown integration:** `grep "reconciliationService.stop" apps/api/src/server.ts`
5. **Step ordering:** `grep -n "Step" apps/api/src/server.ts` shows correct order
</verification>

<success_criteria>
- ReconciliationService imported from @livermore/coinbase-client
- Service instantiated with correct parameters
- Service started after backfill, indicators, WebSocket, and alerts
- Service stopped first during graceful shutdown
- TypeScript compiles without errors
- Startup sequence documented with clear step comments
</success_criteria>

<output>
After completion, create `.planning/phases/08-reconciliation/08-02-SUMMARY.md`
</output>

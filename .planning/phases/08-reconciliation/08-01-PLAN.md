---
phase: 08-reconciliation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/coinbase-client/src/reconciliation/types.ts
  - packages/coinbase-client/src/reconciliation/gap-detector.ts
  - packages/coinbase-client/src/reconciliation/reconciliation-service.ts
  - packages/coinbase-client/src/reconciliation/index.ts
autonomous: true

must_haves:
  truths:
    - "Gap detection identifies missing candle timestamps in cache"
    - "5-minute cron job scans for recent gaps"
    - "Hourly cron job performs full reconciliation"
    - "Detected gaps trigger rate-limited REST backfill"
    - "Cron jobs use noOverlap to prevent task stacking"
  artifacts:
    - path: "packages/coinbase-client/src/reconciliation/types.ts"
      provides: "GapInfo, ReconciliationConfig, ReconciliationResult interfaces"
      exports: ["GapInfo", "ReconciliationConfig", "ReconciliationResult", "DEFAULT_RECONCILIATION_CONFIG"]
    - path: "packages/coinbase-client/src/reconciliation/gap-detector.ts"
      provides: "Pure function for gap detection algorithm"
      exports: ["detectGaps"]
    - path: "packages/coinbase-client/src/reconciliation/reconciliation-service.ts"
      provides: "ReconciliationService with start/stop lifecycle and cron jobs"
      exports: ["ReconciliationService"]
      min_lines: 150
    - path: "packages/coinbase-client/src/reconciliation/index.ts"
      provides: "Barrel exports for reconciliation module"
  key_links:
    - from: "reconciliation-service.ts"
      to: "gap-detector.ts"
      via: "import detectGaps"
      pattern: "import.*detectGaps.*from.*gap-detector"
    - from: "reconciliation-service.ts"
      to: "node-cron"
      via: "cron.schedule with noOverlap"
      pattern: "noOverlap:\\s*true"
    - from: "reconciliation-service.ts"
      to: "CandleCacheStrategy"
      via: "getCandlesInRange for timestamp retrieval"
      pattern: "getCandlesInRange|zrangebyscore"
    - from: "reconciliation-service.ts"
      to: "CoinbaseRestClient"
      via: "getCandles for gap filling"
      pattern: "restClient\\.getCandles"
---

<objective>
Implement ReconciliationService with gap detection and scheduled cron jobs for maintaining cache integrity.

Purpose: Detect and fill gaps in cached candle data automatically, ensuring indicator calculations always have complete data even after WebSocket disconnections or dropped messages.

Output: ReconciliationService class with 5-minute gap scan and hourly full reconciliation, using node-cron v4 with noOverlap option.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-reconciliation/08-RESEARCH.md

# Prior phase summaries for reference
@.planning/phases/07-startup-backfill/07-01-SUMMARY.md (rate-limited backfill pattern)
@.planning/phases/07-startup-backfill/07-02-SUMMARY.md (server integration pattern)

# Key source files to reference
@packages/coinbase-client/src/backfill/startup-backfill-service.ts (backfill pattern to reuse)
@packages/coinbase-client/src/backfill/types.ts (config pattern)
@packages/cache/src/strategies/candle-cache.ts (cache operations)
@packages/cache/src/keys.ts (candleKey function)
@packages/utils/src/time/timeframe.ts (timeframeToMs, getCandleTimestamp, getCandleTimestamps)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reconciliation types and gap detector</name>
  <files>
    packages/coinbase-client/src/reconciliation/types.ts
    packages/coinbase-client/src/reconciliation/gap-detector.ts
  </files>
  <action>
Create the reconciliation module with type definitions and pure gap detection function.

**types.ts:**
```typescript
import type { Timeframe } from '@livermore/schemas';

export interface GapInfo {
  symbol: string;
  timeframe: Timeframe;
  start: number;      // First missing timestamp (ms)
  end: number;        // Last missing timestamp (ms)
  count: number;      // Number of missing candles
}

export interface ReconciliationConfig {
  /** User ID for cache keys */
  userId: number;
  /** Exchange ID for cache keys */
  exchangeId: number;
  /** Lookback window for 5-minute gap scan (ms, default: 30 min) */
  quickScanWindowMs: number;
  /** Lookback window for hourly reconciliation (ms, default: 6 hours) */
  fullReconcileWindowMs: number;
  /** Batch size for gap filling requests */
  batchSize: number;
  /** Delay between batches (ms) */
  batchDelayMs: number;
}

export interface ReconciliationResult {
  scannedSymbols: number;
  scannedTimeframes: number;
  gapsFound: number;
  gapsFilled: number;
  errors: number;
  durationMs: number;
}

export const DEFAULT_RECONCILIATION_CONFIG: ReconciliationConfig = {
  userId: 1,
  exchangeId: 1,
  quickScanWindowMs: 30 * 60 * 1000,      // 30 minutes
  fullReconcileWindowMs: 6 * 60 * 60 * 1000, // 6 hours
  batchSize: 5,
  batchDelayMs: 1000,
};
```

**gap-detector.ts:**
```typescript
import type { Timeframe } from '@livermore/schemas';
import type { GapInfo } from './types';

/**
 * Detect gaps in a sequence of candle timestamps
 *
 * Compares actual cached timestamps against expected timestamps
 * for a given time range and interval.
 *
 * @param symbol - Trading symbol (e.g., 'BTC-USD')
 * @param timeframe - Candle timeframe (e.g., '5m')
 * @param cachedTimestamps - Actual timestamps present in cache (sorted ascending)
 * @param expectedTimestamps - Expected timestamps for the range (sorted ascending)
 * @returns Array of gap info objects describing missing sequences
 */
export function detectGaps(
  symbol: string,
  timeframe: Timeframe,
  cachedTimestamps: number[],
  expectedTimestamps: number[]
): GapInfo[] {
  if (expectedTimestamps.length === 0) return [];

  const gaps: GapInfo[] = [];
  const cachedSet = new Set(cachedTimestamps);

  let gapStart: number | null = null;
  let gapCount = 0;

  for (const expected of expectedTimestamps) {
    if (!cachedSet.has(expected)) {
      // Missing timestamp
      if (gapStart === null) {
        gapStart = expected;
      }
      gapCount++;
    } else if (gapStart !== null) {
      // Gap ended - record it
      gaps.push({
        symbol,
        timeframe,
        start: gapStart,
        end: expected - 1, // End is last missing, not first present
        count: gapCount,
      });
      gapStart = null;
      gapCount = 0;
    }
  }

  // Handle trailing gap (missing at end of range)
  if (gapStart !== null) {
    const lastExpected = expectedTimestamps[expectedTimestamps.length - 1];
    gaps.push({
      symbol,
      timeframe,
      start: gapStart,
      end: lastExpected,
      count: gapCount,
    });
  }

  return gaps;
}
```
  </action>
  <verify>
    - `ls packages/coinbase-client/src/reconciliation/types.ts` exists
    - `ls packages/coinbase-client/src/reconciliation/gap-detector.ts` exists
    - `npx tsc --noEmit -p packages/coinbase-client` passes
  </verify>
  <done>
    - GapInfo, ReconciliationConfig, ReconciliationResult types defined
    - DEFAULT_RECONCILIATION_CONFIG exported with sensible defaults
    - detectGaps pure function correctly identifies gaps in timestamp sequences
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ReconciliationService with cron jobs</name>
  <files>
    packages/coinbase-client/src/reconciliation/reconciliation-service.ts
    packages/coinbase-client/src/reconciliation/index.ts
  </files>
  <action>
Create the main ReconciliationService class following existing service patterns.

**First, install node-cron:**
```bash
pnpm add node-cron --filter @livermore/coinbase-client
```

**reconciliation-service.ts:**
Follow the pattern from StartupBackfillService and existing services. Key features:

1. **Constructor:**
   - Accept apiKeyId, privateKeyPem, redis
   - Create CoinbaseRestClient and CandleCacheStrategy instances
   - Accept partial config to merge with DEFAULT_RECONCILIATION_CONFIG

2. **start(symbols: string[], timeframes: Timeframe[]):**
   - Store symbols and timeframes as instance state
   - Schedule 5-minute gap scan: `cron.schedule('*/5 * * * *', ..., { noOverlap: true, timezone: 'UTC' })`
   - Schedule hourly full reconciliation: `cron.schedule('0 * * * *', ..., { noOverlap: true, timezone: 'UTC' })`
   - Log service start

3. **stop():**
   - Call `.stop()` on both cron tasks
   - Set task references to null
   - Log service stop

4. **performGapScan() (private):**
   - Use quickScanWindowMs for lookback
   - For each symbol/timeframe:
     - Calculate expected timestamps using getCandleTimestamps from @livermore/utils
     - Get cached timestamps (extract from getCandlesInRange or use ZRANGEBYSCORE directly)
     - Call detectGaps
   - Collect all gaps, call fillGaps
   - Return ReconciliationResult

5. **performFullReconciliation() (private):**
   - Same as gap scan but with fullReconcileWindowMs lookback
   - Log more detailed progress

6. **fillGaps(gaps: GapInfo[]) (private):**
   - Reuse rate-limited batch pattern from StartupBackfillService
   - For each gap, fetch candles via REST and write to cache
   - Use Promise.allSettled for resilience
   - Log progress and errors

7. **getTimestampsFromCache(symbol, timeframe, start, end) (private):**
   - Use CandleCacheStrategy.getCandlesInRange to get candles
   - Extract just the timestamps from returned candles
   - This is simpler than raw Redis commands and reuses existing cache layer

8. **sleep(ms) (private):**
   - Promise-based delay helper

**Import node-cron as:**
```typescript
import cron, { type ScheduledTask } from 'node-cron';
```

**index.ts:**
```typescript
export { ReconciliationService } from './reconciliation-service';
export { detectGaps } from './gap-detector';
export type { GapInfo, ReconciliationConfig, ReconciliationResult } from './types';
export { DEFAULT_RECONCILIATION_CONFIG } from './types';
```
  </action>
  <verify>
    - `ls packages/coinbase-client/src/reconciliation/reconciliation-service.ts` exists
    - `ls packages/coinbase-client/src/reconciliation/index.ts` exists
    - `grep "noOverlap" packages/coinbase-client/src/reconciliation/reconciliation-service.ts` returns matches
    - `grep "node-cron" packages/coinbase-client/package.json` confirms dependency added
    - `npx tsc --noEmit -p packages/coinbase-client` passes
  </verify>
  <done>
    - ReconciliationService class with start/stop lifecycle
    - 5-minute gap scan cron job with noOverlap
    - Hourly full reconciliation cron job with noOverlap
    - Rate-limited gap filling using existing backfill pattern
    - Barrel exports for easy importing
  </done>
</task>

<task type="auto">
  <name>Task 3: Export ReconciliationService from coinbase-client package</name>
  <files>
    packages/coinbase-client/src/index.ts
  </files>
  <action>
Add exports for the reconciliation module to the package's main index.ts.

Add these lines to packages/coinbase-client/src/index.ts:

```typescript
// Reconciliation
export { ReconciliationService, detectGaps, DEFAULT_RECONCILIATION_CONFIG } from './reconciliation';
export type { GapInfo, ReconciliationConfig, ReconciliationResult } from './reconciliation';
```

Follow the same pattern used for backfill exports (using separate `export type` for type-only exports due to isolatedModules).
  </action>
  <verify>
    - `grep "ReconciliationService" packages/coinbase-client/src/index.ts` returns match
    - `npx tsc --noEmit -p packages/coinbase-client` passes
    - `pnpm --filter @livermore/coinbase-client build` succeeds
  </verify>
  <done>
    - ReconciliationService, detectGaps, DEFAULT_RECONCILIATION_CONFIG exported
    - Type exports for GapInfo, ReconciliationConfig, ReconciliationResult
    - Package builds successfully
  </done>
</task>

</tasks>

<verification>
Overall phase 08-01 verification:

1. **Type check:** `npx tsc --noEmit -p packages/coinbase-client`
2. **Package build:** `pnpm --filter @livermore/coinbase-client build`
3. **Module structure:**
   - `ls -la packages/coinbase-client/src/reconciliation/`
   - Should show: types.ts, gap-detector.ts, reconciliation-service.ts, index.ts
4. **Cron configuration:**
   - `grep -n "noOverlap" packages/coinbase-client/src/reconciliation/reconciliation-service.ts`
   - Should show noOverlap: true for both cron jobs
5. **Dependencies:**
   - `grep "node-cron" packages/coinbase-client/package.json`
   - Should show node-cron in dependencies
</verification>

<success_criteria>
- ReconciliationService class exists with start/stop methods
- 5-minute cron job scheduled with noOverlap: true
- Hourly cron job scheduled with noOverlap: true
- Gap detection identifies missing timestamps correctly
- Gap filling reuses rate-limited batch pattern (5 req/batch, 1s delay)
- All types exported from @livermore/coinbase-client
- TypeScript compiles without errors
- Package builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/08-reconciliation/08-01-SUMMARY.md`
</output>

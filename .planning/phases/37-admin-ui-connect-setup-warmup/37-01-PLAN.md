---
phase: 37-admin-ui-connect-setup-warmup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/src/components/network/InstanceCard.tsx
  - apps/admin/src/components/network/ConnectButton.tsx
  - apps/admin/src/components/network/LockWarningModal.tsx
  - apps/admin/src/components/network/index.ts
  - apps/admin/src/pages/Network.tsx
autonomous: true
must_haves:
  truths:
    - "Instance cards for offline or idle exchanges show a Connect button"
    - "Clicking Connect on an exchange already running on another machine shows a warning modal with hostname, IP, and connected-since timestamp"
    - "User must explicitly confirm the takeover before proceeding when another instance holds the lock"
    - "Clicking Connect (or confirming takeover) fires the start command and the exchange begins connecting"
  artifacts:
    - path: "apps/admin/src/components/network/ConnectButton.tsx"
      provides: "Connect button with lock-check logic"
      min_lines: 30
    - path: "apps/admin/src/components/network/LockWarningModal.tsx"
      provides: "Warning modal displaying current lock holder info"
      min_lines: 40
  key_links:
    - from: "apps/admin/src/components/network/ConnectButton.tsx"
      to: "network.getExchangeStatus"
      via: "tRPC query to check if exchange is already locked"
      pattern: "trpc\\.network\\.getExchangeStatus"
    - from: "apps/admin/src/components/network/ConnectButton.tsx"
      to: "control.executeCommand"
      via: "tRPC mutation to fire start command"
      pattern: "trpcClient\\.control\\.executeCommand"
---

<objective>
Add a "Connect" button to exchange instance cards on the Network page. When clicked, check if the exchange is already running on another machine. If so, show a warning modal with the lock holder's hostname, IP, and connected-since timestamp requiring explicit confirmation before proceeding.

Purpose: ADM-01 and ADM-02 -- admins can initiate exchange connections from the Network page with awareness of existing locks.
Output: ConnectButton and LockWarningModal components wired into the InstanceCard grid.
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/admin/src/pages/Network.tsx
@apps/admin/src/components/network/InstanceCard.tsx
@apps/admin/src/components/network/index.ts
@apps/api/src/routers/network.router.ts
@apps/api/src/routers/control.router.ts
@apps/admin/src/lib/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: ConnectButton with lock-check and LockWarningModal</name>
  <files>
    apps/admin/src/components/network/ConnectButton.tsx
    apps/admin/src/components/network/LockWarningModal.tsx
    apps/admin/src/components/network/index.ts
  </files>
  <action>
Create two new components:

**ConnectButton.tsx** (apps/admin/src/components/network/ConnectButton.tsx):
- Props: `{ exchangeId: number; exchangeName: string; disabled?: boolean }`
- Renders a Button (from `@/components/ui/button`) with Play icon (from lucide-react) and text "Connect"
- On click:
  1. Set loading state (show Loader2 spinner)
  2. Call `trpcClient.network.getExchangeStatus.query({ exchangeId })` to check current lock status
  3. If `online === true` and status exists with `connectionState !== 'idle'` and `connectionState !== 'stopped'`:
     - Open the LockWarningModal, passing status data (hostname, ipAddress, connectedAt)
  4. If not locked (offline, idle, or stopped): call `handleConnect()` directly
- `handleConnect()`:
  1. Call `trpcClient.control.executeCommand.mutate({ type: 'start', payload: { exchange: exchangeName } })`
  2. On success: `toast.success('Connecting to {exchangeName}...')` and invalidate `['network']` queries via `queryClient.invalidateQueries({ queryKey: [['network']] })`
  3. On error: `toast.error(err.message)`
  4. Clear loading state
- Use `trpcClient` directly (not hooks) since the check and connect are imperative actions, not reactive queries
- Import `toast` from `sonner`, `queryClient` and `trpcClient` from `@/lib/trpc`

**LockWarningModal.tsx** (apps/admin/src/components/network/LockWarningModal.tsx):
- Props: `{ open: boolean; onConfirm: () => void; onCancel: () => void; hostname: string; ipAddress: string | null; connectedAt: string | null; exchangeName: string }`
- Uses Dialog/DialogContent/DialogHeader/DialogTitle/DialogDescription from `@/components/ui/dialog`
- Shows AlertTriangle icon (lucide-react) in yellow/amber
- Title: "Exchange Already Connected"
- Description: "This exchange is currently connected on another machine."
- Body shows a styled info box with:
  - Hostname: `{hostname}`
  - IP Address: `{ipAddress ?? 'Unknown'}`
  - Connected since: format `connectedAt` as relative time (e.g., "2 hours ago") using `new Date(connectedAt).toLocaleString()` for simplicity
- Warning text: "Connecting from here will take over the exchange. The other instance will lose its connection."
- Footer with two buttons:
  - "Cancel" (variant="outline", calls onCancel)
  - "Connect Anyway" (variant="destructive", calls onConfirm)

**Update barrel file** (apps/admin/src/components/network/index.ts):
- Add exports: `export { ConnectButton } from './ConnectButton';`
- Keep existing exports for InstanceCard and ActivityFeed
  </action>
  <verify>
Run `npx tsc --noEmit --project apps/admin/tsconfig.json` from workspace root -- zero type errors in the new files.
Grep for `ConnectButton` and `LockWarningModal` in the barrel file to confirm exports.
  </verify>
  <done>ConnectButton and LockWarningModal components exist with correct props, lock-check logic, and start command wiring. Barrel file exports both.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ConnectButton into InstanceCard and Network page</name>
  <files>
    apps/admin/src/components/network/InstanceCard.tsx
    apps/admin/src/pages/Network.tsx
  </files>
  <action>
**Modify InstanceCard.tsx:**
- Import `ConnectButton` from the barrel file (or directly from `./ConnectButton`)
- Add ConnectButton to the card footer area (after CardContent), but only when the exchange is connectable:
  - Show ConnectButton when: `!online` (offline) OR `(online && status?.connectionState === 'idle')` OR `(online && status?.connectionState === 'stopped')`
  - Do NOT show when: `connectionState` is 'active', 'starting', 'warming', or 'stopping' (already in a non-idle running state)
- Pass `exchangeId={instance.exchangeId}` and `exchangeName={instance.exchangeName}` to ConnectButton
- The button should appear below the existing card content, inside a `div` with `px-6 pb-4` padding (matching CardContent's horizontal padding) and slight top border `border-t pt-3 mt-2` for visual separation
- For the "No active connection" empty state (when `!status`), still show the ConnectButton below the "No active connection" text

**Modify Network.tsx:**
- No changes needed to Network.tsx itself -- the ConnectButton is encapsulated in InstanceCard
- However, ensure the `queryClient` invalidation in ConnectButton (which invalidates `['network']`) will cause the Network page's 5s polling query to refetch immediately, which it will because TanStack Query invalidation triggers immediate refetch
  </action>
  <verify>
Run `npx tsc --noEmit --project apps/admin/tsconfig.json` -- zero type errors.
Grep for `ConnectButton` in InstanceCard.tsx to confirm it's rendered.
Verify the connect button only shows for offline/idle/stopped states by reading the conditional rendering logic.
  </verify>
  <done>InstanceCard renders ConnectButton for offline, idle, and stopped exchanges. Active/warming/starting/stopping exchanges do not show the button. Clicking Connect checks lock status, shows warning if locked, and fires start command.</done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes for the admin app with zero errors
2. ConnectButton component exists and exports from barrel file
3. LockWarningModal component exists with hostname/IP/connectedAt display
4. InstanceCard conditionally renders ConnectButton for offline/idle/stopped states
5. ConnectButton calls `network.getExchangeStatus` before `control.executeCommand`
6. LockWarningModal has Cancel and "Connect Anyway" (destructive) buttons
</verification>

<success_criteria>
- ADM-01: Instance cards for offline/idle exchanges display a Connect button
- ADM-02: Clicking Connect on an in-use exchange shows the lock warning modal with hostname, IP, connected-since before proceeding
- Connect button fires the 'start' command with exchange name payload
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/37-admin-ui-connect-setup-warmup/37-01-SUMMARY.md`
</output>

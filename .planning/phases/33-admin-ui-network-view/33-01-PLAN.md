---
phase: 33-admin-ui-network-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/src/App.tsx
  - apps/admin/src/pages/Network.tsx
  - apps/admin/src/components/network/index.ts
  - apps/admin/src/components/network/InstanceCard.tsx
  - apps/admin/src/components/network/ActivityFeed.tsx
autonomous: true

must_haves:
  truths:
    - "A 'Network' link appears in the Admin header between 'Control' and 'Symbols', highlighted when active"
    - "Clicking #/network shows an instance card for every active exchange in the database"
    - "Each online card displays: exchange name, connection state badge (color-coded), hostname, IP, admin name, symbol count, last heartbeat age, uptime since connectedAt"
    - "Offline instances show a 'Offline' red badge with exchange name visible"
    - "Heartbeat age is color-coded: green < 10s, yellow < 30s, red > 30s"
    - "Uptime shows human-readable duration ('Running for 4h 23m') calculated from connectedAt"
    - "A scrollable activity feed shows state transitions and errors in reverse chronological order"
    - "The page auto-refreshes every 5 seconds using refetchInterval"
  artifacts:
    - path: "apps/admin/src/pages/Network.tsx"
      provides: "Network page component with polling queries"
      min_lines: 40
    - path: "apps/admin/src/components/network/InstanceCard.tsx"
      provides: "Instance card with status badge, heartbeat color, uptime"
      min_lines: 60
    - path: "apps/admin/src/components/network/ActivityFeed.tsx"
      provides: "Scrollable activity feed with state transitions and errors"
      min_lines: 40
    - path: "apps/admin/src/components/network/index.ts"
      provides: "Barrel exports for network components"
      exports: ["InstanceCard", "ActivityFeed"]
    - path: "apps/admin/src/App.tsx"
      provides: "Hash route and nav link for Network page"
      contains: "#/network"
  key_links:
    - from: "apps/admin/src/pages/Network.tsx"
      to: "/api/network.getInstances"
      via: "useQuery with trpc.network.getInstances.queryOptions() and refetchInterval: 5000"
      pattern: "trpc\\.network\\.getInstances"
    - from: "apps/admin/src/pages/Network.tsx"
      to: "/api/network.getActivityLog"
      via: "useQuery with trpc.network.getActivityLog.queryOptions() and refetchInterval: 5000"
      pattern: "trpc\\.network\\.getActivityLog"
    - from: "apps/admin/src/App.tsx"
      to: "apps/admin/src/pages/Network.tsx"
      via: "HashRouter case '#/network' and header nav link"
      pattern: "case '#/network'"
---

<objective>
Build the Network page for the Admin UI displaying live Perseus Network status: instance cards per exchange with connection state badges, heartbeat latency indicators, uptime display, and a scrollable activity feed. Add the Network route and header nav link.

Purpose: This is the user-facing dashboard that makes the entire Perseus Network observable. Admins can see at a glance who is running what, where, whether it is healthy, and what happened recently.
Output: 5 files (1 modified, 4 new). A fully functional Network page accessible from Admin header navigation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/33-admin-ui-network-view/33-RESEARCH.md

Key source files (patterns to follow):
@apps/admin/src/App.tsx (hash routing, nav links)
@apps/admin/src/pages/ControlPanel.tsx (polling pattern with refetchInterval, tRPC usage)
@apps/admin/src/lib/trpc.ts (tRPC options proxy)
@apps/admin/src/components/control/RuntimeStatus.tsx (formatUptime, Badge usage, loading state, Card layout)
@apps/admin/src/components/control/CommandHistory.tsx (formatRelativeTime, list rendering)
@apps/admin/src/components/ui/badge.tsx (available variants: default, secondary, destructive, outline, success, warning)
@apps/admin/src/components/ui/card.tsx (Card, CardHeader, CardTitle, CardContent)
@apps/api/src/routers/network.router.ts (API contract -- getInstances, getActivityLog return shapes)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InstanceCard and ActivityFeed components</name>
  <files>
    apps/admin/src/components/network/InstanceCard.tsx
    apps/admin/src/components/network/ActivityFeed.tsx
    apps/admin/src/components/network/index.ts
  </files>
  <action>
    Create the `apps/admin/src/components/network/` directory with three files.

    **InstanceCard.tsx:**

    Props interface:
    ```typescript
    interface InstanceCardProps {
      instance: {
        exchangeId: number;
        exchangeName: string;
        displayName: string;
        online: boolean;
        status: {
          exchangeId: number;
          exchangeName: string;
          hostname: string;
          ipAddress: string | null;
          adminEmail: string | null;
          adminDisplayName: string | null;
          connectionState: 'idle' | 'starting' | 'warming' | 'active' | 'stopping' | 'stopped';
          symbolCount: number;
          connectedAt: string | null;
          lastHeartbeat: string;
          lastStateChange: string;
          registeredAt: string;
          lastError: string | null;
          lastErrorAt: string | null;
        } | null;
      };
    }
    ```

    Use inline types (do NOT import InstanceStatus from @livermore/schemas -- the admin app infers types from tRPC, not from backend packages).

    Renders a Card with:
    - **CardHeader:** `displayName` as CardTitle with connection state Badge next to it
    - **Badge mapping** (use `getStateBadge` helper function):
      - `online=false` -> `destructive` variant, label "Offline"
      - `active` -> `success` variant, label "Active"
      - `starting` -> `outline` variant with `className="border-blue-300 text-blue-600"`, label "Starting" (matches RuntimeStatus.tsx blue outline pattern)
      - `warming` -> `warning` variant, label "Warming"
      - `stopping` -> `warning` variant, label "Stopping"
      - `stopped` -> `secondary` variant, label "Stopped"
      - `idle` -> `secondary` variant, label "Idle"
    - **CardContent** for online instances (when `status` is not null):
      - Grid layout with `grid grid-cols-2 gap-2 text-sm`
      - Row 1: Hostname (`Server` icon) and IP (`ipAddress ?? 'N/A'`)
      - Row 2: Admin (`adminDisplayName ?? adminEmail ?? 'N/A'`) and Symbol count (`symbolCount`)
      - Row 3: Heartbeat latency with color indicator and Uptime display
    - **CardContent** for offline instances (when `status` is null):
      - Show "No active connection" in `text-gray-400 text-sm`

    **Heartbeat latency** (DIFF-02): Create a `getHeartbeatInfo` helper:
    - Calculate `ageMs = Date.now() - new Date(status.lastHeartbeat).getTime()`
    - Convert to seconds: `ageSec = Math.floor(ageMs / 1000)`
    - Color: `ageSec < 10` -> `text-green-500`, `ageSec < 30` -> `text-yellow-500`, else `text-red-500`
    - Display: `${ageSec}s ago`

    **Uptime display** (DIFF-01): Create a `formatUptime` helper:
    - Input: `connectedAt: string | null`
    - If null, return 'N/A'
    - Calculate seconds from connectedAt to now
    - Format: `Xh Ym` if hours > 0, `Xm` if minutes > 0, `<1m` otherwise
    - Display with Clock icon: "Running for Xh Ym"

    Icons to import from lucide-react: `Server`, `Clock`, `Wifi`, `WifiOff`, `User`, `Hash`

    **ActivityFeed.tsx:**

    Props interface:
    ```typescript
    interface ActivityFeedProps {
      entries: Array<Record<string, string> & { id: string }>;
      isLoading?: boolean;
    }
    ```

    Renders a Card with:
    - CardHeader: "Activity Feed" as CardTitle with `Activity` icon from lucide-react
    - CardContent: scrollable container with `max-h-96 overflow-y-auto space-y-2`
    - Empty state: "No recent activity" in `text-gray-500 text-sm`
    - Loading state: spinner (same pattern as RuntimeStatus.tsx)

    For each entry, render a row with:
    - Timestamp on the left: parse from stream ID (`parseInt(entry.id.split('-')[0])` gives ms timestamp), format with `formatRelativeTime` helper (copy pattern from CommandHistory.tsx: "just now", "Xm ago", "Xh ago", or date)
    - Event content in the middle:
      - If `entry.event === 'state_transition'`: `"${entry.exchangeName}: ${entry.fromState} -> ${entry.toState}"` with subtle arrow, and show `entry.adminEmail` or `entry.hostname` as secondary text
      - If `entry.event === 'error'`: `"${entry.exchangeName}: ${entry.error}"` with red text/icon (`AlertTriangle` from lucide-react)
    - Use `CheckCircle` icon (green) for transitions, `AlertTriangle` icon (red) for errors

    **index.ts (barrel exports):**
    ```typescript
    export { InstanceCard } from './InstanceCard';
    export { ActivityFeed } from './ActivityFeed';
    ```

    **Anti-patterns to avoid:**
    - Do NOT import types from `@livermore/schemas` -- the admin app does not import from backend packages. Use inline types or let tRPC infer them.
    - Do NOT use `trpcClient` directly for queries -- components receive data as props from the parent page.
    - Do NOT use React Router -- hash-based routing only.
  </action>
  <verify>
    Run `npx tsc --noEmit -p apps/admin/tsconfig.json` from the repo root -- no type errors.
    Confirm InstanceCard.tsx exists with Badge variant mapping for all 6 states + offline.
    Confirm ActivityFeed.tsx exists with max-h-96 scrollable container.
    Confirm index.ts exports both components.
  </verify>
  <done>
    InstanceCard renders exchange status with color-coded badge, heartbeat color (green/yellow/red), uptime, hostname, IP, admin, symbol count. ActivityFeed renders scrollable reverse-chronological list of state transitions and errors. Both follow existing Card/Badge/icon patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Network page and wire into App.tsx routing</name>
  <files>
    apps/admin/src/pages/Network.tsx
    apps/admin/src/App.tsx
  </files>
  <action>
    **Network.tsx:**

    Create `apps/admin/src/pages/Network.tsx` following the exact ControlPanel.tsx pattern.

    Imports:
    ```typescript
    import { useQuery } from '@tanstack/react-query';
    import { trpc } from '@/lib/trpc';
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
    import { InstanceCard, ActivityFeed } from '@/components/network';
    ```

    Two polling queries, both with `refetchInterval: 5000` (UI-05):

    1. Instance query:
    ```typescript
    const {
      data: instanceData,
      isLoading: instancesLoading,
      error: instancesError,
    } = useQuery({
      ...trpc.network.getInstances.queryOptions(),
      refetchInterval: 5000,
    });
    ```

    2. Activity log query:
    ```typescript
    const {
      data: activityData,
      isLoading: activityLoading,
    } = useQuery({
      ...trpc.network.getActivityLog.queryOptions({ count: 50 }),
      refetchInterval: 5000,
    });
    ```

    **Error state:** If `instancesError`, show error Card (same pattern as ControlPanel.tsx -- red bg-red-50 text-red-700 with error message).

    **Loading state:** If `instancesLoading`, show a Card with centered spinner (same pattern as RuntimeStatus.tsx loading state).

    **Main layout:**
    ```tsx
    <div className="space-y-6">
      {/* Summary header (optional) */}
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-semibold text-gray-900">
          Perseus Network
        </h2>
        <span className="text-sm text-gray-500">
          {instanceData?.instances.filter(i => i.online).length ?? 0} of{' '}
          {instanceData?.instances.length ?? 0} online
        </span>
      </div>

      {/* Instance Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {instanceData?.instances.map((inst) => (
          <InstanceCard key={inst.exchangeId} instance={inst} />
        ))}
      </div>

      {/* Activity Feed */}
      <ActivityFeed
        entries={activityData?.entries ?? []}
        isLoading={activityLoading}
      />
    </div>
    ```

    Export as named export: `export function Network() { ... }`

    **App.tsx modifications:**

    1. Add import at top with other page imports:
    ```typescript
    import { Network } from './pages/Network';
    ```

    2. Add nav link in the header nav, AFTER the "Control" link and BEFORE the "Symbols" link:
    ```tsx
    <a
      href="#/network"
      className={`${hash === '#/network' ? 'text-gray-900 font-medium' : 'text-gray-600'} hover:text-gray-900`}
    >
      Network
    </a>
    ```

    3. Add case to HashRouter switch, BEFORE the `'#/symbols'` case:
    ```typescript
    case '#/network':
      return <Network />;
    ```

    **Critical: Both the nav link AND the route case must be added.** Missing either one makes the page unreachable (Pitfall 1 from RESEARCH.md).
  </action>
  <verify>
    Run `npx tsc --noEmit -p apps/admin/tsconfig.json` from the repo root -- no type errors.
    Grep App.tsx for `#/network` -- should appear at least twice (nav link href and HashRouter case).
    Grep App.tsx for `import { Network }` -- should match.
    Grep Network.tsx for `refetchInterval: 5000` -- should appear twice (instances and activity).
    Grep Network.tsx for `trpc.network.getInstances` -- should match.
    Grep Network.tsx for `trpc.network.getActivityLog` -- should match.
  </verify>
  <done>
    Network page fetches instance status and activity log with 5s polling. Instance cards render in a responsive grid. Activity feed shows below. Header nav has "Network" link between "Control" and "Symbols". HashRouter routes #/network to Network component. Requirements covered: UI-01, UI-02, UI-03, UI-04, UI-05, DIFF-01, DIFF-02.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit -p apps/admin/tsconfig.json` passes with zero errors
- Network page is accessible at `#/network` via header nav link
- Nav link appears between "Control" and "Symbols" in the header
- HashRouter has `case '#/network': return <Network />;`
- Instance cards show exchange name, state badge, hostname, IP, admin, symbol count, heartbeat age, uptime
- Badge variants map correctly: active=success, starting=outline(blue), warming=warning, stopping=warning, stopped=secondary, idle=secondary, offline=destructive
- Heartbeat color: green < 10s, yellow < 30s, red > 30s
- Uptime formatted as "Xh Ym" from connectedAt
- Offline instances show "Offline" destructive badge with exchange name
- Activity feed is scrollable (max-h-96), shows state transitions and errors
- Both queries use refetchInterval: 5000
- No imports from @livermore/schemas in admin app code
- No React Router usage -- hash routing only
</verification>

<success_criteria>
- UI-01: "Network" page accessible from Admin header navigation
- UI-02: Instance card per exchange with all required fields (name, state badge, hostname, IP, admin, symbols, heartbeat, connected since)
- UI-03: Dead instance shows as "Offline" with destructive badge
- UI-04: Scrollable activity feed with state transitions and errors in reverse chronological order
- UI-05: Polling-based refresh at 5s interval
- DIFF-01: Uptime display ("Running for 4h 23m") from connectedAt
- DIFF-02: Heartbeat latency with color degradation (green < 10s, yellow < 30s, red > 30s)
</success_criteria>

<output>
After completion, create `.planning/phases/33-admin-ui-network-view/33-01-SUMMARY.md`
</output>

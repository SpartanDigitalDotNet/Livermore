---
phase: 33-admin-ui-network-view
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/services/state-machine.service.ts
autonomous: true

must_haves:
  truths:
    - "When an instance transitions state, a Discord notification fires with exchange name, from-state, to-state, and hostname"
    - "Discord notifications are fire-and-forget (errors are logged but do not block the transition)"
    - "Heartbeat refreshes do NOT trigger Discord notifications"
    - "The resetToIdle recovery path does NOT trigger Discord notifications (it's a recovery mechanism, not a normal transition)"
  artifacts:
    - path: "apps/api/src/services/state-machine.service.ts"
      provides: "State machine with Discord notification on transitions"
      contains: "getDiscordService"
  key_links:
    - from: "apps/api/src/services/state-machine.service.ts"
      to: "apps/api/src/services/discord-notification.service.ts"
      via: "getDiscordService().sendSystemNotification() called after successful transition"
      pattern: "getDiscordService.*sendSystemNotification"
---

<objective>
Wire Discord notifications into StateMachineService so that every state transition sends a Discord message via the existing DiscordNotificationService.

Purpose: Admins get immediate Discord alerts when any Perseus Network instance changes state (goes online, goes offline, enters error recovery, etc.) without needing to watch the Admin UI. This is the server-side complement to the UI dashboard.
Output: 1 modified file. Discord notifications fire on every valid state transition.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/33-admin-ui-network-view/33-RESEARCH.md

Key source files:
@apps/api/src/services/state-machine.service.ts (file to modify -- transition method)
@apps/api/src/services/discord-notification.service.ts (getDiscordService singleton, sendSystemNotification method)
@apps/api/src/services/instance-registry.service.ts (registry provides exchangeName and hostname for notification context)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Discord notification to StateMachineService transitions</name>
  <files>apps/api/src/services/state-machine.service.ts</files>
  <action>
    Modify `apps/api/src/services/state-machine.service.ts` to send a Discord notification after every successful state transition.

    **1. Add import:**
    ```typescript
    import { getDiscordService } from './discord-notification.service';
    ```

    **2. In the `transition()` method**, after the existing activity logger block (after the `if (this.activityLogger)` block, near the end of the method), add a Discord notification call:

    ```typescript
    // Phase 33: Discord notification for state changes (fire-and-forget)
    try {
      const discord = getDiscordService();
      if (discord.isEnabled()) {
        const registryStatus = this.registry.getStatus();
        const exchangeName = registryStatus?.exchangeName ?? 'Unknown';
        const hostname = registryStatus?.hostname ?? 'Unknown';
        discord.sendSystemNotification(
          `Perseus Network: ${exchangeName}`,
          `State changed: **${from}** -> **${to}** (${hostname})`
        ).catch(() => {
          // Swallow -- Discord failures must never block state transitions
        });
      }
    } catch {
      // getDiscordService() or getStatus() failed -- swallow
    }
    ```

    **Critical details:**
    - The Discord call must be **fire-and-forget**: do NOT await it. Call `.catch()` to swallow any rejection.
    - Wrap the entire block in try-catch in case `getDiscordService()` or `registry.getStatus()` throws.
    - Use `this.registry.getStatus()` to get the current exchange name and hostname for context in the notification message. Check that `getStatus()` exists on InstanceRegistryService -- if it returns the cached InstanceStatus object, extract `exchangeName` and `hostname` from it. If `getStatus()` does not exist, use `this.registry` fields or fall back to 'Unknown'.
    - Place the Discord block AFTER the activity logger block, not before it.
    - Do NOT add Discord notifications in `resetToIdle()` -- that is a recovery mechanism, not a normal transition.
    - Do NOT add Discord notifications anywhere else (not in the heartbeat path, not in the tRPC router).

    **3. Verify `registry.getStatus()` exists:**
    Before implementing, read `apps/api/src/services/instance-registry.service.ts` to confirm the method name for getting the current status. It may be `getStatus()`, `getCurrentStatus()`, or the status may be accessible via a public field. Adapt the code accordingly.

    **Why fire-and-forget:** Discord webhook latency (100-500ms) must not slow down state transitions. Discord being down must not prevent the state machine from functioning.
  </action>
  <verify>
    Run `npx tsc --noEmit -p apps/api/tsconfig.json` -- no type errors.
    Grep state-machine.service.ts for `getDiscordService` -- should match exactly once (the import) plus usage.
    Grep state-machine.service.ts for `sendSystemNotification` -- should match exactly once.
    Grep state-machine.service.ts for `await.*sendSystemNotification` -- should match ZERO times (must be fire-and-forget, not awaited).
    Confirm the Discord call is inside `transition()` method, not in `resetToIdle()`.
  </verify>
  <done>
    StateMachineService.transition() sends a Discord notification with exchange name, from/to states, and hostname after each valid state transition. The call is fire-and-forget with swallowed errors. resetToIdle() does not send notifications. Requirement DIFF-04 is satisfied.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit -p apps/api/tsconfig.json` passes with zero errors
- Discord notification import is from `./discord-notification.service`
- `sendSystemNotification` is called inside `transition()` only, not in `resetToIdle()`
- The call is fire-and-forget (not awaited, .catch() swallows errors)
- The notification includes exchange name, from-state, to-state, and hostname
- No Discord calls in heartbeat paths or tRPC routers
</verification>

<success_criteria>
- DIFF-04: Discord notifications fire when an instance changes state, leveraging the existing Discord notification service
- Notifications are non-blocking (fire-and-forget with swallowed errors)
- No regression: state transitions still work identically even if Discord is down or unconfigured
</success_criteria>

<output>
After completion, create `.planning/phases/33-admin-ui-network-view/33-02-SUMMARY.md`
</output>

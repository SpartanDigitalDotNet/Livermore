---
phase: 11-database-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/atlas.hcl
autonomous: true

must_haves:
  truths:
    - "Atlas can target sandbox environment via --env sandbox"
    - "Sandbox connection uses PG_SANDBOX_* environment variables"
    - "Sandbox environment has same diff protections as local (skip drop_schema)"
  artifacts:
    - path: "packages/database/atlas.hcl"
      provides: "sandbox environment configuration"
      contains: 'env "sandbox"'
  key_links:
    - from: "atlas.hcl sandbox env"
      to: "PG_SANDBOX_* env vars"
      via: "getenv() in variable block"
      pattern: "getenv.*PG_SANDBOX"
---

<objective>
Add sandbox environment to Atlas configuration for Azure PostgreSQL deployment.

Purpose: Enables Atlas schema apply to target the Azure PostgreSQL Sandbox environment using PG_SANDBOX_* environment variables.
Output: Updated `atlas.hcl` with `sandbox` environment block.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-database-workflow/11-CONTEXT.md
@packages/database/atlas.hcl
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sandbox environment to atlas.hcl</name>
  <files>packages/database/atlas.hcl</files>
  <action>
Add three new variable blocks for PG_SANDBOX_* credentials:
- `pg_sandbox_host` - string, default from `getenv("PG_SANDBOX_HOST")`
- `pg_sandbox_user` - string, default from `getenv("PG_SANDBOX_USER")`
- `pg_sandbox_password` - string, default from `getenv("PG_SANDBOX_PASSWORD")`

Add `sandbox` environment block after `production`:
- `src = "file://schema.sql"` (same as other envs)
- `url` - PostgreSQL connection string built from variables:
  `postgresql://${var.pg_sandbox_user}:${var.pg_sandbox_password}@${var.pg_sandbox_host}:5432/livermore?sslmode=require`
- `schemas = ["public"]`
- `diff` block with `skip { drop_schema = true }` (same as local)

Note: Azure PostgreSQL requires `sslmode=require` (not `disable` like local).
  </action>
  <verify>
Run: `atlas.exe schema inspect --env sandbox --url "env://url" 2>&1`
Should fail with connection error (expected - no env vars set) but NOT with config parse error.

Alternative: `atlas.exe env ls` should list: local, production, sandbox
  </verify>
  <done>
atlas.hcl contains sandbox environment with PG_SANDBOX_* variables, SSL enabled, and drop_schema protection.
  </done>
</task>

</tasks>

<verification>
- [ ] `atlas.exe env ls` shows sandbox environment
- [ ] Variables use getenv() for PG_SANDBOX_HOST, PG_SANDBOX_USER, PG_SANDBOX_PASSWORD
- [ ] Sandbox URL includes `sslmode=require` for Azure
- [ ] Diff policy skips drop_schema (same protection as local)
</verification>

<success_criteria>
Atlas configuration is ready to deploy to sandbox environment when scripts provide the environment variables.
</success_criteria>

<output>
After completion, create `.planning/phases/11-database-workflow/11-01-SUMMARY.md`
</output>

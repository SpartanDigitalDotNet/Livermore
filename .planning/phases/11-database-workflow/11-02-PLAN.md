---
phase: 11-database-workflow
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/apply-schema-sandbox.ps1
autonomous: true

must_haves:
  truths:
    - "Developer can run apply-schema-sandbox.ps1 to deploy schema to Azure"
    - "Script shows verbose output of what it's doing"
    - "Script exits with code 1 on any failure"
    - "Password is masked in output"
  artifacts:
    - path: "scripts/apply-schema-sandbox.ps1"
      provides: "Sandbox schema deployment script"
      min_lines: 20
  key_links:
    - from: "apply-schema-sandbox.ps1"
      to: "atlas.exe"
      via: "subprocess invocation with --env sandbox"
      pattern: "atlas.*--env sandbox"
---

<objective>
Create PowerShell script to deploy schema to Azure PostgreSQL Sandbox.

Purpose: Enables one-command schema deployment to Azure PostgreSQL Sandbox environment with verbose output and proper error handling.
Output: `scripts/apply-schema-sandbox.ps1` ready for execution.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-database-workflow/11-CONTEXT.md
@scripts/apply-schema.ps1
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create apply-schema-sandbox.ps1 script</name>
  <files>scripts/apply-schema-sandbox.ps1</files>
  <action>
Create PowerShell script following the existing `apply-schema.ps1` pattern with these differences:

1. Load environment variables from Windows User scope:
   - PG_SANDBOX_HOST
   - PG_SANDBOX_USER
   - PG_SANDBOX_PASSWORD

2. Validate all three variables are present (exit 1 if missing with clear error message)

3. Build connection URL:
   `postgresql://${user}:${password}@${host}:5432/livermore?sslmode=require`

4. Verbose output:
   - Print "=== Deploying Schema to Sandbox ==="
   - Print "Target: postgresql://${user}:****@${host}:5432/livermore" (password masked)
   - Print "Running Atlas schema apply..."
   - After success: Print "=== Schema deployed successfully ==="
   - After failure: Print "=== Schema deployment FAILED ===" and exit 1

5. Set DATABASE_URL env var and call atlas.exe:
   ```powershell
   $env:DATABASE_URL = $url
   Set-Location "$PSScriptRoot\..\packages\database"
   & "$PSScriptRoot\..\atlas.exe" schema apply --env sandbox --auto-approve
   ```

6. Check $LASTEXITCODE after atlas.exe - if non-zero, print failure message and exit 1

Use `$ErrorActionPreference = "Stop"` at the top for fail-fast behavior.
  </action>
  <verify>
Syntax check: `powershell -File scripts/apply-schema-sandbox.ps1 -?` should not error on parse.
Note: Full test requires actual Azure credentials.
  </verify>
  <done>
Script exists at scripts/apply-schema-sandbox.ps1 with verbose output, env var loading, password masking, and proper exit codes.
  </done>
</task>

</tasks>

<verification>
- [ ] Script loads PG_SANDBOX_* from Windows User environment
- [ ] Script validates all required variables present
- [ ] Password is masked in output (shows **** not actual password)
- [ ] Script uses --env sandbox flag with atlas.exe
- [ ] Script exits with code 1 on atlas failure
- [ ] SSL mode is require (not disable)
</verification>

<success_criteria>
Developer can run `powershell -File scripts/apply-schema-sandbox.ps1` to deploy schema to Azure PostgreSQL Sandbox (assuming credentials are configured).
</success_criteria>

<output>
After completion, create `.planning/phases/11-database-workflow/11-02-SUMMARY.md`
</output>

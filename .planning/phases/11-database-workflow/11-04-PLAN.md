---
phase: 11-database-workflow
plan: 04
type: execute
wave: 2
depends_on:
  - "11-01"
  - "11-02"
  - "11-03"
files_modified:
  - .planning/codebase/ARCHITECTURE.md
autonomous: true

must_haves:
  truths:
    - "ARCHITECTURE.md clearly states Drizzle migrations are banned"
    - "ARCHITECTURE.md documents the Atlas-first workflow"
    - "ARCHITECTURE.md explains the schema.sql -> Atlas -> Drizzle pull flow"
    - "Developer can understand the workflow from reading ARCHITECTURE.md"
  artifacts:
    - path: ".planning/codebase/ARCHITECTURE.md"
      provides: "Updated database workflow documentation"
      contains: "Drizzle migrations"
  key_links:
    - from: "ARCHITECTURE.md"
      to: "scripts/sync-schema.ps1"
      via: "documentation reference"
      pattern: "sync-schema"
    - from: "ARCHITECTURE.md"
      to: "scripts/apply-schema-sandbox.ps1"
      via: "documentation reference"
      pattern: "apply-schema-sandbox"
---

<objective>
Update ARCHITECTURE.md to document Atlas-only migrations and ban Drizzle migrations.

Purpose: Clear documentation ensures all developers understand the schema workflow and don't accidentally use Drizzle migrations.
Output: Updated `.planning/codebase/ARCHITECTURE.md` with database workflow section.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-database-workflow/11-CONTEXT.md
@.planning/codebase/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Database Layer section in ARCHITECTURE.md</name>
  <files>.planning/codebase/ARCHITECTURE.md</files>
  <action>
Update the existing "Database Layer" section and add new "Database Workflow" section.

1. Update the existing Database Layer section (around line 32-37):
   Change from:
   ```
   **Database Layer (packages/database):**
   - Purpose: PostgreSQL schema and Drizzle ORM client
   - Location: `packages/database/src/`
   - Contains: Schema definitions, migrations, client singleton
   ```
   To:
   ```
   **Database Layer (packages/database):**
   - Purpose: PostgreSQL schema (Atlas) and Drizzle ORM client (types only)
   - Location: `packages/database/src/`
   - Contains: Schema source of truth (schema.sql), generated Drizzle types, client singleton
   - Schema management: Atlas (NOT Drizzle migrations)
   ```

2. Update the "Database Migrations" entry point (around line 112-114):
   Change from:
   ```
   **Database Migrations:**
   - Location: `packages/database/src/migrate.ts`
   - Triggers: `pnpm db:migrate` (via drizzle-kit)
   - Responsibilities: Apply schema changes to PostgreSQL
   ```
   To:
   ```
   **Database Schema Management:**
   - Location: `packages/database/schema.sql` (source of truth)
   - Triggers: `sync-schema.ps1` (local), `apply-schema-sandbox.ps1` (Azure)
   - Responsibilities: Apply schema via Atlas, regenerate Drizzle types
   ```

3. Add new section after "Entry Points" section (before "Error Handling"):

```markdown
## Database Workflow

**IMPORTANT: Drizzle migrations are BANNED. Atlas is the only migration tool.**

### Why Atlas, Not Drizzle

| Concern | Atlas | Drizzle |
|---------|-------|---------|
| Schema source of truth | `schema.sql` (plain SQL) | TypeScript schema files |
| Migration style | State-based (declarative) | Change-based (imperative) |
| Diff generation | Automatic from schema | Manual migration files |
| Production safety | Built-in diff policies | Manual review required |

### Schema Change Workflow

1. **Edit `packages/database/schema.sql`** - Make schema changes in plain SQL
2. **Run `scripts/sync-schema.ps1`** (local development):
   - Atlas diffs schema.sql against local PostgreSQL
   - Atlas applies the diff
   - drizzle-kit pull regenerates TypeScript types
3. **Run `scripts/apply-schema-sandbox.ps1`** (deploy to Azure Sandbox):
   - Atlas applies schema.sql to Azure PostgreSQL
   - No Drizzle pull (Sandbox doesn't need local types)

### Scripts

| Script | Environment | Actions |
|--------|-------------|---------|
| `sync-schema.ps1` | Local | Atlas apply + Drizzle pull |
| `apply-schema-sandbox.ps1` | Azure Sandbox | Atlas apply only |
| `apply-schema.ps1` | Local | Atlas apply only (legacy) |

### Environment Variables

**Local (Windows User scope):**
- `DATABASE_HOST`, `DATABASE_PORT`
- `DATABASE_LIVERMORE_USERNAME`, `DATABASE_LIVERMORE_PASSWORD`
- `LIVERMORE_DATABASE_NAME`

**Sandbox (Windows User scope):**
- `PG_SANDBOX_HOST`, `PG_SANDBOX_USER`, `PG_SANDBOX_PASSWORD`

### Atlas Configuration

Atlas environments in `packages/database/atlas.hcl`:
- `local` - Local PostgreSQL (sslmode=disable)
- `sandbox` - Azure PostgreSQL (sslmode=require)
- `production` - Production (extra drop_table protection)

### Anti-Patterns (DO NOT)

- **DO NOT** use `drizzle-kit push` or `drizzle-kit generate`
- **DO NOT** create migration files in `packages/database/migrations/`
- **DO NOT** edit generated files in `packages/database/src/schema/`
- **DO** edit only `schema.sql` for schema changes
```

4. Update the Analysis Date at the top to current date.
  </action>
  <verify>
Read ARCHITECTURE.md and confirm:
- "Drizzle migrations are BANNED" appears in the document
- Database Workflow section exists with Atlas-first explanation
- Scripts table documents sync-schema.ps1 and apply-schema-sandbox.ps1
  </verify>
  <done>
ARCHITECTURE.md clearly documents the Atlas-only workflow, bans Drizzle migrations, and lists the deployment scripts.
  </done>
</task>

</tasks>

<verification>
- [ ] "Drizzle migrations are BANNED" is explicitly stated
- [ ] Schema change workflow is documented (edit schema.sql -> run script)
- [ ] Both scripts (sync-schema.ps1, apply-schema-sandbox.ps1) are documented
- [ ] Environment variables for both local and sandbox are listed
- [ ] Anti-patterns section lists what NOT to do
- [ ] Database Layer section updated to reflect Atlas, not Drizzle migrations
</verification>

<success_criteria>
A developer reading ARCHITECTURE.md understands:
1. Drizzle migrations are banned
2. schema.sql is the source of truth
3. Which script to run for local vs sandbox deployment
4. What environment variables are needed
</success_criteria>

<output>
After completion, create `.planning/phases/11-database-workflow/11-04-SUMMARY.md`
</output>

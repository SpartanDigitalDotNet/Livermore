---
phase: 01-data-retrieval
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/coinbase-client/src/rest/client.ts
  - spikes/fee-analysis/analyze-fees.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Running script retrieves all filled orders from Coinbase API"
    - "Script handles pagination transparently - user sees complete order count"
    - "Script displays current fee tier and 30-day volume"
  artifacts:
    - path: "packages/coinbase-client/src/rest/client.ts"
      provides: "getFilledOrders() method with pagination"
      contains: "getFilledOrders"
    - path: "spikes/fee-analysis/analyze-fees.ts"
      provides: "Standalone script demonstrating data retrieval"
      min_lines: 50
  key_links:
    - from: "spikes/fee-analysis/analyze-fees.ts"
      to: "CoinbaseRestClient.getFilledOrders()"
      via: "method call"
      pattern: "client\\.getFilledOrders\\("
    - from: "spikes/fee-analysis/analyze-fees.ts"
      to: "CoinbaseRestClient.getTransactionSummary()"
      via: "method call"
      pattern: "client\\.getTransactionSummary\\("
---

<objective>
Add filled order retrieval capability to CoinbaseRestClient and create a standalone spike script that demonstrates complete data retrieval for fee analysis.

Purpose: Enable fetching complete order history with fees for subsequent analysis phases. The script serves as both a verification tool and the foundation for Phase 2.

Output:
- Extended CoinbaseRestClient with getFilledOrders() method
- Working analyze-fees.ts spike script that retrieves and displays order/fee data
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-retrieval/01-RESEARCH.md

# Existing client implementation - follow this pattern exactly
@packages/coinbase-client/src/rest/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getFilledOrders() method to CoinbaseRestClient</name>
  <files>packages/coinbase-client/src/rest/client.ts</files>
  <action>
Add a getFilledOrders() method to CoinbaseRestClient following the exact pagination pattern from getOpenOrders() (lines 497-534).

Interface to add (near other interfaces at top of file):
```typescript
interface FilledOrdersOptions {
  productId?: string;      // Filter by trading pair (e.g., "BTC-USD")
  startDate?: string;      // RFC3339 timestamp (e.g., new Date().toISOString())
  endDate?: string;        // RFC3339 timestamp
}
```

Method implementation:
1. Copy the pagination pattern from getOpenOrders()
2. Change order_status from 'OPEN' to 'FILLED'
3. Add optional date filtering via start_date and end_date query params
4. Keep same cursor-based pagination loop
5. Log total count at end for debugging

Key differences from getOpenOrders():
- Accepts optional date range filters
- Uses 'FILLED' status instead of 'OPEN'
- May return many more results (entire trading history)

Follow existing patterns:
- Use URLSearchParams for query building
- Use `response.orders || []` for safe array access
- Check `response.has_next && response.cursor` for pagination
- Use logger.debug for success, logger.error for failures

Export the FilledOrdersOptions interface alongside existing exports.
  </action>
  <verify>
1. TypeScript compiles: `cd packages/coinbase-client && pnpm build`
2. Interface FilledOrdersOptions is exported from package
3. Method signature matches: `getFilledOrders(options?: FilledOrdersOptions): Promise<CoinbaseOrder[]>`
  </verify>
  <done>
- getFilledOrders() method exists in CoinbaseRestClient
- Method handles pagination with cursor-based loop
- Method filters by FILLED status
- Method accepts optional productId, startDate, endDate
- Package compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create analyze-fees.ts spike script</name>
  <files>spikes/fee-analysis/analyze-fees.ts, spikes/fee-analysis/package.json, spikes/fee-analysis/tsconfig.json</files>
  <action>
Create a standalone TypeScript spike script that demonstrates complete data retrieval.

Directory structure:
```
spikes/fee-analysis/
  analyze-fees.ts   # Main script
  package.json      # Dependencies
  tsconfig.json     # TypeScript config
```

package.json:
```json
{
  "name": "fee-analysis-spike",
  "private": true,
  "type": "module",
  "scripts": {
    "analyze": "npx tsx analyze-fees.ts"
  },
  "dependencies": {
    "@livermore/coinbase-client": "workspace:*",
    "tsx": "^4.19.0"
  }
}
```

tsconfig.json:
```json
{
  "extends": "../../tsconfig.base.json",
  "compilerOptions": {
    "outDir": "./dist",
    "rootDir": ".",
    "module": "ESNext",
    "moduleResolution": "bundler"
  },
  "include": ["./*.ts"]
}
```

analyze-fees.ts implementation:
1. Import CoinbaseRestClient from @livermore/coinbase-client
2. Read CDP_API_KEY_ID and CDP_PRIVATE_KEY from environment (same pattern as other scripts)
3. Create client instance
4. Fetch transaction summary and display:
   - Fee tier name (pricing_tier)
   - Current maker/taker rates
   - 30-day volume
   - 30-day fees paid
5. Fetch all filled orders using getFilledOrders()
6. Display summary:
   - Total order count
   - Date range (first to last order)
   - Unique symbols traded
7. Handle errors gracefully with clear messages

Environment variables needed (same as existing scripts):
- CDP_API_KEY_ID
- CDP_PRIVATE_KEY (PEM format, can be multiline)

Console output format:
```
=== Coinbase Fee Analysis ===

Fee Tier Information:
  Tier: Advanced Tier 1
  Maker Rate: 0.40%
  Taker Rate: 0.60%
  30-Day Volume: $12,345.67
  30-Day Fees: $74.07

Order History:
  Total Orders: 156
  Date Range: 2024-01-15 to 2025-01-18
  Symbols: BTC-USD, ETH-USD, SOL-USD (3 unique)

Data retrieval complete.
```
  </action>
  <verify>
1. Run from spike directory: `cd spikes/fee-analysis && pnpm install && pnpm analyze`
2. Script outputs fee tier information
3. Script outputs order count and date range
4. No TypeScript errors during execution
  </verify>
  <done>
- Script runs successfully with valid credentials
- Fee tier info displayed (tier name, rates, volume, fees)
- Order history summary displayed (count, date range, symbols)
- Pagination is transparent - all orders retrieved regardless of count
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Build verification:**
   ```bash
   cd packages/coinbase-client && pnpm build
   ```
   Expected: No errors

2. **Integration test:**
   ```bash
   cd spikes/fee-analysis && pnpm install && pnpm analyze
   ```
   Expected: Script runs, displays fee tier and order summary

3. **Requirements coverage:**
   - DATA-01: getFilledOrders() fetches filled orders - VERIFIED by order count in output
   - DATA-02: Pagination handled - VERIFIED by count exceeding 100 (if user has >100 orders)
   - DATA-03: Fee tier fetched - VERIFIED by tier info in output
</verification>

<success_criteria>
Phase 1 is complete when:
1. Running `pnpm analyze` in spikes/fee-analysis displays fee tier information
2. Running `pnpm analyze` displays filled order count with date range
3. Order count reflects complete history (pagination working)
4. All three DATA-* requirements have visible verification in script output
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-retrieval/01-01-SUMMARY.md`
</output>

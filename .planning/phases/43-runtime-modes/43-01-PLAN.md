---
phase: 43-runtime-modes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/schemas/src/env/config.schema.ts
  - packages/utils/src/validation/env-validator.ts
autonomous: true

must_haves:
  truths:
    - "RuntimeMode type exists with 'exchange' and 'pw-host' values"
    - "resolveMode() reads LIVERMORE_MODE env var and defaults to 'exchange'"
    - "resolveMode() throws on invalid mode values"
    - "PwHostEnvConfigSchema omits Coinbase, Clerk, and Discord fields"
    - "validateEnv() accepts a RuntimeMode parameter and uses the correct schema"
    - "Exchange mode env validation still requires all existing fields"
  artifacts:
    - path: "packages/schemas/src/env/config.schema.ts"
      provides: "RuntimeMode type, PwHostEnvConfigSchema, resolveMode function"
      contains: "PwHostEnvConfigSchema"
    - path: "packages/utils/src/validation/env-validator.ts"
      provides: "Mode-aware validateEnv function"
      contains: "resolveMode"
  key_links:
    - from: "packages/utils/src/validation/env-validator.ts"
      to: "packages/schemas/src/env/config.schema.ts"
      via: "import PwHostEnvConfigSchema, resolveMode, RuntimeMode"
      pattern: "import.*PwHostEnvConfigSchema.*from.*@livermore/schemas"
---

<objective>
Create the RuntimeMode type system, mode-aware environment validation schemas, and resolveMode() function that forms the foundation for pw-host mode startup branching.

Purpose: MODE-01 requires LIVERMORE_MODE env var to control runtime mode. The env validation must be mode-aware because pw-host instances don't need Coinbase API keys, Clerk secrets, or Discord webhooks. Without this, pw-host instances can't start (Zod validation crashes on missing exchange credentials).

Output: RuntimeMode type, resolveMode() function, PwHostEnvConfigSchema (omits exchange/Clerk/Discord fields), updated validateEnv() that accepts mode parameter.
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/43-runtime-modes/43-RESEARCH.md

@packages/schemas/src/env/config.schema.ts
@packages/utils/src/validation/env-validator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add RuntimeMode type, resolveMode(), and PwHostEnvConfigSchema</name>
  <files>packages/schemas/src/env/config.schema.ts</files>
  <action>
  Add the following to `config.schema.ts`:

  1. **RuntimeMode type** at the top of the file (after imports):
     ```typescript
     export type RuntimeMode = 'exchange' | 'pw-host';
     ```

  2. **resolveMode() function** that reads `LIVERMORE_MODE` from process.env:
     ```typescript
     export function resolveMode(): RuntimeMode {
       const raw = process.env.LIVERMORE_MODE?.toLowerCase() ?? 'exchange';
       if (raw !== 'exchange' && raw !== 'pw-host') {
         throw new Error(`Invalid LIVERMORE_MODE: '${raw}'. Must be 'exchange' or 'pw-host'.`);
       }
       return raw;
     }
     ```
     This must be called BEFORE validateEnv() so the correct schema is used.

  3. **PwHostEnvConfigSchema** derived from EnvConfigSchema using Zod `.omit()`:
     ```typescript
     export const PwHostEnvConfigSchema = EnvConfigSchema.omit({
       Coinbase_ApiKeyId: true,
       Coinbase_EcPrivateKeyPem: true,
       CLERK_PUBLISHABLE_KEY: true,
       CLERK_SECRET_KEY: true,
       CLERK_WEBHOOK_SIGNING_SECRET: true,
       DISCORD_LIVERMORE_BOT: true,
     });
     ```
     This keeps all shared fields (API_HOST, API_PORT, DATABASE_*, LIVERMORE_REDIS_*) while removing exchange-specific fields.

  4. **PwHostEnvConfig type** export:
     ```typescript
     export type PwHostEnvConfig = z.infer<typeof PwHostEnvConfigSchema>;
     ```

  5. **Export resolveMode, RuntimeMode, PwHostEnvConfigSchema, and PwHostEnvConfig** from the schemas package index. Check `packages/schemas/src/index.ts` for the barrel export and add the new exports.

  Do NOT modify the existing EnvConfigSchema -- exchange mode validation must remain unchanged.
  </action>
  <verify>
  Run `npx tsc --noEmit -p packages/schemas/tsconfig.json` -- should compile without errors.
  Verify PwHostEnvConfigSchema does not contain Coinbase_ApiKeyId, Coinbase_EcPrivateKeyPem, CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY, DISCORD_LIVERMORE_BOT by inspecting the schema shape.
  </verify>
  <done>RuntimeMode type, resolveMode() function, PwHostEnvConfigSchema, and PwHostEnvConfig type all exist and are exported from @livermore/schemas. resolveMode() defaults to 'exchange' and throws on invalid values.</done>
</task>

<task type="auto">
  <name>Task 2: Make validateEnv() mode-aware</name>
  <files>packages/utils/src/validation/env-validator.ts</files>
  <action>
  Update `validateEnv()` in `env-validator.ts` to accept a `RuntimeMode` parameter and use the correct schema:

  1. **Import** the new types and schema:
     ```typescript
     import { EnvConfigSchema, PwHostEnvConfigSchema, type EnvConfig, type PwHostEnvConfig, type RuntimeMode } from '@livermore/schemas';
     ```

  2. **Update function signature** to accept mode with overloads for type safety:
     ```typescript
     export function validateEnv(mode?: 'exchange'): EnvConfig;
     export function validateEnv(mode: 'pw-host'): PwHostEnvConfig;
     export function validateEnv(mode: RuntimeMode = 'exchange'): EnvConfig | PwHostEnvConfig {
       try {
         const schema = mode === 'pw-host' ? PwHostEnvConfigSchema : EnvConfigSchema;
         const config = schema.parse(process.env);
         logger.info({ mode }, 'Environment variables validated successfully');
         return config;
       } catch (error) {
         logger.error('Invalid environment variables:');
         logger.error({ err: error instanceof Error ? error.message : String(error) });
         logger.error(
           'Please ensure all required environment variables are set. See documentation for details.'
         );
         process.exit(1);
       }
     }
     ```

  3. **Re-export resolveMode** from utils index for convenience. Check `packages/utils/src/index.ts` and add `export { resolveMode } from '@livermore/schemas';` if not already re-exported.

  The existing call signature `validateEnv()` (no args) continues to work exactly as before -- defaults to 'exchange' mode and returns EnvConfig.
  </action>
  <verify>
  Run `npx tsc --noEmit -p packages/utils/tsconfig.json` -- should compile without errors.
  Run `npx tsc --noEmit -p apps/api/tsconfig.json` -- existing server.ts call `validateEnv()` must still compile (backward compatible).
  </verify>
  <done>validateEnv() accepts optional RuntimeMode parameter. When called with no args or 'exchange', validates all fields (backward compatible). When called with 'pw-host', omits exchange/Clerk/Discord fields. TypeScript overloads provide correct return types for each mode.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/schemas/tsconfig.json` passes
2. `npx tsc --noEmit -p packages/utils/tsconfig.json` passes
3. `npx tsc --noEmit -p apps/api/tsconfig.json` passes (backward compatible)
4. resolveMode() returns 'exchange' when LIVERMORE_MODE is unset
5. resolveMode() throws when LIVERMORE_MODE is set to an invalid value
6. PwHostEnvConfigSchema does not contain Coinbase, Clerk, or Discord fields
</verification>

<success_criteria>
- RuntimeMode type exported from @livermore/schemas
- resolveMode() exported and callable before validateEnv()
- PwHostEnvConfigSchema validates only shared + DB + Redis + API fields
- validateEnv('pw-host') uses PwHostEnvConfigSchema
- validateEnv() with no args is backward compatible (returns EnvConfig)
- All three packages compile without errors
</success_criteria>

<output>
After completion, create `.planning/phases/43-runtime-modes/43-01-SUMMARY.md`
</output>

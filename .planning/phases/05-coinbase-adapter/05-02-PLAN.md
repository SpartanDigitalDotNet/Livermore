---
phase: 05-coinbase-adapter
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/coinbase-client/src/adapter/coinbase-adapter.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Candle messages are normalized to UnifiedCandle schema"
    - "Candles are written to Redis cache using addCandleIfNewer()"
    - "candle:close event is emitted when candle timestamp changes"
    - "candle:close is published to Redis pub/sub channel"
  artifacts:
    - path: "packages/coinbase-client/src/adapter/coinbase-adapter.ts"
      provides: "Full candle processing pipeline"
      contains: "addCandleIfNewer"
      min_lines: 200
  key_links:
    - from: "packages/coinbase-client/src/adapter/coinbase-adapter.ts"
      to: "packages/cache/src/strategies/candle-cache.ts"
      via: "addCandleIfNewer call"
      pattern: "this\\.candleCache\\.addCandleIfNewer"
    - from: "packages/coinbase-client/src/adapter/coinbase-adapter.ts"
      to: "Redis pub/sub"
      via: "candleCloseChannel publish"
      pattern: "this\\.redis\\.publish.*candleCloseChannel"
    - from: "packages/coinbase-client/src/adapter/coinbase-adapter.ts"
      to: "EventEmitter"
      via: "emit candle:close"
      pattern: "this\\.emit\\('candle:close'"
---

<objective>
Implement candle processing pipeline: normalize, detect close, write to cache, emit events.

Purpose: Transform raw Coinbase candle messages into UnifiedCandle format, detect when candles close, persist to Redis cache, and notify subscribers via both EventEmitter and Redis pub/sub.

Output: Complete candle processing from WebSocket message to cache and events.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 04 foundation
@.planning/phases/04-foundation/04-02-SUMMARY.md

# Phase 05 Plan 01 (adapter skeleton)
@.planning/phases/05-coinbase-adapter/05-01-SUMMARY.md

# Research - message formats, normalization, pitfalls
@.planning/phases/05-coinbase-adapter/05-RESEARCH.md

# Existing code
@packages/coinbase-client/src/adapter/coinbase-adapter.ts
@packages/cache/src/strategies/candle-cache.ts
@packages/cache/src/keys.ts
@packages/schemas/src/adapter/exchange-adapter.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add candle message type definitions</name>
  <files>packages/coinbase-client/src/adapter/coinbase-adapter.ts</files>
  <action>
Add TypeScript interfaces for Coinbase WebSocket candle messages at the top of the file (after imports):

```typescript
/**
 * Coinbase candle from WebSocket candles channel
 * Note: All values are strings, timestamps are UNIX seconds
 */
interface CoinbaseWebSocketCandle {
  start: string;      // UNIX timestamp in SECONDS
  high: string;
  low: string;
  open: string;
  close: string;
  volume: string;
  product_id: string;
}

/**
 * Candle event from Coinbase WebSocket
 */
interface CandleEvent {
  type: 'snapshot' | 'update';
  candles: CoinbaseWebSocketCandle[];
}

/**
 * Candles channel message from Coinbase WebSocket
 */
interface CandlesMessage {
  channel: 'candles';
  client_id: string;
  timestamp: string;
  sequence_num: number;
  events: CandleEvent[];
}

/**
 * Heartbeats channel message from Coinbase WebSocket
 */
interface HeartbeatsMessage {
  channel: 'heartbeats';
  client_id: string;
  timestamp: string;
  sequence_num: number;
  events: Array<{
    current_time: string;
    heartbeat_counter: string;
  }>;
}

/**
 * All possible WebSocket message types
 */
type CoinbaseWSMessage =
  | CandlesMessage
  | HeartbeatsMessage
  | { channel: 'subscriptions'; events: Array<{ subscriptions: Record<string, string[]> }> }
  | { channel: 'error'; message: string };
```
  </action>
  <verify>
```bash
npx tsc --noEmit -p packages/coinbase-client/tsconfig.json
```
Should compile without errors.
  </verify>
  <done>
Type definitions for Coinbase WebSocket messages exist in coinbase-adapter.ts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement candle normalization and close detection</name>
  <files>packages/coinbase-client/src/adapter/coinbase-adapter.ts</files>
  <action>
Add private field to track last candle timestamps for close detection:
```typescript
// Add to private fields
private lastCandleTimestamps = new Map<string, number>();
```

Add normalization method:
```typescript
/**
 * Normalize Coinbase WebSocket candle to UnifiedCandle format
 */
private normalizeCandle(candle: CoinbaseWebSocketCandle, sequenceNum: number): UnifiedCandle {
  return {
    timestamp: parseInt(candle.start, 10) * 1000, // Convert seconds to milliseconds
    open: parseFloat(candle.open),
    high: parseFloat(candle.high),
    low: parseFloat(candle.low),
    close: parseFloat(candle.close),
    volume: parseFloat(candle.volume),
    symbol: candle.product_id,
    timeframe: '5m',  // Coinbase WebSocket candles are always 5m
    exchange: 'coinbase',
    sequenceNum,
  };
}
```

Add candle processing method:
```typescript
/**
 * Process incoming candle messages
 * Detects candle close by comparing timestamps
 */
private async handleCandlesMessage(message: CandlesMessage): Promise<void> {
  const sequenceNum = message.sequence_num;

  for (const event of message.events) {
    for (const rawCandle of event.candles) {
      const candle = this.normalizeCandle(rawCandle, sequenceNum);
      const symbol = candle.symbol;
      const previousTimestamp = this.lastCandleTimestamps.get(symbol);

      // Detect candle close: timestamp changed means previous candle closed
      if (previousTimestamp !== undefined && previousTimestamp !== candle.timestamp) {
        // Previous candle just closed - emit close event for it
        // Note: We emit for the NEW candle (which contains the finalized OHLCV)
        // because Coinbase sends the new candle when the old one closes
        await this.onCandleClose(candle);
      }

      // Update tracking
      this.lastCandleTimestamps.set(symbol, candle.timestamp);

      // Always write to cache (addCandleIfNewer handles versioning)
      try {
        await this.candleCache.addCandleIfNewer(
          this.userIdNum,
          this.exchangeIdNum,
          candle
        );
      } catch (error) {
        logger.error({ error, symbol, timestamp: candle.timestamp }, 'Failed to write candle to cache');
      }
    }
  }
}
```

Add candle close handler:
```typescript
/**
 * Handle candle close event
 * Writes to cache, publishes to Redis, emits event
 */
private async onCandleClose(candle: UnifiedCandle): Promise<void> {
  logger.debug(
    { symbol: candle.symbol, timestamp: new Date(candle.timestamp).toISOString() },
    'Candle closed'
  );

  // Emit typed event for local subscribers
  this.emit('candle:close', candle);

  // Publish to Redis pub/sub for distributed subscribers (indicator service)
  try {
    const channel = candleCloseChannel(
      this.userIdNum,
      this.exchangeIdNum,
      candle.symbol,
      candle.timeframe
    );
    await this.redis.publish(channel, JSON.stringify(candle));
  } catch (error) {
    logger.error({ error, symbol: candle.symbol }, 'Failed to publish candle:close to Redis');
  }
}
```

**Important:** Rename constructor parameters to avoid confusion:
- `userId` parameter -> `userIdNum` field (numeric, for cache keys)
- `exchangeId` parameter -> `exchangeIdNum` field (numeric, for cache keys)
- Keep `exchangeId` as string 'coinbase' (from BaseExchangeAdapter abstract property)
  </action>
  <verify>
```bash
npx tsc --noEmit -p packages/coinbase-client/tsconfig.json
```
  </verify>
  <done>
normalizeCandle() converts Coinbase format to UnifiedCandle. handleCandlesMessage() processes messages and detects close. onCandleClose() emits events and publishes to Redis.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update handleMessage to route to candle processor</name>
  <files>packages/coinbase-client/src/adapter/coinbase-adapter.ts</files>
  <action>
Update the handleMessage method to properly route messages:

```typescript
private handleMessage(data: WebSocket.Data): void {
  try {
    const message = JSON.parse(data.toString()) as CoinbaseWSMessage;

    // Log subscription confirmations
    if (message.channel === 'subscriptions') {
      logger.info({ events: message.events }, 'Subscription confirmed');
      return;
    }

    // Log errors
    if (message.channel === 'error') {
      logger.error({ error: message.message }, 'WebSocket error message');
      return;
    }

    // Handle candles - fire and forget to avoid blocking
    if (message.channel === 'candles') {
      this.handleCandlesMessage(message as CandlesMessage).catch(error => {
        logger.error({ error }, 'Error processing candles message');
      });
      return;
    }

    // Handle heartbeats - just log at debug level for now
    if (message.channel === 'heartbeats') {
      logger.debug({ counter: (message as HeartbeatsMessage).events[0]?.heartbeat_counter }, 'Heartbeat received');
      return;
    }

    // Unknown channel
    logger.warn({ channel: (message as { channel: string }).channel }, 'Unknown WebSocket channel');
  } catch (error) {
    logger.error({ error, data: data.toString() }, 'Failed to parse WebSocket message');
  }
}
```

Note: The candle processing is fire-and-forget (`.catch()` at the end) to avoid blocking the message handler. Errors are logged but don't stop processing of subsequent messages.
  </action>
  <verify>
```bash
npx tsc --noEmit -p packages/coinbase-client/tsconfig.json
```
  </verify>
  <done>
handleMessage routes candles to handleCandlesMessage, heartbeats are logged, subscription confirmations are logged, errors are handled. Processing is non-blocking.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compilation succeeds:
   ```bash
   npx tsc --noEmit -p packages/coinbase-client/tsconfig.json
   ```

2. Key methods exist:
   ```bash
   grep "normalizeCandle" packages/coinbase-client/src/adapter/coinbase-adapter.ts
   grep "handleCandlesMessage" packages/coinbase-client/src/adapter/coinbase-adapter.ts
   grep "onCandleClose" packages/coinbase-client/src/adapter/coinbase-adapter.ts
   ```

3. Cache integration exists:
   ```bash
   grep "addCandleIfNewer" packages/coinbase-client/src/adapter/coinbase-adapter.ts
   ```

4. Redis pub/sub integration exists:
   ```bash
   grep "candleCloseChannel" packages/coinbase-client/src/adapter/coinbase-adapter.ts
   ```
</verification>

<success_criteria>
- [x] CoinbaseWebSocketCandle and CandlesMessage types defined
- [x] normalizeCandle() converts Coinbase format to UnifiedCandle
- [x] Timestamps converted from seconds to milliseconds
- [x] handleCandlesMessage() detects candle close via timestamp change
- [x] Candles written to cache using addCandleIfNewer()
- [x] candle:close event emitted on EventEmitter
- [x] candle:close published to Redis pub/sub channel
- [x] Error handling prevents message processing from blocking
- [x] TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-coinbase-adapter/05-02-SUMMARY.md`
</output>

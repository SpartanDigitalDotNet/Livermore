---
phase: 05-coinbase-adapter
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/coinbase-client/src/adapter/coinbase-adapter.ts
  - packages/coinbase-client/src/adapter/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "CoinbaseAdapter connects to wss://advanced-trade-ws.coinbase.com"
    - "Adapter subscribes to candles channel with product_ids"
    - "Adapter subscribes to heartbeats channel on connection"
    - "Adapter emits 'connected' event after successful connection"
  artifacts:
    - path: "packages/coinbase-client/src/adapter/coinbase-adapter.ts"
      provides: "CoinbaseAdapter class extending BaseExchangeAdapter"
      exports: ["CoinbaseAdapter"]
      min_lines: 100
    - path: "packages/coinbase-client/src/adapter/index.ts"
      provides: "Barrel export including CoinbaseAdapter"
      contains: "CoinbaseAdapter"
  key_links:
    - from: "packages/coinbase-client/src/adapter/coinbase-adapter.ts"
      to: "packages/coinbase-client/src/adapter/base-adapter.ts"
      via: "extends BaseExchangeAdapter"
      pattern: "extends BaseExchangeAdapter"
    - from: "packages/coinbase-client/src/adapter/coinbase-adapter.ts"
      to: "ws"
      via: "WebSocket constructor"
      pattern: "new WebSocket"
---

<objective>
Implement CoinbaseAdapter skeleton with WebSocket connection and dual channel subscription.

Purpose: Create the foundation for the Coinbase adapter that connects to the native candles WebSocket channel and subscribes to heartbeats to prevent idle disconnection.

Output: CoinbaseAdapter class that can connect, subscribe to candles/heartbeats, and handle basic lifecycle.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 04 foundation (interfaces, base class)
@.planning/phases/04-foundation/04-01-SUMMARY.md
@.planning/phases/04-foundation/04-03-SUMMARY.md

# Research - WebSocket message formats, subscription patterns
@.planning/phases/05-coinbase-adapter/05-RESEARCH.md

# Existing code
@packages/coinbase-client/src/adapter/base-adapter.ts
@packages/coinbase-client/src/websocket/client.ts
@packages/coinbase-client/src/rest/auth.ts
@packages/schemas/src/adapter/exchange-adapter.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CoinbaseAdapter class skeleton</name>
  <files>packages/coinbase-client/src/adapter/coinbase-adapter.ts</files>
  <action>
Create CoinbaseAdapter class that extends BaseExchangeAdapter:

1. **Imports:**
   - `BaseExchangeAdapter` from ./base-adapter
   - `WebSocket` from 'ws'
   - `CoinbaseAuth` from '../rest/auth'
   - `CoinbaseRestClient` from '../rest/client'
   - `CandleCacheStrategy, candleCloseChannel` from '@livermore/cache'
   - `Redis` from 'ioredis'
   - `Timeframe, UnifiedCandle` from '@livermore/schemas'
   - `logger` from '@livermore/utils'

2. **Constructor parameters:**
   ```typescript
   interface CoinbaseAdapterOptions {
     apiKeyId: string;
     privateKeyPem: string;
     redis: Redis;
     userId: number;
     exchangeId: number;
   }
   ```

3. **Private fields:**
   - `ws: WebSocket | null = null`
   - `auth: CoinbaseAuth`
   - `restClient: CoinbaseRestClient`
   - `candleCache: CandleCacheStrategy`
   - `redis: Redis`
   - `userId: number`
   - `exchangeId: number`
   - `subscribedSymbols: string[] = []`
   - `subscribedTimeframe: Timeframe = '5m'`
   - `isIntentionalClose = false`
   - `WS_URL = 'wss://advanced-trade-ws.coinbase.com'`

4. **Protected abstract implementation:**
   - `readonly exchangeId = 'coinbase'` (string, not the numeric exchangeId from options)

5. **Implement connect():**
   ```typescript
   async connect(): Promise<void> {
     return new Promise((resolve, reject) => {
       this.isIntentionalClose = false;
       this.ws = new WebSocket(this.WS_URL);

       this.ws.on('open', () => {
         logger.info({ exchangeId: this.exchangeId }, 'Connected to Coinbase WebSocket');
         this.resetReconnectAttempts();
         this.subscribeToHeartbeats();
         this.emit('connected');
         resolve();
       });

       this.ws.on('message', (data: WebSocket.Data) => {
         this.handleMessage(data);
       });

       this.ws.on('error', (error) => {
         logger.error({ error, exchangeId: this.exchangeId }, 'WebSocket error');
         this.emit('error', error);
         reject(error);
       });

       this.ws.on('close', (code, reason) => {
         logger.warn({ code, reason: reason.toString(), exchangeId: this.exchangeId }, 'WebSocket closed');
         this.emit('disconnected', reason.toString() || `Code: ${code}`);
         if (!this.isIntentionalClose) {
           this.handleReconnect();
         }
       });
     });
   }
   ```

6. **Implement disconnect():**
   ```typescript
   disconnect(): void {
     this.isIntentionalClose = true;
     if (this.ws) {
       this.ws.close();
       this.ws = null;
     }
     logger.info({ exchangeId: this.exchangeId }, 'Disconnected from Coinbase WebSocket');
   }
   ```

7. **Implement isConnected():**
   ```typescript
   isConnected(): boolean {
     return this.ws !== null && this.ws.readyState === WebSocket.OPEN;
   }
   ```

8. **Implement subscribe():**
   ```typescript
   subscribe(symbols: string[], timeframe: Timeframe): void {
     if (!this.isConnected()) {
       throw new Error('Cannot subscribe: WebSocket not connected');
     }

     // Coinbase WebSocket only supports 5m candles
     if (timeframe !== '5m') {
       logger.warn({ timeframe }, 'Coinbase WebSocket only supports 5m candles, using 5m');
     }

     this.subscribedSymbols = symbols;
     this.subscribedTimeframe = '5m';

     const token = this.auth.generateToken();
     const subscribeMessage = {
       type: 'subscribe',
       product_ids: symbols,
       channel: 'candles',
       jwt: token,
     };

     this.ws!.send(JSON.stringify(subscribeMessage));
     logger.info({ symbols, channel: 'candles' }, 'Subscribed to candles channel');
   }
   ```

9. **Implement unsubscribe():**
   ```typescript
   unsubscribe(symbols: string[], timeframe: Timeframe): void {
     if (!this.isConnected()) return;

     const token = this.auth.generateToken();
     const unsubscribeMessage = {
       type: 'unsubscribe',
       product_ids: symbols,
       channel: 'candles',
       jwt: token,
     };

     this.ws!.send(JSON.stringify(unsubscribeMessage));
     this.subscribedSymbols = this.subscribedSymbols.filter(s => !symbols.includes(s));
     logger.info({ symbols, channel: 'candles' }, 'Unsubscribed from candles channel');
   }
   ```

10. **Private helper - subscribeToHeartbeats():**
    ```typescript
    private subscribeToHeartbeats(): void {
      if (!this.isConnected()) return;

      const token = this.auth.generateToken();
      const subscribeMessage = {
        type: 'subscribe',
        channel: 'heartbeats',
        jwt: token,
      };

      this.ws!.send(JSON.stringify(subscribeMessage));
      logger.info('Subscribed to heartbeats channel');
    }
    ```

11. **Private placeholder - handleMessage():**
    ```typescript
    private handleMessage(data: WebSocket.Data): void {
      try {
        const message = JSON.parse(data.toString());

        // Log subscription confirmations
        if (message.channel === 'subscriptions') {
          logger.info({ events: message.events }, 'Subscription confirmed');
          return;
        }

        // Log errors
        if (message.channel === 'error') {
          logger.error({ error: message.message }, 'WebSocket error message');
          return;
        }

        // TODO: Handle candles and heartbeats in Plan 02
        logger.debug({ channel: message.channel }, 'Received message');
      } catch (error) {
        logger.error({ error, data: data.toString() }, 'Failed to parse WebSocket message');
      }
    }
    ```

Note: Name the numeric exchangeId as `exchangeIdNum` internally to avoid conflict with the string `exchangeId` from BaseExchangeAdapter.
  </action>
  <verify>
Run TypeScript compilation:
```bash
npx tsc --noEmit -p packages/coinbase-client/tsconfig.json
```
Should compile without errors.
  </verify>
  <done>
CoinbaseAdapter class exists with all IExchangeAdapter methods implemented. Class extends BaseExchangeAdapter and can connect to Coinbase WebSocket, subscribe to candles and heartbeats channels.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update barrel export and verify imports</name>
  <files>packages/coinbase-client/src/adapter/index.ts</files>
  <action>
Update the adapter barrel export to include CoinbaseAdapter:

```typescript
export { BaseExchangeAdapter } from './base-adapter';
export { CoinbaseAdapter } from './coinbase-adapter';
export type { CoinbaseAdapterOptions } from './coinbase-adapter';
```

Verify that the main package index (src/index.ts) already re-exports from adapter/index.ts.
  </action>
  <verify>
```bash
# Verify compilation
npx tsc --noEmit -p packages/coinbase-client/tsconfig.json

# Verify CoinbaseAdapter is exported
grep -l "CoinbaseAdapter" packages/coinbase-client/src/adapter/index.ts
```
  </verify>
  <done>
CoinbaseAdapter is exported from @livermore/coinbase-client package. Import `{ CoinbaseAdapter }` from '@livermore/coinbase-client' works.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. TypeScript compilation succeeds:
   ```bash
   npx tsc --noEmit -p packages/coinbase-client/tsconfig.json
   ```

2. CoinbaseAdapter exists and extends BaseExchangeAdapter:
   ```bash
   grep "extends BaseExchangeAdapter" packages/coinbase-client/src/adapter/coinbase-adapter.ts
   ```

3. Exports are correct:
   ```bash
   grep "CoinbaseAdapter" packages/coinbase-client/src/adapter/index.ts
   ```
</verification>

<success_criteria>
- [x] CoinbaseAdapter class extends BaseExchangeAdapter
- [x] connect() establishes WebSocket connection to wss://advanced-trade-ws.coinbase.com
- [x] connect() subscribes to heartbeats channel automatically
- [x] connect() emits 'connected' event on success
- [x] subscribe() sends subscription message for candles channel
- [x] unsubscribe() sends unsubscription message
- [x] disconnect() gracefully closes connection
- [x] isConnected() returns correct connection state
- [x] handleMessage() stub processes incoming messages
- [x] CoinbaseAdapter exported from @livermore/coinbase-client
- [x] TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/05-coinbase-adapter/05-01-SUMMARY.md`
</output>

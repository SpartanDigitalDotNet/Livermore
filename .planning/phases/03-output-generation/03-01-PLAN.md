---
phase: 03-output-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spikes/fee-analysis/analyze-fees.ts
autonomous: true

must_haves:
  truths:
    - "Running script creates markdown file in spikes/fee-analysis/reports/"
    - "Markdown report includes fee tier section with tier name, rates, and 30-day volume"
    - "Markdown report includes all three analysis tables (symbol, side, monthly)"
    - "Console still displays all formatted tables (existing behavior preserved)"
  artifacts:
    - path: "spikes/fee-analysis/analyze-fees.ts"
      provides: "Markdown generation and file save"
      exports: []
      contains: "generateReport"
    - path: "spikes/fee-analysis/reports/fee-analysis-*.md"
      provides: "Generated markdown report"
      min_lines: 50
  key_links:
    - from: "analyze-fees.ts main()"
      to: "generateReport()"
      via: "function call with data"
      pattern: "generateReport\\("
    - from: "analyze-fees.ts main()"
      to: "saveReport()"
      via: "async file write"
      pattern: "saveReport\\("
---

<objective>
Add markdown report generation to the fee analysis spike

Purpose: Complete Phase 3 requirements by generating a markdown file containing all fee analysis results, with fee tier info in the header, suitable for reference and sharing.

Output:
- Updated analyze-fees.ts with markdown generation functions
- Running the script creates spikes/fee-analysis/reports/fee-analysis-{date}.md
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-output-generation/03-RESEARCH.md

# Source file to modify
@spikes/fee-analysis/analyze-fees.ts
@spikes/fee-analysis/calculations.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add markdown generation functions</name>
  <files>spikes/fee-analysis/analyze-fees.ts</files>
  <action>
Add the following functions to analyze-fees.ts (after the existing display functions, before main()):

1. `generateMarkdownTable(headers: string[], rows: string[][], alignments?: ('left' | 'right')[]): string`
   - Generic markdown table generator
   - Returns markdown string with | delimiters and --- separator
   - Alignments: 'right' produces `---:`, 'left' produces `---`
   - Used by the specific table generators below

2. `generateSymbolTable(reports: SymbolFeeReport[]): string`
   - Headers: Symbol, Total Fees, Total Volume, Eff Rate, Avg Fee, Orders
   - Alignments: left, right, right, right, right, right
   - Include totals row at bottom
   - Format values using existing formatCurrency/formatPercent helpers

3. `generateSideTable(reports: SideFeeReport[]): string`
   - Headers: Symbol, Side, Total Fees, Total Volume, Eff Rate, Orders
   - Alignments: left, left, right, right, right, right
   - No grouping spacing needed in markdown (unlike console)

4. `generateMonthlyTable(reports: MonthlyFeeReport[]): string`
   - Headers: Month, Total Fees, Total Volume, Eff Rate, Orders
   - Alignments: left, right, right, right, right
   - Include totals row at bottom

5. `generateReport(data: { feeTier: TransactionSummary; symbolFees: SymbolFeeReport[]; sideFees: SideFeeReport[]; monthlyFees: MonthlyFeeReport[]; dateRange: { earliest: string; latest: string } | null; orderCount: number; }): string`
   - Assembles complete markdown report
   - Structure:
     ```
     # Coinbase Fee Analysis Report

     **Generated:** {YYYY-MM-DD}
     **Data Range:** {earliest} to {latest}
     **Total Orders:** {count}

     ## Current Fee Tier

     | Property | Value |
     |----------|-------|
     | Tier | {pricing_tier} |
     | Maker Rate | {maker_fee_rate as %} |
     | Taker Rate | {taker_fee_rate as %} |
     | 30-Day Volume | {advanced_trade_only_volume as $} |
     | 30-Day Fees | {advanced_trade_only_fees as $} |

     ## Fee Analysis by Symbol

     {generateSymbolTable output}

     ## Buy vs Sell Comparison

     {generateSideTable output}

     ## Monthly Breakdown

     {generateMonthlyTable output}
     ```

Note: Import `TransactionSummary` type from @livermore/coinbase-client if not already imported. Check the existing import statement and add it there.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd spikes/fee-analysis && pnpm tsc --noEmit
```
  </verify>
  <done>
- generateMarkdownTable helper function exists
- generateSymbolTable, generateSideTable, generateMonthlyTable functions exist
- generateReport function assembles complete report with fee tier header
- TypeScript compiles successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add file save and integrate into main()</name>
  <files>spikes/fee-analysis/analyze-fees.ts</files>
  <action>
1. Add imports at top of file:
   ```typescript
   import { writeFile, mkdir } from 'node:fs/promises';
   import { join, dirname } from 'node:path';
   import { fileURLToPath } from 'node:url';
   ```

2. Add saveReport function:
   ```typescript
   async function saveReport(content: string): Promise<string> {
     // Get directory of current file (ESM compatible)
     const __dirname = dirname(fileURLToPath(import.meta.url));
     const reportDir = join(__dirname, 'reports');

     // Create reports directory if needed
     await mkdir(reportDir, { recursive: true });

     // Generate timestamped filename
     const date = new Date().toISOString().split('T')[0];
     const filename = `fee-analysis-${date}.md`;
     const filepath = join(reportDir, filename);

     await writeFile(filepath, content, 'utf-8');
     return filepath;
   }
   ```

3. Update main() function to generate and save report:
   - After the existing console display calls (after `displayMonthlyFees(monthlyFees);`)
   - Add report generation and save:
   ```typescript
   // Generate markdown report
   console.log('\nGenerating markdown report...');
   const reportContent = generateReport({
     feeTier: summary,
     symbolFees,
     sideFees,
     monthlyFees,
     dateRange,
     orderCount: orders.length,
   });

   const reportPath = await saveReport(reportContent);
   console.log(`Report saved: ${reportPath}`);
   ```
   - Update the final console.log from "Fee analysis complete." to "Fee analysis complete. Report saved."
  </action>
  <verify>
1. TypeScript compiles:
   ```bash
   cd spikes/fee-analysis && pnpm tsc --noEmit
   ```

2. Run the script and verify report is created:
   ```bash
   cd spikes/fee-analysis && pnpm analyze
   ```
   Should see "Report saved: .../reports/fee-analysis-{date}.md"

3. Verify report file exists and has expected content:
   ```bash
   ls spikes/fee-analysis/reports/
   head -30 spikes/fee-analysis/reports/fee-analysis-*.md
   ```
  </verify>
  <done>
- saveReport function writes to spikes/fee-analysis/reports/
- main() calls generateReport() and saveReport()
- Running `pnpm analyze` creates markdown file
- Report contains fee tier header section
- Report contains all three analysis tables
  </done>
</task>

</tasks>

<verification>
1. **Console output preserved (OUT-01):**
   - Run `pnpm analyze` in spikes/fee-analysis
   - Verify console still shows all three formatted tables

2. **Markdown file created (OUT-02):**
   - Check spikes/fee-analysis/reports/ contains fee-analysis-{date}.md
   - Open file and verify markdown renders correctly (tables, headers)

3. **Fee tier in report header (OUT-03):**
   - Open generated markdown file
   - Verify "Current Fee Tier" section exists with tier name, rates, 30-day volume
</verification>

<success_criteria>
- [ ] Running `pnpm analyze` displays console output AND creates markdown file
- [ ] Markdown file located at spikes/fee-analysis/reports/fee-analysis-{YYYY-MM-DD}.md
- [ ] Report header includes fee tier table (tier name, maker rate, taker rate, 30-day volume, 30-day fees)
- [ ] Report contains Symbol Summary table with totals row
- [ ] Report contains Buy vs Sell table
- [ ] Report contains Monthly Breakdown table with totals row
- [ ] All tables render correctly as markdown (proper | delimiters, --- separators)
</success_criteria>

<output>
After completion, create `.planning/phases/03-output-generation/03-01-SUMMARY.md`
</output>

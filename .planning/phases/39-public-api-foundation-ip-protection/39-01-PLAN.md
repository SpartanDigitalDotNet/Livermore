---
phase: 39-public-api-foundation-ip-protection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/public-api/package.json
  - packages/public-api/tsconfig.json
  - packages/public-api/src/index.ts
  - packages/public-api/src/schemas/envelope.schema.ts
  - packages/public-api/src/schemas/candle.schema.ts
  - packages/public-api/src/schemas/exchange.schema.ts
  - packages/public-api/src/schemas/symbol.schema.ts
  - packages/public-api/src/schemas/error.schema.ts
  - packages/public-api/src/schemas/index.ts
  - packages/public-api/src/transformers/candle.transformer.ts
  - packages/public-api/src/transformers/index.ts
  - packages/public-api/src/helpers/pagination.ts
  - packages/public-api/src/helpers/index.ts
  - pnpm-workspace.yaml
autonomous: true
must_haves:
  truths:
    - "Public API code lives in isolated packages/public-api package, not in apps/api"
    - "Public schemas use explicit field whitelisting (only timestamp, open, high, low, close, volume for candles)"
    - "No internal field names (macdV, signal, histogram, fastEMA, slowEMA, atr, informativeATR, isSynthetic, sequenceNum) appear in any public schema"
    - "Candle transformer maps internal Candle type to public format with string decimals and ISO8601 timestamps"
    - "JSON envelope helper produces { success, data, meta: { count, next_cursor, has_more } } structure"
    - "Cursor-based pagination helper converts Redis sorted set scores to opaque cursors"
  artifacts:
    - path: "packages/public-api/package.json"
      provides: "Isolated public-api package with dependencies"
      contains: "@fastify/swagger"
    - path: "packages/public-api/src/schemas/candle.schema.ts"
      provides: "Public candle Zod schema with OpenAPI metadata"
      contains: "openapi"
    - path: "packages/public-api/src/schemas/envelope.schema.ts"
      provides: "JSON envelope schema for all responses"
      contains: "success"
    - path: "packages/public-api/src/transformers/candle.transformer.ts"
      provides: "Internal-to-public candle field mapping"
      contains: "transformCandle"
    - path: "packages/public-api/src/helpers/pagination.ts"
      provides: "Cursor encoding/decoding and pagination logic"
      contains: "encodeCursor"
  key_links:
    - from: "packages/public-api/src/schemas/candle.schema.ts"
      to: "packages/schemas/src/market/candle.schema.ts"
      via: "Type awareness only - public schema defined independently, not imported from internal"
      pattern: "timestamp.*open.*high.*low.*close.*volume"
    - from: "packages/public-api/src/transformers/candle.transformer.ts"
      to: "packages/public-api/src/schemas/candle.schema.ts"
      via: "Transformer returns PublicCandle type"
      pattern: "PublicCandle"
---

<objective>
Create the packages/public-api package with public Zod schemas, DTO transformers, and pagination/envelope helpers.

Purpose: Establish the IP protection boundary and response contract before any endpoint is wired up. Public schemas use explicit field whitelisting (not omission), ensuring proprietary field names can never leak. This is the foundation all endpoints depend on.

Output: packages/public-api package with schemas, transformers, and helpers ready for route implementation.
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/schemas/src/market/candle.schema.ts
@packages/schemas/src/market/liquidity.schema.ts
@packages/cache/src/keys.ts
@packages/cache/src/strategies/candle-cache.ts
@packages/database/schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold packages/public-api and install dependencies</name>
  <files>
    packages/public-api/package.json
    packages/public-api/tsconfig.json
    packages/public-api/src/index.ts
    pnpm-workspace.yaml
  </files>
  <action>
Create `packages/public-api/` as a new pnpm workspace package.

**package.json:**
- name: `@livermore/public-api`
- type: `module`
- main: `src/index.ts` (internal package, no build needed)
- dependencies:
  - `@fastify/swagger`: `^9.7.0`
  - `@fastify/swagger-ui`: `^5.2.0`
  - `fastify-type-provider-zod`: `^4.0.2`
  - `fastify`: `^5.2.2` (peer-like, needed for types)
  - `zod`: `^3.24.1`
  - `@livermore/cache`: `workspace:*`
  - `@livermore/database`: `workspace:*`
  - `@livermore/schemas`: `workspace:*`
  - `@livermore/utils`: `workspace:*`
- devDependencies: `typescript`, `@types/node`

**tsconfig.json:** Extend from root or use standard Node ESM config matching other packages.

**pnpm-workspace.yaml:** Verify `packages/*` glob already includes this path (it should from existing packages). If not, no change needed.

**src/index.ts:** Empty barrel export for now (will export plugin in Plan 02).

IMPORTANT: Do NOT add `@livermore/indicators` as a dependency. The public-api package must NEVER import from the indicators package to maintain IP isolation.

Run `pnpm install` from workspace root to link the new package.
  </action>
  <verify>
Run `pnpm install` succeeds. Run `pnpm ls @livermore/public-api --depth 0` from apps/api (after adding it in Plan 02) or verify the package resolves: `node -e "require.resolve('@livermore/public-api')"` from packages/public-api.

Verify no `@livermore/indicators` in packages/public-api/package.json.
  </verify>
  <done>packages/public-api exists as valid pnpm workspace package with @fastify/swagger, fastify-type-provider-zod installed. Package does NOT depend on @livermore/indicators.</done>
</task>

<task type="auto">
  <name>Task 2: Create public Zod schemas with OpenAPI metadata, DTO transformers, and pagination helpers</name>
  <files>
    packages/public-api/src/schemas/envelope.schema.ts
    packages/public-api/src/schemas/candle.schema.ts
    packages/public-api/src/schemas/exchange.schema.ts
    packages/public-api/src/schemas/symbol.schema.ts
    packages/public-api/src/schemas/error.schema.ts
    packages/public-api/src/schemas/index.ts
    packages/public-api/src/transformers/candle.transformer.ts
    packages/public-api/src/transformers/index.ts
    packages/public-api/src/helpers/pagination.ts
    packages/public-api/src/helpers/index.ts
    packages/public-api/src/index.ts
  </files>
  <action>
**schemas/envelope.schema.ts** - Response envelope used by ALL endpoints:
Create a generic Zod schema factory `createEnvelopeSchema(dataSchema)` that produces:
```
{ success: boolean, data: T, meta: { count: number, next_cursor: string | null, has_more: boolean } }
```
Also create an error envelope: `{ success: false, error: { code: string, message: string } }`

All schemas should have `.describe()` calls for OpenAPI docs. Use `z.string()` for `next_cursor` (opaque cursor).

**schemas/candle.schema.ts** - Public candle schema (WHITELIST ONLY):
Define `PublicCandleSchema` with ONLY these fields:
- `timestamp`: z.string() - ISO8601 format (NOT unix ms internally)
- `open`: z.string() - String decimal (per API-08, not number)
- `high`: z.string() - String decimal
- `low`: z.string() - String decimal
- `close`: z.string() - String decimal
- `volume`: z.string() - String decimal

Add `.describe()` with AI-optimized descriptions on every field. Example:
```typescript
timestamp: z.string().describe('ISO 8601 timestamp of candle open time. Example: 2026-02-18T12:00:00.000Z')
```

CRITICAL: Do NOT include `symbol`, `timeframe`, `isSynthetic`, `sequenceNum`, or any internal fields. Symbol and timeframe are in the URL path, not repeated in each candle object.

Also create `CandleParamsSchema` for URL params (exchange, symbol, timeframe) and `CandleQuerySchema` for query params (cursor, limit, start_time, end_time).

**schemas/exchange.schema.ts** - Public exchange schema:
- `id`: z.string() - String exchange identifier (use the `name` field from DB, e.g. "coinbase", NOT the numeric id)
- `name`: z.string() - Display name (e.g. "Coinbase Advanced Trade")
- `status`: z.enum(['online', 'offline']) - Derived from Redis instance registry
- `symbol_count`: z.number().int()

Do NOT expose: ws_url, rest_url, api_limits, fee_schedule, geo_restrictions (internal operational data).

**schemas/symbol.schema.ts** - Public symbol schema:
- `symbol`: z.string() - Trading pair (e.g. "BTC-USD")
- `base`: z.string() - Base currency (e.g. "BTC")
- `quote`: z.string() - Quote currency (e.g. "USD")
- `exchange`: z.string() - Exchange identifier (e.g. "coinbase")
- `liquidity_grade`: z.enum(['high', 'medium', 'low']) - Mapped from liquidity_score

Do NOT expose: id, volume_24h, volume_rank, global_rank, market_cap, coingecko_id, trade_count_24h, liquidity_score (raw numeric).

Add query schema for filtering: `exchange` (optional filter), `cursor`, `limit`.

**schemas/error.schema.ts** - Error response schemas for OpenAPI:
Define schemas for 400, 404, 429, 500 error responses. All use the error envelope format: `{ success: false, error: { code: string, message: string } }`. Codes: `BAD_REQUEST`, `NOT_FOUND`, `RATE_LIMITED`, `INTERNAL_ERROR`. These are for OAS-04 documentation.

**schemas/index.ts** - Barrel export all schemas.

**transformers/candle.transformer.ts** - Internal-to-public candle mapping:
```typescript
import type { Candle } from '@livermore/schemas';

export function transformCandle(internal: Candle): PublicCandle {
  return {
    timestamp: new Date(internal.timestamp).toISOString(),
    open: internal.open.toString(),
    high: internal.high.toString(),
    low: internal.low.toString(),
    close: internal.close.toString(),
    volume: internal.volume.toString(),
  };
}
```
CRITICAL: This is explicit whitelisting. Only the 6 fields above are picked. Any new field added to internal Candle will NOT automatically leak.

**transformers/index.ts** - Export transformers.

**helpers/pagination.ts** - Cursor-based pagination:
- `encodeCursor(timestamp: number): string` - Base64 encode the timestamp score from Redis sorted set
- `decodeCursor(cursor: string): number` - Decode back to timestamp
- `buildPaginationMeta(items: unknown[], limit: number, lastTimestamp: number | null): { count, next_cursor, has_more }` - If items.length === limit, there may be more (has_more=true, next_cursor from last item's timestamp)

For candles, cursor is the timestamp of the last candle returned. Next page fetches candles with timestamp > cursor value.

For symbols, cursor is the symbol ID (numeric). Next page fetches symbols with id > cursor.

**helpers/index.ts** - Export helpers.

**src/index.ts** - Update to export schemas, transformers, and helpers.
  </action>
  <verify>
Run `cd packages/public-api && npx tsc --noEmit` to verify all types compile.

Manually verify no proprietary field names exist in any schema file:
```bash
grep -rn "macdV\|fastEMA\|slowEMA\|informativeATR\|histogram\|signalDelta\|triggerValue\|isSynthetic\|sequenceNum" packages/public-api/src/
```
Should return zero results.

Verify envelope schema produces correct structure by checking the Zod schema shape.
  </verify>
  <done>
All public schemas defined with OpenAPI descriptions. Candle transformer uses explicit field whitelisting. Pagination helpers encode/decode cursors. Zero proprietary field names in any file under packages/public-api/. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `packages/public-api/` exists as valid workspace package
2. `pnpm install` succeeds from workspace root
3. `grep -rn "macdV\|fastEMA\|slowEMA\|informativeATR\|histogram\|signalDelta\|atr" packages/public-api/src/` returns zero matches
4. `npx tsc --noEmit` passes in packages/public-api
5. Package does NOT have @livermore/indicators as a dependency
</verification>

<success_criteria>
- packages/public-api is a valid pnpm workspace package with schemas, transformers, and helpers
- All public schemas use explicit field whitelisting (not importing and omitting from internal schemas)
- Zero proprietary field names in any public-api source file
- Candle transformer converts unix ms timestamps to ISO8601 and numbers to string decimals
- Envelope schema produces { success, data, meta: { count, next_cursor, has_more } }
- Cursor pagination encodes/decodes Redis sorted set scores
</success_criteria>

<output>
After completion, create `.planning/phases/39-public-api-foundation-ip-protection/39-01-SUMMARY.md`
</output>

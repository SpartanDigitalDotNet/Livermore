---
phase: 39-public-api-foundation-ip-protection
plan: 02
type: execute
wave: 2
depends_on: ["39-01"]
files_modified:
  - packages/public-api/src/routes/candles.route.ts
  - packages/public-api/src/routes/exchanges.route.ts
  - packages/public-api/src/routes/symbols.route.ts
  - packages/public-api/src/routes/index.ts
  - packages/public-api/src/plugin.ts
  - packages/public-api/src/index.ts
autonomous: true
must_haves:
  truths:
    - "GET /public/v1/candles/:exchange/:symbol/:timeframe returns OHLCV candle data from Redis cache"
    - "GET /public/v1/exchanges returns exchange metadata with id, name, status, symbol_count"
    - "GET /public/v1/symbols returns symbol list with symbol, base, quote, exchange, liquidity_grade"
    - "All three endpoints return responses in JSON envelope format with cursor pagination metadata"
    - "Candle endpoint supports cursor and limit query params for pagination"
    - "Candle endpoint supports start_time and end_time query params in ISO8601 format"
    - "All prices and volumes are string decimals, all timestamps are ISO8601"
    - "Exchange name in URL path is resolved to exchange ID via database lookup"
  artifacts:
    - path: "packages/public-api/src/routes/candles.route.ts"
      provides: "Candle REST endpoint with Redis cache read"
      contains: "GET"
    - path: "packages/public-api/src/routes/exchanges.route.ts"
      provides: "Exchange metadata endpoint"
      contains: "GET"
    - path: "packages/public-api/src/routes/symbols.route.ts"
      provides: "Symbol list endpoint with liquidity grade"
      contains: "liquidity_grade"
    - path: "packages/public-api/src/plugin.ts"
      provides: "Fastify plugin that registers all public routes with OpenAPI"
      contains: "fastify.register"
  key_links:
    - from: "packages/public-api/src/routes/candles.route.ts"
      to: "packages/cache/src/strategies/candle-cache.ts"
      via: "Redis sorted set read via exchangeCandleKey"
      pattern: "exchangeCandleKey|zrangebyscore|zrange"
    - from: "packages/public-api/src/routes/candles.route.ts"
      to: "packages/public-api/src/transformers/candle.transformer.ts"
      via: "Transform internal candles to public format before response"
      pattern: "transformCandle"
    - from: "packages/public-api/src/routes/exchanges.route.ts"
      to: "packages/database"
      via: "Drizzle query for exchange metadata"
      pattern: "exchanges"
    - from: "packages/public-api/src/routes/symbols.route.ts"
      to: "packages/database"
      via: "Drizzle query for exchange_symbols with liquidity score"
      pattern: "exchangeSymbols"
---

<objective>
Implement the three public REST endpoints (candles, exchanges, symbols) as Fastify route handlers with Zod schema validation and cursor-based pagination.

Purpose: Deliver the core data access endpoints that external clients will use. All responses go through the DTO transformer and envelope wrapper established in Plan 01, ensuring IP protection is enforced at every response boundary.

Output: Three working route handlers and a Fastify plugin that registers them under /public/v1/ prefix.
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/39-public-api-foundation-ip-protection/39-01-SUMMARY.md
@packages/cache/src/keys.ts
@packages/cache/src/strategies/candle-cache.ts
@packages/database/schema.sql
@apps/api/src/routers/exchange-symbol.router.ts
@apps/api/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement candle, exchange, and symbol route handlers</name>
  <files>
    packages/public-api/src/routes/candles.route.ts
    packages/public-api/src/routes/exchanges.route.ts
    packages/public-api/src/routes/symbols.route.ts
    packages/public-api/src/routes/index.ts
  </files>
  <action>
**routes/candles.route.ts** - `GET /public/v1/candles/:exchange/:symbol/:timeframe`

Implementation:
1. Resolve `:exchange` param (string name like "coinbase") to exchange ID via DB lookup. Cache this mapping in-memory (exchanges rarely change). Return 404 if exchange not found or inactive.
2. Validate `:symbol` is a string (e.g. "BTC-USD"), `:timeframe` is valid enum value.
3. Parse query params: `cursor` (opaque string), `limit` (1-500, default 100), `start_time` (ISO8601), `end_time` (ISO8601).
4. Read candles from Redis using `getRedisClient()` and `exchangeCandleKey(exchangeId, symbol, timeframe)`:
   - If `start_time`/`end_time` provided: use `ZRANGEBYSCORE key startMs endMs` with LIMIT
   - If `cursor` provided: decode cursor to timestamp, use `ZRANGEBYSCORE key (cursorTs +inf LIMIT 0 limit`
   - Default: use `ZRANGE key -limit -1` (most recent candles)
5. Parse each JSON string from Redis, transform via `transformCandle()` to public format.
6. Build response using envelope helper: `{ success: true, data: candles, meta: { count, next_cursor, has_more } }`
7. If `cursor` was used for forward pagination, `has_more` is true if results.length === limit. `next_cursor` encodes the last candle's timestamp.

Register as Fastify route with schema object containing:
- `params`: CandleParamsSchema (from Plan 01 schemas)
- `querystring`: CandleQuerySchema
- `response.200`: Envelope wrapping PublicCandleSchema array
- `response.400`: ErrorEnvelopeSchema
- `response.404`: ErrorEnvelopeSchema
- `tags`: ['Candles']
- `description`: AI-optimized description explaining the endpoint, use cases, and data source

IMPORTANT: Do NOT use CandleCacheStrategy directly (it requires userId). Instead, use raw Redis commands via `getRedisClient()` with `exchangeCandleKey()` to read exchange-scoped candle data without any userId dependency.

**routes/exchanges.route.ts** - `GET /public/v1/exchanges`

Implementation:
1. Query `exchanges` table for active exchanges: id, name, display_name, is_active.
2. Query `exchange_symbols` for per-exchange active symbol counts.
3. Check Redis instance registry for each exchange's connection status (online/offline).
4. Map to public schema: `{ id: exchange.name, name: exchange.displayName, status: 'online'|'offline', symbol_count: count }`
5. Wrap in envelope. No pagination needed (small fixed list of exchanges).

Do NOT expose: ws_url, rest_url, api_limits, fee_schedule, geo_restrictions.

Register with schema, tags: ['Exchanges'], AI-optimized description.

**routes/symbols.route.ts** - `GET /public/v1/symbols`

Implementation:
1. Parse query params: `exchange` (optional filter), `cursor`, `limit` (1-500, default 100).
2. Query `exchange_symbols` table joined with `exchanges`:
   - Filter: `is_active = true`, optionally `exchanges.name = :exchange`
   - Order by: `exchange_symbols.id ASC` (stable cursor ordering)
   - If cursor: `WHERE exchange_symbols.id > decodedCursorId`
   - LIMIT: limit + 1 (to detect has_more)
3. Map liquidity_score to liquidity_grade:
   - liquidity_score >= 0.8 -> 'high'
   - liquidity_score >= 0.5 -> 'medium'
   - else -> 'low'
   - If liquidity_score is null -> 'low'
4. Map to public schema: `{ symbol, base: baseCurrency, quote: quoteCurrency, exchange: exchanges.name, liquidity_grade }`
5. Wrap in envelope with cursor pagination.

Do NOT expose: id, volume_24h, volume_rank, global_rank, market_cap, coingecko_id, trade_count_24h, liquidity_score.

Register with schema, tags: ['Symbols'], AI-optimized description. Support `exchange` query param as filter.

**routes/index.ts** - Barrel export all route registration functions.
  </action>
  <verify>
`cd packages/public-api && npx tsc --noEmit` compiles cleanly.

Verify no proprietary field names:
```bash
grep -rn "macdV\|fastEMA\|slowEMA\|informativeATR\|histogram\|signalDelta\|triggerValue\|isSynthetic\|sequenceNum\|userId" packages/public-api/src/routes/
```
Should return zero results (userId should not appear in any public route).
  </verify>
  <done>Three route handlers implemented with Zod schema validation, Redis/DB reads, DTO transformation, and envelope wrapping. All responses use string decimals, ISO8601 timestamps, and cursor pagination. No internal field names exposed.</done>
</task>

<task type="auto">
  <name>Task 2: Create Fastify plugin with OpenAPI registration</name>
  <files>
    packages/public-api/src/plugin.ts
    packages/public-api/src/index.ts
  </files>
  <action>
**plugin.ts** - Fastify plugin that registers OpenAPI and all public routes:

Create an async Fastify plugin function `publicApiPlugin` that:

1. Registers `@fastify/swagger` with OpenAPI 3.1 config:
   ```
   openapi: '3.1.0'
   info:
     title: 'Livermore Public API'
     version: '1.0.0'
     description: AI-optimized description explaining the API provides cryptocurrency market data including OHLCV candles, exchange metadata, and symbol information. Mention it's designed for programmatic access by trading bots, portfolio trackers, and AI agents.
   servers: [{ url: '/public/v1' }]
   ```
   Use `jsonSchemaTransform` from `fastify-type-provider-zod` as the transform.

2. Set Zod validator/serializer compilers from `fastify-type-provider-zod`:
   - `instance.setValidatorCompiler(validatorCompiler)`
   - `instance.setSerializerCompiler(serializerCompiler)`

3. Register each route handler from routes/index.ts.

4. Add a GET route at `/openapi.json` that returns `instance.swagger()` (the generated OpenAPI spec).

5. Optionally register `@fastify/swagger-ui` at `/docs` for interactive API explorer (useful for development, can be disabled in production later).

6. Add a custom error handler for this plugin scope that sanitizes errors:
   - Never return stack traces
   - Never return internal field names in error messages
   - Map Zod validation errors to generic "Invalid request parameters" with field names only (no internal schema details)
   - Return consistent error envelope format

The plugin should be registered in server.ts under the `/public/v1` prefix (done in Plan 03).

**Export from plugin.ts:** `publicApiPlugin` as a named export.

**Update src/index.ts:** Export the plugin function plus schemas and transformers.

IMPORTANT: The plugin uses `instance.withTypeProvider<ZodTypeProvider>()` to get type-safe route registration.

IMPORTANT: Error handler must catch Zod validation errors and strip any mention of internal schema field names. Return `{ success: false, error: { code: 'BAD_REQUEST', message: 'Invalid parameters', details: [...field errors with public field names only...] } }`.
  </action>
  <verify>
`cd packages/public-api && npx tsc --noEmit` compiles cleanly.

Verify the plugin exports correctly:
```bash
grep -n "publicApiPlugin" packages/public-api/src/index.ts
```
Should find the export.

Verify error handler does not leak internal details:
```bash
grep -rn "stack\|stackTrace\|stack_trace" packages/public-api/src/plugin.ts
```
Should find the error handler suppressing stack traces, not exposing them.
  </verify>
  <done>Fastify plugin registered with @fastify/swagger for OpenAPI 3.1 generation, Zod type provider for schema validation, all three route handlers, OpenAPI spec endpoint at /openapi.json, sanitized error handler. Plugin ready to be registered in server.ts.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd packages/public-api && npx tsc --noEmit`
2. Zero proprietary field names: `grep -rn "macdV\|fastEMA\|slowEMA\|informativeATR\|histogram\|signalDelta\|atr\b" packages/public-api/src/`
3. Plugin exports correctly from index.ts
4. All three routes have Zod schemas for params, querystring, and response
5. Error handler strips stack traces and internal details
</verification>

<success_criteria>
- Three route handlers (candles, exchanges, symbols) read data from Redis/PostgreSQL
- All responses use JSON envelope with cursor pagination metadata
- Candle route supports cursor, limit, start_time, end_time query parameters
- Symbol route supports exchange filter query parameter
- OpenAPI spec generated from Zod schemas via @fastify/swagger
- Sanitized error handler prevents IP leakage through error messages
- Fastify plugin ready for registration in server.ts
</success_criteria>

<output>
After completion, create `.planning/phases/39-public-api-foundation-ip-protection/39-02-SUMMARY.md`
</output>

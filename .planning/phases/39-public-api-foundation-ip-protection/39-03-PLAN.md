---
phase: 39-public-api-foundation-ip-protection
plan: 03
type: execute
wave: 3
depends_on: ["39-02"]
files_modified:
  - apps/api/package.json
  - apps/api/src/server.ts
autonomous: false
must_haves:
  truths:
    - "External client can fetch OHLCV candle data via GET /public/v1/candles/:exchange/:symbol/:timeframe"
    - "External client can fetch exchange metadata via GET /public/v1/exchanges"
    - "External client can fetch symbol list via GET /public/v1/symbols"
    - "OpenAPI 3.1 spec serves at /public/v1/openapi.json"
    - "No internal field names (macdV, signal, histogram, fastEMA, slowEMA, atr, informativeATR) appear in any response or the OpenAPI spec"
    - "All candle responses use string decimals for prices/volumes and ISO8601 timestamps"
    - "All responses use { success, data, meta } envelope format"
    - "Error responses return sanitized messages with no stack traces"
  artifacts:
    - path: "apps/api/src/server.ts"
      provides: "Public API plugin registration under /public/v1 prefix"
      contains: "publicApiPlugin"
    - path: "apps/api/package.json"
      provides: "Dependency on @livermore/public-api workspace package"
      contains: "@livermore/public-api"
  key_links:
    - from: "apps/api/src/server.ts"
      to: "packages/public-api/src/plugin.ts"
      via: "fastify.register(publicApiPlugin, { prefix: '/public/v1' })"
      pattern: "publicApiPlugin"
    - from: "apps/api/src/server.ts"
      to: "packages/cache/src/client.ts"
      via: "Redis client shared between existing routes and public API"
      pattern: "getRedisClient"
---

<objective>
Wire the public-api plugin into the Fastify server and verify the complete end-to-end flow with live Redis data.

Purpose: This is the integration step that makes the public API accessible. After this plan, all three endpoints are live and the OpenAPI spec is served. The human verification checkpoint confirms IP protection is working in practice.

Output: Live public API endpoints and OpenAPI spec accessible at /public/v1/*.
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/39-public-api-foundation-ip-protection/39-01-SUMMARY.md
@.planning/phases/39-public-api-foundation-ip-protection/39-02-SUMMARY.md
@apps/api/src/server.ts
@apps/api/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register public-api plugin in server.ts and verify endpoints</name>
  <files>
    apps/api/package.json
    apps/api/src/server.ts
  </files>
  <action>
**apps/api/package.json:**
Add `"@livermore/public-api": "workspace:*"` to dependencies. Run `pnpm install`.

**apps/api/src/server.ts:**
Add the public API plugin registration. This goes AFTER existing Fastify setup (CORS, WebSocket) but BEFORE the tRPC plugin registration. The public API operates on a completely separate route prefix from tRPC.

1. Import: `import { publicApiPlugin } from '@livermore/public-api';`

2. Register the plugin with prefix AFTER the Fastify instance is created and basic plugins (cors, websocket) are registered:
```typescript
// Public REST API (Phase 39) - separate from tRPC admin routes
await fastify.register(publicApiPlugin, { prefix: '/public/v1' });
```

3. Place this registration BEFORE the tRPC plugin registration. The order matters because:
   - Public API routes at `/public/v1/*` must not go through Clerk middleware
   - tRPC routes at `/trpc/*` continue to use Clerk as before
   - No auth middleware on public routes for Phase 39 (auth added in Phase 41)

4. Add a startup log message after registration:
```typescript
logger.info('Public API registered at /public/v1');
```

IMPORTANT: Do NOT modify the existing CORS configuration. The current `origin: true` works for development. Route-scoped CORS is deferred (not in Phase 39 requirements).

IMPORTANT: Do NOT add any authentication middleware to the public API routes. Phase 39 endpoints are open during development (auth comes in Phase 41).

After wiring, test with curl:
```bash
# Test candles (requires running server with Redis data)
curl http://localhost:3000/public/v1/candles/coinbase/BTC-USD/1h?limit=5

# Test exchanges
curl http://localhost:3000/public/v1/exchanges

# Test symbols
curl http://localhost:3000/public/v1/symbols?exchange=coinbase&limit=10

# Test OpenAPI spec
curl http://localhost:3000/public/v1/openapi.json

# Test error handling (invalid timeframe)
curl http://localhost:3000/public/v1/candles/coinbase/BTC-USD/invalid
```
  </action>
  <verify>
1. `pnpm install` succeeds
2. `pnpm --filter @livermore/api type-check` passes (or `cd apps/api && npx tsc --noEmit`)
3. Server starts without errors: `cd apps/api && npx tsx src/server.ts` (verify startup log shows "Public API registered at /public/v1")
4. If Redis is available with candle data:
   - `curl http://localhost:3000/public/v1/candles/coinbase/BTC-USD/1h?limit=3` returns JSON envelope with candle data
   - `curl http://localhost:3000/public/v1/exchanges` returns exchange list
   - `curl http://localhost:3000/public/v1/symbols?limit=5` returns symbol list
   - `curl http://localhost:3000/public/v1/openapi.json` returns valid OpenAPI 3.1 spec
  </verify>
  <done>Public API plugin registered in server.ts. All three endpoints accessible at /public/v1/*. OpenAPI spec serves at /public/v1/openapi.json. Server starts cleanly with public API alongside existing tRPC routes.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify IP protection and response format</name>
  <what-built>
Complete public REST API with three endpoints (candles, exchanges, symbols), OpenAPI 3.1 spec, JSON envelope responses, cursor pagination, and IP protection via DTO transformation layer.
  </what-built>
  <how-to-verify>
With the server running (`cd apps/api && npx tsx src/server.ts`):

1. **Candle endpoint** - Verify response format and IP protection:
   ```bash
   curl -s http://localhost:3000/public/v1/candles/coinbase/BTC-USD/1h?limit=3 | jq .
   ```
   Expected: `{ success: true, data: [{ timestamp: "2026-...", open: "50123.45", ... }], meta: { count: 3, next_cursor: "...", has_more: true } }`
   - Prices are STRING decimals (not numbers)
   - Timestamps are ISO8601 (not unix ms)
   - No `symbol`, `timeframe`, `isSynthetic`, `sequenceNum` fields in candle objects

2. **Exchange endpoint** - Verify no internal data leaks:
   ```bash
   curl -s http://localhost:3000/public/v1/exchanges | jq .
   ```
   Expected: Each exchange has only `id`, `name`, `status`, `symbol_count`
   - No `ws_url`, `rest_url`, `api_limits`, `fee_schedule`, `geo_restrictions`

3. **Symbol endpoint** - Verify liquidity grade mapping:
   ```bash
   curl -s http://localhost:3000/public/v1/symbols?exchange=coinbase&limit=5 | jq .
   ```
   Expected: Each symbol has only `symbol`, `base`, `quote`, `exchange`, `liquidity_grade`
   - No `id`, `volume_24h`, `global_rank`, `market_cap`, `coingecko_id`

4. **OpenAPI spec** - Verify no proprietary terms:
   ```bash
   curl -s http://localhost:3000/public/v1/openapi.json | jq . > /tmp/openapi-check.json
   grep -i "macdV\|fastEMA\|slowEMA\|informativeATR\|histogram\|signalDelta\|atr" /tmp/openapi-check.json
   ```
   Expected: ZERO matches. No proprietary field names in the spec.

5. **Error handling** - Verify sanitized errors:
   ```bash
   curl -s http://localhost:3000/public/v1/candles/coinbase/BTC-USD/invalid | jq .
   ```
   Expected: `{ success: false, error: { code: "BAD_REQUEST", message: "..." } }` - no stack trace, no internal details.

6. **Pagination** - Verify cursor works:
   ```bash
   # Get first page
   curl -s "http://localhost:3000/public/v1/candles/coinbase/BTC-USD/1h?limit=2" | jq .meta
   # Use next_cursor for second page
   curl -s "http://localhost:3000/public/v1/candles/coinbase/BTC-USD/1h?limit=2&cursor=CURSOR_FROM_ABOVE" | jq .meta
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Server starts with "Public API registered at /public/v1" log message
2. GET /public/v1/candles/:exchange/:symbol/:timeframe returns OHLCV in envelope format
3. GET /public/v1/exchanges returns exchange metadata (no internal operational data)
4. GET /public/v1/symbols returns symbols with liquidity grades (no raw scores)
5. GET /public/v1/openapi.json returns valid OpenAPI 3.1 spec
6. OpenAPI spec contains ZERO proprietary field names
7. Error responses use sanitized envelope format with no stack traces
8. Cursor pagination works for candles and symbols
9. All prices/volumes are string decimals, all timestamps are ISO8601
</verification>

<success_criteria>
Phase 39 success criteria (all must be TRUE):
1. External client can fetch OHLCV candle data for any symbol/timeframe/exchange from public REST endpoint
2. External client can fetch exchange metadata and symbol lists with liquidity grades
3. All responses use consistent JSON envelope with cursor pagination and ISO8601 timestamps
4. OpenAPI 3.1 spec serves at /public/v1/openapi.json with AI-optimized descriptions and concrete examples
5. No internal field names (macdV, signal, histogram, fastEMA, slowEMA, atr, informativeATR) appear in any public response or spec
</success_criteria>

<output>
After completion, create `.planning/phases/39-public-api-foundation-ip-protection/39-03-SUMMARY.md`
</output>

---
phase: 24-data-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cache/src/keys.ts
  - packages/cache/src/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Exchange-scoped candle key function returns candles:{exchange_id}:{symbol}:{timeframe}"
    - "Exchange-scoped indicator key function returns indicator:{exchange_id}:{symbol}:{timeframe}:{type}"
    - "User overflow candle key function returns usercandles:{userId}:{exchange_id}:{symbol}:{timeframe}"
    - "Exchange-scoped candle close channel function returns channel:exchange:{exchange_id}:candle:close:{symbol}:{timeframe}"
    - "Legacy key functions remain functional but marked @deprecated"
  artifacts:
    - path: "packages/cache/src/keys.ts"
      provides: "Exchange-scoped and user-scoped key builders"
      exports: ["exchangeCandleKey", "exchangeIndicatorKey", "userCandleKey", "userIndicatorKey", "exchangeCandleCloseChannel", "exchangeCandleClosePattern"]
    - path: "packages/cache/src/index.ts"
      provides: "Re-exports new key functions"
      contains: "exchangeCandleKey"
  key_links:
    - from: "packages/cache/src/keys.ts"
      to: "@livermore/schemas"
      via: "Timeframe type import"
      pattern: "import.*Timeframe.*from.*@livermore/schemas"
---

<objective>
Add exchange-scoped and user-scoped key builder functions to the cache package for Tier 1 (shared) and Tier 2 (overflow) data patterns.

Purpose: Enable shared Redis keys across users for the same exchange/symbol, reducing storage duplication and enabling cross-user data visibility.

Output: New key functions in `packages/cache/src/keys.ts` with JSDoc documentation and deprecation markers on legacy functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-data-architecture/24-RESEARCH.md

# Current key patterns
@packages/cache/src/keys.ts
@packages/cache/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add exchange-scoped and user-overflow key functions</name>
  <files>packages/cache/src/keys.ts</files>
  <action>
Add new key builder functions to `packages/cache/src/keys.ts`:

**Tier 1: Exchange-Scoped Keys (Shared Data)**

1. `exchangeCandleKey(exchangeId: number, symbol: string, timeframe: Timeframe): string`
   - Returns: `candles:${exchangeId}:${symbol}:${timeframe}`
   - JSDoc: "Build a cache key for exchange-scoped candles (shared across users). Tier 1: All users on same exchange share this data."

2. `exchangeIndicatorKey(exchangeId: number, symbol: string, timeframe: Timeframe, type: string, params?: Record<string, unknown>): string`
   - Returns: `indicator:${exchangeId}:${symbol}:${timeframe}:${type}` (with optional sorted params suffix)
   - JSDoc: "Build a cache key for exchange-scoped indicators (shared across users). Tier 1: Computed from shared candle data."

3. `exchangeCandleCloseChannel(exchangeId: number, symbol: string, timeframe: Timeframe): string`
   - Returns: `channel:exchange:${exchangeId}:candle:close:${symbol}:${timeframe}`
   - JSDoc: "Build a Redis pub/sub channel for exchange-scoped candle close events. Used by all users subscribing to same exchange/symbol."

4. `exchangeCandleClosePattern(exchangeId: number, symbol: string, timeframe: Timeframe | '*'): string`
   - Returns: `channel:exchange:${exchangeId}:candle:close:${symbol}:${timeframe}`
   - JSDoc: "Build a Redis psubscribe pattern for exchange-scoped candle close events."

**Tier 2: User-Scoped Keys (Overflow Data)**

5. `userCandleKey(userId: number, exchangeId: number, symbol: string, timeframe: Timeframe): string`
   - Returns: `usercandles:${userId}:${exchangeId}:${symbol}:${timeframe}`
   - JSDoc: "Build a cache key for user-specific candle overflow. Tier 2: User-specific data with TTL."

6. `userIndicatorKey(userId: number, exchangeId: number, symbol: string, timeframe: Timeframe, type: string): string`
   - Returns: `userindicator:${userId}:${exchangeId}:${symbol}:${timeframe}:${type}`
   - JSDoc: "Build a cache key for user-specific indicator overflow. Tier 2: User-specific with TTL."

**Legacy Deprecation**

Add `@deprecated` JSDoc tag to existing functions:
- `candleKey` - "@deprecated Use exchangeCandleKey for shared data or userCandleKey for overflow"
- `indicatorKey` - "@deprecated Use exchangeIndicatorKey for shared data or userIndicatorKey for overflow"
- `candleChannel` - "@deprecated Use exchangeCandleCloseChannel for shared events"
- `candleCloseChannel` - "@deprecated Use exchangeCandleCloseChannel for shared events"
- `candleClosePattern` - "@deprecated Use exchangeCandleClosePattern for shared events"

Organize the file with section comments:
```typescript
// ============================================
// TIER 1: Exchange-Scoped Keys (Shared Data)
// ============================================

// ============================================
// TIER 2: User-Scoped Keys (Overflow Data)
// ============================================

// ============================================
// LEGACY: User-Scoped Keys (Deprecated)
// ============================================
```

Keep all existing functions working - deprecation is advisory only.
  </action>
  <verify>
Run TypeScript compile check: `cd packages/cache && npx tsc --noEmit`
Verify no errors and all functions exported.
  </verify>
  <done>
- 6 new key functions exist with correct return patterns
- Existing functions have @deprecated JSDoc tags
- File organized with section comments
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Export new key functions from package index</name>
  <files>packages/cache/src/index.ts</files>
  <action>
Update `packages/cache/src/index.ts` to export the new key functions.

Add exports for:
- `exchangeCandleKey`
- `exchangeIndicatorKey`
- `exchangeCandleCloseChannel`
- `exchangeCandleClosePattern`
- `userCandleKey`
- `userIndicatorKey`

Keep all existing exports - this is additive.

The file likely uses a re-export pattern like:
```typescript
export { candleKey, exchangeCandleKey, ... } from './keys';
```

Add the new function names to this export.
  </action>
  <verify>
Run: `cd packages/cache && npx tsc --noEmit`
Import test: Create a simple import check that the new functions are available from '@livermore/cache'
  </verify>
  <done>
- All 6 new key functions exported from package index
- Existing exports unchanged
- Package compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify key function outputs</name>
  <files>N/A - verification only</files>
  <action>
Create a quick test script or use Node REPL to verify key outputs:

```bash
npx tsx -e "
const { exchangeCandleKey, exchangeIndicatorKey, userCandleKey, exchangeCandleCloseChannel, exchangeCandleClosePattern } = require('./packages/cache/src/keys');
console.log('exchangeCandleKey(1, \"BTC-USD\", \"5m\"):', exchangeCandleKey(1, 'BTC-USD', '5m'));
console.log('exchangeIndicatorKey(1, \"BTC-USD\", \"5m\", \"macd-v\"):', exchangeIndicatorKey(1, 'BTC-USD', '5m', 'macd-v'));
console.log('userCandleKey(42, 1, \"BTC-USD\", \"5m\"):', userCandleKey(42, 1, 'BTC-USD', '5m'));
console.log('exchangeCandleCloseChannel(1, \"BTC-USD\", \"5m\"):', exchangeCandleCloseChannel(1, 'BTC-USD', '5m'));
"
```

Expected outputs:
- `exchangeCandleKey(1, "BTC-USD", "5m")` -> `candles:1:BTC-USD:5m`
- `exchangeIndicatorKey(1, "BTC-USD", "5m", "macd-v")` -> `indicator:1:BTC-USD:5m:macd-v`
- `userCandleKey(42, 1, "BTC-USD", "5m")` -> `usercandles:42:1:BTC-USD:5m`
- `exchangeCandleCloseChannel(1, "BTC-USD", "5m")` -> `channel:exchange:1:candle:close:BTC-USD:5m`
  </action>
  <verify>
Output matches expected patterns exactly.
  </verify>
  <done>
- All key functions produce correct Redis key/channel patterns
- Patterns match DATA-01, DATA-02, DATA-03, DATA-05 requirements
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd packages/cache && npx tsc --noEmit`
2. Key patterns verified via REPL test
3. All exports available from package
4. Legacy functions still work (backward compatibility)
</verification>

<success_criteria>
- DATA-01: `exchangeCandleKey` produces `candles:{exchange_id}:{symbol}:{timeframe}`
- DATA-02: `exchangeIndicatorKey` produces `indicator:{exchange_id}:{symbol}:{timeframe}:{type}`
- DATA-03: `userCandleKey` produces `usercandles:{userId}:{exchange_id}:{symbol}:{timeframe}`
- DATA-05: `exchangeCandleCloseChannel` produces `channel:exchange:{exchange_id}:candle:close:{symbol}:{timeframe}`
- Legacy functions remain functional with @deprecated markers
</success_criteria>

<output>
After completion, create `.planning/phases/24-data-architecture/24-01-SUMMARY.md`
</output>

---
phase: 24-data-architecture
plan: 03
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - packages/coinbase-client/src/adapter/coinbase-adapter.ts
  - apps/api/src/services/indicator-calculation.service.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "CoinbaseAdapter publishes candle:close events to exchange-scoped channel channel:exchange:{exchangeId}:candle:close:{symbol}:{timeframe}"
    - "CoinbaseAdapter also publishes to legacy user-scoped channel for backward compatibility during migration"
    - "IndicatorCalculationService subscribes to exchange-scoped candle:close pattern"
    - "IndicatorCalculationService parses exchange_id from new channel format"
  artifacts:
    - path: "packages/coinbase-client/src/adapter/coinbase-adapter.ts"
      provides: "Dual-publish to exchange-scoped and legacy channels"
      contains: "exchangeCandleCloseChannel"
    - path: "apps/api/src/services/indicator-calculation.service.ts"
      provides: "Subscription to exchange-scoped candle close events"
      contains: "channel:exchange"
  key_links:
    - from: "packages/coinbase-client/src/adapter/coinbase-adapter.ts"
      to: "packages/cache/src/keys.ts"
      via: "Import exchangeCandleCloseChannel"
      pattern: "import.*exchangeCandleCloseChannel.*from.*@livermore/cache"
    - from: "apps/api/src/services/indicator-calculation.service.ts"
      to: "IndicatorCacheStrategy"
      via: "Uses cache strategy for indicator storage"
      pattern: "IndicatorCacheStrategy"
---

<objective>
Update pub/sub channels to use exchange-scoped patterns for candle close events, enabling cross-user visibility while maintaining backward compatibility through dual-publish.

Purpose: Move from user-scoped candle:close channels to exchange-scoped channels, allowing the indicator service to receive events regardless of which user triggered them.

Output: CoinbaseAdapter publishes to both exchange-scoped and legacy channels. IndicatorCalculationService subscribes to exchange-scoped pattern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-data-architecture/24-RESEARCH.md

# Key functions created in Plan 01
@packages/cache/src/keys.ts

# Files to update
@packages/coinbase-client/src/adapter/coinbase-adapter.ts
@apps/api/src/services/indicator-calculation.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update CoinbaseAdapter to dual-publish candle close events</name>
  <files>packages/coinbase-client/src/adapter/coinbase-adapter.ts</files>
  <action>
Update `packages/coinbase-client/src/adapter/coinbase-adapter.ts`:

**1. Import new key function:**
Add `exchangeCandleCloseChannel` to the imports from `@livermore/cache`:
```typescript
import { CandleCacheStrategy, candleCloseChannel, exchangeCandleCloseChannel, TickerCacheStrategy, type RedisClient } from '@livermore/cache';
```

**2. Update `onCandleClose` method (around line 513):**
```typescript
private async onCandleClose(candle: UnifiedCandle): Promise<void> {
  logger.info(
    { symbol: candle.symbol, timestamp: new Date(candle.timestamp).toISOString(), event: 'candle_close_emitted' },
    'Candle closed'
  );

  // Emit typed event for local subscribers
  this.emit('candle:close', candle);

  // Publish to Redis pub/sub for distributed subscribers (indicator service)
  try {
    // NEW: Exchange-scoped channel (shared across users)
    const exchangeChannel = exchangeCandleCloseChannel(
      this.exchangeIdNum,
      candle.symbol,
      candle.timeframe
    );
    await this.redis.publish(exchangeChannel, JSON.stringify(candle));

    // LEGACY: User-scoped channel (backward compatibility during migration)
    const userChannel = candleCloseChannel(
      this.userId,
      this.exchangeIdNum,
      candle.symbol,
      candle.timeframe
    );
    await this.redis.publish(userChannel, JSON.stringify(candle));
  } catch (error) {
    logger.error({ error, symbol: candle.symbol }, 'Failed to publish candle:close to Redis');
  }
}
```

**3. Update the 1m candle close publish (around line 666):**
Same dual-publish pattern - publish to both exchange-scoped and user-scoped channels.

```typescript
// In the 1m candle persistence block:
const unified: UnifiedCandle = { ...candle, exchange: 'coinbase' };

// NEW: Exchange-scoped channel
const exchangeChannel = exchangeCandleCloseChannel(this.exchangeIdNum, symbol, timeframe);
await this.redis.publish(exchangeChannel, JSON.stringify(unified));

// LEGACY: User-scoped channel
const userChannel = candleCloseChannel(this.userId, this.exchangeIdNum, symbol, timeframe);
await this.redis.publish(userChannel, JSON.stringify(unified));
```

**Why dual-publish:** During migration, some services may still subscribe to legacy channels. Dual-publish ensures no messages are lost. Remove legacy publish in a future cleanup phase.
  </action>
  <verify>
Run: `cd packages/coinbase-client && npx tsc --noEmit`
Verify no TypeScript errors.
  </verify>
  <done>
- exchangeCandleCloseChannel imported from @livermore/cache
- onCandleClose publishes to exchange-scoped channel first, then legacy
- 1m candle close also dual-publishes
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Update IndicatorCalculationService to subscribe to exchange-scoped channels</name>
  <files>apps/api/src/services/indicator-calculation.service.ts</files>
  <action>
Update `apps/api/src/services/indicator-calculation.service.ts`:

**1. Replace TEST_USER_ID with exchangeId for subscription:**
The service currently subscribes to:
```typescript
const pattern = `channel:candle:close:${this.TEST_USER_ID}:${this.TEST_EXCHANGE_ID}:*:*`;
```

Change to exchange-scoped pattern:
```typescript
// NEW: Subscribe to exchange-scoped candle:close events (Phase 24 pattern)
// Pattern: channel:exchange:{exchange_id}:candle:close:{symbol}:{timeframe}
const pattern = `channel:exchange:${this.TEST_EXCHANGE_ID}:candle:close:*:*`;
```

**2. Update channel parsing in pmessage handler:**
The current parsing assumes:
```
channel:candle:close:{userId}:{exchangeId}:{symbol}:{timeframe}
indices: 0      1      2      3        4           5       6
```

New format:
```
channel:exchange:{exchangeId}:candle:close:{symbol}:{timeframe}
indices: 0        1          2        3      4       5        6
```

Update parsing:
```typescript
this.subscriber.on('pmessage', (_pattern, channel, message) => {
  // Parse: "channel:exchange:{exchange_id}:candle:close:{symbol}:{timeframe}"
  const parts = channel.split(':');
  const exchangeId = parseInt(parts[2], 10);
  const symbol = parts[5];
  const timeframe = parts[6] as Timeframe;

  // Rest of handler uses exchangeId, symbol, timeframe...
});
```

**3. Note: Keep TEST_EXCHANGE_ID for now:**
The service still needs an exchange ID for subscription. In Phase 28, this will come from the adapter factory. For now, keep `TEST_EXCHANGE_ID = 1` as the subscription filter.

**4. Update any cache reads to use exchange-scoped keys (if present):**
The service reads candles via CandleCacheStrategy which now has dual-read built in (from Plan 02). No changes needed for reads - they'll automatically try exchange-scoped first.
  </action>
  <verify>
Run: `cd apps/api && npx tsc --noEmit`
Verify no TypeScript errors.
  </verify>
  <done>
- Subscription pattern changed to channel:exchange:{exchangeId}:candle:close:*:*
- Channel parsing updated for new format (exchangeId at index 2, symbol at 5, timeframe at 6)
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify pub/sub integration</name>
  <files>N/A - verification only</files>
  <action>
Run the full build to ensure all changes integrate properly:

```bash
npx turbo run build
```

Verify:
1. packages/cache builds (key functions)
2. packages/coinbase-client builds (adapter with dual-publish)
3. apps/api builds (indicator service with new subscription)

The pub/sub pattern should now be:
- Publisher (CoinbaseAdapter): `channel:exchange:1:candle:close:BTC-USD:5m`
- Subscriber (IndicatorCalculationService): `channel:exchange:1:candle:close:*:*`

Pattern match test: `channel:exchange:1:candle:close:BTC-USD:5m` matches `channel:exchange:1:candle:close:*:*` (yes)
  </action>
  <verify>
`npx turbo run build` completes without errors
  </verify>
  <done>
- Full turbo build passes
- Publisher pattern matches subscriber pattern
- No TypeScript errors across all packages
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx turbo run build`
2. Publisher uses exchangeCandleCloseChannel function
3. Subscriber pattern matches published channels
4. Channel parsing extracts correct indices (exchangeId=2, symbol=5, timeframe=6)
5. Dual-publish maintains backward compatibility
</verification>

<success_criteria>
- DATA-05: Candle close events publish to `channel:exchange:{exchange_id}:candle:close:{symbol}:{timeframe}`
- Indicator service subscribes to exchange-scoped pattern (no userId)
- Legacy channels still published for backward compatibility
- All packages build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/24-data-architecture/24-03-SUMMARY.md`
</output>

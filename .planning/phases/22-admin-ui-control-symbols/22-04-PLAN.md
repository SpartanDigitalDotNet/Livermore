---
phase: 22-admin-ui-control-symbols
plan: 04
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - apps/admin/src/components/symbols/SymbolWatchlist.tsx
  - apps/admin/src/components/symbols/SymbolRow.tsx
  - apps/admin/src/components/symbols/ScannerStatus.tsx
  - apps/admin/src/components/symbols/index.ts
  - apps/admin/src/pages/Symbols.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of symbols in their watchlist"
    - "User can see symbol metrics (price, volume, 24h change) on hover/expand"
    - "User can see scanner status display"
    - "User can enable/disable individual symbols via toggle"
  artifacts:
    - path: "apps/admin/src/components/symbols/SymbolWatchlist.tsx"
      provides: "Main watchlist component managing symbol display"
      exports: ["SymbolWatchlist"]
    - path: "apps/admin/src/components/symbols/SymbolRow.tsx"
      provides: "Individual symbol row with metrics and actions"
      exports: ["SymbolRow"]
    - path: "apps/admin/src/components/symbols/ScannerStatus.tsx"
      provides: "Scanner status card showing enabled state"
      exports: ["ScannerStatus"]
    - path: "apps/admin/src/pages/Symbols.tsx"
      provides: "Complete symbols page with watchlist and scanner status"
      min_lines: 60
  key_links:
    - from: "apps/admin/src/pages/Symbols.tsx"
      to: "/api/trpc/settings.get"
      via: "useQuery for symbols array"
      pattern: "trpc.settings.get"
    - from: "apps/admin/src/components/symbols/SymbolRow.tsx"
      to: "/api/trpc/symbol.metrics"
      via: "useQuery on expand for metrics"
      pattern: "trpc.symbol.(metrics|validate)"
---

<objective>
Build Symbol Watchlist UI with symbol display and metrics.

Purpose: Enable users to view their symbol watchlist with enable/disable toggles, see metrics on expand, and check scanner status.

Output: SymbolWatchlist component displaying symbols; SymbolRow with expand for metrics; ScannerStatus showing enabled state; Symbols page integrating all components.

Requirements covered: UI-SYM-01, UI-SYM-05, UI-SYM-06
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-admin-ui-control-symbols/22-RESEARCH.md
@.planning/phases/22-admin-ui-control-symbols/22-01-SUMMARY.md
@apps/admin/src/pages/Symbols.tsx
@apps/api/src/routers/symbol.router.ts
@apps/admin/src/components/ui/tooltip.tsx
@apps/admin/src/components/ui/switch.tsx
@packages/schemas/src/settings/user-settings.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SymbolRow component with metrics display</name>
  <files>
    apps/admin/src/components/symbols/SymbolRow.tsx
    apps/admin/src/components/symbols/index.ts
  </files>
  <action>
Create apps/admin/src/components/symbols/ directory and components.

Create apps/admin/src/components/symbols/SymbolRow.tsx:

```typescript
import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Switch } from '@/components/ui/switch';
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from '@/components/ui/tooltip';
import { ChevronDown, ChevronUp, Loader2 } from 'lucide-react';
import { trpc } from '@/lib/trpc';

interface SymbolRowProps {
  symbol: string;
  enabled: boolean;
  onToggle: (enabled: boolean) => void;
  onRemove: () => void;
  isRemoving?: boolean;
}

/**
 * Format price with appropriate decimal places
 */
function formatPrice(price: string): string {
  const num = parseFloat(price);
  if (isNaN(num)) return price;
  return num < 1 ? num.toFixed(6) : num.toLocaleString(undefined, { maximumFractionDigits: 2 });
}

/**
 * Format percentage change with sign
 */
function formatChange(change: string): string {
  const num = parseFloat(change);
  if (isNaN(num)) return change;
  return `${num >= 0 ? '+' : ''}${num.toFixed(2)}%`;
}

/**
 * Format volume with abbreviations
 */
function formatVolume(volume: string): string {
  const num = parseFloat(volume);
  if (isNaN(num)) return volume;

  if (num >= 1_000_000_000) {
    return `$${(num / 1_000_000_000).toFixed(2)}B`;
  }
  if (num >= 1_000_000) {
    return `$${(num / 1_000_000).toFixed(2)}M`;
  }
  if (num >= 1_000) {
    return `$${(num / 1_000).toFixed(2)}K`;
  }
  return `$${num.toFixed(2)}`;
}

/**
 * SymbolRow Component
 *
 * Displays individual symbol with:
 * - Enable/disable toggle (UI-SYM-01)
 * - Expandable metrics display (UI-SYM-06)
 * - Remove button
 */
export function SymbolRow({
  symbol,
  enabled,
  onToggle,
  onRemove,
  isRemoving,
}: SymbolRowProps) {
  const [expanded, setExpanded] = useState(false);

  // Fetch metrics when expanded
  const { data: metrics, isLoading: metricsLoading } = useQuery({
    ...trpc.symbol.validate.queryOptions({ symbol }),
    enabled: expanded, // Only fetch when expanded
    staleTime: 60_000, // Cache for 1 minute
  });

  const priceData = metrics?.valid ? metrics.metrics : null;

  return (
    <div className="border rounded-lg p-3">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          {/* Enable/Disable Toggle */}
          <Switch
            checked={enabled}
            onCheckedChange={onToggle}
            disabled={isRemoving}
          />

          {/* Symbol Name */}
          <span className="font-mono font-medium">{symbol}</span>

          {/* Backfilling indicator would go here if tracking state */}
        </div>

        <div className="flex items-center gap-4">
          {/* Price preview (from cached metrics if available) */}
          {priceData && (
            <TooltipProvider>
              <Tooltip>
                <TooltipTrigger>
                  <div className="text-sm text-right">
                    <div className="font-medium">
                      ${formatPrice(priceData.price)}
                    </div>
                    <div
                      className={
                        parseFloat(priceData.priceChange24h) >= 0
                          ? 'text-green-600'
                          : 'text-red-600'
                      }
                    >
                      {formatChange(priceData.priceChange24h)}
                    </div>
                  </div>
                </TooltipTrigger>
                <TooltipContent>
                  <p>24h Volume: {formatVolume(priceData.volume24h)}</p>
                </TooltipContent>
              </Tooltip>
            </TooltipProvider>
          )}

          {/* Expand/Collapse Button */}
          <Button
            variant="ghost"
            size="icon"
            onClick={() => setExpanded(!expanded)}
          >
            {expanded ? (
              <ChevronUp className="h-4 w-4" />
            ) : (
              <ChevronDown className="h-4 w-4" />
            )}
          </Button>

          {/* Remove Button */}
          <Button
            variant="ghost"
            size="icon"
            onClick={onRemove}
            disabled={isRemoving}
            className="text-red-500 hover:text-red-700 hover:bg-red-50"
          >
            {isRemoving ? (
              <Loader2 className="h-4 w-4 animate-spin" />
            ) : (
              <span className="text-lg">&times;</span>
            )}
          </Button>
        </div>
      </div>

      {/* Expanded Metrics Section */}
      {expanded && (
        <div className="mt-3 pt-3 border-t">
          {metricsLoading ? (
            <div className="flex items-center justify-center py-2">
              <Loader2 className="h-5 w-5 animate-spin text-gray-400" />
            </div>
          ) : priceData ? (
            <div className="grid grid-cols-3 gap-4 text-sm">
              <div>
                <span className="text-gray-500">Price</span>
                <div className="font-medium">
                  ${formatPrice(priceData.price)}
                </div>
              </div>
              <div>
                <span className="text-gray-500">24h Change</span>
                <div
                  className={
                    parseFloat(priceData.priceChange24h) >= 0
                      ? 'text-green-600 font-medium'
                      : 'text-red-600 font-medium'
                  }
                >
                  {formatChange(priceData.priceChange24h)}
                </div>
              </div>
              <div>
                <span className="text-gray-500">24h Volume</span>
                <div className="font-medium">
                  {formatVolume(priceData.volume24h)}
                </div>
              </div>
              <div>
                <span className="text-gray-500">Base</span>
                <div className="font-medium">{priceData.baseName}</div>
              </div>
              <div>
                <span className="text-gray-500">Quote</span>
                <div className="font-medium">{priceData.quoteName}</div>
              </div>
            </div>
          ) : (
            <p className="text-gray-500 text-sm">
              Unable to fetch metrics
            </p>
          )}
        </div>
      )}
    </div>
  );
}
```

Create apps/admin/src/components/symbols/index.ts:

```typescript
export { SymbolRow } from './SymbolRow';
```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/admin && pnpm tsc --noEmit
```
  </verify>
  <done>SymbolRow component displays symbol with enable/disable toggle and expandable metrics</done>
</task>

<task type="auto">
  <name>Task 2: Create ScannerStatus and SymbolWatchlist components</name>
  <files>
    apps/admin/src/components/symbols/ScannerStatus.tsx
    apps/admin/src/components/symbols/SymbolWatchlist.tsx
    apps/admin/src/components/symbols/index.ts
  </files>
  <action>
Create apps/admin/src/components/symbols/ScannerStatus.tsx:

```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Search, AlertCircle } from 'lucide-react';

interface ScannerStatusProps {
  scanner?: {
    enabled: boolean;
    exchange: string;
    lastRun?: string;
  } | null;
  isLoading?: boolean;
}

/**
 * ScannerStatus Component
 *
 * Displays scanner status information (UI-SYM-05):
 * - Enabled/disabled state
 * - Target exchange
 * - Last run timestamp (if available)
 */
export function ScannerStatus({ scanner, isLoading }: ScannerStatusProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Search className="h-5 w-5" />
          Scanner Status
        </CardTitle>
      </CardHeader>
      <CardContent>
        {isLoading ? (
          <div className="flex items-center justify-center py-4">
            <div className="h-6 w-6 animate-spin rounded-full border-2 border-gray-200 border-t-gray-600" />
          </div>
        ) : scanner ? (
          <div className="space-y-3">
            <div className="flex items-center justify-between">
              <span className="text-sm text-gray-500">Status</span>
              <Badge variant={scanner.enabled ? 'default' : 'secondary'}>
                {scanner.enabled ? 'Enabled' : 'Disabled'}
              </Badge>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-sm text-gray-500">Exchange</span>
              <span className="text-sm font-medium">{scanner.exchange}</span>
            </div>
            {scanner.lastRun && (
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-500">Last Run</span>
                <span className="text-sm">
                  {new Date(scanner.lastRun).toLocaleString()}
                </span>
              </div>
            )}
          </div>
        ) : (
          <div className="flex items-center gap-2 text-gray-500">
            <AlertCircle className="h-4 w-4" />
            <span className="text-sm">Scanner not configured</span>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

Create apps/admin/src/components/symbols/SymbolWatchlist.tsx:

```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { BarChart3 } from 'lucide-react';
import { SymbolRow } from './SymbolRow';

interface SymbolWatchlistProps {
  symbols: string[];
  disabledSymbols?: string[];
  onToggle: (symbol: string, enabled: boolean) => void;
  onRemove: (symbol: string) => void;
  removingSymbol?: string | null;
  isLoading?: boolean;
}

/**
 * SymbolWatchlist Component
 *
 * Displays the user's symbol watchlist (UI-SYM-01):
 * - List of symbols with enable/disable toggles
 * - Each symbol is rendered via SymbolRow
 * - Shows empty state when no symbols configured
 */
export function SymbolWatchlist({
  symbols,
  disabledSymbols = [],
  onToggle,
  onRemove,
  removingSymbol,
  isLoading,
}: SymbolWatchlistProps) {
  const disabledSet = new Set(disabledSymbols);

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <BarChart3 className="h-5 w-5" />
          Watchlist
          {!isLoading && <Badge variant="secondary">{symbols.length}</Badge>}
        </CardTitle>
      </CardHeader>
      <CardContent>
        {isLoading ? (
          <div className="flex items-center justify-center py-8">
            <div className="h-8 w-8 animate-spin rounded-full border-4 border-gray-200 border-t-gray-600" />
          </div>
        ) : symbols.length === 0 ? (
          <div className="text-center py-8 text-gray-500">
            <p>No symbols in your watchlist</p>
            <p className="text-sm mt-1">
              Add symbols using the form above
            </p>
          </div>
        ) : (
          <div className="space-y-2">
            {symbols.map((symbol) => (
              <SymbolRow
                key={symbol}
                symbol={symbol}
                enabled={!disabledSet.has(symbol)}
                onToggle={(enabled) => onToggle(symbol, enabled)}
                onRemove={() => onRemove(symbol)}
                isRemoving={removingSymbol === symbol}
              />
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

Update apps/admin/src/components/symbols/index.ts:

```typescript
export { SymbolRow } from './SymbolRow';
export { SymbolWatchlist } from './SymbolWatchlist';
export { ScannerStatus } from './ScannerStatus';
```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/admin && pnpm tsc --noEmit
```
  </verify>
  <done>SymbolWatchlist shows list of symbols with SymbolRow components; ScannerStatus shows scanner configuration</done>
</task>

<task type="auto">
  <name>Task 3: Integrate components into Symbols page</name>
  <files>apps/admin/src/pages/Symbols.tsx</files>
  <action>
Update apps/admin/src/pages/Symbols.tsx:

```typescript
import { useState } from 'react';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { toast } from 'sonner';
import { trpc, trpcClient } from '@/lib/trpc';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { SymbolWatchlist, ScannerStatus } from '@/components/symbols';
import { ConfirmationDialog } from '@/components/control';

/**
 * Symbols Page
 *
 * Symbol management page for viewing and managing the user's watchlist.
 *
 * Requirements:
 * - UI-SYM-01: Symbol watchlist display with enable/disable toggles
 * - UI-SYM-05: Scanner status display
 * - UI-SYM-06: Symbol metrics display on hover/expand
 *
 * Note: Add/Remove functionality will be added in Plan 05.
 */
export function Symbols() {
  const queryClient = useQueryClient();

  // Symbol pending removal (for confirmation dialog)
  const [removingSymbol, setRemovingSymbol] = useState<string | null>(null);
  const [showRemoveConfirm, setShowRemoveConfirm] = useState(false);

  // Fetch user settings
  const {
    data: settings,
    isLoading,
    error,
  } = useQuery(trpc.settings.get.queryOptions());

  // Extract symbols and scanner from settings
  const symbols: string[] = (settings as any)?.symbols ?? [];
  const disabledSymbols: string[] = (settings as any)?.disabledSymbols ?? [];
  const scanner = (settings as any)?.scanner ?? null;

  // Handle symbol toggle (enable/disable)
  const handleToggle = async (symbol: string, enabled: boolean) => {
    // For now, just show a toast - actual implementation will use settings.patch
    toast.info(
      `Symbol ${symbol} ${enabled ? 'enabled' : 'disabled'} (save pending)`
    );

    // TODO: In plan 05, this will call executeCommand to update settings
  };

  // Handle remove click (show confirmation)
  const handleRemoveClick = (symbol: string) => {
    setRemovingSymbol(symbol);
    setShowRemoveConfirm(true);
  };

  // Handle confirmed removal
  const handleConfirmRemove = async () => {
    if (!removingSymbol) return;

    try {
      // Execute remove-symbol command
      const result = await trpcClient.control.executeCommand.mutate({
        type: 'remove-symbol',
        payload: { symbol: removingSymbol },
      });

      if (result.success) {
        toast.success(`Symbol ${removingSymbol} removed`);
        queryClient.invalidateQueries({ queryKey: ['settings'] });
      } else {
        toast.error(result.message ?? 'Failed to remove symbol');
      }
    } catch (err: any) {
      toast.error(`Failed to remove symbol: ${err.message}`);
    } finally {
      setShowRemoveConfirm(false);
      setRemovingSymbol(null);
    }
  };

  if (error) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Symbols</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="rounded-md bg-red-50 p-4 text-red-700">
            Error loading symbols: {error.message}
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Placeholder for Add Symbol form (Plan 05) */}
      <Card>
        <CardHeader>
          <CardTitle>Add Symbol</CardTitle>
        </CardHeader>
        <CardContent>
          <p className="text-gray-500 text-sm">
            Symbol search and add form will be added in the next plan.
          </p>
        </CardContent>
      </Card>

      {/* Scanner Status */}
      <ScannerStatus scanner={scanner} isLoading={isLoading} />

      {/* Symbol Watchlist */}
      <SymbolWatchlist
        symbols={symbols}
        disabledSymbols={disabledSymbols}
        onToggle={handleToggle}
        onRemove={handleRemoveClick}
        removingSymbol={removingSymbol}
        isLoading={isLoading}
      />

      {/* Remove Confirmation Dialog */}
      <ConfirmationDialog
        open={showRemoveConfirm}
        onOpenChange={(open) => {
          setShowRemoveConfirm(open);
          if (!open) setRemovingSymbol(null);
        }}
        title="Remove Symbol"
        description={`Are you sure you want to remove ${removingSymbol} from your watchlist? This will stop monitoring and delete cached data for this symbol.`}
        confirmLabel="Remove"
        onConfirm={handleConfirmRemove}
        isLoading={removingSymbol !== null && !showRemoveConfirm}
      />
    </div>
  );
}
```
  </action>
  <verify>
1. Run dev server: `cd apps/admin && pnpm dev`
2. Navigate to http://localhost:5173/#/symbols
3. Scanner Status card displays (shows "Not configured" if no scanner in settings)
4. Watchlist shows symbols from settings
5. Clicking expand on a symbol row fetches and displays metrics
6. Clicking remove shows confirmation dialog
7. Confirming removal sends remove-symbol command
  </verify>
  <done>Symbols page displays watchlist with enable/disable toggles, expandable metrics, and scanner status</done>
</task>

</tasks>

<verification>
1. SymbolWatchlist renders list of symbols from settings
2. SymbolRow expands to show metrics fetched from symbol.validate
3. ScannerStatus shows configuration or "Not configured"
4. Enable/disable toggle works (shows toast for now)
5. Remove button shows confirmation dialog
6. Confirming removal executes remove-symbol command
</verification>

<success_criteria>
- UI-SYM-01: User can see symbols with enable/disable toggles
- UI-SYM-05: Scanner status displayed (enabled, exchange, last run)
- UI-SYM-06: Symbol metrics displayed on expand (price, volume, change)
</success_criteria>

<output>
After completion, create `.planning/phases/22-admin-ui-control-symbols/22-04-SUMMARY.md`
</output>

---
phase: 22-admin-ui-control-symbols
plan: 06
type: execute
wave: 4
depends_on: ["22-05"]
files_modified:
  - apps/admin/src/components/symbols/BulkImportModal.tsx
  - apps/admin/src/components/symbols/index.ts
  - apps/admin/src/pages/Symbols.tsx
autonomous: true

must_haves:
  truths:
    - "User can open bulk import modal from Symbols page"
    - "User can paste JSON array of symbols"
    - "User sees validation results for each symbol before import"
    - "User can import only valid symbols in one action"
    - "Duplicate and invalid symbols are clearly marked"
  artifacts:
    - path: "apps/admin/src/components/symbols/BulkImportModal.tsx"
      provides: "Modal with JSON input, validation preview, and import button"
      exports: ["BulkImportModal"]
    - path: "apps/admin/src/pages/Symbols.tsx"
      provides: "Symbols page with bulk import button and modal integration"
      min_lines: 130
  key_links:
    - from: "apps/admin/src/components/symbols/BulkImportModal.tsx"
      to: "/api/trpc/symbol.bulkValidate"
      via: "useMutation for validation"
      pattern: "trpc.symbol.bulkValidate"
    - from: "apps/admin/src/components/symbols/BulkImportModal.tsx"
      to: "/api/trpc/control.executeCommand"
      via: "useMutation for bulk-add-symbols"
      pattern: "type.*bulk-add-symbols"
---

<objective>
Add bulk import functionality to Symbols page.

Purpose: Enable users to import multiple symbols at once by pasting a JSON array, validating all symbols, and adding valid ones in a single operation.

Output: BulkImportModal component with JSON input, validation preview showing valid/invalid/duplicate status, and import button; Symbols page updated with bulk import button.

Requirements covered: UI-SYM-04
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-admin-ui-control-symbols/22-RESEARCH.md
@.planning/phases/22-admin-ui-control-symbols/22-05-SUMMARY.md
@apps/admin/src/pages/Symbols.tsx
@apps/admin/src/components/symbols/index.ts
@apps/api/src/routers/symbol.router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create BulkImportModal component</name>
  <files>
    apps/admin/src/components/symbols/BulkImportModal.tsx
    apps/admin/src/components/symbols/index.ts
  </files>
  <action>
Create apps/admin/src/components/symbols/BulkImportModal.tsx:

```typescript
import { useState } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { toast } from 'sonner';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import {
  CheckCircle,
  XCircle,
  AlertCircle,
  Loader2,
  Upload,
} from 'lucide-react';
import { trpcClient } from '@/lib/trpc';

interface ValidationResult {
  symbol: string;
  status: 'valid' | 'invalid' | 'duplicate';
  metrics?: {
    price: string;
    volume24h: string;
    priceChange24h: string;
    baseName: string;
    quoteName: string;
  };
  error?: string;
}

interface BulkImportModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  onImportComplete: () => void;
}

/**
 * BulkImportModal Component
 *
 * Modal for bulk importing symbols (UI-SYM-04):
 * - JSON array input (paste or type)
 * - Validation preview showing status for each symbol
 * - Import button to add all valid symbols at once
 */
export function BulkImportModal({
  open,
  onOpenChange,
  onImportComplete,
}: BulkImportModalProps) {
  const queryClient = useQueryClient();

  const [jsonInput, setJsonInput] = useState('');
  const [parseError, setParseError] = useState<string | null>(null);
  const [validationResults, setValidationResults] = useState<
    ValidationResult[] | null
  >(null);

  // Validate mutation
  const validateMutation = useMutation({
    mutationFn: async (symbols: string[]) => {
      const result = await trpcClient.symbol.bulkValidate.query({ symbols });
      return result;
    },
    onSuccess: (data) => {
      setValidationResults(data.results);
    },
    onError: (err) => {
      toast.error(`Validation failed: ${err.message}`);
    },
  });

  // Import mutation
  const importMutation = useMutation({
    mutationFn: async (symbols: string[]) => {
      const result = await trpcClient.control.executeCommand.mutate({
        type: 'bulk-add-symbols',
        payload: { symbols },
      });
      return result;
    },
    onSuccess: (result) => {
      if (result.success) {
        const data = result.data as {
          added: number;
          skipped: number;
          totalSymbols: number;
        };
        toast.success(
          `Imported ${data.added} symbols (${data.skipped} skipped)`
        );
        handleClose();
        onImportComplete();
        queryClient.invalidateQueries({ queryKey: ['settings'] });
      } else {
        toast.error(result.message ?? 'Import failed');
      }
    },
    onError: (err) => {
      toast.error(`Import failed: ${err.message}`);
    },
  });

  // Handle validate button
  const handleValidate = () => {
    setParseError(null);
    setValidationResults(null);

    try {
      const parsed = JSON.parse(jsonInput);

      if (!Array.isArray(parsed)) {
        setParseError('Input must be a JSON array (e.g., ["BTC-USD", "ETH-USD"])');
        return;
      }

      if (parsed.length === 0) {
        setParseError('Array cannot be empty');
        return;
      }

      if (parsed.length > 50) {
        setParseError('Maximum 50 symbols allowed per import');
        return;
      }

      // Ensure all items are strings
      const symbols = parsed.filter((item): item is string => typeof item === 'string');

      if (symbols.length !== parsed.length) {
        setParseError('All array items must be strings');
        return;
      }

      validateMutation.mutate(symbols);
    } catch (err) {
      setParseError('Invalid JSON. Example: ["BTC-USD", "ETH-USD", "SOL-USD"]');
    }
  };

  // Handle import button
  const handleImport = () => {
    if (!validationResults) return;

    const validSymbols = validationResults
      .filter((r) => r.status === 'valid')
      .map((r) => r.symbol);

    if (validSymbols.length === 0) {
      toast.error('No valid symbols to import');
      return;
    }

    importMutation.mutate(validSymbols);
  };

  // Handle close/reset
  const handleClose = () => {
    setJsonInput('');
    setParseError(null);
    setValidationResults(null);
    onOpenChange(false);
  };

  // Count results by status
  const validCount =
    validationResults?.filter((r) => r.status === 'valid').length ?? 0;
  const invalidCount =
    validationResults?.filter((r) => r.status === 'invalid').length ?? 0;
  const duplicateCount =
    validationResults?.filter((r) => r.status === 'duplicate').length ?? 0;

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="max-w-2xl max-h-[80vh] overflow-hidden flex flex-col">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Upload className="h-5 w-5" />
            Bulk Import Symbols
          </DialogTitle>
          <DialogDescription>
            Paste a JSON array of symbols to validate and import. Maximum 50
            symbols per import.
          </DialogDescription>
        </DialogHeader>

        <div className="flex-1 overflow-auto space-y-4">
          {/* JSON Input */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Symbol Array (JSON)
            </label>
            <textarea
              value={jsonInput}
              onChange={(e) => setJsonInput(e.target.value)}
              placeholder='["BTC-USD", "ETH-USD", "SOL-USD"]'
              className="w-full h-32 px-3 py-2 border rounded-md font-mono text-sm resize-none"
              disabled={validateMutation.isPending || importMutation.isPending}
            />
            {parseError && (
              <p className="mt-1 text-sm text-red-600">{parseError}</p>
            )}
          </div>

          {/* Validate Button */}
          {!validationResults && (
            <Button
              onClick={handleValidate}
              disabled={
                !jsonInput.trim() ||
                validateMutation.isPending ||
                importMutation.isPending
              }
              className="w-full"
            >
              {validateMutation.isPending ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Validating...
                </>
              ) : (
                'Validate Symbols'
              )}
            </Button>
          )}

          {/* Validation Results */}
          {validationResults && (
            <div className="space-y-3">
              {/* Summary */}
              <div className="flex items-center gap-3 text-sm">
                <Badge variant="default" className="gap-1">
                  <CheckCircle className="h-3 w-3" />
                  {validCount} valid
                </Badge>
                {invalidCount > 0 && (
                  <Badge variant="destructive" className="gap-1">
                    <XCircle className="h-3 w-3" />
                    {invalidCount} invalid
                  </Badge>
                )}
                {duplicateCount > 0 && (
                  <Badge variant="secondary" className="gap-1">
                    <AlertCircle className="h-3 w-3" />
                    {duplicateCount} duplicate
                  </Badge>
                )}
              </div>

              {/* Results List */}
              <div className="border rounded-md max-h-60 overflow-auto">
                {validationResults.map((result) => (
                  <div
                    key={result.symbol}
                    className="flex items-center justify-between px-3 py-2 border-b last:border-b-0"
                  >
                    <div className="flex items-center gap-2">
                      {result.status === 'valid' && (
                        <CheckCircle className="h-4 w-4 text-green-500" />
                      )}
                      {result.status === 'invalid' && (
                        <XCircle className="h-4 w-4 text-red-500" />
                      )}
                      {result.status === 'duplicate' && (
                        <AlertCircle className="h-4 w-4 text-yellow-500" />
                      )}
                      <span className="font-mono font-medium">
                        {result.symbol}
                      </span>
                    </div>
                    <div className="text-sm text-gray-500">
                      {result.status === 'valid' && result.metrics && (
                        <span>${parseFloat(result.metrics.price).toLocaleString(undefined, { maximumFractionDigits: 2 })}</span>
                      )}
                      {result.status === 'invalid' && (
                        <span className="text-red-500">
                          {result.error ?? 'Not found'}
                        </span>
                      )}
                      {result.status === 'duplicate' && (
                        <span>Already in watchlist</span>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              {/* Edit / Import Buttons */}
              <div className="flex gap-2">
                <Button
                  variant="outline"
                  onClick={() => setValidationResults(null)}
                  disabled={importMutation.isPending}
                >
                  Edit Input
                </Button>
                <Button
                  onClick={handleImport}
                  disabled={validCount === 0 || importMutation.isPending}
                  className="flex-1"
                >
                  {importMutation.isPending ? (
                    <>
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                      Importing...
                    </>
                  ) : (
                    `Import ${validCount} Symbol${validCount !== 1 ? 's' : ''}`
                  )}
                </Button>
              </div>
            </div>
          )}
        </div>

        <DialogFooter>
          <Button
            variant="ghost"
            onClick={handleClose}
            disabled={importMutation.isPending}
          >
            Cancel
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

Update apps/admin/src/components/symbols/index.ts:

```typescript
export { SymbolRow } from './SymbolRow';
export { SymbolWatchlist } from './SymbolWatchlist';
export { ScannerStatus } from './ScannerStatus';
export { AddSymbolForm } from './AddSymbolForm';
export { BulkImportModal } from './BulkImportModal';
```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/admin && pnpm tsc --noEmit
```
  </verify>
  <done>BulkImportModal component provides JSON input, validation preview, and bulk import functionality</done>
</task>

<task type="auto">
  <name>Task 2: Add bulk import button and modal to Symbols page</name>
  <files>apps/admin/src/pages/Symbols.tsx</files>
  <action>
Update apps/admin/src/pages/Symbols.tsx to add bulk import button and modal:

```typescript
import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { toast } from 'sonner';
import { trpc, trpcClient } from '@/lib/trpc';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Upload } from 'lucide-react';
import {
  SymbolWatchlist,
  ScannerStatus,
  AddSymbolForm,
  BulkImportModal,
} from '@/components/symbols';
import { ConfirmationDialog } from '@/components/control';

/**
 * Symbols Page
 *
 * Symbol management page for viewing and managing the user's watchlist.
 *
 * Requirements:
 * - UI-SYM-01: Symbol watchlist display with enable/disable toggles
 * - UI-SYM-02: Add symbol with search + validation against exchange
 * - UI-SYM-03: Remove symbol with confirmation
 * - UI-SYM-04: Bulk import modal (paste JSON, validate, preview)
 * - UI-SYM-05: Scanner status display
 * - UI-SYM-06: Symbol metrics display on hover/expand
 */
export function Symbols() {
  const queryClient = useQueryClient();

  // Symbol pending removal (for confirmation dialog)
  const [removingSymbol, setRemovingSymbol] = useState<string | null>(null);
  const [showRemoveConfirm, setShowRemoveConfirm] = useState(false);
  const [isRemoving, setIsRemoving] = useState(false);

  // Bulk import modal state
  const [showBulkImport, setShowBulkImport] = useState(false);

  // Fetch user settings
  const {
    data: settings,
    isLoading,
    error,
  } = useQuery(trpc.settings.get.queryOptions());

  // Extract symbols and scanner from settings
  const symbols: string[] = (settings as any)?.symbols ?? [];
  const disabledSymbols: string[] = (settings as any)?.disabledSymbols ?? [];
  const scanner = (settings as any)?.scanner ?? null;

  // Handle symbol toggle (enable/disable)
  const handleToggle = async (symbol: string, enabled: boolean) => {
    toast.info(
      `Symbol ${symbol} ${enabled ? 'enabled' : 'disabled'} - full toggle support coming in v4.1`
    );
  };

  // Handle remove click (show confirmation)
  const handleRemoveClick = (symbol: string) => {
    setRemovingSymbol(symbol);
    setShowRemoveConfirm(true);
  };

  // Handle confirmed removal
  const handleConfirmRemove = async () => {
    if (!removingSymbol) return;

    setIsRemoving(true);

    try {
      const result = await trpcClient.control.executeCommand.mutate({
        type: 'remove-symbol',
        payload: { symbol: removingSymbol },
      });

      if (result.success) {
        toast.success(`Symbol ${removingSymbol} removed from watchlist`);
        queryClient.invalidateQueries({ queryKey: ['settings'] });
      } else {
        toast.error(result.message ?? 'Failed to remove symbol');
      }
    } catch (err: any) {
      toast.error(`Failed to remove symbol: ${err.message}`);
    } finally {
      setShowRemoveConfirm(false);
      setRemovingSymbol(null);
      setIsRemoving(false);
    }
  };

  // Handle symbol added callback (single or bulk)
  const handleSymbolsChanged = () => {
    queryClient.invalidateQueries({ queryKey: ['settings'] });
  };

  if (error) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Symbols</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="rounded-md bg-red-50 p-4 text-red-700">
            Error loading symbols: {error.message}
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Add Symbol Section */}
      <div className="flex gap-4">
        <div className="flex-1">
          <AddSymbolForm
            existingSymbols={symbols}
            onSymbolAdded={handleSymbolsChanged}
          />
        </div>
        <div className="flex flex-col justify-start">
          <Card>
            <CardHeader>
              <CardTitle className="text-base">Bulk Import</CardTitle>
            </CardHeader>
            <CardContent>
              <Button
                onClick={() => setShowBulkImport(true)}
                variant="outline"
                className="w-full"
              >
                <Upload className="h-4 w-4 mr-2" />
                Import from JSON
              </Button>
              <p className="text-xs text-gray-500 mt-2">
                Import multiple symbols at once
              </p>
            </CardContent>
          </Card>
        </div>
      </div>

      {/* Scanner Status */}
      <ScannerStatus scanner={scanner} isLoading={isLoading} />

      {/* Symbol Watchlist */}
      <SymbolWatchlist
        symbols={symbols}
        disabledSymbols={disabledSymbols}
        onToggle={handleToggle}
        onRemove={handleRemoveClick}
        removingSymbol={removingSymbol}
        isLoading={isLoading}
      />

      {/* Remove Confirmation Dialog (UI-SYM-03) */}
      <ConfirmationDialog
        open={showRemoveConfirm}
        onOpenChange={(open) => {
          if (!isRemoving) {
            setShowRemoveConfirm(open);
            if (!open) setRemovingSymbol(null);
          }
        }}
        title="Remove Symbol"
        description={`Are you sure you want to remove ${removingSymbol} from your watchlist? This will stop monitoring and delete cached data for this symbol.`}
        confirmLabel="Remove Symbol"
        onConfirm={handleConfirmRemove}
        isLoading={isRemoving}
      />

      {/* Bulk Import Modal (UI-SYM-04) */}
      <BulkImportModal
        open={showBulkImport}
        onOpenChange={setShowBulkImport}
        onImportComplete={handleSymbolsChanged}
      />
    </div>
  );
}
```
  </action>
  <verify>
1. Run dev server: `cd apps/admin && pnpm dev`
2. Navigate to http://localhost:5173/#/symbols
3. "Bulk Import" card appears next to Add Symbol form
4. Click "Import from JSON" - modal opens
5. Paste: `["BTC-USD", "INVALID-XXX", "ETH-USD"]`
6. Click "Validate Symbols" - shows validation results with green/red/yellow badges
7. Click "Import 2 Symbols" - valid symbols are added
8. Toast shows success with count
9. Watchlist updates with new symbols
  </verify>
  <done>Symbols page has bulk import button that opens modal for validating and importing multiple symbols</done>
</task>

</tasks>

<verification>
1. Bulk Import button visible on Symbols page
2. Modal opens with JSON textarea
3. Paste JSON array and click Validate
4. Results show valid (green), invalid (red), duplicate (yellow)
5. Import button shows count of valid symbols
6. Clicking Import executes bulk-add-symbols command
7. Success toast shows added/skipped counts
8. Watchlist updates after import
</verification>

<success_criteria>
- UI-SYM-04: User can bulk import via JSON paste, validate, preview, and import
- Valid/invalid/duplicate symbols clearly distinguished
- Import adds only valid symbols
- Watchlist updates after bulk import
</success_criteria>

<output>
After completion, create `.planning/phases/22-admin-ui-control-symbols/22-06-SUMMARY.md`
</output>

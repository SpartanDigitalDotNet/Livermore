---
phase: 22-admin-ui-control-symbols
plan: 03
type: execute
wave: 3
depends_on: ["22-02"]
files_modified:
  - apps/admin/src/components/control/CommandHistory.tsx
  - apps/admin/src/components/control/ActiveSymbols.tsx
  - apps/admin/src/components/control/index.ts
  - apps/admin/src/pages/ControlPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User can see list of active symbols being monitored"
    - "User can see recent command history with timestamps and results"
    - "Command history updates when new commands are executed"
  artifacts:
    - path: "apps/admin/src/components/control/CommandHistory.tsx"
      provides: "Panel showing recent commands with timestamps and status"
      exports: ["CommandHistory"]
    - path: "apps/admin/src/components/control/ActiveSymbols.tsx"
      provides: "Card showing count and list of monitored symbols"
      exports: ["ActiveSymbols"]
  key_links:
    - from: "apps/admin/src/pages/ControlPanel.tsx"
      to: "components/control/CommandHistory.tsx"
      via: "commandHistory state and addCommand callback"
      pattern: "CommandHistory.*commandHistory"
    - from: "apps/admin/src/pages/ControlPanel.tsx"
      to: "/api/trpc/settings.get"
      via: "useQuery for symbols"
      pattern: "trpc.settings.get"
---

<objective>
Add command history panel and active symbols display to Control Panel.

Purpose: Enable users to track recently executed commands with their results, and see which symbols are currently being monitored.

Output: CommandHistory component showing recent commands with timestamps and success/error status; ActiveSymbols showing count and list of monitored symbols; ControlPanel page updated to include both components.

Requirements covered: UI-CTL-04, UI-CTL-06
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-admin-ui-control-symbols/22-RESEARCH.md
@.planning/phases/22-admin-ui-control-symbols/22-02-SUMMARY.md
@apps/admin/src/pages/ControlPanel.tsx
@apps/admin/src/components/control/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommandHistory component</name>
  <files>
    apps/admin/src/components/control/CommandHistory.tsx
    apps/admin/src/components/control/index.ts
  </files>
  <action>
Create apps/admin/src/components/control/CommandHistory.tsx:

```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { CheckCircle, XCircle, Clock, Loader2 } from 'lucide-react';

interface CommandHistoryItem {
  id: string;
  type: string;
  timestamp: Date;
  status: 'pending' | 'success' | 'error';
  message?: string;
  duration?: number; // milliseconds
}

interface CommandHistoryProps {
  commands: CommandHistoryItem[];
  maxItems?: number;
}

/**
 * Format timestamp to relative time (e.g., "2 minutes ago")
 */
function formatRelativeTime(date: Date): string {
  const seconds = Math.floor((Date.now() - date.getTime()) / 1000);

  if (seconds < 60) return 'just now';
  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  return date.toLocaleDateString();
}

/**
 * Format command type to human-readable label
 */
function formatCommandType(type: string): string {
  return type
    .split('-')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

/**
 * CommandHistory Component
 *
 * Displays recent commands with timestamps and status (UI-CTL-06).
 * Commands are stored in-memory (session only) and shown in reverse
 * chronological order.
 */
export function CommandHistory({
  commands,
  maxItems = 10,
}: CommandHistoryProps) {
  const displayedCommands = commands.slice(0, maxItems);

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <Clock className="h-5 w-5" />
          Command History
          {commands.length > 0 && (
            <Badge variant="secondary">{commands.length}</Badge>
          )}
        </CardTitle>
      </CardHeader>
      <CardContent>
        {displayedCommands.length === 0 ? (
          <p className="text-gray-500 text-sm">No commands executed yet</p>
        ) : (
          <div className="space-y-2">
            {displayedCommands.map((cmd) => (
              <div
                key={cmd.id}
                className="flex items-center justify-between border rounded-lg p-3"
              >
                <div className="flex items-center gap-3">
                  {/* Status Icon */}
                  {cmd.status === 'pending' && (
                    <Loader2 className="h-4 w-4 text-blue-500 animate-spin" />
                  )}
                  {cmd.status === 'success' && (
                    <CheckCircle className="h-4 w-4 text-green-500" />
                  )}
                  {cmd.status === 'error' && (
                    <XCircle className="h-4 w-4 text-red-500" />
                  )}

                  {/* Command Info */}
                  <div>
                    <div className="font-medium text-sm">
                      {formatCommandType(cmd.type)}
                    </div>
                    {cmd.message && (
                      <div className="text-xs text-gray-500 truncate max-w-xs">
                        {cmd.message}
                      </div>
                    )}
                  </div>
                </div>

                {/* Timestamp and Duration */}
                <div className="text-right">
                  <div className="text-xs text-gray-500">
                    {formatRelativeTime(cmd.timestamp)}
                  </div>
                  {cmd.duration !== undefined && cmd.status !== 'pending' && (
                    <div className="text-xs text-gray-400">
                      {cmd.duration}ms
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  );
}

export type { CommandHistoryItem };
```

Update apps/admin/src/components/control/index.ts:

```typescript
export { RuntimeStatus } from './RuntimeStatus';
export { ControlButtons } from './ControlButtons';
export { ConfirmationDialog } from './ConfirmationDialog';
export { CommandHistory } from './CommandHistory';
export type { CommandHistoryItem } from './CommandHistory';
```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/admin && pnpm tsc --noEmit
```
  </verify>
  <done>CommandHistory component displays recent commands with status icons, timestamps, and duration</done>
</task>

<task type="auto">
  <name>Task 2: Create ActiveSymbols component</name>
  <files>
    apps/admin/src/components/control/ActiveSymbols.tsx
    apps/admin/src/components/control/index.ts
  </files>
  <action>
Create apps/admin/src/components/control/ActiveSymbols.tsx:

```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { BarChart3 } from 'lucide-react';

interface ActiveSymbolsProps {
  symbols: string[];
  isLoading?: boolean;
}

/**
 * ActiveSymbols Component
 *
 * Displays count and list of currently monitored symbols (UI-CTL-04).
 * Symbols are fetched from user settings.
 */
export function ActiveSymbols({ symbols, isLoading }: ActiveSymbolsProps) {
  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <BarChart3 className="h-5 w-5" />
          Active Symbols
          {!isLoading && <Badge variant="secondary">{symbols.length}</Badge>}
        </CardTitle>
      </CardHeader>
      <CardContent>
        {isLoading ? (
          <div className="flex items-center justify-center py-4">
            <div className="h-6 w-6 animate-spin rounded-full border-2 border-gray-200 border-t-gray-600" />
          </div>
        ) : symbols.length === 0 ? (
          <p className="text-gray-500 text-sm">No symbols being monitored</p>
        ) : (
          <div className="flex flex-wrap gap-2">
            {symbols.map((symbol) => (
              <Badge key={symbol} variant="outline" className="font-mono">
                {symbol}
              </Badge>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

Update apps/admin/src/components/control/index.ts:

```typescript
export { RuntimeStatus } from './RuntimeStatus';
export { ControlButtons } from './ControlButtons';
export { ConfirmationDialog } from './ConfirmationDialog';
export { CommandHistory } from './CommandHistory';
export { ActiveSymbols } from './ActiveSymbols';
export type { CommandHistoryItem } from './CommandHistory';
```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/admin && pnpm tsc --noEmit
```
  </verify>
  <done>ActiveSymbols component displays count and badge list of monitored symbols</done>
</task>

<task type="auto">
  <name>Task 3: Integrate CommandHistory and ActiveSymbols into ControlPanel</name>
  <files>apps/admin/src/pages/ControlPanel.tsx</files>
  <action>
Update apps/admin/src/pages/ControlPanel.tsx to add command history tracking and active symbols display:

```typescript
import { useState, useCallback } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { toast } from 'sonner';
import { trpc, trpcClient } from '@/lib/trpc';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import {
  RuntimeStatus,
  ControlButtons,
  CommandHistory,
  ActiveSymbols,
  type CommandHistoryItem,
} from '@/components/control';

/**
 * ControlPanel Page
 *
 * Main control panel for monitoring and controlling API runtime.
 *
 * Requirements:
 * - UI-CTL-01: Runtime status display
 * - UI-CTL-02: Pause/resume buttons
 * - UI-CTL-03: Mode switcher
 * - UI-CTL-04: Active symbols count and list
 * - UI-CTL-05: Exchange connection status
 * - UI-CTL-06: Command history panel
 * - UI-CTL-07: Confirmation dialog for destructive commands
 */
export function ControlPanel() {
  const queryClient = useQueryClient();

  // Command history state (session memory only)
  const [commandHistory, setCommandHistory] = useState<CommandHistoryItem[]>([]);

  // Fetch status with 5-second polling
  const {
    data: status,
    isLoading: statusLoading,
    error: statusError,
  } = useQuery({
    ...trpc.control.getStatus.queryOptions(),
    refetchInterval: 5000,
  });

  // Fetch user settings for symbols list
  const {
    data: settings,
    isLoading: settingsLoading,
  } = useQuery(trpc.settings.get.queryOptions());

  // Get symbols from settings
  const symbols: string[] = (settings as any)?.symbols ?? [];

  // Add command to history
  const addCommand = useCallback(
    (
      id: string,
      type: string,
      status: 'pending' | 'success' | 'error',
      message?: string,
      duration?: number
    ) => {
      setCommandHistory((prev) => {
        // Find existing command or create new
        const existingIndex = prev.findIndex((cmd) => cmd.id === id);

        if (existingIndex >= 0) {
          // Update existing command
          const updated = [...prev];
          updated[existingIndex] = {
            ...updated[existingIndex],
            status,
            message,
            duration,
          };
          return updated;
        }

        // Add new command at the start
        return [
          {
            id,
            type,
            timestamp: new Date(),
            status,
            message,
            duration,
          },
          ...prev,
        ].slice(0, 50); // Keep max 50 items
      });
    },
    []
  );

  // Command execution mutation
  const executeCommandMutation = useMutation({
    mutationFn: async (params: {
      type: string;
      payload?: Record<string, unknown>;
    }) => {
      const result = await trpcClient.control.executeCommand.mutate({
        type: params.type as any,
        payload: params.payload,
      });
      return result;
    },
    onMutate: (variables) => {
      // Add pending command to history
      const id = crypto.randomUUID();
      addCommand(id, variables.type, 'pending');
      return { id, startTime: Date.now() };
    },
    onSuccess: (result, variables, context) => {
      const duration = context ? Date.now() - context.startTime : undefined;

      if (result.success) {
        addCommand(
          context?.id ?? '',
          variables.type,
          'success',
          'Completed',
          duration
        );
        toast.success(`Command '${variables.type}' executed successfully`);
      } else {
        addCommand(
          context?.id ?? '',
          variables.type,
          'error',
          result.message ?? 'Failed',
          duration
        );
        toast.error(result.message ?? 'Command failed');
      }
      // Refetch status immediately after command
      queryClient.invalidateQueries({ queryKey: ['control', 'getStatus'] });
    },
    onError: (err, variables, context) => {
      const duration = context ? Date.now() - context.startTime : undefined;
      addCommand(
        context?.id ?? '',
        variables.type,
        'error',
        err.message,
        duration
      );
      toast.error(`Command failed: ${err.message}`);
    },
  });

  const handlePause = () => {
    executeCommandMutation.mutate({ type: 'pause' });
  };

  const handleResume = () => {
    executeCommandMutation.mutate({ type: 'resume' });
  };

  const handleModeChange = (mode: string) => {
    executeCommandMutation.mutate({
      type: 'switch-mode',
      payload: { mode },
    });
  };

  const handleReloadSettings = () => {
    executeCommandMutation.mutate({ type: 'reload-settings' });
  };

  const handleClearCache = (scope: 'all' | 'symbol' | 'timeframe') => {
    executeCommandMutation.mutate({
      type: 'clear-cache',
      payload: { scope },
    });
  };

  if (statusError) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Control Panel</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="rounded-md bg-red-50 p-4 text-red-700">
            Error loading status: {statusError.message}
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Top Row: Status and Active Symbols */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <RuntimeStatus status={status ?? null} isLoading={statusLoading} />
        <ActiveSymbols symbols={symbols} isLoading={settingsLoading} />
      </div>

      {/* Controls Card */}
      <Card>
        <CardHeader>
          <CardTitle>Controls</CardTitle>
        </CardHeader>
        <CardContent>
          <ControlButtons
            isPaused={status?.isPaused ?? false}
            currentMode={status?.mode ?? 'position-monitor'}
            onPause={handlePause}
            onResume={handleResume}
            onModeChange={handleModeChange}
            onReloadSettings={handleReloadSettings}
            onClearCache={handleClearCache}
            isExecuting={executeCommandMutation.isPending}
          />
        </CardContent>
      </Card>

      {/* Command History */}
      <CommandHistory commands={commandHistory} maxItems={10} />
    </div>
  );
}
```
  </action>
  <verify>
1. Run dev server: `cd apps/admin && pnpm dev`
2. Navigate to http://localhost:5173/#/control
3. Active Symbols card shows count and badges of symbols from settings
4. Execute a command (e.g., Reload Settings)
5. Command appears in history with "pending" status
6. After completion, status updates to "success" or "error" with duration
7. Command history shows recent commands in reverse chronological order
  </verify>
  <done>ControlPanel displays active symbols count/list and command history with timestamps and results</done>
</task>

</tasks>

<verification>
1. ActiveSymbols shows count badge and symbol badges from settings
2. CommandHistory shows empty state when no commands
3. Executing command adds pending entry to history
4. Command completion updates history with success/error and duration
5. History shows relative timestamps (e.g., "just now", "2m ago")
</verification>

<success_criteria>
- UI-CTL-04: User can see count and list of active symbols
- UI-CTL-06: User can see command history with timestamps and results
- History updates in real-time as commands execute
</success_criteria>

<output>
After completion, create `.planning/phases/22-admin-ui-control-symbols/22-03-SUMMARY.md`
</output>

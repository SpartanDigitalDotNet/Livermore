---
phase: 22-admin-ui-control-symbols
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - apps/admin/src/components/control/RuntimeStatus.tsx
  - apps/admin/src/components/control/ControlButtons.tsx
  - apps/admin/src/components/control/ConfirmationDialog.tsx
  - apps/admin/src/components/control/index.ts
  - apps/admin/src/pages/ControlPanel.tsx
autonomous: true

must_haves:
  truths:
    - "User can see current API status (running/paused, mode, uptime)"
    - "User can pause and resume API with single button click"
    - "User can switch runtime mode from dropdown"
    - "User sees exchange connection status indicator"
    - "Destructive actions (clear-cache) require confirmation dialog"
  artifacts:
    - path: "apps/admin/src/components/control/RuntimeStatus.tsx"
      provides: "Status card showing running state, mode, uptime, exchange status"
      exports: ["RuntimeStatus"]
    - path: "apps/admin/src/components/control/ControlButtons.tsx"
      provides: "Pause/Resume, Mode switcher, Clear cache buttons"
      exports: ["ControlButtons"]
    - path: "apps/admin/src/components/control/ConfirmationDialog.tsx"
      provides: "Reusable confirmation dialog for destructive actions"
      exports: ["ConfirmationDialog"]
    - path: "apps/admin/src/pages/ControlPanel.tsx"
      provides: "Complete control panel page with status and controls"
      min_lines: 80
  key_links:
    - from: "apps/admin/src/pages/ControlPanel.tsx"
      to: "/api/trpc/control.getStatus"
      via: "useQuery with 5s polling"
      pattern: "refetchInterval.*5000"
    - from: "apps/admin/src/components/control/ControlButtons.tsx"
      to: "/api/trpc/control.executeCommand"
      via: "useMutation"
      pattern: "trpc.control.executeCommand"
---

<objective>
Build Control Panel UI with status display and control buttons.

Purpose: Enable users to monitor API runtime status and execute pause/resume/mode-switch/clear-cache commands from the Admin UI.

Output: RuntimeStatus component showing status card; ControlButtons with pause/resume, mode switcher, and clear-cache; ConfirmationDialog for destructive actions; ControlPanel page integrating all components.

Requirements covered: UI-CTL-01, UI-CTL-02, UI-CTL-03, UI-CTL-05, UI-CTL-07
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/22-admin-ui-control-symbols/22-RESEARCH.md
@.planning/phases/22-admin-ui-control-symbols/22-01-SUMMARY.md
@apps/admin/src/pages/ControlPanel.tsx
@apps/api/src/routers/control.router.ts
@apps/admin/src/components/ui/badge.tsx
@apps/admin/src/components/ui/dialog.tsx
@apps/admin/src/components/ui/button.tsx
@apps/admin/src/components/ui/select.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RuntimeStatus and ConfirmationDialog components</name>
  <files>
    apps/admin/src/components/control/RuntimeStatus.tsx
    apps/admin/src/components/control/ConfirmationDialog.tsx
    apps/admin/src/components/control/index.ts
  </files>
  <action>
Create apps/admin/src/components/control/ directory and components.

Create apps/admin/src/components/control/RuntimeStatus.tsx:

```typescript
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { PlayCircle, PauseCircle, Clock, Wifi, WifiOff } from 'lucide-react';

interface RuntimeStatusProps {
  status: {
    isPaused: boolean;
    mode: string;
    uptime: number;
    exchangeConnected: boolean;
    queueDepth: number;
  } | null;
  isLoading: boolean;
}

/**
 * Format uptime seconds into human-readable string
 */
function formatUptime(seconds: number): string {
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);

  if (hours > 0) {
    return `${hours}h ${minutes}m`;
  }
  if (minutes > 0) {
    return `${minutes}m ${secs}s`;
  }
  return `${secs}s`;
}

/**
 * RuntimeStatus Component
 *
 * Displays current API runtime status including:
 * - Running/Paused state (UI-CTL-01)
 * - Current mode (UI-CTL-01)
 * - Uptime (UI-CTL-01)
 * - Exchange connection status (UI-CTL-05)
 */
export function RuntimeStatus({ status, isLoading }: RuntimeStatusProps) {
  if (isLoading || !status) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Runtime Status</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="flex items-center justify-center py-8">
            <div className="h-8 w-8 animate-spin rounded-full border-4 border-gray-200 border-t-gray-600" />
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          Runtime Status
          <Badge variant={status.isPaused ? 'secondary' : 'default'}>
            {status.isPaused ? (
              <>
                <PauseCircle className="h-3 w-3 mr-1" />
                Paused
              </>
            ) : (
              <>
                <PlayCircle className="h-3 w-3 mr-1" />
                Running
              </>
            )}
          </Badge>
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        <div className="grid grid-cols-2 gap-4">
          {/* Uptime */}
          <div className="flex items-center gap-2">
            <Clock className="h-4 w-4 text-gray-500" />
            <span className="text-sm">Uptime: {formatUptime(status.uptime)}</span>
          </div>

          {/* Exchange Status */}
          <div className="flex items-center gap-2">
            {status.exchangeConnected ? (
              <Wifi className="h-4 w-4 text-green-500" />
            ) : (
              <WifiOff className="h-4 w-4 text-red-500" />
            )}
            <span className="text-sm">
              Exchange: {status.exchangeConnected ? 'Connected' : 'Disconnected'}
            </span>
          </div>
        </div>

        {/* Mode */}
        <div>
          <span className="text-sm text-gray-500">Mode: </span>
          <Badge variant="outline">{status.mode}</Badge>
        </div>

        {/* Queue Depth (if > 0) */}
        {status.queueDepth > 0 && (
          <div className="text-sm text-yellow-600">
            {status.queueDepth} commands in queue
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

Create apps/admin/src/components/control/ConfirmationDialog.tsx:

```typescript
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog';
import { Button } from '@/components/ui/button';

interface ConfirmationDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  title: string;
  description: string;
  confirmLabel?: string;
  onConfirm: () => void;
  isLoading?: boolean;
  variant?: 'default' | 'destructive';
}

/**
 * ConfirmationDialog Component
 *
 * Reusable confirmation dialog for destructive actions (UI-CTL-07).
 * Used for clear-cache and remove-symbol operations.
 */
export function ConfirmationDialog({
  open,
  onOpenChange,
  title,
  description,
  confirmLabel = 'Confirm',
  onConfirm,
  isLoading = false,
  variant = 'destructive',
}: ConfirmationDialogProps) {
  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>{title}</DialogTitle>
          <DialogDescription>{description}</DialogDescription>
        </DialogHeader>
        <DialogFooter>
          <Button
            variant="outline"
            onClick={() => onOpenChange(false)}
            disabled={isLoading}
          >
            Cancel
          </Button>
          <Button
            variant={variant}
            onClick={onConfirm}
            disabled={isLoading}
          >
            {isLoading ? 'Processing...' : confirmLabel}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

Create apps/admin/src/components/control/index.ts:

```typescript
export { RuntimeStatus } from './RuntimeStatus';
export { ConfirmationDialog } from './ConfirmationDialog';
```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/admin && pnpm tsc --noEmit
```
  </verify>
  <done>RuntimeStatus shows status card with running state, mode, uptime, exchange status; ConfirmationDialog ready for destructive action confirmations</done>
</task>

<task type="auto">
  <name>Task 2: Create ControlButtons component with pause/resume/mode/clear-cache</name>
  <files>
    apps/admin/src/components/control/ControlButtons.tsx
    apps/admin/src/components/control/index.ts
  </files>
  <action>
Create apps/admin/src/components/control/ControlButtons.tsx:

```typescript
import { useState } from 'react';
import { Button } from '@/components/ui/button';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Play, Pause, RefreshCw, Trash2 } from 'lucide-react';
import { ConfirmationDialog } from './ConfirmationDialog';

interface ControlButtonsProps {
  isPaused: boolean;
  currentMode: string;
  onPause: () => void;
  onResume: () => void;
  onModeChange: (mode: string) => void;
  onReloadSettings: () => void;
  onClearCache: (scope: 'all' | 'symbol' | 'timeframe') => void;
  isExecuting: boolean;
}

/**
 * ControlButtons Component
 *
 * Provides runtime control buttons:
 * - Pause/Resume toggle (UI-CTL-02)
 * - Mode switcher dropdown (UI-CTL-03)
 * - Reload settings button
 * - Clear cache button with confirmation (UI-CTL-07)
 */
export function ControlButtons({
  isPaused,
  currentMode,
  onPause,
  onResume,
  onModeChange,
  onReloadSettings,
  onClearCache,
  isExecuting,
}: ControlButtonsProps) {
  const [showClearConfirm, setShowClearConfirm] = useState(false);

  return (
    <div className="flex flex-wrap items-center gap-3">
      {/* Pause/Resume Button */}
      {isPaused ? (
        <Button onClick={onResume} disabled={isExecuting}>
          <Play className="h-4 w-4 mr-2" />
          Resume
        </Button>
      ) : (
        <Button onClick={onPause} disabled={isExecuting} variant="secondary">
          <Pause className="h-4 w-4 mr-2" />
          Pause
        </Button>
      )}

      {/* Mode Switcher */}
      <Select
        value={currentMode}
        onValueChange={onModeChange}
        disabled={isExecuting}
      >
        <SelectTrigger className="w-48">
          <SelectValue placeholder="Select mode" />
        </SelectTrigger>
        <SelectContent>
          <SelectItem value="position-monitor">Position Monitor</SelectItem>
          <SelectItem value="scalper-macdv">Scalper MACD-V</SelectItem>
          <SelectItem value="scalper-orderbook" disabled>
            Scalper Orderbook (v4.1)
          </SelectItem>
        </SelectContent>
      </Select>

      {/* Reload Settings */}
      <Button
        variant="outline"
        onClick={onReloadSettings}
        disabled={isExecuting}
      >
        <RefreshCw className="h-4 w-4 mr-2" />
        Reload Settings
      </Button>

      {/* Clear Cache */}
      <Button
        variant="destructive"
        onClick={() => setShowClearConfirm(true)}
        disabled={isExecuting}
      >
        <Trash2 className="h-4 w-4 mr-2" />
        Clear Cache
      </Button>

      {/* Clear Cache Confirmation Dialog */}
      <ConfirmationDialog
        open={showClearConfirm}
        onOpenChange={setShowClearConfirm}
        title="Clear Cache"
        description="This will delete all cached candles and indicators. You'll need to wait for backfill to complete before data is available again. This action cannot be undone."
        confirmLabel="Clear All Cache"
        onConfirm={() => {
          onClearCache('all');
          setShowClearConfirm(false);
        }}
        isLoading={isExecuting}
      />
    </div>
  );
}
```

Update apps/admin/src/components/control/index.ts:

```typescript
export { RuntimeStatus } from './RuntimeStatus';
export { ControlButtons } from './ControlButtons';
export { ConfirmationDialog } from './ConfirmationDialog';
```
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd apps/admin && pnpm tsc --noEmit
```
  </verify>
  <done>ControlButtons component provides pause/resume toggle, mode switcher, reload settings, and clear-cache with confirmation dialog</done>
</task>

<task type="auto">
  <name>Task 3: Integrate components into ControlPanel page with data fetching</name>
  <files>apps/admin/src/pages/ControlPanel.tsx</files>
  <action>
Update apps/admin/src/pages/ControlPanel.tsx:

```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { toast } from 'sonner';
import { trpc, trpcClient } from '@/lib/trpc';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { RuntimeStatus, ControlButtons } from '@/components/control';

/**
 * ControlPanel Page
 *
 * Main control panel for monitoring and controlling API runtime.
 *
 * Requirements:
 * - UI-CTL-01: Runtime status display
 * - UI-CTL-02: Pause/resume buttons
 * - UI-CTL-03: Mode switcher
 * - UI-CTL-05: Exchange connection status
 * - UI-CTL-07: Confirmation dialog for destructive commands
 */
export function ControlPanel() {
  const queryClient = useQueryClient();

  // Fetch status with 5-second polling
  const {
    data: status,
    isLoading,
    error,
  } = useQuery({
    ...trpc.control.getStatus.queryOptions(),
    refetchInterval: 5000, // Poll every 5 seconds
  });

  // Command execution mutation
  const executeCommandMutation = useMutation({
    mutationFn: async (params: {
      type: string;
      payload?: Record<string, unknown>;
    }) => {
      const result = await trpcClient.control.executeCommand.mutate({
        type: params.type as any,
        payload: params.payload,
      });
      return result;
    },
    onSuccess: (result, variables) => {
      if (result.success) {
        toast.success(`Command '${variables.type}' executed successfully`);
      } else {
        toast.error(result.message ?? 'Command failed');
      }
      // Refetch status immediately after command
      queryClient.invalidateQueries({ queryKey: ['control', 'getStatus'] });
    },
    onError: (err) => {
      toast.error(`Command failed: ${err.message}`);
    },
  });

  const handlePause = () => {
    executeCommandMutation.mutate({ type: 'pause' });
  };

  const handleResume = () => {
    executeCommandMutation.mutate({ type: 'resume' });
  };

  const handleModeChange = (mode: string) => {
    executeCommandMutation.mutate({
      type: 'switch-mode',
      payload: { mode },
    });
  };

  const handleReloadSettings = () => {
    executeCommandMutation.mutate({ type: 'reload-settings' });
  };

  const handleClearCache = (scope: 'all' | 'symbol' | 'timeframe') => {
    executeCommandMutation.mutate({
      type: 'clear-cache',
      payload: { scope },
    });
  };

  if (error) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Control Panel</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="rounded-md bg-red-50 p-4 text-red-700">
            Error loading status: {error.message}
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Runtime Status Card */}
      <RuntimeStatus status={status ?? null} isLoading={isLoading} />

      {/* Controls Card */}
      <Card>
        <CardHeader>
          <CardTitle>Controls</CardTitle>
        </CardHeader>
        <CardContent>
          <ControlButtons
            isPaused={status?.isPaused ?? false}
            currentMode={status?.mode ?? 'position-monitor'}
            onPause={handlePause}
            onResume={handleResume}
            onModeChange={handleModeChange}
            onReloadSettings={handleReloadSettings}
            onClearCache={handleClearCache}
            isExecuting={executeCommandMutation.isPending}
          />
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
1. Run dev server: `cd apps/admin && pnpm dev`
2. Navigate to http://localhost:5173/#/control
3. RuntimeStatus card displays with loading state, then shows mock status
4. ControlButtons render with Pause/Resume, Mode dropdown, Reload Settings, Clear Cache
5. Clicking Clear Cache shows confirmation dialog
6. Buttons are disabled during command execution (isPending state)
  </verify>
  <done>ControlPanel page displays runtime status with 5s polling, provides pause/resume/mode-switch/clear-cache controls with confirmation dialog</done>
</task>

</tasks>

<verification>
1. RuntimeStatus shows running/paused state, mode, uptime, exchange status
2. Pause/Resume buttons toggle based on current state
3. Mode switcher dropdown shows available modes
4. Clear Cache button shows confirmation dialog before executing
5. Commands show toast notifications on success/error
6. Status refetches immediately after command execution
</verification>

<success_criteria>
- UI-CTL-01: User sees running/paused, mode, uptime at a glance
- UI-CTL-02: User can pause/resume with single click
- UI-CTL-03: User can switch mode via dropdown
- UI-CTL-05: Exchange connection status displayed
- UI-CTL-07: Clear cache requires confirmation before execution
</success_criteria>

<output>
After completion, create `.planning/phases/22-admin-ui-control-symbols/22-02-SUMMARY.md`
</output>

---
phase: 02-fee-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - spikes/fee-analysis/calculations.ts
  - spikes/fee-analysis/analyze-fees.ts
autonomous: true

must_haves:
  truths:
    - "Running script shows total fees and volume per symbol"
    - "Running script shows effective fee rate per symbol as percentage"
    - "Running script shows BUY vs SELL comparison per symbol"
    - "Running script shows monthly breakdown with fees and volume"
  artifacts:
    - path: "spikes/fee-analysis/calculations.ts"
      provides: "Pure calculation functions for fee analysis"
      exports: ["calculateSymbolFees", "calculateSideFees", "calculateMonthlyFees"]
    - path: "spikes/fee-analysis/analyze-fees.ts"
      provides: "Complete fee analysis with all calculations displayed"
      contains: "calculateSymbolFees"
  key_links:
    - from: "spikes/fee-analysis/analyze-fees.ts"
      to: "spikes/fee-analysis/calculations.ts"
      via: "import and call"
      pattern: "import.*calculations"
---

<objective>
Add fee calculation functions and integrate them into the analyze-fees spike.

Purpose: Complete Phase 2 requirements (SYMBOL-01 through SYMBOL-04, SIDE-01, SIDE-02, MONTH-01 through MONTH-04) by implementing pure calculation functions that aggregate order data.

Output: Extended spike script that displays per-symbol fees, buy/sell comparison, and monthly breakdown when run.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-fee-analysis/02-RESEARCH.md
@.planning/phases/01-data-retrieval/01-01-SUMMARY.md
@spikes/fee-analysis/analyze-fees.ts
@packages/coinbase-client/src/rest/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create fee calculation functions module</name>
  <files>spikes/fee-analysis/calculations.ts</files>
  <action>
Create a new calculations.ts module with three pure calculation functions and their return types.

**Types to define:**

```typescript
interface SymbolFeeReport {
  symbol: string;
  totalFees: number;
  totalVolume: number;
  effectiveFeeRate: number; // as percentage (e.g., 0.5 for 0.5%)
  averageFeePerTrade: number;
  orderCount: number;
}

interface SideFeeReport {
  symbol: string;
  side: 'BUY' | 'SELL';
  totalFees: number;
  totalVolume: number;
  effectiveFeeRate: number;
  orderCount: number;
}

interface MonthlyFeeReport {
  yearMonth: string; // "YYYY-MM" format
  totalFees: number;
  totalVolume: number;
  effectiveFeeRate: number;
  orderCount: number;
}
```

**Functions to implement:**

1. `calculateSymbolFees(orders: CoinbaseOrder[]): SymbolFeeReport[]`
   - Group orders by `product_id`
   - For each symbol: sum `total_fees`, sum `filled_value`, calculate rate as `(fees/volume)*100`
   - Handle empty/undefined fields with `parseFloat(order.total_fees || '0')`
   - Return sorted by totalFees descending

2. `calculateSideFees(orders: CoinbaseOrder[]): SideFeeReport[]`
   - Group orders by composite key `${product_id}:${side}`
   - Calculate same metrics per symbol+side combination
   - Return sorted by symbol then side

3. `calculateMonthlyFees(orders: CoinbaseOrder[]): MonthlyFeeReport[]`
   - Extract year-month from `created_time.substring(0, 7)` (gives "YYYY-MM")
   - Group orders by year-month
   - Calculate same metrics per month
   - Return sorted by yearMonth ascending (chronological)

**Patterns from research:**
- Use Map for grouping: `new Map<string, CoinbaseOrder[]>()`
- Check for division by zero: `volume > 0 ? (fees/volume)*100 : 0`
- Check for empty arrays: `orders.length > 0 ? fees/orders.length : 0`

Export all three functions and all three interfaces.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd spikes/fee-analysis && pnpm tsc --noEmit
```
  </verify>
  <done>calculations.ts exists with three exported functions and three exported interfaces. TypeScript compiles successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate calculations into spike script</name>
  <files>spikes/fee-analysis/analyze-fees.ts</files>
  <action>
Extend the existing analyze-fees.ts to use the calculation functions and display results.

**Add import at top:**
```typescript
import {
  calculateSymbolFees,
  calculateSideFees,
  calculateMonthlyFees,
  type SymbolFeeReport,
  type SideFeeReport,
  type MonthlyFeeReport,
} from './calculations.js';
```

**Add display functions:**

1. `displaySymbolFees(reports: SymbolFeeReport[])` - Displays table with columns:
   - Symbol, Total Fees, Total Volume, Eff Rate%, Avg Fee, Orders
   - Use existing formatCurrency() for fee/volume values
   - Format rate as `X.XX%`

2. `displaySideFees(reports: SideFeeReport[])` - Displays comparison table:
   - For each symbol, show BUY row and SELL row side by side or grouped
   - Highlight if buy/sell rates differ significantly

3. `displayMonthlyFees(reports: MonthlyFeeReport[])` - Displays monthly table:
   - Year-Month, Total Fees, Total Volume, Eff Rate%, Orders
   - Chronological order (oldest to newest)

**In main() function, after "Data retrieval complete" section, add:**

```typescript
// Calculate and display fee analysis
console.log('\n=== Fee Analysis by Symbol ===\n');
const symbolFees = calculateSymbolFees(orders);
displaySymbolFees(symbolFees);

console.log('\n=== Buy vs Sell Comparison ===\n');
const sideFees = calculateSideFees(orders);
displaySideFees(sideFees);

console.log('\n=== Monthly Breakdown ===\n');
const monthlyFees = calculateMonthlyFees(orders);
displayMonthlyFees(monthlyFees);
```

**Console formatting guidance:**
- Use console.log with fixed-width padding for table columns
- Example: `symbol.padEnd(12)`, `formatCurrency(fees).padStart(15)`
- Add header row with column names
- Add separator line (dashes) after header
  </action>
  <verify>
Run the spike script (with valid credentials in env):
```bash
cd spikes/fee-analysis && pnpm analyze
```

Expected: Script completes and shows three analysis sections (Symbol, Side, Monthly) with formatted tables.
  </verify>
  <done>
analyze-fees.ts imports calculation functions and displays three analysis tables when run:
1. Per-symbol fee summary (SYMBOL-01, SYMBOL-02, SYMBOL-03, SYMBOL-04)
2. Buy vs Sell comparison (SIDE-01, SIDE-02)
3. Monthly breakdown (MONTH-01, MONTH-02, MONTH-03, MONTH-04)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `cd spikes/fee-analysis && pnpm tsc --noEmit` - no errors
2. Script runs: `cd spikes/fee-analysis && pnpm analyze` - completes successfully
3. Output contains all three analysis sections with formatted data
4. Calculations appear correct (fees/volume ratios make sense, monthly data is chronological)
</verification>

<success_criteria>
- [ ] calculations.ts exports calculateSymbolFees, calculateSideFees, calculateMonthlyFees
- [ ] analyze-fees.ts displays per-symbol fee summary table
- [ ] analyze-fees.ts displays buy/sell comparison table
- [ ] analyze-fees.ts displays monthly breakdown table
- [ ] All 10 Phase 2 requirements covered (SYMBOL-01-04, SIDE-01-02, MONTH-01-04)
</success_criteria>

<output>
After completion, create `.planning/phases/02-fee-analysis/02-01-SUMMARY.md`
</output>

---
phase: 21-admin-ui-settings
plan: 05
type: execute
wave: 4
depends_on: ["21-04"]
files_modified:
  - apps/admin/src/components/settings/SettingsDiffModal.tsx
  - apps/admin/src/components/settings/index.ts
  - apps/admin/src/pages/Settings.tsx
autonomous: true

must_haves:
  truths:
    - "User can click Save to open diff view before committing"
    - "User can see side-by-side comparison of original vs modified"
    - "User can confirm save and see success toast"
    - "User can discard changes and revert to original"
    - "User sees error toast if save fails"
    - "Validation errors prevent save and show clear message"
  artifacts:
    - path: "apps/admin/src/components/settings/SettingsDiffModal.tsx"
      provides: "Modal with diff view and confirm/cancel buttons"
      min_lines: 60
    - path: "apps/admin/src/pages/Settings.tsx"
      provides: "Complete Settings page with save/discard/diff functionality"
      min_lines: 120
  key_links:
    - from: "apps/admin/src/pages/Settings.tsx"
      to: "trpc.settings.update"
      via: "useMutation hook"
      pattern: "trpc\\.settings\\.update"
    - from: "apps/admin/src/pages/Settings.tsx"
      to: "sonner"
      via: "toast import and calls"
      pattern: "toast\\.(success|error|promise)"
    - from: "apps/admin/src/components/settings/SettingsDiffModal.tsx"
      to: "apps/admin/src/components/settings/SettingsDiffView.tsx"
      via: "component import"
      pattern: "import.*SettingsDiffView"
---

<objective>
Add save/discard functionality with diff preview modal and toast notifications.

Purpose: Complete the settings editing workflow by letting users review changes before saving, discard unwanted changes, and receive clear feedback on save success or failure.

Output: Complete Settings page with Save (opens diff modal), Discard buttons, diff preview, and toast notifications for all operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-admin-ui-settings/21-RESEARCH.md
@.planning/phases/21-admin-ui-settings/21-04-SUMMARY.md

@apps/admin/src/pages/Settings.tsx
@apps/admin/src/components/settings/SettingsDiffView.tsx
@apps/admin/src/lib/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettingsDiffModal component</name>
  <files>apps/admin/src/components/settings/SettingsDiffModal.tsx</files>
  <action>
    Create apps/admin/src/components/settings/SettingsDiffModal.tsx:

    ```typescript
    import { SettingsDiffView } from './SettingsDiffView';

    interface SettingsDiffModalProps {
      /** Whether the modal is open */
      isOpen: boolean;
      /** Original settings JSON string */
      original: string;
      /** Modified settings JSON string */
      modified: string;
      /** Callback when user confirms save */
      onConfirm: () => void;
      /** Callback when user cancels */
      onCancel: () => void;
      /** Whether save is in progress */
      isSaving?: boolean;
    }

    /**
     * Modal dialog showing settings diff with confirm/cancel actions.
     * Satisfies UI-SET-04.
     */
    export function SettingsDiffModal({
      isOpen,
      original,
      modified,
      onConfirm,
      onCancel,
      isSaving = false,
    }: SettingsDiffModalProps) {
      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          {/* Backdrop */}
          <div
            className="absolute inset-0 bg-black/50"
            onClick={onCancel}
            aria-hidden="true"
          />

          {/* Modal */}
          <div className="relative bg-white rounded-lg shadow-xl max-w-5xl w-full mx-4 max-h-[90vh] flex flex-col">
            {/* Header */}
            <div className="px-6 py-4 border-b">
              <h2 className="text-lg font-semibold text-gray-900">
                Review Changes
              </h2>
              <p className="text-sm text-gray-500 mt-1">
                Review your changes before saving. Original settings are on the left,
                your modifications are on the right.
              </p>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-auto p-6">
              <SettingsDiffView
                original={original}
                modified={modified}
                height="400px"
              />
            </div>

            {/* Footer */}
            <div className="px-6 py-4 border-t flex justify-end gap-3">
              <button
                type="button"
                onClick={onCancel}
                disabled={isSaving}
                className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50"
              >
                Cancel
              </button>
              <button
                type="button"
                onClick={onConfirm}
                disabled={isSaving}
                className="px-4 py-2 text-sm font-medium text-white bg-gray-900 rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50"
              >
                {isSaving ? 'Saving...' : 'Save Changes'}
              </button>
            </div>
          </div>
        </div>
      );
    }
    ```
  </action>
  <verify>
    - File exists at apps/admin/src/components/settings/SettingsDiffModal.tsx
    - Exports SettingsDiffModal component
    - Uses SettingsDiffView for diff display
    - Has confirm/cancel buttons with loading state
    - Modal backdrop closes on click
  </verify>
  <done>Diff preview modal with confirm/cancel actions created</done>
</task>

<task type="auto">
  <name>Task 2: Complete Settings page with save/discard and toasts</name>
  <files>apps/admin/src/pages/Settings.tsx</files>
  <action>
    Update apps/admin/src/pages/Settings.tsx with full save/discard functionality:

    ```typescript
    import { useState, useCallback, useRef } from 'react';
    import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
    import { toast } from 'sonner';
    import { trpc, trpcClient } from '@/lib/trpc';
    import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
    import { SettingsSplitView, SettingsDiffModal } from '@/components/settings';
    import { UserSettingsSchema, type UserSettings } from '@livermore/schemas';

    export function Settings() {
      const queryClient = useQueryClient();

      // Fetch settings
      const { data, isLoading, error, refetch, isFetching } = useQuery(
        trpc.settings.get.queryOptions()
      );

      // Track current settings and dirty state
      const [currentSettings, setCurrentSettings] = useState<UserSettings | null>(null);
      const [isDirty, setIsDirty] = useState(false);

      // Diff modal state
      const [showDiffModal, setShowDiffModal] = useState(false);

      // Validation error state
      const [validationError, setValidationError] = useState<string | null>(null);

      // Key to force remount of SettingsSplitView on discard
      const splitViewKey = useRef(0);

      // Save mutation
      const saveMutation = useMutation({
        mutationFn: (settings: UserSettings) =>
          trpcClient.settings.update.mutate(settings),
        onSuccess: () => {
          toast.success('Settings saved successfully');
          setShowDiffModal(false);
          setIsDirty(false);
          setValidationError(null);
          // Invalidate and refetch
          queryClient.invalidateQueries({ queryKey: ['settings'] });
        },
        onError: (err) => {
          toast.error(`Failed to save: ${err.message}`);
        },
      });

      // Handle settings changes from split view
      const handleSettingsChange = useCallback(
        (settings: UserSettings, dirty: boolean) => {
          setCurrentSettings(settings);
          setIsDirty(dirty);
          setValidationError(null);
        },
        []
      );

      // Handle save button click - validate and show diff modal
      const handleSaveClick = useCallback(() => {
        if (!currentSettings) return;

        // Validate settings before showing diff
        const result = UserSettingsSchema.safeParse(currentSettings);
        if (!result.success) {
          const errorMessage = result.error.errors
            .map((e) => `${e.path.join('.')}: ${e.message}`)
            .join('\n');
          setValidationError(errorMessage);
          toast.error('Validation failed. Please fix errors before saving.');
          return;
        }

        setShowDiffModal(true);
      }, [currentSettings]);

      // Handle diff modal confirm
      const handleConfirmSave = useCallback(() => {
        if (!currentSettings) return;
        saveMutation.mutate(currentSettings);
      }, [currentSettings, saveMutation]);

      // Handle discard
      const handleDiscard = useCallback(() => {
        // Increment key to force SettingsSplitView remount
        splitViewKey.current += 1;
        setCurrentSettings(null);
        setIsDirty(false);
        setValidationError(null);
        toast.info('Changes discarded');
        // Refetch to ensure we have latest
        refetch();
      }, [refetch]);

      if (isLoading) {
        return (
          <Card>
            <CardHeader>
              <CardTitle>Settings</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="flex items-center justify-center py-8">
                <div className="h-8 w-8 animate-spin rounded-full border-4 border-gray-200 border-t-gray-600" />
              </div>
            </CardContent>
          </Card>
        );
      }

      if (error) {
        return (
          <Card>
            <CardHeader>
              <CardTitle>Settings</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="rounded-md bg-red-50 p-4 text-red-700">
                Error loading settings: {error.message}
              </div>
            </CardContent>
          </Card>
        );
      }

      const settings = data as UserSettings;

      return (
        <>
          <Card>
            <CardHeader className="flex flex-row items-center justify-between">
              <div className="flex items-center gap-3">
                <CardTitle>Settings</CardTitle>
                {isDirty && (
                  <span className="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">
                    Unsaved changes
                  </span>
                )}
              </div>
              <div className="flex items-center gap-2">
                {isDirty && (
                  <>
                    <button
                      onClick={handleDiscard}
                      className="rounded-md bg-white px-3 py-1 text-sm font-medium text-gray-700 border border-gray-300 hover:bg-gray-50"
                    >
                      Discard
                    </button>
                    <button
                      onClick={handleSaveClick}
                      disabled={saveMutation.isPending}
                      className="rounded-md bg-gray-900 px-3 py-1 text-sm font-medium text-white hover:bg-gray-800 disabled:opacity-50"
                    >
                      {saveMutation.isPending ? 'Saving...' : 'Save'}
                    </button>
                  </>
                )}
                <button
                  onClick={() => refetch()}
                  disabled={isFetching}
                  className="rounded-md bg-gray-100 px-3 py-1 text-sm font-medium text-gray-700 hover:bg-gray-200 disabled:opacity-50"
                >
                  {isFetching ? 'Refreshing...' : 'Refresh'}
                </button>
              </div>
            </CardHeader>
            <CardContent>
              {validationError && (
                <div className="mb-4 rounded-md bg-red-50 p-4 text-red-700">
                  <p className="font-medium">Validation Errors:</p>
                  <pre className="mt-2 text-sm whitespace-pre-wrap">
                    {validationError}
                  </pre>
                </div>
              )}
              <SettingsSplitView
                key={splitViewKey.current}
                initialSettings={settings}
                onSettingsChange={handleSettingsChange}
              />
            </CardContent>
          </Card>

          {/* Diff Modal */}
          <SettingsDiffModal
            isOpen={showDiffModal}
            original={JSON.stringify(settings, null, 2)}
            modified={JSON.stringify(currentSettings ?? settings, null, 2)}
            onConfirm={handleConfirmSave}
            onCancel={() => setShowDiffModal(false)}
            isSaving={saveMutation.isPending}
          />
        </>
      );
    }
    ```

    Key implementation details:
    - Save button validates with Zod before showing diff modal
    - Validation errors displayed above split view and in toast
    - Diff modal shows original vs modified before confirm
    - Discard uses key prop to force SettingsSplitView remount
    - Toast notifications for success, error, and discard
    - Save/Discard buttons only visible when dirty
  </action>
  <verify>
    - apps/admin/src/pages/Settings.tsx imports SettingsDiffModal
    - Save button validates and opens diff modal
    - Discard button resets to original settings
    - Toast notifications appear on save success, error, and discard
    - Validation errors display above split view
    - useMutation calls trpcClient.settings.update.mutate
  </verify>
  <done>Complete Settings page with save/discard, diff preview, and toast notifications</done>
</task>

<task type="auto">
  <name>Task 3: Update index and verify complete workflow</name>
  <files>apps/admin/src/components/settings/index.ts</files>
  <action>
    Update apps/admin/src/components/settings/index.ts:

    ```typescript
    export { SettingsJsonEditor } from './SettingsJsonEditor';
    export { SettingsDiffView } from './SettingsDiffView';
    export { SettingsForm, useSettingsForm } from './SettingsForm';
    export { ProfileSection } from './ProfileSection';
    export { RuntimeSection } from './RuntimeSection';
    export { SettingsSplitView } from './SettingsSplitView';
    export { SettingsDiffModal } from './SettingsDiffModal';
    ```

    Verify complete workflow:
    1. Run `pnpm --filter admin dev` and ensure API is running
    2. Navigate to http://localhost:5173/#/settings
    3. Edit a field in the form (e.g., Display Name)
    4. See "Unsaved changes" badge and Save/Discard buttons appear
    5. Click Save -> diff modal opens showing changes
    6. Click "Save Changes" in modal -> toast shows "Settings saved successfully"
    7. Edit another field -> click Discard -> toast shows "Changes discarded"
    8. Edit JSON with invalid syntax -> validation error appears
    9. Fix JSON, edit a field, click Save -> diff modal shows changes
    10. Stop API server -> edit and Save -> error toast appears
  </action>
  <verify>
    - Index file exports SettingsDiffModal
    - Complete workflow works: edit -> save -> diff review -> confirm -> success toast
    - Discard workflow works: edit -> discard -> toast, values reset
    - Validation errors appear for invalid JSON
    - Network errors show error toast
    - UI-SET-04 verified: diff view shows changes before saving
    - UI-SET-05 verified: save/discard buttons with validation error display
    - UI-SET-06 verified: loading states and success/error toasts
  </verify>
  <done>All settings UI requirements satisfied, complete workflow verified</done>
</task>

</tasks>

<verification>
1. `pnpm --filter admin dev` starts without errors
2. Navigate to http://localhost:5173/#/settings
3. Full workflow test:
   a. Settings load and display in form + JSON editor
   b. Edit Display Name -> "Unsaved changes" appears, Save/Discard buttons visible
   c. Click Save -> diff modal shows original vs modified
   d. Click "Save Changes" -> modal closes, success toast appears
   e. Refresh page -> saved changes persist
   f. Edit timezone -> click Discard -> changes revert, info toast appears
   g. Enter invalid JSON -> validation error marker in editor
   h. Try to save invalid JSON -> validation error toast + display
</verification>

<success_criteria>
- UI-SET-04 satisfied: Diff view shows changes before saving (via modal)
- UI-SET-05 satisfied: Save/discard buttons with validation error display
- UI-SET-06 satisfied: Loading states and success/error toasts
- All Phase 21 requirements complete (UI-SET-01 through UI-SET-06)
- Settings can be edited via form or JSON with real-time sync
- Changes reviewed via diff before commit
- Clear feedback on all operations
</success_criteria>

<output>
After completion, create `.planning/phases/21-admin-ui-settings/21-05-SUMMARY.md`
</output>

---
phase: 21-admin-ui-settings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/admin/src/components/settings/SettingsJsonEditor.tsx
  - apps/admin/src/components/settings/SettingsDiffView.tsx
autonomous: true

must_haves:
  truths:
    - "User can edit JSON with syntax highlighting"
    - "User can see validation errors inline in the editor"
    - "User can view side-by-side diff of original vs modified JSON"
  artifacts:
    - path: "apps/admin/src/components/settings/SettingsJsonEditor.tsx"
      provides: "Monaco-based JSON editor component"
      min_lines: 40
    - path: "apps/admin/src/components/settings/SettingsDiffView.tsx"
      provides: "Monaco DiffEditor wrapper for settings comparison"
      min_lines: 30
  key_links:
    - from: "apps/admin/src/components/settings/SettingsJsonEditor.tsx"
      to: "@monaco-editor/react"
      via: "Editor import"
      pattern: "import.*Editor.*from.*@monaco-editor/react"
    - from: "apps/admin/src/components/settings/SettingsDiffView.tsx"
      to: "@monaco-editor/react"
      via: "DiffEditor import"
      pattern: "import.*DiffEditor.*from.*@monaco-editor/react"
---

<objective>
Create Monaco-based JSON editor and diff view components for power user editing.

Purpose: Enable power users to directly edit settings as JSON with syntax highlighting, validation markers, and the ability to review changes before saving via diff view.

Output: Two reusable components - SettingsJsonEditor for editing and SettingsDiffView for comparing original vs modified settings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-admin-ui-settings/21-RESEARCH.md

@packages/schemas/src/settings/user-settings.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SettingsJsonEditor component with Monaco</name>
  <files>apps/admin/src/components/settings/SettingsJsonEditor.tsx</files>
  <action>
    Create apps/admin/src/components/settings/SettingsJsonEditor.tsx:

    ```typescript
    import { useCallback, useRef } from 'react';
    import Editor, { OnMount, OnChange } from '@monaco-editor/react';
    import type { editor } from 'monaco-editor';

    interface SettingsJsonEditorProps {
      /** JSON string value to display/edit */
      value: string;
      /** Callback when JSON content changes */
      onChange: (value: string) => void;
      /** Whether the editor is read-only */
      readOnly?: boolean;
      /** Editor height (CSS value) */
      height?: string;
      /** Validation error message to display as marker */
      validationError?: string;
    }

    /**
     * Monaco-based JSON editor for settings.
     * Provides syntax highlighting, formatting, and validation markers.
     * Satisfies UI-SET-02.
     */
    export function SettingsJsonEditor({
      value,
      onChange,
      readOnly = false,
      height = '400px',
      validationError,
    }: SettingsJsonEditorProps) {
      const editorRef = useRef<editor.IStandaloneCodeEditor | null>(null);
      const monacoRef = useRef<typeof import('monaco-editor') | null>(null);

      const handleEditorMount: OnMount = (editor, monaco) => {
        editorRef.current = editor;
        monacoRef.current = monaco;

        // Format document on mount
        setTimeout(() => {
          editor.getAction('editor.action.formatDocument')?.run();
        }, 100);
      };

      const handleChange: OnChange = useCallback(
        (newValue) => {
          if (newValue !== undefined) {
            onChange(newValue);
          }
        },
        [onChange]
      );

      // Update validation markers when error changes
      const handleEditorValidation = useCallback(() => {
        if (!editorRef.current || !monacoRef.current) return;

        const model = editorRef.current.getModel();
        if (!model) return;

        if (validationError) {
          // Set error marker on first line
          monacoRef.current.editor.setModelMarkers(model, 'settings-validation', [
            {
              startLineNumber: 1,
              startColumn: 1,
              endLineNumber: 1,
              endColumn: model.getLineMaxColumn(1),
              message: validationError,
              severity: monacoRef.current.MarkerSeverity.Error,
            },
          ]);
        } else {
          // Clear markers
          monacoRef.current.editor.setModelMarkers(model, 'settings-validation', []);
        }
      }, [validationError]);

      // Run validation whenever error changes
      // Use effect callback pattern via Editor's onMount
      const wrappedMount: OnMount = (editor, monaco) => {
        handleEditorMount(editor, monaco);
        // Set up effect for validation
        setTimeout(handleEditorValidation, 150);
      };

      return (
        <div className="border rounded-md overflow-hidden">
          <Editor
            height={height}
            language="json"
            value={value}
            onChange={handleChange}
            onMount={wrappedMount}
            options={{
              readOnly,
              minimap: { enabled: false },
              lineNumbers: 'on',
              scrollBeyondLastLine: false,
              formatOnPaste: true,
              formatOnType: true,
              tabSize: 2,
              wordWrap: 'on',
              automaticLayout: true,
              folding: true,
              foldingStrategy: 'indentation',
            }}
            theme="vs-dark"
            loading={
              <div className="flex items-center justify-center h-full bg-gray-900 text-gray-400">
                Loading editor...
              </div>
            }
          />
        </div>
      );
    }
    ```

    Note: The component uses a callback pattern rather than useEffect since Monaco is loaded asynchronously. The validation markers are set after mount and on subsequent renders when validationError changes.
  </action>
  <verify>
    - File exists at apps/admin/src/components/settings/SettingsJsonEditor.tsx
    - Exports SettingsJsonEditor function component
    - Props include value, onChange, readOnly, height, validationError
    - Uses @monaco-editor/react Editor component
  </verify>
  <done>Monaco JSON editor component with syntax highlighting, formatting, and validation marker support</done>
</task>

<task type="auto">
  <name>Task 2: Create SettingsDiffView component with Monaco DiffEditor</name>
  <files>apps/admin/src/components/settings/SettingsDiffView.tsx</files>
  <action>
    Create apps/admin/src/components/settings/SettingsDiffView.tsx:

    ```typescript
    import { DiffEditor } from '@monaco-editor/react';

    interface SettingsDiffViewProps {
      /** Original JSON string (left side) */
      original: string;
      /** Modified JSON string (right side) */
      modified: string;
      /** Editor height (CSS value) */
      height?: string;
    }

    /**
     * Monaco DiffEditor wrapper for comparing settings versions.
     * Shows side-by-side comparison of original vs modified settings.
     * Satisfies UI-SET-04.
     */
    export function SettingsDiffView({
      original,
      modified,
      height = '400px',
    }: SettingsDiffViewProps) {
      // Format JSON strings for consistent comparison
      const formatJson = (json: string): string => {
        try {
          return JSON.stringify(JSON.parse(json), null, 2);
        } catch {
          return json;
        }
      };

      const formattedOriginal = formatJson(original);
      const formattedModified = formatJson(modified);

      // Check if there are actual changes
      const hasChanges = formattedOriginal !== formattedModified;

      if (!hasChanges) {
        return (
          <div className="flex items-center justify-center h-32 bg-gray-100 rounded-md text-gray-600">
            No changes detected
          </div>
        );
      }

      return (
        <div className="border rounded-md overflow-hidden">
          <div className="flex bg-gray-800 text-gray-300 text-xs">
            <div className="flex-1 px-4 py-2 border-r border-gray-700">
              Original (Saved)
            </div>
            <div className="flex-1 px-4 py-2">
              Modified (Unsaved)
            </div>
          </div>
          <DiffEditor
            height={height}
            language="json"
            original={formattedOriginal}
            modified={formattedModified}
            options={{
              readOnly: true,
              renderSideBySide: true,
              enableSplitViewResizing: true,
              ignoreTrimWhitespace: false,
              minimap: { enabled: false },
              scrollBeyondLastLine: false,
              lineNumbers: 'on',
              folding: true,
            }}
            theme="vs-dark"
            loading={
              <div className="flex items-center justify-center h-full bg-gray-900 text-gray-400">
                Loading diff viewer...
              </div>
            }
          />
        </div>
      );
    }
    ```
  </action>
  <verify>
    - File exists at apps/admin/src/components/settings/SettingsDiffView.tsx
    - Exports SettingsDiffView function component
    - Props include original, modified, height
    - Uses @monaco-editor/react DiffEditor component
    - Shows "No changes detected" when original equals modified
  </verify>
  <done>Monaco DiffEditor wrapper with side-by-side comparison and header labels</done>
</task>

<task type="auto">
  <name>Task 3: Create settings components index file</name>
  <files>apps/admin/src/components/settings/index.ts</files>
  <action>
    Create apps/admin/src/components/settings/index.ts for cleaner imports:

    ```typescript
    export { SettingsJsonEditor } from './SettingsJsonEditor';
    export { SettingsDiffView } from './SettingsDiffView';
    ```

    This allows later plans to import via:
    ```typescript
    import { SettingsJsonEditor, SettingsDiffView } from '@/components/settings';
    ```
  </action>
  <verify>
    - File exists at apps/admin/src/components/settings/index.ts
    - Exports both SettingsJsonEditor and SettingsDiffView
  </verify>
  <done>Index file created for cleaner component imports</done>
</task>

</tasks>

<verification>
1. Both component files exist in apps/admin/src/components/settings/
2. TypeScript compilation passes: `pnpm --filter admin build` or `pnpm --filter admin typecheck`
3. Components can be imported in other files without errors
4. Monaco types are available (no red squiggles in IDE)
</verification>

<success_criteria>
- UI-SET-02 satisfied: JSON raw editor component created with Monaco
- UI-SET-04 foundation: DiffEditor component created for settings comparison
- Components are reusable and can be integrated into split view
</success_criteria>

<output>
After completion, create `.planning/phases/21-admin-ui-settings/21-02-SUMMARY.md`
</output>

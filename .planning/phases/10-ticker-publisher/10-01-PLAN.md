---
phase: 10-ticker-publisher
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/coinbase-client/src/adapter/coinbase-adapter.ts
autonomous: true

must_haves:
  truths:
    - "Alert notifications show actual current price (not $0.00)"
    - "Ticker prices available for all monitored symbols"
    - "No additional REST calls - ticker from WebSocket only"
  artifacts:
    - path: "packages/coinbase-client/src/adapter/coinbase-adapter.ts"
      provides: "Ticker channel subscription and publishing"
      contains: "handleTickerMessage"
  key_links:
    - from: "CoinbaseAdapter.subscribe()"
      to: "subscribeToTicker()"
      via: "method call after candles subscription"
      pattern: "subscribeToTicker\\(\\)"
    - from: "CoinbaseAdapter.handleMessage()"
      to: "handleTickerMessage()"
      via: "channel routing"
      pattern: "message\\.channel === 'ticker'"
    - from: "handleTickerMessage()"
      to: "tickerCache.publishUpdate()"
      via: "Redis pub/sub"
      pattern: "this\\.tickerCache\\.publishUpdate"
---

<objective>
Add ticker channel subscription and publishing to CoinbaseAdapter

Purpose: Fix alert notifications showing "$0.00" by publishing real-time ticker prices to Redis pub/sub (same pattern as legacy CoinbaseWebSocketService)

Output: CoinbaseAdapter publishes ticker events that AlertEvaluationService receives
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-ticker-publisher/10-RESEARCH.md

Key files:
@packages/coinbase-client/src/adapter/coinbase-adapter.ts (modify)
@packages/cache/src/strategies/ticker-cache.ts (reference - DO NOT modify)
@packages/cache/src/keys.ts (reference - tickerChannel export)
@apps/api/src/services/coinbase-websocket.service.ts (reference - legacy ticker handling, lines 207-236)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ticker infrastructure to CoinbaseAdapter</name>
  <files>packages/coinbase-client/src/adapter/coinbase-adapter.ts</files>
  <action>
Add ticker support infrastructure to CoinbaseAdapter:

1. **Add imports** (line ~15, after existing @livermore/cache import):
```typescript
import { CandleCacheStrategy, candleCloseChannel, TickerCacheStrategy, tickerChannel } from '@livermore/cache';
import type { Timeframe, UnifiedCandle, Ticker } from '@livermore/schemas';
```

2. **Add ticker message type definitions** (after HeartbeatsMessage interface, ~line 65):
```typescript
/**
 * Ticker event from Coinbase WebSocket
 */
interface CoinbaseTickerEvent {
  type: 'snapshot' | 'update';
  tickers: Array<{
    type: 'ticker';
    product_id: string;
    price: string;
    volume_24_h: string;
    low_24_h: string;
    high_24_h: string;
    price_percent_chg_24_h: string;
  }>;
}

/**
 * Ticker channel message from Coinbase WebSocket
 */
interface TickerMessage {
  channel: 'ticker';
  client_id: string;
  timestamp: string;
  sequence_num: number;
  events: CoinbaseTickerEvent[];
}
```

3. **Update CoinbaseWSMessage union type** (around line 70):
Add `| TickerMessage` to the union.

4. **Add tickerCache property** (after candleCache declaration, ~line 122):
```typescript
/** Cache strategy for ticker storage and pub/sub */
protected tickerCache: TickerCacheStrategy;
```

5. **Initialize tickerCache in constructor** (after candleCache initialization, ~line 164):
```typescript
this.tickerCache = new TickerCacheStrategy(options.redis);
```

6. **Add subscribeToTicker method** (after subscribeToHeartbeats method, ~line 303):
```typescript
/**
 * Subscribe to ticker channel for price updates
 * Called after candles subscription when symbols are known.
 * Unlike heartbeats, ticker requires product_ids.
 */
private subscribeToTicker(): void {
  if (!this.isConnected() || this.subscribedSymbols.length === 0) return;

  const token = this.auth.generateToken();
  const subscribeMessage = {
    type: 'subscribe',
    channel: 'ticker',
    product_ids: this.subscribedSymbols,
    jwt: token,
  };

  this.ws!.send(JSON.stringify(subscribeMessage));
  logger.info({ symbols: this.subscribedSymbols.length }, 'Subscribed to ticker channel');
}
```

7. **Call subscribeToTicker in subscribe method** (after the candles subscription send, ~line 265):
```typescript
// Also subscribe to ticker for price updates (used by alerts)
this.subscribeToTicker();
```
  </action>
  <verify>
Run TypeScript compilation:
```bash
cd packages/coinbase-client && npm run build
```
Should compile without errors. Check that:
- TickerCacheStrategy import resolves
- Ticker type import resolves
- tickerChannel import resolves
- No "unused variable" warnings for new code
  </verify>
  <done>
CoinbaseAdapter has:
- TickerMessage type definition
- tickerCache property initialized
- subscribeToTicker method
- subscribe() calls subscribeToTicker() after candles
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ticker message handler and routing</name>
  <files>packages/coinbase-client/src/adapter/coinbase-adapter.ts</files>
  <action>
Add ticker message handling to CoinbaseAdapter:

1. **Add handleTickerMessage method** (after handleCandlesMessage, ~line 373):
```typescript
/**
 * Process incoming ticker messages
 * Transforms Coinbase ticker to Livermore Ticker format and publishes to Redis
 */
private async handleTickerMessage(message: TickerMessage): Promise<void> {
  for (const event of message.events) {
    // Only process 'update' events, not 'snapshot'
    if (event.type !== 'update') continue;

    for (const tickerData of event.tickers) {
      const price = parseFloat(tickerData.price);
      const timestamp = new Date(message.timestamp).getTime();
      const changePercent24h = parseFloat(tickerData.price_percent_chg_24_h);
      // Calculate absolute change from percentage: change = price - (price / (1 + pct/100))
      const change24h = price - (price / (1 + changePercent24h / 100));

      const ticker: Ticker = {
        symbol: tickerData.product_id,
        price,
        change24h,
        changePercent24h,
        volume24h: parseFloat(tickerData.volume_24_h),
        low24h: parseFloat(tickerData.low_24_h),
        high24h: parseFloat(tickerData.high_24_h),
        timestamp,
      };

      try {
        // Cache ticker in Redis (with 60s TTL)
        await this.tickerCache.setTicker(this.userId, this.exchangeIdNum, ticker);

        // Publish update via Redis pub/sub (AlertEvaluationService subscribes to this)
        await this.tickerCache.publishUpdate(this.userId, this.exchangeIdNum, ticker);
      } catch (error) {
        logger.error({ error, symbol: ticker.symbol }, 'Failed to cache/publish ticker');
      }
    }
  }
}
```

2. **Route ticker messages in handleMessage** (before "Unknown channel" warning, ~line 436):
Add this block after the heartbeats handler and before the unknown channel warning:
```typescript
// Handle ticker - fire and forget to avoid blocking
if (message.channel === 'ticker') {
  this.handleTickerMessage(message as TickerMessage).catch(error => {
    logger.error({ error }, 'Error processing ticker message');
  });
  return;
}
```
  </action>
  <verify>
1. Run TypeScript compilation:
```bash
cd packages/coinbase-client && npm run build
```
Should compile without errors.

2. Run existing tests to ensure no regressions:
```bash
cd packages/coinbase-client && npm test
```

3. Verify the full build works:
```bash
npm run build
```
  </verify>
  <done>
CoinbaseAdapter:
- handleTickerMessage processes ticker events
- Transforms Coinbase ticker to Livermore Ticker format
- Caches ticker with 60s TTL via tickerCache.setTicker()
- Publishes to Redis pub/sub via tickerCache.publishUpdate()
- handleMessage routes ticker channel to handleTickerMessage
  </done>
</task>

</tasks>

<verification>
After both tasks:

1. **Code verification:**
   - `grep -n "handleTickerMessage" packages/coinbase-client/src/adapter/coinbase-adapter.ts` shows method exists
   - `grep -n "subscribeToTicker" packages/coinbase-client/src/adapter/coinbase-adapter.ts` shows method exists and is called
   - `grep -n "tickerCache" packages/coinbase-client/src/adapter/coinbase-adapter.ts` shows property and usage

2. **Build verification:**
   - `npm run build` completes without errors
   - No TypeScript errors in coinbase-adapter.ts

3. **Runtime verification (manual):**
   Start the server and check logs for:
   - "Subscribed to ticker channel" message
   - No "Unknown WebSocket channel: ticker" warnings
</verification>

<success_criteria>
- [ ] CoinbaseAdapter subscribes to ticker channel when symbols are subscribed
- [ ] Ticker messages are routed to handleTickerMessage
- [ ] Ticker data is cached via TickerCacheStrategy.setTicker()
- [ ] Ticker updates are published via TickerCacheStrategy.publishUpdate()
- [ ] TypeScript compilation succeeds
- [ ] No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/10-ticker-publisher/10-01-SUMMARY.md`
</output>

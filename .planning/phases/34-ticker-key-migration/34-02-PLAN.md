---
phase: 34-ticker-key-migration
plan: 02
type: execute
wave: 2
depends_on: ["34-01"]
files_modified:
  - packages/exchange-core/src/adapter/coinbase-adapter.ts
  - apps/api/src/services/coinbase-websocket.service.ts
  - apps/api/src/services/alert-evaluation.service.ts
  - apps/api/src/services/position-sync.service.ts
  - apps/api/src/routers/indicator.router.ts
autonomous: true
must_haves:
  truths:
    - "Ticker data is stored at ticker:{exchangeId}:{symbol} and all services resolve prices correctly from the new key"
    - "Ticker pub/sub channels use exchange-scoped pattern and real-time price updates flow without interruption"
    - "No userId parameter is passed to any tickerKey, tickerChannel, or TickerCacheStrategy method anywhere in the codebase"
  artifacts:
    - path: "packages/exchange-core/src/adapter/coinbase-adapter.ts"
      provides: "Ticker writes using exchange-scoped TickerCacheStrategy"
      contains: "setTicker(this.exchangeIdNum, ticker)"
    - path: "apps/api/src/services/alert-evaluation.service.ts"
      provides: "Ticker channel subscription using exchange-scoped pattern"
      contains: "tickerChannel(this.exchangeId, symbol)"
    - path: "apps/api/src/routers/indicator.router.ts"
      provides: "Ticker reads using exchange-scoped TickerCacheStrategy"
      contains: "getTickers(TEST_EXCHANGE_ID, symbols)"
    - path: "apps/api/src/services/position-sync.service.ts"
      provides: "Ticker price lookup using exchange-scoped TickerCacheStrategy"
      contains: "getTicker(exchangeId, tradingPair)"
  key_links:
    - from: "packages/exchange-core/src/adapter/coinbase-adapter.ts"
      to: "packages/cache/src/strategies/ticker-cache.ts"
      via: "setTicker and publishUpdate calls"
      pattern: "tickerCache\\.setTicker\\(this\\.exchangeIdNum"
    - from: "apps/api/src/services/alert-evaluation.service.ts"
      to: "packages/cache/src/keys.ts"
      via: "tickerChannel subscription"
      pattern: "tickerChannel\\(this\\.exchangeId, symbol\\)"
    - from: "apps/api/src/routers/indicator.router.ts"
      to: "packages/cache/src/strategies/ticker-cache.ts"
      via: "getTickers for price display"
      pattern: "tickerCache\\.getTickers\\(\\s*TEST_EXCHANGE_ID"
---

<objective>
Update all consumer code to use the exchange-scoped TickerCacheStrategy API (no userId parameter) and verify the full project compiles and ticker data flows correctly.

Purpose: Plan 01 changed the cache layer interface. This plan updates every caller to match the new signatures, completing TICK-02 (key pattern) and TICK-03 (pub/sub channel pattern). After this plan, the entire codebase uses exchange-scoped ticker keys consistent with candles and indicators.

Output: All 5 consumer files updated, project compiles cleanly, ticker flow verified end-to-end.
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-ticker-key-migration/34-01-SUMMARY.md
@packages/cache/src/keys.ts
@packages/cache/src/strategies/ticker-cache.ts
@packages/exchange-core/src/adapter/coinbase-adapter.ts
@apps/api/src/services/alert-evaluation.service.ts
@apps/api/src/services/position-sync.service.ts
@apps/api/src/routers/indicator.router.ts
@apps/api/src/services/coinbase-websocket.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all ticker key/channel consumers to exchange-scoped API</name>
  <files>
    packages/exchange-core/src/adapter/coinbase-adapter.ts
    apps/api/src/services/coinbase-websocket.service.ts
    apps/api/src/services/alert-evaluation.service.ts
    apps/api/src/services/position-sync.service.ts
    apps/api/src/routers/indicator.router.ts
  </files>
  <action>
Update each file to remove the userId parameter from all TickerCacheStrategy and tickerChannel calls:

**1. `packages/exchange-core/src/adapter/coinbase-adapter.ts`:**
- Line ~574: Change `this.tickerCache.setTicker(this.userId, this.exchangeIdNum, ticker)` to `this.tickerCache.setTicker(this.exchangeIdNum, ticker)`
- Line ~577: Change `this.tickerCache.publishUpdate(this.userId, this.exchangeIdNum, ticker)` to `this.tickerCache.publishUpdate(this.exchangeIdNum, ticker)`
- Note: The `userId` field on the class is also used by CandleCacheStrategy (legacy candle path). Do NOT remove the `userId` property from the class -- it may still be used elsewhere in the adapter. Only remove it from ticker-specific calls.

**2. `apps/api/src/services/coinbase-websocket.service.ts` (DEPRECATED module):**
- Line ~233: Change `this.tickerCache.setTicker(this.TEST_USER_ID, this.TEST_EXCHANGE_ID, ticker)` to `this.tickerCache.setTicker(this.TEST_EXCHANGE_ID, ticker)`
- Line ~236: Change `this.tickerCache.publishUpdate(this.TEST_USER_ID, this.TEST_EXCHANGE_ID, ticker)` to `this.tickerCache.publishUpdate(this.TEST_EXCHANGE_ID, ticker)`

**3. `apps/api/src/services/alert-evaluation.service.ts`:**
- Line ~1 (import): Remove `tickerChannel` from the import if it is the only usage -- actually keep the import, just update the call.
- Line ~140: Change `tickerChannel(1, this.exchangeId, symbol)` to `tickerChannel(this.exchangeId, symbol)` (removes hardcoded userId=1)
- Line ~171: The `channel.includes('channel:ticker:')` check does NOT need to change -- it matches on prefix which still works with the new pattern.

**4. `apps/api/src/services/position-sync.service.ts`:**
- Line ~246: Change `this.tickerCache.getTicker(userId, exchangeId, tradingPair)` to `this.tickerCache.getTicker(exchangeId, tradingPair)`

**5. `apps/api/src/routers/indicator.router.ts`:**
- Line ~457-460: Change `tickerCache.getTickers(TEST_USER_ID, TEST_EXCHANGE_ID, symbols)` to `tickerCache.getTickers(TEST_EXCHANGE_ID, symbols)`

IMPORTANT: Do NOT change any inline string patterns in server.ts or control-channel.service.ts -- they already use the correct exchange-scoped pattern (`ticker:${exchangeId}:${symbol}`).
  </action>
  <verify>Run `npx turbo build 2>&1 | tail -20` from the repo root to verify the entire project compiles without errors. If turbo is not available, run `npx tsc --noEmit -p apps/api/tsconfig.json` and `npx tsc --noEmit -p packages/exchange-core/tsconfig.json`.</verify>
  <done>All 5 consumer files updated. No file in the codebase passes userId to tickerKey(), tickerChannel(), or any TickerCacheStrategy method.</done>
</task>

<task type="auto">
  <name>Task 2: Final verification -- grep audit and compile check</name>
  <files></files>
  <action>
Run a comprehensive verification to confirm the migration is complete:

1. **Grep audit -- no userId in ticker calls:**
   - `grep -rn "tickerKey(" packages/cache/src/ apps/api/src/ packages/exchange-core/src/` -- every match should show only (exchangeId, symbol), never (userId, exchangeId, symbol)
   - `grep -rn "tickerChannel(" packages/cache/src/ apps/api/src/ packages/exchange-core/src/` -- same check
   - `grep -rn "\.setTicker\|\.getTicker\|\.getTickers\|\.publishUpdate\|\.deleteTicker\|\.hasTicker" packages/cache/src/strategies/ticker-cache.ts apps/api/src/ packages/exchange-core/src/` -- no userId in any call

2. **Grep audit -- inline strings still correct:**
   - `grep -rn 'ticker:\${exchangeId}' apps/api/src/server.ts apps/api/src/services/control-channel.service.ts` -- these should still exist unchanged

3. **Grep audit -- no orphan user-scoped ticker keys:**
   - `grep -rn "ticker:\${userId}" packages/ apps/` -- should return ZERO matches

4. **Full compile check:**
   - Run `npx turbo build` or `npx tsc --noEmit` for all affected packages

If any grep check fails, fix the offending file before marking done.
  </action>
  <verify>All 4 grep audits pass (no userId in ticker function calls, inline strings unchanged, no orphan user-scoped patterns). Full project compiles without type errors.</verify>
  <done>Zero references to userId in ticker key/channel functions across the entire codebase. Full project compiles. Ticker keys are exchange-scoped (`ticker:{exchangeId}:{symbol}`), ticker channels are exchange-scoped (`channel:ticker:{exchangeId}:{symbol}`), consistent with candle and indicator key patterns.</done>
</task>

</tasks>

<verification>
Phase 34 complete verification:
1. TICK-01: Impact assessment document exists at `.planning/phases/34-ticker-key-migration/TICK-01-IMPACT-ASSESSMENT.md`
2. TICK-02: `tickerKey(1, 'BTC-USD')` returns `'ticker:1:BTC-USD'` (no userId). All callers updated.
3. TICK-03: `tickerChannel(1, 'BTC-USD')` returns `'channel:ticker:1:BTC-USD'` (no userId). All subscribers updated.
4. Full codebase grep for `ticker:${userId}` returns zero matches
5. Project compiles cleanly with `npx turbo build` or `npx tsc --noEmit`
</verification>

<success_criteria>
- All 5 consumer files pass only (exchangeId, ...) to ticker cache methods
- No TypeScript compilation errors across the entire monorepo
- Grep confirms zero remaining user-scoped ticker key/channel references
- The ticker data flow is unbroken: adapter writes -> cache stores -> pub/sub publishes -> alert service subscribes
</success_criteria>

<output>
After completion, create `.planning/phases/34-ticker-key-migration/34-02-SUMMARY.md`
</output>

---
phase: 34-ticker-key-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/34-ticker-key-migration/TICK-01-IMPACT-ASSESSMENT.md
  - packages/cache/src/keys.ts
  - packages/cache/src/strategies/ticker-cache.ts
autonomous: true
must_haves:
  truths:
    - "Impact assessment lists every file that reads or writes ticker keys and ticker pub/sub channels"
    - "tickerKey() returns exchange-scoped key without userId segment"
    - "tickerChannel() returns exchange-scoped channel without userId segment"
    - "TickerCacheStrategy methods no longer require userId parameter"
  artifacts:
    - path: ".planning/phases/34-ticker-key-migration/TICK-01-IMPACT-ASSESSMENT.md"
      provides: "Comprehensive impact assessment documenting all ticker key/channel consumers"
      min_lines: 30
    - path: "packages/cache/src/keys.ts"
      provides: "Exchange-scoped tickerKey and tickerChannel functions"
      contains: "ticker:$exchangeId:$symbol"
    - path: "packages/cache/src/strategies/ticker-cache.ts"
      provides: "TickerCacheStrategy with exchange-scoped signatures"
      exports: ["TickerCacheStrategy"]
  key_links:
    - from: "packages/cache/src/strategies/ticker-cache.ts"
      to: "packages/cache/src/keys.ts"
      via: "import tickerKey, tickerChannel"
      pattern: "tickerKey\\(exchangeId"
---

<objective>
Create impact assessment for ticker key migration (TICK-01) and migrate the core cache layer functions and TickerCacheStrategy to exchange-scoped patterns (TICK-02/TICK-03 foundation).

Purpose: The ticker key (`ticker:{userId}:{exchangeId}:{symbol}`) and ticker channel (`channel:ticker:{userId}:{exchangeId}:{symbol}`) are the last user-scoped key patterns in the codebase. Candles and indicators were migrated to exchange-scoped keys in v5.0. This plan aligns tickers to the same pattern: `ticker:{exchangeId}:{symbol}` and `channel:ticker:{exchangeId}:{symbol}`. Notably, several consumers (control-channel.service.ts, server.ts) already hardcode the exchange-scoped pattern inline, bypassing the function -- this plan fixes the function to match those expectations.

Output: Impact assessment document + updated cache layer (keys.ts, ticker-cache.ts)
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/cache/src/keys.ts
@packages/cache/src/strategies/ticker-cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TICK-01 Impact Assessment</name>
  <files>.planning/phases/34-ticker-key-migration/TICK-01-IMPACT-ASSESSMENT.md</files>
  <action>
Create an impact assessment document that catalogs every file reading or writing ticker keys and ticker pub/sub channels. The document must include:

1. **Current State** section showing the current key patterns:
   - `tickerKey()` in keys.ts: `ticker:{userId}:{exchangeId}:{symbol}` (user-scoped)
   - `tickerChannel()` in keys.ts: `channel:ticker:{userId}:{exchangeId}:{symbol}` (user-scoped)

2. **Target State** section showing the new patterns:
   - `tickerKey()`: `ticker:{exchangeId}:{symbol}` (exchange-scoped)
   - `tickerChannel()`: `channel:ticker:{exchangeId}:{symbol}` (exchange-scoped)

3. **Affected Files** table with columns: File, Function/Usage, Current Pattern, Change Required. Include ALL of these files:

   **Cache layer (function definitions):**
   - `packages/cache/src/keys.ts` -- tickerKey() and tickerChannel() function signatures
   - `packages/cache/src/strategies/ticker-cache.ts` -- TickerCacheStrategy class (all 6 methods: setTicker, getTicker, getTickers, publishUpdate, deleteTicker, hasTicker)

   **Writers (set ticker data + publish updates):**
   - `packages/exchange-core/src/adapter/coinbase-adapter.ts` -- calls setTicker(userId, exchangeIdNum, ticker) and publishUpdate(userId, exchangeIdNum, ticker) at lines ~574-577
   - `apps/api/src/services/coinbase-websocket.service.ts` -- DEPRECATED, calls setTicker/publishUpdate with TEST_USER_ID at lines ~233-236

   **Readers (get ticker data):**
   - `apps/api/src/routers/indicator.router.ts` -- calls getTickers(TEST_USER_ID, TEST_EXCHANGE_ID, symbols) at line ~457
   - `apps/api/src/services/position-sync.service.ts` -- calls getTicker(userId, exchangeId, tradingPair) at line ~246

   **Subscribers (pub/sub channels):**
   - `apps/api/src/services/alert-evaluation.service.ts` -- subscribes to tickerChannel(1, exchangeId, symbol) at line ~140, matches on 'channel:ticker:' prefix at line ~171

   **Inline key strings (already exchange-scoped -- NO CHANGE NEEDED):**
   - `apps/api/src/server.ts` -- `ticker:${exchangeId}:${symbol}` at line ~175 (already correct)
   - `apps/api/src/services/control-channel.service.ts` -- `ticker:${exchangeId}:*` at line ~872, `ticker:${exchangeId}:${symbol}` at lines ~893, ~1280 (already correct)

4. **Key Observation:** The inline strings in server.ts and control-channel.service.ts already use the exchange-scoped pattern (no userId). This confirms the codebase has been expecting exchange-scoped ticker keys -- the tickerKey()/tickerChannel() functions just never caught up.

5. **Migration Risk Assessment:** LOW -- this is a signature change on 2 functions, removing 1 parameter from 6 TickerCacheStrategy methods, and updating 5 caller sites. No database changes. No schema changes. Existing inline strings already match target pattern.
  </action>
  <verify>Read the created file and confirm it lists all 9 affected files (2 cache layer + 2 writers + 2 readers + 1 subscriber + 2 inline-already-correct).</verify>
  <done>Impact assessment document exists at .planning/phases/34-ticker-key-migration/TICK-01-IMPACT-ASSESSMENT.md and catalogs all services, routers, and components that read/write ticker keys or subscribe to ticker pub/sub channels.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate tickerKey, tickerChannel, and TickerCacheStrategy to exchange-scoped</name>
  <files>packages/cache/src/keys.ts, packages/cache/src/strategies/ticker-cache.ts</files>
  <action>
**In `packages/cache/src/keys.ts`:**

1. Change `tickerKey()` signature from `(userId: number, exchangeId: number, symbol: string)` to `(exchangeId: number, symbol: string)`. Change the return from `ticker:${userId}:${exchangeId}:${symbol}` to `ticker:${exchangeId}:${symbol}`. Add a JSDoc comment: `@example tickerKey(1, 'BTC-USD') // 'ticker:1:BTC-USD'`. Remove the `@deprecated` or add one saying this is now exchange-scoped (consistent with exchangeCandleKey pattern).

2. Change `tickerChannel()` signature from `(userId: number, exchangeId: number, symbol: string)` to `(exchangeId: number, symbol: string)`. Change the return from `channel:ticker:${userId}:${exchangeId}:${symbol}` to `channel:ticker:${exchangeId}:${symbol}`. Add JSDoc: `@example tickerChannel(1, 'BTC-USD') // 'channel:ticker:1:BTC-USD'`.

3. Move both functions from the "LEGACY: User-Scoped Keys" section up to the "TIER 1: Exchange-Scoped Keys" section (after exchangeAlertChannel). Update their JSDoc to say "Exchange-scoped ticker key/channel" consistent with the Tier 1 naming convention.

**In `packages/cache/src/strategies/ticker-cache.ts`:**

4. Remove `userId` parameter from ALL 6 methods: `setTicker`, `getTicker`, `getTickers`, `publishUpdate`, `deleteTicker`, `hasTicker`. Each method currently takes `(userId: number, exchangeId: number, ...)` -- change to `(exchangeId: number, ...)`. Update all internal calls to `tickerKey()` and `tickerChannel()` to pass only `(exchangeId, symbol)`.

5. Update the class JSDoc comment to say "Exchange-scoped ticker caching strategy" and remove the line "All tickers are scoped by userId and exchangeId for multi-user support" -- replace with "Tickers are exchange-scoped (shared across users on the same exchange), consistent with candle and indicator key patterns."

IMPORTANT: Do NOT touch any files outside of the cache package in this task. Consumer updates happen in Plan 02.
  </action>
  <verify>Run `npx tsc --noEmit -p packages/cache/tsconfig.json 2>&1 | head -5` to verify the cache package itself compiles (it will -- no internal consumers). Then grep to confirm: `grep "userId" packages/cache/src/keys.ts` should NOT match tickerKey or tickerChannel. `grep "userId" packages/cache/src/strategies/ticker-cache.ts` should return NO matches.</verify>
  <done>tickerKey() returns `ticker:{exchangeId}:{symbol}`, tickerChannel() returns `channel:ticker:{exchangeId}:{symbol}`, and all TickerCacheStrategy methods accept (exchangeId, ...) without userId.</done>
</task>

</tasks>

<verification>
- `tickerKey(1, 'BTC-USD')` would return `'ticker:1:BTC-USD'` (no userId segment)
- `tickerChannel(1, 'BTC-USD')` would return `'channel:ticker:1:BTC-USD'` (no userId segment)
- TickerCacheStrategy.setTicker takes (exchangeId, ticker) not (userId, exchangeId, ticker)
- Impact assessment lists all 9 files with their specific usage
- The full project will NOT compile yet -- consumer files still pass userId (fixed in Plan 02)
</verification>

<success_criteria>
- TICK-01 impact assessment document exists and is comprehensive
- Cache layer (keys.ts + ticker-cache.ts) is fully migrated to exchange-scoped pattern
- No userId parameter remains in tickerKey, tickerChannel, or any TickerCacheStrategy method
</success_criteria>

<output>
After completion, create `.planning/phases/34-ticker-key-migration/34-01-SUMMARY.md`
</output>

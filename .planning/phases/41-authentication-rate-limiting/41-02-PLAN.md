---
phase: 41-authentication-rate-limiting
plan: 02
type: execute
wave: 2
depends_on: ["41-01"]
files_modified:
  - apps/admin/src/pages/ApiKeys.tsx
  - apps/admin/src/components/api-keys/ApiKeyTable.tsx
  - apps/admin/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to API Keys page from the header navigation"
    - "Admin can see a list of existing API keys with masked key preview, name, status, and last used date"
    - "Admin can create a new API key by providing a name and sees the full key exactly once"
    - "Admin can regenerate an existing key and sees the new full key exactly once"
    - "Admin can deactivate an API key with confirmation dialog"
  artifacts:
    - path: "apps/admin/src/pages/ApiKeys.tsx"
      provides: "API Keys management page"
      contains: "ApiKeys"
    - path: "apps/admin/src/components/api-keys/ApiKeyTable.tsx"
      provides: "API key list table with actions"
      contains: "ApiKeyTable"
  key_links:
    - from: "apps/admin/src/pages/ApiKeys.tsx"
      to: "apps/api/src/routers/api-key.router.ts"
      via: "tRPC useQuery and useMutation hooks"
      pattern: "trpc\\.apiKey\\.(list|create|regenerate|deactivate)"
    - from: "apps/admin/src/App.tsx"
      to: "apps/admin/src/pages/ApiKeys.tsx"
      via: "HashRouter case for #/api-keys"
      pattern: "case.*api-keys.*ApiKeys"
---

<objective>
Build the admin UI page for API key management, allowing admins to create, view, regenerate, and deactivate API keys.

Purpose: Provide a user-friendly interface for managing API keys without direct database access (AUTH-05).

Output: ApiKeys page with table listing keys, create form, regenerate and deactivate actions, and copy-to-clipboard for new keys.
</objective>

<execution_context>
@C:/Users/Mike McWilliams/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Mike McWilliams/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-authentication-rate-limiting/41-01-SUMMARY.md

@apps/admin/src/App.tsx
@apps/admin/src/pages/Settings.tsx
@apps/admin/src/pages/ControlPanel.tsx
@apps/admin/src/components/ui/Card.tsx
@apps/admin/src/components/ui/Dialog.tsx
@apps/admin/src/components/ui/Button.tsx
@apps/admin/src/lib/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: API Keys page, table component, and navigation wiring</name>
  <files>
    apps/admin/src/pages/ApiKeys.tsx
    apps/admin/src/components/api-keys/ApiKeyTable.tsx
    apps/admin/src/App.tsx
  </files>
  <action>
1. **apps/admin/src/components/api-keys/ApiKeyTable.tsx** -- Create table component:
   - Props: `keys` array (from tRPC list query), `onRegenerate(id: number)`, `onDeactivate(id: number)`, loading state.
   - Display table with columns: Name, Key Preview (masked like `••••-xxxx`), Status (active/inactive badge), Last Used (relative time or "Never"), Created At, Actions.
   - Actions column: "Regenerate" button (with confirmation dialog -- "This will invalidate the current key. Continue?") and "Deactivate" button (with confirmation dialog -- "This key will stop working immediately. Continue?"). Deactivate only shown for active keys.
   - Use existing UI components: Card, Button, Dialog (or simple `window.confirm` if Dialog adds too much complexity).
   - Empty state: "No API keys yet. Create one above."
   - Follow existing component patterns from the codebase (Tailwind classes, shadcn-style components).

2. **apps/admin/src/pages/ApiKeys.tsx** -- Create the page:
   - Use `trpc.apiKey.list.useQuery()` to fetch keys.
   - "Create API Key" section at top: input for key name + "Create" button. Use `trpc.apiKey.create.useMutation()` with `onSuccess` that invalidates the list query.
   - When a key is created or regenerated, show the FULL key in a highlighted box with a "Copy to Clipboard" button and a warning: "Save this key now. It won't be shown again." Use `navigator.clipboard.writeText()` for copy. Dismiss the key display after user acknowledges.
   - `trpc.apiKey.regenerate.useMutation()` and `trpc.apiKey.deactivate.useMutation()` -- both invalidate list query on success, show toast on error.
   - Use sonner `toast.success()` / `toast.error()` for feedback (already installed in the project).
   - Render `<ApiKeyTable>` with the query data and mutation handlers.
   - Page title: "API Keys" with subtitle "Manage API keys for public API access."
   - Follow the layout pattern of Settings.tsx (Card wrapper, padding, etc.).

3. **apps/admin/src/App.tsx** -- Wire up navigation:
   - Import `ApiKeys` page component.
   - Add `case '#/api-keys': return <ApiKeys />;` to the HashRouter switch.
   - Add navigation link "API Keys" in the header navigation (find the existing nav links like Control, Network, Symbols, Settings and add "API Keys" after Settings or before it). Look at where the nav links are rendered and add one for `#/api-keys` with a key/lock icon if icons are used.
  </action>
  <verify>
1. Run `npx tsc --noEmit` from apps/admin to verify TypeScript compiles.
2. Navigate to `http://localhost:4001/#/api-keys` and confirm the page renders.
3. Create a key via the UI, confirm full key is displayed with copy button.
4. Refresh page, confirm key is listed with masked preview.
5. Regenerate the key, confirm new key is shown.
6. Deactivate the key, confirm status changes to inactive.
  </verify>
  <done>
Admin UI page at #/api-keys displays API keys list, allows creation with full-key-once display and copy-to-clipboard, supports regeneration and deactivation with confirmation dialogs, accessible from header navigation.
  </done>
</task>

</tasks>

<verification>
1. Navigate to admin UI and see "API Keys" link in navigation
2. Click "API Keys" -- page loads with empty state
3. Enter name "Test Key" and click Create -- full UUID key displayed with copy button
4. Copy key to clipboard -- paste confirms UUID format
5. Dismiss key display -- table shows key with masked preview
6. Click Regenerate -- confirmation dialog appears, confirm shows new full key
7. Click Deactivate -- confirmation dialog appears, confirm changes status badge to inactive
8. Use the deactivated key with curl -- returns 401 (within 60s after cache expires)
</verification>

<success_criteria>
- API Keys page accessible from admin navigation at #/api-keys
- Create flow shows full key exactly once with copy-to-clipboard
- Key list shows masked previews, status badges, and timestamps
- Regenerate and deactivate work with confirmation dialogs
- All mutations invalidate the list query for instant UI updates
- Toast notifications for success/error feedback
</success_criteria>

<output>
After completion, create `.planning/phases/41-authentication-rate-limiting/41-02-SUMMARY.md`
</output>

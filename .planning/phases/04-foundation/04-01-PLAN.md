---
phase: 04-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/schemas/src/adapter/exchange-adapter.schema.ts
  - packages/schemas/src/adapter/index.ts
  - packages/schemas/src/index.ts
autonomous: true

must_haves:
  truths:
    - "UnifiedCandle schema extends existing CandleSchema with exchange field"
    - "ExchangeAdapterEvents type defines candle:close, connected, disconnected, error, reconnecting events"
    - "IExchangeAdapter interface defines connect/disconnect/subscribe/unsubscribe/isConnected methods"
    - "TypeScript types are inferred from Zod schemas using z.infer"
  artifacts:
    - path: "packages/schemas/src/adapter/exchange-adapter.schema.ts"
      provides: "UnifiedCandle, ExchangeAdapterEvents, IExchangeAdapter"
      exports: ["UnifiedCandleSchema", "UnifiedCandle", "ExchangeAdapterEvents", "IExchangeAdapter"]
    - path: "packages/schemas/src/adapter/index.ts"
      provides: "Barrel export for adapter schemas"
      exports: ["*"]
  key_links:
    - from: "packages/schemas/src/adapter/exchange-adapter.schema.ts"
      to: "packages/schemas/src/market/candle.schema.ts"
      via: "extends CandleSchema"
      pattern: "CandleSchema\\.extend"
    - from: "packages/schemas/src/index.ts"
      to: "packages/schemas/src/adapter/index.ts"
      via: "barrel export"
      pattern: "export \\* from './adapter'"
---

<objective>
Define TypeScript interfaces and Zod schemas for the exchange adapter pattern.

Purpose: Establish type-safe contracts that allow indicator service to work with any exchange adapter without knowing exchange-specific details. These definitions are the foundation for Phase 05 (Coinbase Adapter) and future exchange implementations.

Output:
- `UnifiedCandle` schema extending `CandleSchema` with `exchange`, `exchangeTimestamp`, and `sequenceNum` fields
- `ExchangeAdapterEvents` type map for typed EventEmitter events
- `IExchangeAdapter` interface defining adapter contract
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-foundation/04-RESEARCH.md

# Existing patterns to follow
@packages/schemas/src/market/candle.schema.ts
@packages/schemas/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UnifiedCandle schema and ExchangeAdapterEvents type</name>
  <files>packages/schemas/src/adapter/exchange-adapter.schema.ts</files>
  <action>
Create new file `packages/schemas/src/adapter/exchange-adapter.schema.ts` with:

1. **UnifiedCandle schema** - Extend existing `CandleSchema` using `.extend()`:
   ```typescript
   export const UnifiedCandleSchema = CandleSchema.extend({
     /** Exchange identifier (e.g., 'coinbase', 'binance') */
     exchange: z.string().min(1),
     /** Original exchange timestamp for debugging (ISO string) */
     exchangeTimestamp: z.string().optional(),
     /** Sequence number from WebSocket for gap detection */
     sequenceNum: z.number().int().nonnegative().optional(),
   });
   export type UnifiedCandle = z.infer<typeof UnifiedCandleSchema>;
   ```

2. **ExchangeAdapterEvents type** - Event map for typed EventEmitter (Node 20+):
   ```typescript
   export type ExchangeAdapterEvents = {
     'candle:close': [candle: UnifiedCandle];
     'connected': [];
     'disconnected': [reason: string];
     'error': [error: Error];
     'reconnecting': [attempt: number, delay: number];
   };
   ```

3. **IExchangeAdapter interface** - Extend EventEmitter with generics:
   ```typescript
   import { EventEmitter } from 'events';
   import type { Timeframe } from '../market/candle.schema';

   export interface IExchangeAdapter extends EventEmitter<ExchangeAdapterEvents> {
     /** Establish connection to exchange WebSocket */
     connect(): Promise<void>;
     /** Gracefully close connection */
     disconnect(): void;
     /** Subscribe to candle updates for symbols */
     subscribe(symbols: string[], timeframe: Timeframe): void;
     /** Unsubscribe from candle updates */
     unsubscribe(symbols: string[], timeframe: Timeframe): void;
     /** Check if currently connected */
     isConnected(): boolean;
   }
   ```

Import `z` from 'zod', `CandleSchema` and `Timeframe` from existing candle.schema.ts using relative path.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/schemas/tsconfig.json` - should compile without errors.
Verify EventEmitter generic syntax is correct for Node 20+ types.
  </verify>
  <done>
- UnifiedCandleSchema extends CandleSchema with exchange, exchangeTimestamp, sequenceNum fields
- UnifiedCandle type is inferred from schema
- ExchangeAdapterEvents defines 5 event types with proper payloads
- IExchangeAdapter interface extends typed EventEmitter with 5 methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Create barrel export and update schemas index</name>
  <files>packages/schemas/src/adapter/index.ts, packages/schemas/src/index.ts</files>
  <action>
1. **Create barrel export** at `packages/schemas/src/adapter/index.ts`:
   ```typescript
   /**
    * Exchange adapter schemas and types
    */
   export * from './exchange-adapter.schema';
   ```

2. **Update main index** at `packages/schemas/src/index.ts`:
   Add export line after existing exports (place after Position schemas, before Environment schemas):
   ```typescript
   // Adapter schemas
   export * from './adapter';
   ```

This follows the existing pattern used for other schema categories.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/schemas/tsconfig.json` - should compile without errors.
Verify exports are accessible: `import { UnifiedCandle, IExchangeAdapter } from '@livermore/schemas'`
  </verify>
  <done>
- adapter/index.ts barrel export created
- schemas/index.ts updated to export adapter schemas
- UnifiedCandle, UnifiedCandleSchema, ExchangeAdapterEvents, IExchangeAdapter all exported from @livermore/schemas
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npx tsc --noEmit -p packages/schemas/tsconfig.json` passes
2. `npx tsc --noEmit -p packages/cache/tsconfig.json` passes (uses schemas)
3. Types are properly exported and importable from @livermore/schemas

Test import in a scratch file or REPL:
```typescript
import {
  UnifiedCandleSchema,
  UnifiedCandle,
  ExchangeAdapterEvents,
  IExchangeAdapter
} from '@livermore/schemas';
```
</verification>

<success_criteria>
- [ ] UnifiedCandleSchema extends CandleSchema with 3 new fields
- [ ] UnifiedCandle type inferred from schema (not manually defined)
- [ ] ExchangeAdapterEvents defines typed event map for 5 events
- [ ] IExchangeAdapter extends EventEmitter<ExchangeAdapterEvents>
- [ ] All types exported from @livermore/schemas package
- [ ] TypeScript compilation succeeds across monorepo
</success_criteria>

<output>
After completion, create `.planning/phases/04-foundation/04-01-SUMMARY.md`
</output>

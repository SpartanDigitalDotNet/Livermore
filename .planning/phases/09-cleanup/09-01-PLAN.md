---
phase: 09-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/server.ts
  - apps/api/src/services/coinbase-websocket.service.ts
autonomous: true

must_haves:
  truths:
    - "Server starts using CoinbaseAdapter for 5m candle data"
    - "Old CoinbaseWebSocketService is not instantiated at runtime"
    - "CoinbaseAdapter connects and subscribes to candles channel"
    - "Graceful shutdown disconnects CoinbaseAdapter"
  artifacts:
    - path: "apps/api/src/server.ts"
      provides: "Server startup with CoinbaseAdapter"
      contains: "CoinbaseAdapter"
    - path: "apps/api/src/services/coinbase-websocket.service.ts"
      provides: "Deprecated legacy service"
      contains: "@deprecated"
  key_links:
    - from: "apps/api/src/server.ts"
      to: "CoinbaseAdapter"
      via: "import and instantiation"
      pattern: "new CoinbaseAdapter"
    - from: "CoinbaseAdapter"
      to: "redis pub/sub"
      via: "candleCloseChannel publish"
      pattern: "candleCloseChannel"
---

<objective>
Replace legacy CoinbaseWebSocketService with CoinbaseAdapter in server.ts

Purpose: Complete the migration from ticker-based 1m candle building to native 5m WebSocket candles. The new CoinbaseAdapter (built in Phase 05) uses Coinbase's candles channel for real-time 5m data, eliminating data gaps from low-liquidity symbols.

Output: Server runs with new adapter, old service deprecated but preserved for rollback
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work reference
@.planning/phases/05-coinbase-adapter/05-01-SUMMARY.md
@.planning/phases/05-coinbase-adapter/05-02-SUMMARY.md
@.planning/phases/05-coinbase-adapter/05-03-SUMMARY.md
@.planning/phases/08-reconciliation/08-03-SUMMARY.md

# Key source files
@packages/coinbase-client/src/adapter/coinbase-adapter.ts
@apps/api/src/server.ts
@apps/api/src/services/coinbase-websocket.service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace CoinbaseWebSocketService with CoinbaseAdapter in server.ts</name>
  <files>apps/api/src/server.ts</files>
  <action>
Update server.ts to use CoinbaseAdapter instead of CoinbaseWebSocketService:

1. **Update imports** (around line 9-10):
   - Remove: `import { CoinbaseWebSocketService } from './services/coinbase-websocket.service';`
   - Add to existing coinbase-client import: `CoinbaseAdapter`

   The import should become:
   ```typescript
   import { CoinbaseRestClient, StartupBackfillService, BoundaryRestService, DEFAULT_BOUNDARY_CONFIG, CoinbaseAdapter } from '@livermore/coinbase-client';
   ```

2. **Replace service instantiation** (around lines 263-269):
   Replace:
   ```typescript
   const coinbaseWsService = new CoinbaseWebSocketService(
     config.Coinbase_ApiKeyId,
     config.Coinbase_EcPrivateKeyPem
   );
   await coinbaseWsService.start(monitoredSymbols);
   ```

   With:
   ```typescript
   const coinbaseAdapter = new CoinbaseAdapter({
     apiKeyId: config.Coinbase_ApiKeyId,
     privateKeyPem: config.Coinbase_EcPrivateKeyPem,
     redis,
     userId: 1,  // Matches DEFAULT_BOUNDARY_CONFIG.userId
     exchangeId: 1,  // Matches DEFAULT_BOUNDARY_CONFIG.exchangeId
   });
   await coinbaseAdapter.connect();
   coinbaseAdapter.subscribe(monitoredSymbols, '5m');
   ```

3. **Update shutdown handler** (around line 302):
   Replace: `coinbaseWsService.stop();`
   With: `coinbaseAdapter.disconnect();`

4. **Update logging** (around line 270):
   Change log message from "Coinbase WebSocket service started" to "Coinbase Adapter started (5m candles)"

NOTE: Do NOT remove the CoinbaseWebSocketService import entirely yet - we deprecate it in Task 2. The import removal happens automatically when the file no longer references it.
  </action>
  <verify>
1. `pnpm build` completes without TypeScript errors
2. Grep for "CoinbaseWebSocketService" in server.ts returns 0 matches
3. Grep for "CoinbaseAdapter" in server.ts returns matches for import and instantiation
  </verify>
  <done>
Server.ts uses CoinbaseAdapter for WebSocket candle data instead of legacy CoinbaseWebSocketService
  </done>
</task>

<task type="auto">
  <name>Task 2: Deprecate CoinbaseWebSocketService</name>
  <files>apps/api/src/services/coinbase-websocket.service.ts</files>
  <action>
Mark CoinbaseWebSocketService as deprecated while preserving it for potential rollback:

1. **Add deprecation JSDoc to class** (before line 37):
   ```typescript
   /**
    * @deprecated Use CoinbaseAdapter from @livermore/coinbase-client instead.
    * This service builds 1m candles from ticker data which causes data gaps
    * for low-liquidity symbols. CoinbaseAdapter uses native 5m candles channel.
    *
    * Kept for rollback purposes - scheduled for removal in v2.1.
    */
   ```

2. **Add deprecation warning to constructor** (inside constructor, after line 59):
   ```typescript
   logger.warn(
     'CoinbaseWebSocketService is deprecated. Use CoinbaseAdapter from @livermore/coinbase-client instead.'
   );
   ```

3. **Add file-level deprecation comment** (at top of file, line 1):
   ```typescript
   /**
    * @deprecated This entire module is deprecated as of v2.0.
    * Use packages/coinbase-client/src/adapter/coinbase-adapter.ts instead.
    */
   ```

Do NOT delete the file. It remains as a rollback option if issues are discovered with CoinbaseAdapter.
  </action>
  <verify>
1. File contains "@deprecated" annotation
2. Constructor contains deprecation warning log
3. File still compiles: `pnpm build`
  </verify>
  <done>
CoinbaseWebSocketService marked as deprecated with clear migration guidance
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify no REST calls in indicator hot path</name>
  <files>apps/api/src/services/indicator-calculation.service.ts</files>
  <action>
Verify that the indicator service has no REST API calls in its recalculation path:

1. **Grep for REST client usage** in indicator-calculation.service.ts:
   - Search for `restClient`
   - Search for `CoinbaseRestClient`
   - Search for `getCandles`
   - Search for `fetch(`

2. **Verify cache-only reads**:
   - Confirm `recalculateFromCache` reads from `this.candleCache.getRecentCandles()` only
   - Confirm no fallback to REST on cache miss

3. **Document findings** in SUMMARY.md

This is a verification task - no code changes expected. If REST calls ARE found, stop and flag as blocker.
  </action>
  <verify>
1. Grep for `restClient` returns 0 matches in indicator-calculation.service.ts
2. Grep for `CoinbaseRestClient` returns 0 matches in indicator-calculation.service.ts
3. The only data source is candleCache.getRecentCandles()
  </verify>
  <done>
Confirmed: Indicator service reads exclusively from cache, no REST API calls in hot path
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Build verification:**
   ```bash
   pnpm build
   ```
   All packages must compile without errors.

2. **Import verification:**
   Grep server.ts for CoinbaseAdapter usage:
   - Import present: `CoinbaseAdapter`
   - Instantiation present: `new CoinbaseAdapter`
   - Connect called: `coinbaseAdapter.connect()`
   - Subscribe called: `coinbaseAdapter.subscribe`
   - Disconnect in shutdown: `coinbaseAdapter.disconnect()`

3. **Legacy service verification:**
   - CoinbaseWebSocketService NOT imported in server.ts
   - CoinbaseWebSocketService file exists but has @deprecated

4. **No REST in hot path:**
   - indicator-calculation.service.ts has 0 REST client references
</verification>

<success_criteria>
- Server.ts uses CoinbaseAdapter (not CoinbaseWebSocketService)
- CoinbaseAdapter connects, subscribes to candles channel, and disconnects on shutdown
- Legacy CoinbaseWebSocketService marked @deprecated but preserved
- Zero REST client references in indicator-calculation.service.ts
- All TypeScript compiles
</success_criteria>

<output>
After completion, create `.planning/phases/09-cleanup/09-01-SUMMARY.md`
</output>

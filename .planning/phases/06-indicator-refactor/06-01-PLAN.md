---
phase: 06-indicator-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/utils/src/candle/aggregate-candles.ts
  - packages/utils/src/candle/index.ts
  - packages/utils/src/index.ts
autonomous: true

must_haves:
  truths:
    - "aggregateCandles() builds larger timeframe candles from smaller ones"
    - "5m candles aggregate to 15m, 1h, 4h, 1d"
    - "Aggregation uses correct OHLC rules (first open, max high, min low, last close, sum volume)"
    - "Incomplete periods are excluded from output"
  artifacts:
    - path: "packages/utils/src/candle/aggregate-candles.ts"
      provides: "Candle aggregation function"
      exports: ["aggregateCandles"]
      min_lines: 60
  key_links:
    - from: "packages/utils/src/candle/aggregate-candles.ts"
      to: "@livermore/schemas Candle type"
      via: "import type"
      pattern: "import.*Candle.*from '@livermore/schemas'"
    - from: "packages/utils/src/candle/aggregate-candles.ts"
      to: "timeframeToMs utility"
      via: "import from sibling"
      pattern: "import.*timeframeToMs.*from"
---

<objective>
Create candle aggregation utility for building higher timeframes from 5m candles

Purpose: Enable indicator service to calculate 15m/1h/4h/1d indicators from cached 5m WebSocket data without REST API calls for each timeframe
Output: `aggregateCandles()` function exported from @livermore/utils
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-indicator-refactor/06-RESEARCH.md
@packages/utils/src/time/timeframe.ts
@packages/schemas/src/candle.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create aggregateCandles utility</name>
  <files>packages/utils/src/candle/aggregate-candles.ts</files>
  <action>
Create a new file `aggregate-candles.ts` with the `aggregateCandles()` function.

The function signature:
```typescript
function aggregateCandles(
  candles: Candle[],
  sourceTimeframe: Timeframe,
  targetTimeframe: Timeframe
): Candle[]
```

Implementation requirements:
1. Import `Candle`, `Timeframe` from `@livermore/schemas`
2. Import `timeframeToMs`, `getCandleTimestamp` from sibling `../time/timeframe`
3. Validate that target timeframe is larger than source (throw Error if not)
4. Calculate how many source candles make one target candle (factor = targetMs / sourceMs)
5. Group source candles by target timeframe boundary using `getCandleTimestamp(candle.timestamp, targetTimeframe)`
6. Only include COMPLETE groups (groups with exactly `factor` candles)
7. For each complete group, aggregate:
   - timestamp: the group boundary timestamp
   - open: first candle's open
   - high: Math.max of all highs
   - low: Math.min of all lows
   - close: last candle's close
   - volume: sum of all volumes
   - symbol: from source candles
   - timeframe: targetTimeframe
   - isSynthetic: true if ANY source candle was synthetic

Aggregation factor lookup for 5m source:
- 15m: 3 candles (15 / 5)
- 1h: 12 candles (60 / 5)
- 4h: 48 candles (240 / 5)
- 1d: 288 candles (1440 / 5)

Return candles sorted by timestamp ascending.

Add JSDoc with example showing 5m -> 1h aggregation.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit -p packages/utils/tsconfig.json`
Function exported: `grep "export function aggregateCandles" packages/utils/src/candle/aggregate-candles.ts`
  </verify>
  <done>
aggregateCandles() function exists, properly typed, validates inputs, groups by boundary, only outputs complete periods
  </done>
</task>

<task type="auto">
  <name>Task 2: Export aggregation utility</name>
  <files>packages/utils/src/candle/index.ts, packages/utils/src/index.ts</files>
  <action>
1. Create `packages/utils/src/candle/index.ts` barrel file:
```typescript
export * from './candle-utils';
export * from './aggregate-candles';
```

2. Update `packages/utils/src/index.ts` to use the barrel:
Replace `export * from './candle/candle-utils';` with `export * from './candle';`

This allows importing as:
```typescript
import { aggregateCandles, fillCandleGaps } from '@livermore/utils';
```
  </action>
  <verify>
Build succeeds: `npm run build -w @livermore/utils`
Can import: `grep "export \* from './candle'" packages/utils/src/index.ts`
  </verify>
  <done>
aggregateCandles is exported from @livermore/utils package
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for aggregation</name>
  <files>packages/utils/src/candle/aggregate-candles.test.ts</files>
  <action>
Create test file with vitest tests:

```typescript
import { describe, it, expect } from 'vitest';
import { aggregateCandles } from './aggregate-candles';
import type { Candle } from '@livermore/schemas';
```

Test cases:
1. **5m to 15m aggregation:** Create 6 candles (2 complete 15m periods), verify 2 output candles with correct OHLCV
2. **Incomplete period excluded:** Create 4 candles (1 complete + 1 partial), verify only 1 output
3. **OHLC rules correct:** Verify open=first, high=max, low=min, close=last, volume=sum
4. **isSynthetic propagation:** If any source candle has isSynthetic=true, output should too
5. **Empty input:** Returns empty array
6. **Target smaller than source:** Throws error
7. **Sorted output:** Result is sorted by timestamp ascending

Use factory function to create test candles:
```typescript
function makeCandle(timestamp: number, ohlcv: [number, number, number, number, number]): Candle {
  return {
    timestamp,
    open: ohlcv[0],
    high: ohlcv[1],
    low: ohlcv[2],
    close: ohlcv[3],
    volume: ohlcv[4],
    symbol: 'BTC-USD',
    timeframe: '5m',
    isSynthetic: false,
  };
}
```

Use timestamps that align to 15m boundaries:
- 1000 * 60 * 5 = 300000 (5m in ms)
- Start at a clean hour like 1704067200000 (Mon Jan 01 2024 00:00:00 UTC)
  </action>
  <verify>
Tests pass: `npm test -w @livermore/utils -- --run aggregate-candles`
  </verify>
  <done>
All 7 test cases pass, aggregation logic verified
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles across workspace: `npm run build`
2. Tests pass: `npm test -w @livermore/utils`
3. Function is importable from package root
</verification>

<success_criteria>
- aggregateCandles() converts 5m candles to 15m/1h/4h/1d
- Only complete periods are included in output
- OHLC aggregation follows standard rules
- isSynthetic flag propagates correctly
- Tests verify all edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/06-indicator-refactor/06-01-SUMMARY.md`
</output>

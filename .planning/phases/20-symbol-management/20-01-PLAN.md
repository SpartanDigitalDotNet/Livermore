---
phase: 20-symbol-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/src/routers/symbol.router.ts
  - apps/api/src/routers/index.ts
autonomous: true

must_haves:
  truths:
    - "Admin UI can search available symbols from Coinbase exchange"
    - "Admin UI can validate a symbol exists on Coinbase before adding"
    - "Admin UI can preview symbol metrics (price, 24h volume, 24h change) before adding"
  artifacts:
    - path: "apps/api/src/routers/symbol.router.ts"
      provides: "Symbol search, validate, metrics endpoints"
      exports: ["symbolRouter"]
    - path: "apps/api/src/routers/index.ts"
      provides: "Router registration"
      contains: "symbol: symbolRouter"
  key_links:
    - from: "apps/api/src/routers/symbol.router.ts"
      to: "@livermore/coinbase-client"
      via: "CoinbaseRestClient.getProducts, getProduct"
      pattern: "CoinbaseRestClient"
    # Note: Admin UI consumption of these endpoints is Phase 22 (Admin Symbol Management UI)
    # This plan creates the API endpoints; Phase 22 will wire Admin UI to consume them
---

<objective>
Create tRPC symbol router for Admin UI symbol validation

Purpose: Enable Admin UI to search, validate, and preview symbols against Coinbase exchange API before adding to watchlist. This satisfies the user constraint that symbol validation happens in Admin (not API command handlers).

Output: `symbol.router.ts` with search, validate, and metrics endpoints using `protectedProcedure`
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-symbol-management/20-RESEARCH.md
@apps/api/src/routers/settings.router.ts
@packages/coinbase-client/src/rest/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create symbol.router.ts with search and validate endpoints</name>
  <files>apps/api/src/routers/symbol.router.ts</files>
  <action>
Create `apps/api/src/routers/symbol.router.ts` with three tRPC endpoints:

1. **search** (SYM-04):
   - Input: `{ query: string (1-20 chars), limit: number (1-100, default 20) }`
   - Instantiate `CoinbaseRestClient` using env vars: `process.env.COINBASE_API_KEY_ID`, `process.env.COINBASE_PRIVATE_KEY` (replace `\\n` with actual newlines)
   - Call `client.getProducts()` to get all products
   - Filter products where `product_id` or `base_display_symbol` includes query (case-insensitive)
   - Filter to only `status === 'online'` and `!trading_disabled`
   - Limit results and map to `{ symbol: product_id, baseName: base_name, quoteName: quote_name }`
   - Return `{ results: [...], exchange: 'coinbase' }`

2. **validate** (SYM-03, SYM-06):
   - Input: `{ symbol: string (1-20 chars) }`
   - Normalize symbol: uppercase, trim, if no hyphen attempt to split at USD/USDC suffix
   - Call `client.getProduct(symbol)`
   - If throws or `trading_disabled` or `status !== 'online'`, return `{ valid: false, symbol, error: 'reason' }`
   - On success return: `{ valid: true, symbol, metrics: { price, priceChange24h, volume24h, baseName, quoteName } }`

3. **metrics** (SYM-06 - convenience endpoint):
   - Input: `{ symbols: string[] (1-20 items) }`
   - Call `getProduct` for each symbol, collect metrics
   - Return array of `{ symbol, price, priceChange24h, volume24h }` or `{ symbol, error }` for failures
   - Add 100ms delay between calls to respect rate limits

Import patterns from `settings.router.ts`: use `protectedProcedure`, `router` from `@livermore/trpc-config`.

Helper function for symbol normalization:
```typescript
function normalizeSymbol(input: string): string {
  const clean = input.trim().toUpperCase();
  if (clean.includes('-')) return clean;
  // Try to split at common quote currencies
  const quotes = ['USD', 'USDC', 'USDT', 'EUR', 'GBP'];
  for (const quote of quotes) {
    if (clean.endsWith(quote)) {
      return `${clean.slice(0, -quote.length)}-${quote}`;
    }
  }
  return clean;
}
```
  </action>
  <verify>
TypeScript compiles: `cd apps/api && pnpm tsc --noEmit`
  </verify>
  <done>
symbol.router.ts exists with search, validate, metrics endpoints using protectedProcedure
  </done>
</task>

<task type="auto">
  <name>Task 2: Register symbol router in index.ts</name>
  <files>apps/api/src/routers/index.ts</files>
  <action>
Update `apps/api/src/routers/index.ts`:

1. Add import: `import { symbolRouter } from './symbol.router';`
2. Add to appRouter: `symbol: symbolRouter,`
3. Add re-export: `export { symbolRouter } from './symbol.router';`

Follow existing pattern from settingsRouter registration.
  </action>
  <verify>
TypeScript compiles: `cd apps/api && pnpm tsc --noEmit`
  </verify>
  <done>
symbolRouter registered in appRouter, exported from index.ts
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify endpoints work via curl</name>
  <files></files>
  <action>
Start API in dev mode and test endpoints manually. Since these are protectedProcedure, they require Clerk auth. Verification is that TypeScript compiles and router is registered.

Alternative verification: Check that the router exports are correct by examining the compiled output or running a simple import test.
  </action>
  <verify>
Run API type check: `cd apps/api && pnpm tsc --noEmit`
Check router is importable: Verify no import errors in index.ts
  </verify>
  <done>
API compiles cleanly with symbol router integrated
  </done>
</task>

</tasks>

<verification>
- [ ] `apps/api/src/routers/symbol.router.ts` exists with 3 endpoints
- [ ] `apps/api/src/routers/index.ts` includes symbolRouter
- [ ] TypeScript compiles without errors: `cd apps/api && pnpm tsc --noEmit`
- [ ] Endpoints use `protectedProcedure` (not publicProcedure)
</verification>

<success_criteria>
1. symbol.search endpoint searches Coinbase products by query
2. symbol.validate endpoint validates symbol against Coinbase and returns metrics
3. symbol.metrics endpoint fetches metrics for multiple symbols
4. All endpoints require Clerk authentication (protectedProcedure)
5. Symbol normalization handles "SOLUSD" -> "SOL-USD" format conversion
</success_criteria>

<output>
After completion, create `.planning/phases/20-symbol-management/20-01-SUMMARY.md`
</output>

# Milestone v2.0: Data Pipeline Redesign

**Status:** ✅ SHIPPED 2026-01-24
**Phases:** 04-10
**Total Plans:** 17

## Overview

Transform from REST-heavy, request-driven architecture to cache-first, event-driven system using native WebSocket candles channel.

```
[Coinbase WebSocket] → [Exchange Adapter] → [Redis Cache] → [Indicator Service] → [Alerts]
                              ↓                    ↑
                        candle:close         [BoundaryRestService]
                           events          (event-driven higher TF)
```

## Phases

### Phase 04: Foundation

**Goal**: Define interfaces and base classes for exchange adapter pattern
**Plans**: 3 plans

Plans:
- [x] 04-01-PLAN.md — Schema definitions (UnifiedCandle, ExchangeAdapterEvents, IExchangeAdapter)
- [x] 04-02-PLAN.md — Cache enhancements (candleCloseChannel, versioned writes)
- [x] 04-03-PLAN.md — Base adapter abstract class

**Requirements:**
- ADPT-01: Exchange adapter interface
- CACHE-01: Candle cache writing
- CACHE-02: Timestamp-based versioning

---

### Phase 05: Coinbase Adapter

**Goal**: Implement Coinbase adapter with native candles channel and robust connection management
**Plans**: 3 plans

Plans:
- [x] 05-01-PLAN.md — CoinbaseAdapter skeleton with WebSocket connection and dual channel subscription
- [x] 05-02-PLAN.md — Candle processing pipeline (normalize, detect close, cache, emit)
- [x] 05-03-PLAN.md — Watchdog timer, sequence tracking, and REST backfill on reconnection

**Requirements:**
- ADPT-02: Subscribe to native `candles` WebSocket channel
- ADPT-03: Normalize to UnifiedCandle schema
- ADPT-04: Emit candle:close events
- WS-01: Auto-reconnect with exponential backoff
- WS-02: Heartbeat subscription
- WS-03: Watchdog timer for silent disconnections
- WS-04: Sequence number tracking
- WS-05: Reconnection gap detection

---

### Phase 06: Indicator Refactor

**Goal**: Make indicator service event-driven, reading exclusively from cache
**Plans**: 2 plans

Plans:
- [x] 06-01-PLAN.md — candleClosePattern helper for Redis psubscribe
- [x] 06-02-PLAN.md — Event-driven indicator service (psubscribe, cache-only, readiness gate)

**Requirements:**
- CACHE-03: Cache as single source of truth
- IND-01: Subscribe to candle:close events
- IND-02: Read exclusively from cache
- IND-03: 60-candle readiness check
- IND-04: Higher timeframes from cache

---

### Phase 07: Startup Backfill

**Goal**: Populate cache with historical candles on startup
**Plans**: 2 plans

Plans:
- [x] 07-01-PLAN.md — StartupBackfillService class with rate-limited REST fetching
- [x] 07-02-PLAN.md — Server.ts integration (backfill before indicators)

**Requirements:**
- BKFL-01: Fetch 60+ historical candles per symbol/timeframe
- BKFL-02: Rate-limited REST calls
- BKFL-03: Priority order (short timeframes first)
- BKFL-04: Progress tracking

---

### Phase 08: Reconciliation

**Goal**: Event-driven higher timeframe fetching at candle boundaries
**Plans**: 3 plans

Plans:
- [x] 08-01-PLAN.md — Boundary detector and BoundaryRestService
- [x] 08-02-PLAN.md — Gap detection utilities
- [x] 08-03-PLAN.md — Server.ts integration

**Architecture:** Option A — Event-Driven REST at Timeframe Boundaries
- WebSocket provides 5m candles in real-time
- On 5m candle close, detect if it's also a higher timeframe boundary
- At boundaries (15m, 1h, 4h, 1d), fire rate-limited REST calls
- NO cron jobs — purely event-driven (triggered by WebSocket)

**Requirements:**
- CACHE-04: Gap detection query (for future use)
- RECON-01: Boundary detection (is 5m close also 15m/1h/4h/1d boundary?)
- RECON-02: Event-driven REST fetching at boundaries
- RECON-03: Rate-limited batch processing (5 req/batch, 1s delay)

---

### Phase 09: Cleanup

**Goal**: Remove legacy code and finalize migration
**Plans**: 2 plans

Plans:
- [x] 09-01-PLAN.md — Server migration to CoinbaseAdapter
- [x] 09-02-PLAN.md — Documentation finalization

**Deliverables:**
- Deprecate old `CoinbaseWebSocketService`
- Remove REST API calls from indicator hot path
- Update server.ts to use new adapter
- Documentation updates

---

### Phase 10: Ticker Publisher

**Goal**: Add ticker price publishing to CoinbaseAdapter for alert notifications
**Plans**: 1 plan

Plans:
- [x] 10-01-PLAN.md — Add ticker subscription and publishing to CoinbaseAdapter

**Problem:** Milestone audit identified that alert notifications show "$0.00" because CoinbaseAdapter doesn't publish ticker events like the legacy service did.

**Requirements:**
- TICK-01: CoinbaseAdapter publishes ticker prices to Redis pub/sub
- TICK-02: AlertEvaluationService receives current prices for notifications

---

## Milestone Summary

**Key Decisions:**

| ID | Decision | Reason |
|----|----------|--------|
| IND-PATTERN | Redis psubscribe with wildcard pattern | Scales to any number of symbols/timeframes |
| IND-THRESHOLD | 60-candle readiness threshold | TradingView alignment |
| IND-NO-AGGREGATION | Fetch each timeframe from cache directly | User preference - no aggregation |
| BKFL-RATE | 5 requests per batch with 1s delay | 6x safety margin under Coinbase limit |
| RECON-BOUNDARY-DETECTION | Timestamp modulo for boundaries | Pure, testable, no external dependencies |
| CLEANUP-PRESERVE-LEGACY | Deprecate but preserve legacy service | Rollback safety net |
| TICKER-SUBSCRIBE-AFTER-CANDLES | Subscribe to ticker after candles | Symbols already known |

**Issues Resolved:**

- 17,309 429 errors from REST-heavy architecture → eliminated
- Data gaps from ticker-built candles (93% missing for low-liquidity) → native 5m candles
- $0.00 price in alert notifications → ticker pub/sub added

**Technical Debt Deferred:**

- 1m timeframe in SUPPORTED_TIMEFRAMES but not functional (v2.0 uses 5m)
- Runtime verification items (24-hour observation, test suite)

---

*Archived: 2026-01-24 as part of v2.0 milestone completion*
*For current project status, see .planning/ROADMAP.md*

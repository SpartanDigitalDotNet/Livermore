# Milestone v5.0: Distributed Exchange Architecture

**Status:** SHIPPED 2026-02-08
**Phases:** 23-29
**Total Plans:** 7 phases (mixed formal/ad-hoc execution)

## Overview

Transform Livermore from user-scoped single-exchange to exchange-scoped distributed architecture. Core outcome: cross-exchange visibility enabling "trigger remotely, buy locally" soft-arbitrage patterns. Mike's Coinbase signals visible to Kaia's Binance instance via Redis pub/sub.

## Phases

### Phase 23: Schema Foundation

**Goal**: Establish database foundation for multi-exchange architecture with normalized metadata.
**Depends on**: None (foundation phase)
**Plans**: 1 plan

Plans:

- [x] 23-01: Create exchanges table with seed data and add FK to user_exchanges

**Requirements:** EXC-01, EXC-02

**Details:**
Created `exchanges` table with 6 exchange seed data (Coinbase, Binance, Binance US, Kraken, KuCoin, MEXC). Added FK from `user_exchanges.exchange_id` to `exchanges.id`. Schema deployed via Atlas.

---

### Phase 24: Data Architecture

**Goal**: Redis key patterns support exchange-scoped shared data and user-scoped overflow with backward compatibility.
**Depends on**: Phase 23
**Plans**: 3 plans

Plans:

- [x] 24-01: Add exchange-scoped and user-overflow key functions to cache package
- [x] 24-02: Implement dual-read and tiered writes in cache strategies
- [x] 24-03: Update pub/sub to exchange-scoped channels with dual-publish

**Requirements:** DATA-01, DATA-02, DATA-03, DATA-04, DATA-05

**Details:**
New key functions (`exchangeCandleKey`, `exchangeIndicatorKey`, `userCandleKey`, `userIndicatorKey`) in `packages/cache/src/keys.ts`. Dual-read pattern in cache strategies. Exchange-scoped pub/sub channels with backward-compatible legacy channels.

---

### Phase 25: Symbol Management

**Goal**: Two-tier symbol sourcing with automatic de-duplication between shared pool and user positions.
**Depends on**: Phase 24
**Plans**: 1 plan (executed ad-hoc)

Plans:

- [x] 25-01: exchange_symbols table, SymbolSourceService, Admin symbols UI

**Requirements:** SYM-01, SYM-02, SYM-04

**Details:**
Created `exchange_symbols` table with volume ranking. `SymbolSourceService` provides merged symbol list with tier annotations. Admin symbols UI shows tier classification. Symbol refresh pipeline via CoinGecko for volume ranking.

---

### Phase 26: Startup Control

**Goal**: API starts idle and awaits explicit start command, with CLI override for automation.
**Depends on**: Phase 25
**Plans**: 1 plan (executed ad-hoc)

Plans:

- [x] 26-01: Idle startup, start/stop commands, --autostart flag

**Requirements:** CTL-01, CTL-02, CTL-03, CTL-04

**Details:**
API starts idle (no exchange connections). ControlChannelService handles `start` command with user_exchanges lookup. `--autostart` flag bypasses idle mode. Connection lifecycle events via pub/sub.

---

### Phase 27: Cross-Exchange Visibility

**Goal**: Any subscriber can receive signals from any exchange, enabling soft-arbitrage patterns.
**Depends on**: Phase 24, Phase 26
**Plans**: 1 plan (executed ad-hoc)

Plans:

- [x] 27-01: Exchange-scoped alert channels with source attribution

**Requirements:** VIS-01, VIS-02, VIS-03

**Details:**
AlertEvaluationService publishes to `channel:alerts:{exchange_id}`. Alert payloads include `source_exchange_id` and `source_exchange_name`. Any Redis subscriber can subscribe to any exchange's alert feed.

---

### Phase 28: Adapter Refactor

**Goal**: Exchange adapters instantiated via factory with connection status tracking.
**Depends on**: Phase 23, Phase 24, Phase 26
**Plans**: 1 plan (executed ad-hoc)

Plans:

- [x] 28-01: ExchangeAdapterFactory, BinanceAdapter, connection status tracking

**Requirements:** EXC-03, EXC-04

**Details:**
`ExchangeAdapterFactory` creates correct adapter by exchange type. `BinanceAdapter` and `BinanceRestClient` implemented. Connection status stored in Redis with heartbeat tracking. `IRestClient` interface for pluggable REST clients.

---

### Phase 29: Service Integration (GAP CLOSURE)

**Goal**: Wire orphaned services into main application, completing all E2E flows.
**Depends on**: Phase 25, Phase 28
**Plans**: 1 plan (executed ad-hoc)

Plans:

- [x] 29-01: Wire services, fix Binance routing, package rename

**Details:**
Addressed audit findings. Refactored `StartupBackfillService` to accept `IRestClient`. Created `createRestClient()` factory. Refactored `BoundaryRestService` to accept `IRestClient` + `exchangeName`. Added `setExchange()` setter for runtime exchange switching. Renamed `@livermore/coinbase-client` to `@livermore/exchange-core`. Fixed Redis 3-env-var connection.

---

## Milestone Summary

**Key Decisions:**

- Exchange-scoped shared keys (Rationale: Tier 1 symbols share data across users/instances)
- User overflow with TTL (Rationale: Tier 2 symbols have TTL-based auto-cleanup)
- Idle startup mode (Rationale: API doesn't connect until `start` command)
- --autostart flag (Rationale: CI/CD and automation can bypass idle mode)
- Adapter factory pattern (Rationale: Factory instantiates correct adapter by exchange type)
- Dual-read for migration (Rationale: Check exchange-scoped first, fall back to user-scoped)
- IRestClient interface (Rationale: Decouple REST clients from exchange-specific implementations)
- Package rename to exchange-core (Rationale: Package now contains exchange-agnostic services)
- 3 separate Redis env vars (Rationale: Never store full connection URL; construct at runtime)

**Issues Resolved:**

- Kaia's Binance getting 400 errors from Coinbase API (BoundaryRestService hardcoded to CoinbaseRestClient)
- Exchange key not set in Redis for Binance users (BoundaryRestService had no setter for exchangeId)
- Redis env var not reaching child processes (added to turbo.json globalPassThroughEnv)

**Issues Deferred:**

- SymbolSourceService not wired into server.ts startup (uses legacy getAccountSymbols)
- ExchangeAdapterFactory not wired into server.ts startup (direct CoinbaseAdapter creation)
- Hardcoded userId=1, exchangeId=1 in 4 locations
- Router auth hardening (publicProcedure â†’ protectedProcedure)
- switch-mode is a stub

**Technical Debt Incurred:**

- 6 hardcoded ID locations across 4 files
- 2 orphaned services (built but not wired into main startup)
- Autostart has no user context (can't load user settings/symbols)

---

_Archived: 2026-02-08 as part of v5.0 milestone completion_

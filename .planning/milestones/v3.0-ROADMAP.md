# Milestone v3.0: Admin UI + IAM Foundation

**Status:** SHIPPED 2026-01-30
**Phases:** 11-16
**Total Plans:** 9

## Overview

Establishes the database-first workflow with Atlas migrations, extends the users table for OAuth identity management, integrates Clerk authentication for the admin UI, and builds monitoring dashboards for MACD-V portfolio analysis, logs, and trade signals. Concludes with handoff documentation for Kaia's PerseusWeb development.

## Phases

### Phase 11: Database Workflow

**Goal**: Developers can deploy schema changes to Sandbox via a single command
**Depends on**: None (foundation phase)
**Plans**: 4 plans

Plans:
- [x] 11-01-PLAN.md - Atlas sandbox environment configuration
- [x] 11-02-PLAN.md - apply-schema-sandbox.ps1 script
- [x] 11-03-PLAN.md - sync-schema.ps1 script
- [x] 11-04-PLAN.md - ARCHITECTURE.md documentation update

**Requirements:**
- DB-01: Atlas `sandbox` environment configured in `atlas.hcl` with PG_SANDBOX_* variables
- DB-02: `apply-schema-sandbox.ps1` script deploys schema to Azure PostgreSQL (Sandbox)
- DB-03: `sync-schema.ps1` runs Atlas apply then Drizzle pull (single command workflow)
- DB-04: ARCHITECTURE.md updated to reflect Atlas-only migrations (Drizzle migrations banned)

---

### Phase 12: IAM Schema

**Goal**: Users table supports OAuth identity storage and role-based access
**Depends on**: Phase 11 (needs deployment scripts to apply schema)
**Plans**: 1 plan

Plans:
- [x] 12-01-PLAN.md - Add IAM columns to users table, deploy to local + sandbox, create role type helper

**Requirements:**
- IAM-01: Users table extended with `identity_provider` VARCHAR(20)
- IAM-02: Users table extended with `identity_sub` VARCHAR(255)
- IAM-03: Users table extended with `display_name` VARCHAR(100)
- IAM-04: Users table extended with `identity_picture_url` TEXT
- IAM-05: Users table extended with `role` VARCHAR(20) DEFAULT 'user'
- IAM-06: Users table extended with `last_login_at` TIMESTAMP

---

### Phase 13: Clerk Authentication

**Goal**: Fastify server validates Clerk tokens and tRPC procedures can require authentication
**Depends on**: Phase 12 (IAM columns exist for user sync)
**Plans**: 1 plan

Plans:
- [x] 13-01-PLAN.md - Install @clerk/fastify, register plugin, add auth to tRPC context, create protectedProcedure

**Requirements:**
- AUTH-01: `@clerk/fastify` plugin registered in Fastify server (import order: dotenv first)
- AUTH-02: tRPC context includes auth object from `getAuth(req)`
- AUTH-03: `protectedProcedure` middleware created, checks `ctx.auth.userId`

---

### Phase 14: User Sync Webhooks

**Goal**: Clerk user events automatically sync to PostgreSQL users table
**Depends on**: Phase 13 (Clerk plugin registered, IAM columns exist)
**Plans**: 1 plan

Plans:
- [x] 14-01-PLAN.md - Webhook handler with signature verification and user sync

**Requirements:**
- AUTH-04: Clerk webhook endpoint `/webhooks/clerk` syncs users on `user.created`
- AUTH-05: Clerk webhook syncs user data on `user.updated` events

---

### Phase 15: Admin UI

**Goal**: Authenticated users can view portfolio analysis, logs, and trade signals
**Depends on**: Phase 14 (authentication complete, user sync working)
**Plans**: 3 plans

Plans:
- [x] 15-01-PLAN.md - Vite + React + Clerk + tRPC client foundation
- [x] 15-02-PLAN.md - Logs router endpoint for server-side log access
- [x] 15-03-PLAN.md - Portfolio, Signals, and Logs pages with data tables

**Requirements:**
- UI-01: MACD-V portfolio viewer (symbols, prices, MACD-V values, signals)
- UI-02: Log viewer (error/warning logs from Livermore)
- UI-03: Trade signals viewer (triggered alerts with timestamp, symbol, signal type)
- UI-04: Clerk sign-in component with Google OAuth

---

### Phase 16: Kaia Handoff Documentation

**Goal**: Kaia has full context to build PerseusWeb authentication against Livermore
**Depends on**: Phase 15 (all features implemented and tested)
**Plans**: 0 plans (documentation only)

**Requirements:**
- DOC-01: `docs/KAIA-IAM-HANDOFF.md` - full context document for Kaia's AI workflow

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| Atlas-only migrations | Drizzle migrations banned - schema.sql is source of truth | Good |
| Database-first ORM | Use `drizzle-kit pull` to generate TypeScript from database | Good |
| Sandbox as shared DB | Azure PostgreSQL shared between Livermore and Kaia's UI | Good |
| Webhook before clerkPlugin | Server-to-server route has no JWT | Good |
| Check-then-update for upsert | Partial unique index doesn't work with onConflictDoUpdate | Good |
| protectedProcedure only for new routers | Existing routers left as publicProcedure | Tech Debt |

**Issues Resolved:**

- Fixed drizzle-orm type conflicts (duplicate instances from peer dep mismatch)
- Fixed tRPC v11 queryOptions pattern with shared QueryClient
- Fixed Clerk import order (dotenv must be first)
- Fixed webhook route registration order

**Tech Debt Incurred:**

- indicator.router.ts uses publicProcedure (should be protectedProcedure)
- alert.router.ts uses publicProcedure (should be protectedProcedure)
- position.router.ts uses publicProcedure (should be protectedProcedure)
- UserRole, isValidRole(), assertRole() exported but never used for RBAC

---

_For current project status, see .planning/PROJECT.md_

# Requirements: v3.0 Admin UI + IAM Foundation

**Defined:** 2026-01-26
**Shipped:** 2026-01-30
**Core Value:** Data accuracy and timely alerts

## Summary

20 requirements across 6 phases delivered database-first workflow with Atlas migrations, OAuth identity management via Clerk authentication, and Admin UI for monitoring portfolio, signals, and logs.

## Requirements

### Database Workflow (Phase 11)

- [x] **DB-01**: Atlas `sandbox` environment configured in `atlas.hcl` with PG_SANDBOX_* variables
- [x] **DB-02**: `apply-schema-sandbox.ps1` script deploys schema to Azure PostgreSQL (Sandbox)
- [x] **DB-03**: `sync-schema.ps1` runs Atlas apply then Drizzle pull (single command workflow)
- [x] **DB-04**: ARCHITECTURE.md updated to reflect Atlas-only migrations (Drizzle migrations banned)

### IAM Schema (Phase 12)

- [x] **IAM-01**: Users table extended with `identity_provider` VARCHAR(20) — OAuth provider name
- [x] **IAM-02**: Users table extended with `identity_sub` VARCHAR(255) — Provider's user ID
- [x] **IAM-03**: Users table extended with `display_name` VARCHAR(100) — User's display name from provider
- [x] **IAM-04**: Users table extended with `identity_picture_url` TEXT — Profile picture URL from provider
- [x] **IAM-05**: Users table extended with `role` VARCHAR(20) DEFAULT 'user' — User role (admin, user, subscriber_basic, subscriber_pro)
- [x] **IAM-06**: Users table extended with `last_login_at` TIMESTAMP — Last login timestamp

### Authentication (Phase 13)

- [x] **AUTH-01**: `@clerk/fastify` plugin registered in Fastify server (import order: dotenv first)
- [x] **AUTH-02**: tRPC context includes auth object from `getAuth(req)`
- [x] **AUTH-03**: `protectedProcedure` middleware created, checks `ctx.auth.userId`

### User Sync Webhooks (Phase 14)

- [x] **AUTH-04**: Clerk webhook endpoint `/webhooks/clerk` syncs users on `user.created`
- [x] **AUTH-05**: Clerk webhook syncs user data on `user.updated` events

### Admin UI (Phase 15)

- [x] **UI-01**: MACD-V portfolio viewer — displays portfolio analysis (symbols, prices, MACD-V values, signals)
- [x] **UI-02**: Log viewer — displays error/warning logs from Livermore
- [x] **UI-03**: Trade signals viewer — displays triggered alerts with timestamp, symbol, signal type
- [x] **UI-04**: Clerk sign-in component with Google OAuth

### Documentation (Phase 16)

- [x] **DOC-01**: `docs/KAIA-IAM-HANDOFF.md` — full context document for Kaia's AI workflow

## Traceability

| Requirement | Phase | Plan | Status |
|-------------|-------|------|--------|
| DB-01 | 11 | 11-01-PLAN.md | Complete |
| DB-02 | 11 | 11-02-PLAN.md | Complete |
| DB-03 | 11 | 11-03-PLAN.md | Complete |
| DB-04 | 11 | 11-04-PLAN.md | Complete |
| IAM-01 | 12 | 12-01-PLAN.md | Complete |
| IAM-02 | 12 | 12-01-PLAN.md | Complete |
| IAM-03 | 12 | 12-01-PLAN.md | Complete |
| IAM-04 | 12 | 12-01-PLAN.md | Complete |
| IAM-05 | 12 | 12-01-PLAN.md | Complete |
| IAM-06 | 12 | 12-01-PLAN.md | Complete |
| AUTH-01 | 13 | 13-01-PLAN.md | Complete |
| AUTH-02 | 13 | 13-01-PLAN.md | Complete |
| AUTH-03 | 13 | 13-01-PLAN.md | Complete |
| AUTH-04 | 14 | 14-01-PLAN.md | Complete |
| AUTH-05 | 14 | 14-01-PLAN.md | Complete |
| UI-01 | 15 | 15-03-PLAN.md | Complete |
| UI-02 | 15 | 15-03-PLAN.md | Complete |
| UI-03 | 15 | 15-03-PLAN.md | Complete |
| UI-04 | 15 | 15-01-PLAN.md | Complete |
| DOC-01 | 16 | N/A | Complete |

## Coverage

- v3.0 requirements: 20 total
- Mapped to phases: 20
- Unmapped: 0
- **Coverage: 100%**

## Deferred to v3.1

- **AUTH-06**: API key authentication path for PerseusWeb
- **AUTH-07**: JWT validation for PerseusWeb tokens
- **TRADE-01**: Order model (buy/sell, limit/market, quantity, price)
- **TRADE-02**: Position model (symbol, quantity, entry price, P&L)
- **TRADE-03**: WebSocket contract for real-time data to PerseusWeb

---
*Requirements archived: 2026-01-30*

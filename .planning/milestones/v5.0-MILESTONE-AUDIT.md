# Milestone Audit: v5.0 Distributed Exchange Architecture

---
milestone: 5.0
audited: 2026-02-07
revised: 2026-02-08
status: complete
scores:
  requirements: 19/19
  phases: 7/7
  integration: 12/12
  flows: 3/3
---

## Summary

All 19 requirements are implemented. All 7 phases complete (including Phase 29 gap closure). All services integrated into the main application. All E2E flows working.

**Verdict:** Shipped clean. Remaining hardcoded IDs are in autostart path (no user context by design) and unprotected routers (publicProcedure — tech debt from v3.0).

---

## Requirements Coverage

| ID | Requirement | Phase | Status |
|----|-------------|-------|--------|
| EXC-01 | `exchanges` metadata table | 23 | SATISFIED |
| EXC-02 | `user_exchanges` FK refactor | 23 | SATISFIED |
| EXC-03 | Exchange adapter factory | 28 | SATISFIED |
| EXC-04 | Connection status tracking | 28 | SATISFIED |
| DATA-01 | Exchange-scoped candle keys | 24 | SATISFIED |
| DATA-02 | Exchange-scoped indicator keys | 24 | SATISFIED |
| DATA-03 | User overflow keys with TTL | 24 | SATISFIED |
| DATA-04 | Dual-read pattern | 24 | SATISFIED |
| DATA-05 | Cross-exchange pub/sub channels | 24 | SATISFIED |
| SYM-01 | Tier 1 symbol list by volume | 25 | SATISFIED |
| SYM-02 | Tier 2 user positions | 25 | SATISFIED |
| SYM-04 | Symbol de-duplication | 25 | SATISFIED |
| CTL-01 | Idle startup mode | 26 | SATISFIED |
| CTL-02 | `start` command | 26 | SATISFIED |
| CTL-03 | `--autostart` flag | 26 | SATISFIED |
| CTL-04 | Connection lifecycle events | 26 | SATISFIED |
| VIS-01 | Exchange-scoped alert channels | 27 | SATISFIED |
| VIS-02 | Cross-exchange subscription | 27 | SATISFIED |
| VIS-03 | Alert source attribution | 27 | SATISFIED |

**Score: 19/19 requirements satisfied**

---

## Phase Verification

| Phase | Name | Summary | Status |
|-------|------|---------|--------|
| 23 | Schema Foundation | `exchanges` table, `user_exchanges` FK | COMPLETE |
| 24 | Data Architecture | Key functions, dual-read, pub/sub channels | COMPLETE |
| 25 | Symbol Management | `exchange_symbols` table, SymbolSourceService | COMPLETE |
| 26 | Startup Control | Idle mode, start/stop commands, --autostart | COMPLETE |
| 27 | Cross-Exchange Visibility | Alert channels, source attribution | COMPLETE |
| 28 | Adapter Refactor | ExchangeAdapterFactory, connection tracking | COMPLETE |
| 29 | Service Integration | Wire orphaned services, fix Binance routing, package rename | COMPLETE |

**Score: 7/7 phases complete**

---

## Integration Analysis

### Connected (Working)

| Export | From | Used By |
|--------|------|---------|
| `exchanges` table | Phase 23 | Phase 28 adapter factory |
| `exchange_symbols` table | Phase 25 | Phase 25 symbol service |
| `exchangeCandleKey` | Phase 24 | CandleCacheStrategy, CoinbaseAdapter |
| `exchangeIndicatorKey` | Phase 24 | IndicatorCacheStrategy |
| `userCandleKey` | Phase 24 | CandleCacheStrategy |
| `exchangeCandleCloseChannel` | Phase 24 | CoinbaseAdapter |
| `exchangeAlertChannel` | Phase 27 | AlertEvaluationService |
| `connectionState` | Phase 26 | RuntimeState, ControlChannelService |
| `start`/`stop` commands | Phase 26 | CommandSchema |
| Dual-read pattern | Phase 24 | Cache strategies |
| `ExchangeAdapterFactory` | Phase 28 | `server.ts:364` (Phase 29 wired) |
| `SymbolSourceService` | Phase 25 | `server.ts:259` (autostart), `control-channel.service.ts:487` (start cmd) |

**Score: 12/12 exports connected**

---

## E2E Flow Analysis

### Flow 1: Start Flow (COMPLETE)

```
API starts idle → "start" command → DB lookup for exchangeId → services connect → indicators calculate
```

`control-channel.service.ts:480` resolves `exchangeId` from `user_exchanges` DB query. No hardcoded IDs in this path.

### Flow 2: Alert Flow (COMPLETE)

```
Candle closes → indicator calculates → alert triggers → publishes to exchange channel
```

Exchange-scoped channels working. Source attribution included. `AlertEvaluationService` and `IndicatorCalculationService` accept `exchangeId` via constructor and `setExchange()`/`setExchangeId()` setters.

### Flow 3: Symbol Classification Flow (COMPLETE)

```
Start command → SymbolSourceService → Tier 1 symbols from exchange_symbols table
Autostart → SymbolSourceService → classifyUserPositions() → Tier 1/2 assignment
```

Both paths use `SymbolSourceService`. Autostart path also calls `getAccountSymbols()` for user position detection, then feeds results through `classifyUserPositions()`.

**Score: 3/3 flows complete**

---

## Remaining Technical Debt

### Hardcoded IDs (autostart path only)

| File | Line | Issue | Reason |
|------|------|-------|--------|
| `server.ts` | 250 | `activeExchangeId = 1` (autostart) | Autostart has no user context by design |
| `server.ts` | 281 | `userId: 1` in backfill config | Legacy cache API requires userId param |
| `server.ts` | 369 | `userId: 1` in adapter factory | Autostart has no user context |

### Hardcoded IDs (routers — publicProcedure debt from v3.0)

| File | Line | Issue |
|------|------|-------|
| `indicator.router.ts` | 26-27 | `TEST_USER_ID = 1`, `TEST_EXCHANGE_ID = 1` |
| `position.router.ts` | 9-10 | `TEST_USER_ID = 1`, `TEST_EXCHANGE_ID = 1` |
| `alert.router.ts` | 11 | `TEST_EXCHANGE_ID = 1` |
| `coinbase-websocket.service.ts` | 55-56 | `TEST_USER_ID = 1`, `TEST_EXCHANGE_ID = 1` |

### Legacy userId params in cache calls

`IndicatorCalculationService` and `AlertEvaluationService` pass `1` as userId to cache functions that still require the param in their signature, even though exchange-scoped keys don't use it. These are annotated with `// legacy userId param` comments.

### TODOs and Stubs

| File | Issue |
|------|-------|
| `control-channel.service.ts:593` | `TODO: Apply settings to running services` |
| `control-channel.service.ts:627` | `switch-mode` is a stub |

---

## Phase 29 Corrections

This audit was originally written on 2026-02-07 before Phase 29 (Service Integration). The following items from the original audit were resolved by Phase 29:

| Original Finding | Resolution |
|---|---|
| `ExchangeAdapterFactory` orphaned | Wired into `server.ts:364` with factory pattern |
| `SymbolSourceService` orphaned | Wired into `server.ts:259` (autostart) and `control-channel.service.ts:487` (start command) |
| `control-channel.service.ts` hardcoded userId/exchangeId | Resolved — uses `userExchange.exchangeId` from DB query |
| `indicator-calculation.service.ts` hardcoded TEST_USER_ID/TEST_EXCHANGE_ID | Resolved — accepts `exchangeId` via constructor + `setExchangeId()` setter |
| `alert-evaluation.service.ts` hardcoded TEST_USER_ID/TEST_EXCHANGE_ID | Resolved — accepts `exchangeId` via constructor + `setExchange()` setter |
| Symbol Classification Flow incomplete | Complete — both autostart and start command paths use `SymbolSourceService` |

**Original status:** `tech_debt` (integration: 10/12, flows: 2/3)
**Revised status:** `complete` (integration: 12/12, flows: 3/3)

---

## Verdict

**STATUS: COMPLETE** - All requirements met. All services integrated. All E2E flows working. Remaining hardcoded IDs are in autostart (no user context by design) and unprotected routers (publicProcedure tech debt from v3.0).

---

*Audited: 2026-02-07*
*Revised: 2026-02-08 — updated to reflect Phase 29 fixes*
*Auditor: Claude (gsd-integration-checker)*
